---
title: "Multivariate analysis of E5 time series biological data"
author: "Ariana S Huffmyer, E5 RoL Team"
date: "04/14/2022"
output: html_document
editor_options: 
  chunk_output_type: console
--- 
NOTE: If you want to run this script, do not Knit, instead "run all chunks below" and look at console output.   

# Set Up    
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

```{r}
## install packages if you dont already have them
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("RColorBrewer")) install.packages("RColorBrewer")
if (!require("lme4")) install.packages("lme4")
if (!require("lmerTest")) install.packages("lmerTest")
if (!require("car")) install.packages("car")
if (!require("effects")) install.packages("effects")
if (!require("ggfortify")) install.packages("ggfortify")
if (!require("cowplot")) install.packages("cowplot")
if (!require("vegan")) install.packages("vegan")
if (!require("corrr")) install.packages("corrr")
if (!require("ggcorrplot")) install.packages("ggcorrplot")
if (!require("GGally")) install.packages("GGally")
if (!require("broom")) install.packages("broom")
if (!require("cowplot")) install.packages("cowplot")

# load packages
library(tidyverse)
library(ggplot2)
library(RColorBrewer)
library(lme4)
library(lmerTest)
library(car)
library(effects)
library(ggfortify)
library(cowplot)
library(vegan)
library(corrr)
library(ggcorrplot)
library(GGally)
library(broom)
library(cowplot)
```

# Load dataframe

Load in master dataframe generated from 1_assemble_data.Rmd.  
```{r}
master<-read.csv("Output/master_timeseries.csv")
```

# Multivariate analyses  

## All Responses  
### Standard PCA's
#### PCAs: Surface Area normalizers  

##### Combined PCA's   
 
Plot PCA using prcomp to center and scale.     
 
```{r}
pca_data_cm2<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.cm2, chlc2.ug.cm2, prot_mg.cm2, cells.cm2, cre.umol.cm2, Am, AQY, Rd, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ratio_AFDW.mg.cm2>0)

pca_data_cm2<-pca_data_cm2[complete.cases(pca_data_cm2), ]

scaled_data_cm2<-prcomp(pca_data_cm2[c(5:16)], scale=TRUE, center=TRUE) 
```

Groupings by species:  
```{r}
pcaSpecies_cm2<-ggplot2::autoplot(scaled_data_cm2, data=pca_data_cm2, frame.colour="species", loadings=FALSE,  colour="species", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("orange", "darkgray", "purple")) +
  scale_fill_manual(values=c("orange", "darkgray", "purple")) + 
  theme_classic()+
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaSpecies_cm2

```

PERMANOVA of the effect of species  
```{r}
# scale data
vegan_cm2 <- scale(pca_data_cm2[ ,5:16])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_cm2 ~ species, data = pca_data_cm2, method='eu')
```


Groupings by timepoint:  
```{r}
pcaTimepoint_cm2<-ggplot2::autoplot(scaled_data_cm2, data=pca_data_cm2, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaTimepoint_cm2
```

PERMANOVA of the effect of timepoint  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_cm2 ~ timepoint, data = pca_data_cm2, method='eu')
```

Groupings by site:  
```{r}
pcaSite_cm2<-ggplot2::autoplot(scaled_data_cm2, data=pca_data_cm2, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaSite_cm2

```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_cm2 ~ site_code, data = pca_data_cm2, method='eu')
```

Generate a plot of all PCA's for surface area normalization.  

```{r}
pcaplots_cm2<-plot_grid(pcaSpecies_cm2, pcaSite_cm2, pcaTimepoint_cm2, labels = c("Species: Surface Area", "Site: Surface Area", "Timepoint: Surface Area"), ncol=3, nrow=1, rel_widths = c(1, 1, 1), label_size = 20, label_x = 0.01)

#ggsave(filename="Figures/All_PCAs_cm2.pdf", plot=pcaplots_cm2, dpi=300, width=24, height=5, units="in")
```  

##### Species-specific PCA's   

Next generate PCA for site and timepoint for each species separately.  

Separate by species.  
```{r}
#porites
por_data_cm2<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.cm2, chlc2.ug.cm2, prot_mg.cm2, cells.cm2, cre.umol.cm2, Am, AQY, Rd, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Porites")

por_data_cm2<-por_data_cm2[complete.cases(por_data_cm2), ]

scaled_por_cm2<-prcomp(por_data_cm2[c(5:16)], scale=TRUE, center=TRUE) 

#acropora
acr_data_cm2<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.cm2, chlc2.ug.cm2, prot_mg.cm2, cells.cm2, cre.umol.cm2, Am, AQY, Rd, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Acropora")

acr_data_cm2<-acr_data_cm2[complete.cases(acr_data_cm2), ]

scaled_acr_cm2<-prcomp(acr_data_cm2[c(5:16)], scale=TRUE, center=TRUE) 

#pocillopora
poc_data_cm2<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.cm2, chlc2.ug.cm2, prot_mg.cm2, cells.cm2, cre.umol.cm2, Am, AQY, Rd, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Pocillopora")

poc_data_cm2<-poc_data_cm2[complete.cases(poc_data_cm2), ]

scaled_poc_cm2<-prcomp(poc_data_cm2[c(5:16)], scale=TRUE, center=TRUE) 
```

###### Porites PCA's   

Groupings by timepoint:  
```{r}
porTimepoint_cm2<-ggplot2::autoplot(scaled_por_cm2, data=por_data_cm2, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.7,0.5)+
  #ylim(-0.7, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));porTimepoint_cm2
```

PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_cm2 <- scale(por_data_cm2[ ,5:15])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_cm2 ~ timepoint, data = por_data_cm2, method='eu')
```

Groupings by site:  
```{r}
porSite_cm2<-ggplot2::autoplot(scaled_por_cm2, data=por_data_cm2, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.7,0.5)+
  #ylim(-0.7, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));porSite_cm2
```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_cm2 ~ site_code, data = por_data_cm2, method='eu')
```

###### Acropora PCA's  
 
Groupings by timepoint:  
```{r}
acrTimepoint_cm2<-ggplot2::autoplot(scaled_acr_cm2, data=acr_data_cm2, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.5,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));acrTimepoint_cm2
```

PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_cm2 <- scale(acr_data_cm2[ ,5:15])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_cm2 ~ timepoint, data = acr_data_cm2, method='eu')
```

Groupings by site:  
```{r}
acrSite_cm2<-ggplot2::autoplot(scaled_acr_cm2, data=acr_data_cm2, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.5,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));acrSite_cm2
```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_cm2 ~ site_code, data = acr_data_cm2, method='eu')
```

###### Pocillopora PCA's  

Groupings by timepoint:   
```{r}
pocTimepoint_cm2<-ggplot2::autoplot(scaled_poc_cm2, data=poc_data_cm2, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.6,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pocTimepoint_cm2
```
 
PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_cm2 <- scale(poc_data_cm2[ ,5:15])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_cm2 ~ timepoint, data = poc_data_cm2, method='eu')
```

Groupings by site:  
```{r}
pocSite_cm2<-ggplot2::autoplot(scaled_poc_cm2, data=poc_data_cm2, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.5,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pocSite_cm2
```

PERMANOVA of the effect of site  
```{r}

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_cm2 ~ site_code, data = poc_data_cm2, method='eu')
```

Generate a plot of all PCA's for all Species    

```{r}
species_plots_cm2<-plot_grid(porSite_cm2, porTimepoint_cm2, acrSite_cm2, acrTimepoint_cm2, pocSite_cm2, pocTimepoint_cm2, labels = c("Porites: Surface Area", "Porites: Surface Area", "Acropora: Surface Area", "Acropora: Surface Area", "Pocillopora: Surface Area", "Pocillopora: Surface Area"), ncol=2, nrow=3, rel_widths = c(1, 1, 1, 1, 1, 1), label_size = 20, label_x = 0.01, label_y=1.0)

#ggsave(filename="Figures/Species_PCAs_cm2.pdf", plot=species_plots_cm2, dpi=300, width=18, height=15, units="in")
``` 




#### PCAs: Protein normalizers  

##### Combined PCA's  

Plot PCA using prcomp to center and scale.    
 
```{r}
pca_data_prot<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgprot, chlc2.ug.mgprot, prot_mg.cm2, cells.mgprot, cre.umol.mgprot, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ratio_AFDW.mg.cm2>0)

pca_data_prot<-pca_data_prot[complete.cases(pca_data_prot), ]

scaled_data_prot<-prcomp(pca_data_prot[c(5:15)], scale=TRUE, center=TRUE) 
```

Groupings by species:  
```{r}
pcaSpecies_prot<-ggplot2::autoplot(scaled_data_prot, data=pca_data_prot, frame.colour="species", loadings=FALSE,  colour="species", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("orange", "darkgray", "purple")) +
  scale_fill_manual(values=c("orange", "darkgray", "purple")) + 
  theme_classic()+
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaSpecies_prot

```

PERMANOVA of the effect of species  
```{r}
# scale data
vegan_prot <- scale(pca_data_prot[ ,5:15])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_prot ~ species, data = pca_data_prot, method='eu')
```


Groupings by timepoint:  
```{r}
pcaTimepoint_prot<-ggplot2::autoplot(scaled_data_prot, data=pca_data_prot, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaTimepoint_prot
```

PERMANOVA of the effect of timepoint  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_prot ~ timepoint, data = pca_data_prot, method='eu')
```

Groupings by site:  
```{r}
pcaSite_prot<-ggplot2::autoplot(scaled_data_prot, data=pca_data_prot, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaSite_prot

```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_prot ~ site_code, data = pca_data_prot, method='eu')
```

Generate a plot of all PCA's for protein normalization.  

```{r}
pcaplots_prot<-plot_grid(pcaSpecies_prot, pcaSite_prot, pcaTimepoint_prot, labels = c("Species: Protein", "Site: Protein", "Timepoint: Protein"), ncol=3, nrow=1, rel_widths = c(1, 1, 1), label_size = 20, label_x = 0.02)

#ggsave(filename="Figures/All_PCAs_prot.pdf", plot=pcaplots_prot, dpi=300, width=24, height=5, units="in")
```  

##### Species-specific PCA's   

Next generate PCA for site and timepoint for each species separately.  

Separate by species.  
```{r}
#porites
por_data_prot<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgprot, chlc2.ug.mgprot, prot_mg.cm2, cells.mgprot, cre.umol.mgprot, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Porites")

por_data_prot<-por_data_prot[complete.cases(por_data_prot), ]

scaled_por_prot<-prcomp(por_data_prot[c(5:15)], scale=TRUE, center=TRUE) 

#acropora
acr_data_prot<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgprot, chlc2.ug.mgprot, prot_mg.cm2, cells.mgprot, cre.umol.mgprot, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Acropora")

acr_data_prot<-acr_data_prot[complete.cases(acr_data_prot), ]

scaled_acr_prot<-prcomp(acr_data_prot[c(5:15)], scale=TRUE, center=TRUE) 

#pocillopora
poc_data_prot<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgprot, chlc2.ug.mgprot, prot_mg.cm2, cells.mgprot, cre.umol.mgprot, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Pocillopora")

poc_data_prot<-poc_data_prot[complete.cases(poc_data_prot), ]

scaled_poc_prot<-prcomp(poc_data_prot[c(5:15)], scale=TRUE, center=TRUE) 
```

##### Porites PCA's   

Groupings by timepoint:  
```{r}
porTimepoint_prot<-ggplot2::autoplot(scaled_por_prot, data=por_data_prot, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.7,0.5)+
  #ylim(-0.7, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));porTimepoint_prot
```

PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_prot <- scale(por_data_prot[ ,5:15])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_prot ~ timepoint, data = por_data_prot, method='eu')
```

Groupings by site:  
```{r}
porSite_prot<-ggplot2::autoplot(scaled_por_prot, data=por_data_prot, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.7,0.5)+
  #ylim(-0.7, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));porSite_prot
```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_prot ~ site_code, data = por_data_prot, method='eu')
```

##### Acropora PCA's  
 
Groupings by timepoint:  
```{r}
acrTimepoint_prot<-ggplot2::autoplot(scaled_acr_prot, data=acr_data_prot, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.5,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));acrTimepoint_prot
```

PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_prot <- scale(acr_data_prot[ ,5:15])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_prot ~ timepoint, data = acr_data_prot, method='eu')
```

Groupings by site:  
```{r}
acrSite_prot<-ggplot2::autoplot(scaled_acr_prot, data=acr_data_prot, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.5,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));acrSite_prot
```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_prot ~ site_code, data = acr_data_prot, method='eu')
```

##### Pocillopora PCA's  
 
Groupings by timepoint:   
```{r}
pocTimepoint_prot<-ggplot2::autoplot(scaled_poc_prot, data=poc_data_prot, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.6,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pocTimepoint_prot
```
 
PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_prot <- scale(poc_data_prot[ ,5:15])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_prot ~ timepoint, data = poc_data_prot, method='eu')
```

Groupings by site:  
```{r}
pocSite_prot<-ggplot2::autoplot(scaled_poc_prot, data=poc_data_prot, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.5,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pocSite_prot
```

PERMANOVA of the effect of site  
```{r}

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_prot ~ site_code, data = poc_data_prot, method='eu')
```

Generate a plot of all PCA's for all Species    

```{r}
species_plots_prot<-plot_grid(porSite_prot, porTimepoint_prot, acrSite_prot, acrTimepoint_prot, pocSite_prot, pocTimepoint_prot, labels = c("Porites: Protein", "Porites: Protein", "Acropora: Protein", "Acropora: Protein", "Pocillopora: Protein", "Pocillopora: Protein"), ncol=2, nrow=3, rel_widths = c(1, 1, 1, 1, 1, 1), label_size = 20, label_x = 0.01, label_y=1.0)

#ggsave(filename="Figures/Species_PCAs_prot.pdf", plot=species_plots_prot, dpi=300, width=18, height=15, units="in")
``` 





#### PCAs: Biomass normalizers  

##### Combined PCA's  

Plot PCA using prcomp to center and scale.    
  
```{r}
pca_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(prot_mg.mgafdw<1.5) #remove outliers


pca_data_afdw<-pca_data_afdw[complete.cases(pca_data_afdw), ]

scaled_data_afdw<-prcomp(pca_data_afdw[c(5:15)], scale=TRUE, center=TRUE) 
```

```{r}
# scale data
vegan <- scale(pca_data_afdw[ ,5:15])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis(vegan ~ species, data = pca_data_afdw, method='eu')
z_species<-permanova$aov.tab
z_species
``` 
 
Groupings by species:  
```{r}
pcaSpecies_afdw<-ggplot2::autoplot(scaled_data_afdw, data=pca_data_afdw, frame.colour="species", loadings=FALSE,  colour="species", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm', alpha=0.5) + 
  scale_colour_manual(values=c("darkgray", "orange", "purple")) +
  scale_fill_manual(values=c("darkgray", "orange", "purple")) + 
  theme_classic()+
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
  #geom_text(x=0.3, y=-0.15, label=paste("p(Species)=", z_species$`Pr(>F)`[1]), size=6, color="black") + 
  xlab("PC1")+
  ylab("PC2")+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_blank(), 
        axis.text = element_text(size=18, color="black"), 
        axis.title = element_text(size=18, color="black"));pcaSpecies_afdw

ggsave(filename="Figures/Species_Overall_PCA.pdf", plot=pcaSpecies_afdw, dpi=300, width=7, height=5, units="in")
```

PERMANOVA of the effect of species  
```{r}
# scale data
vegan_afdw <- scale(pca_data_afdw[ ,5:15])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_afdw ~ species, data = pca_data_afdw, method='eu')
```
 

Groupings by timepoint:  
```{r}
pcaTimepoint_afdw<-ggplot2::autoplot(scaled_data_afdw, data=pca_data_afdw, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaTimepoint_afdw
```

PERMANOVA of the effect of timepoint  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_afdw ~ timepoint, data = pca_data_afdw, method='eu')
```

Groupings by site:  
```{r}
pcaSite_afdw<-ggplot2::autoplot(scaled_data_afdw, data=pca_data_afdw, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaSite_afdw

```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_afdw ~ site_code, data = pca_data_afdw, method='eu')
```

Generate a plot of all PCA's for afdw normalization.  

```{r}
pcaplots_afdw<-plot_grid(pcaSpecies_afdw, pcaSite_afdw, pcaTimepoint_afdw, labels = c("Species: Biomass", "Site: Biomass", "Timepoint: Biomass"), ncol=3, nrow=1, rel_widths = c(1, 1, 1), label_size = 20, label_x = 0.02)

#ggsave(filename="Figures/All_PCAs_afdw.pdf", plot=pcaplots_afdw, dpi=300, width=24, height=5, units="in")
```  

##### Species-specific PCA's   

Next generate PCA for site and timepoint for each species separately.  
 
Separate by species.  
```{r}
#porites
por_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Porites")

por_data_afdw<-por_data_afdw[complete.cases(por_data_afdw), ]

scaled_por_afdw<-prcomp(por_data_afdw[c(5:15)], scale=TRUE, center=TRUE) 

#acropora
acr_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Acropora")

acr_data_afdw<-acr_data_afdw[complete.cases(acr_data_afdw), ]

scaled_acr_afdw<-prcomp(acr_data_afdw[c(5:15)], scale=TRUE, center=TRUE) 

#pocillopora
poc_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Pocillopora")

poc_data_afdw<-poc_data_afdw[complete.cases(poc_data_afdw), ]

scaled_poc_afdw<-prcomp(poc_data_afdw[c(5:15)], scale=TRUE, center=TRUE) 
```

##### Porites PCA's   

Groupings by timepoint:  
```{r}
porTimepoint_afdw<-ggplot2::autoplot(scaled_por_afdw, data=por_data_afdw, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.7,0.5)+
  #ylim(-0.7, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));porTimepoint_afdw
```

PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_afdw <- scale(por_data_afdw[ ,5:15])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_afdw ~ timepoint, data = por_data_afdw, method='eu')
```

Groupings by site:  
```{r}
porSite_afdw<-ggplot2::autoplot(scaled_por_afdw, data=por_data_afdw, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
 # xlim(-0.7,0.5)+
 # ylim(-0.7, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));porSite_afdw
```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_afdw ~ site_code, data = por_data_afdw, method='eu')
```

##### Acropora PCA's  
 
Groupings by timepoint:  
```{r}
acrTimepoint_afdw<-ggplot2::autoplot(scaled_acr_afdw, data=acr_data_afdw, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.5,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));acrTimepoint_afdw
```

PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_afdw <- scale(acr_data_afdw[ ,5:15])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_afdw ~ timepoint, data = acr_data_afdw, method='eu')
```

Groupings by site:  
```{r}
acrSite_afdw<-ggplot2::autoplot(scaled_acr_afdw, data=acr_data_afdw, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.5,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));acrSite_afdw
```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_afdw ~ site_code, data = acr_data_afdw, method='eu')
```

##### Pocillopora PCA's  

Groupings by timepoint:   
```{r}
pocTimepoint_afdw<-ggplot2::autoplot(scaled_poc_afdw, data=poc_data_afdw, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
 # xlim(-0.6,0.5)+
  #ylim(-0.5, 0.8)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pocTimepoint_afdw
```
 
PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_afdw <- scale(poc_data_afdw[ ,5:15])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_afdw ~ timepoint, data = poc_data_afdw, method='eu')
```

Groupings by site:  
```{r}
pocSite_afdw<-ggplot2::autoplot(scaled_poc_afdw, data=poc_data_afdw, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.5,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pocSite_afdw
```

PERMANOVA of the effect of site  
```{r}

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_afdw ~ site_code, data = poc_data_afdw, method='eu')
```

Generate a plot of all PCA's for all Species    

```{r}
species_plots_afdw<-plot_grid(porSite_afdw, porTimepoint_afdw, acrSite_afdw, acrTimepoint_afdw, pocSite_afdw, pocTimepoint_afdw, labels = c("Porites: Biomass", "Porites: Biomass", "Acropora: Biomass", "Acropora: Biomass", "Pocillopora: Biomass", "Pocillopora: Biomass"), ncol=2, nrow=3, rel_widths = c(1, 1, 1, 1, 1, 1), label_size = 20, label_x = 0.01, label_y=1.0)

#ggsave(filename="Figures/Species_PCAs_afdw.pdf", plot=species_plots_afdw, dpi=300, width=18, height=15, units="in")
``` 




#### Assemble all PCA plots  

Generate plot of all combined PCA's

```{r}
All_PCAs<-plot_grid(pcaSpecies_prot, pcaSite_prot, pcaTimepoint_prot, pcaSpecies_afdw, pcaSite_afdw, pcaTimepoint_afdw, pcaSpecies_cm2, pcaSite_cm2, pcaTimepoint_cm2, labels = c("Protein", "Protein", "Protein", "Biomass", "Biomass", "Biomass","Surface Area", "Surface Area", "Surface Area"), ncol=3, nrow=3, rel_widths = c(1, 1, 1, 1, 1, 1, 1, 1, 1), label_size = 20, label_x = 0.06, label_y=1.0)

ggsave(filename="Figures/All_PCAs.pdf", plot=All_PCAs, dpi=300, width=24, height=15, units="in")
``` 

Generate plot of all species specific PCA's

```{r}
All_PCAs_species<-plot_grid(porSite_prot, porTimepoint_prot, porSite_afdw, porTimepoint_afdw, porSite_cm2, porTimepoint_cm2, 
                    acrSite_prot, acrTimepoint_prot, acrSite_afdw, acrTimepoint_afdw, acrSite_cm2, acrTimepoint_cm2,
                    pocSite_prot, pocTimepoint_prot, pocSite_afdw, pocTimepoint_afdw, pocSite_cm2, pocTimepoint_cm2,
                    labels = c("Porites: Protein", "Porites: Protein", "Porites: Biomass", "Porites: Biomass", "Porites: SA", "Porites: SA",
                               "Acropora: Protein", "Acropora: Protein", "Acropora: Biomass", "Acropora: Biomass", "Acropora: SA", "Acropora: SA",
                               "Pocillopora: Protein", "Pocillopora: Protein", "Pocillopora: Biomass", "Pocillopora: Biomass", "Pocillopora: SA", "Pocillopora: SA"), ncol=6, nrow=3, rel_widths = c(1), label_size = 20, label_x = 0.06, label_y=1.0)

ggsave(filename="Figures/All_Species_PCAs.pdf", plot=All_PCAs_species, dpi=300, width=48, height=15, units="in")
``` 


### PCA's for centroid and trajectories  

#### Acropora  

Generate PCA using scaled (scaled_acr_afdw) from dataframe (acr_data_afdw).   
 
```{r}
acr_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Acropora")%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Chl_a=chla.ug.mgAFDW, Chl_c2=chlc2.ug.mgAFDW, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw)

acr_data_afdw<-acr_data_afdw[complete.cases(acr_data_afdw), ]

scaled_acr_afdw<-prcomp(acr_data_afdw[c(5:15)], scale=TRUE, center=TRUE) 

acr_info<-acr_data_afdw[c(2,4)]

acr_data<-scaled_acr_afdw%>%
  augment(acr_info)%>%
  group_by(timepoint, site_code)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

acr.centroids<-acr_data %>% 
  select(timepoint, site_code, PC1.mean, PC2.mean)%>%
  group_by(timepoint, site_code)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
```

Examine PERMANOVA results.  
 
```{r}
# scale data
vegan <- scale(acr_data_afdw[ ,5:12])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis(vegan ~ timepoint*site_code, data = acr_data_afdw, method='eu')
z_acr<-permanova$aov.tab
z_acr
``` 
 
Assemble plot with background points 
```{r}
#1. make plot with dots
acrPCA<-ggplot(acr_data, aes(.fittedPC1, .fittedPC2, color=site_code)) + 
  geom_point(size = 4, alpha=0.2, show.legend=FALSE)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  ylim(-6,10)+
  xlim(-5,10)+
  ylab("PC2")+
  xlab("PC1")+
  ggtitle(expression(italic("Acropora")))+
  geom_text(x=7, y=-2.5, label=paste("p(Timepoint)=", z_acr$`Pr(>F)`[1]), size=4, color=ifelse(z_acr$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  geom_text(x=7, y=-3.25, label=paste("p(Site)=", z_acr$`Pr(>F)`[2]), size=4, color=ifelse(z_acr$`Pr(>F)`[2] < 0.05, "black", "darkgray")) + 
  geom_text(x=7, y=-4, label=paste("p(Timepoint x Site)=", z_acr$`Pr(>F)`[3]), size=4, color=ifelse(z_acr$`Pr(>F)`[3] < 0.05, "black", "darkgray")) + 
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         title = element_text(size=25, face="bold"), 
         axis.title = element_text(size=18));acrPCA

```

Add centroids  

```{r}
#2. add centroids 
acrPCAcen<-acrPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site_code), data=acr.centroids, size=3, show.legend=FALSE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="none"); acrPCAcen

```

Add segments

```{r}
#3. add segments
segpoints<-acr.centroids%>%
  gather(variable, value, -(timepoint:site_code)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
acrPCAfull<-acrPCAcen + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = site_code), data = segpoints, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); acrPCAfull
```

Add bi plot with loadings  
```{r}
#1. make plot with dots
acrArrows<-ggplot2::autoplot(scaled_acr_afdw, data=acr_data_afdw, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=3.5, loadings.label.vjust=0.5, loadings.label.hjust=-0.1, loadings.label.repel=TRUE, size=4, alpha=0.0) + 
  #scale_colour_manual(values=c("blue4", "darkgray", "springgreen4")) +
  #scale_fill_manual(values=c("blue4", "darkgray", "springgreen4")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_blank(),
         axis.text.y=element_blank(),
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         title = element_text(size=25, face="bold"),
         axis.title = element_blank());acrArrows
```


Asemble final figure with inset biplot.  
```{r}
#acrFullPCA<-ggdraw(acrPCAfull) + #theme_half_open(12)) +
  #draw_plot(acrArrows, .5, .5, .5, .5); acrFullPCA #x, y, w, h

#ggsave(filename="Figures/FullPCA_Acropora.pdf", plot=acrFullPCA, dpi=300, width=12, height=8, units="in")
```

##### Calculate plasticity using centroid travel calculations.  

1 - calculate sd of mean distance between all points and the centroid of all points (spread)

```{r}

#calculate mean centroid location
mean.centroid.acr <- acr.centroids%>%
  select(PC1.mean, PC2.mean)%>%
  summarise(x.mean = mean(PC1.mean), 
         y.mean = mean(PC2.mean))%>%
  summarise(x.mean = mean(x.mean), 
         y.mean = mean(y.mean))

#calculate average standard deviation of mean distance between mean centroid and location of each point using formula for distance between two points
spread.acr<-acr_data%>%
  mutate(distance=sqrt((PC1.mean-mean.centroid.acr[1])^2+(PC2.mean-mean.centroid.acr[2])^2))%>%
  summarise(distance=mean(distance$x.mean))%>% #summarize across groups
  summarise(distance=sd(distance))%>% #calculate the sd of distances
  summarise(distance=mean(distance)) #summarize across groups

#spread<-acr_data[c(12,13)]
#spread<-as.matrix(dist(spread, mean.centroid, method="euclidean"))
#spread<-mean(spread)
spread.acr$distance
```


2 - calculate distance between each time point centroids for each site (distance) 

```{r}
distance.acr<-acr.centroids%>%
  arrange(site_code)%>%
  gather(variable, value, -(timepoint:site_code)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)%>%
  group_by(site_code)%>%
  mutate(tp1.2=sqrt((timepoint1_PC1.mean-timepoint2_PC1.mean)^2+(timepoint1_PC2.mean-timepoint2_PC2.mean)^2), #calculate distance between tp1 and tp2 centroids, do for each pair of time points
         tp2.3=sqrt((timepoint2_PC1.mean-timepoint3_PC1.mean)^2+(timepoint2_PC2.mean-timepoint3_PC2.mean)^2),
         tp3.4=sqrt((timepoint3_PC1.mean-timepoint4_PC1.mean)^2+(timepoint3_PC2.mean-timepoint4_PC2.mean)^2))
```

3 - divide distance by spread, generating a plasticity ratio for each site, higher ratio = more plasticity

```{r}
plasticity.acr<-distance.acr%>%
  select(site_code, tp1.2, tp2.3, tp3.4)%>% #keep desired columns
  gather(key="comparison", value="distance_time", -site_code)%>% #gather and generate new rows to designate time comparisons
  mutate(ratio=distance_time/spread.acr$distance)
plasticity.acr
```

4 - average these ratios across sites to generate a mean plasticity ratio for time, site, and species

Display mean plasticity scores by site:  
```{r}
acr.plasticity.site<-plasticity.acr%>%
  group_by(site_code)%>%
  summarise(mean_site=mean(ratio))%>%
  mutate(species="Acropora")
acr.plasticity.site
```

Display mean plasticity scores by timepoint comparison: 
```{r}
plasticity.acr.time<-plasticity.acr%>%
  group_by(comparison)%>%
  summarise(mean_timepoint=mean(ratio))%>%
  mutate(species="Acropora")
plasticity.acr.time
```

Display mean plasticity score for the species:  
```{r}
plasticity.acr.species<-plasticity.acr%>%
  summarise(mean_species=mean(ratio))%>%
  summarise(mean_species=mean(mean_species))%>%
  mutate(species="Acropora")
plasticity.acr.species
```


#### Porites

Generate PCA using scaled (scaled_por_afdw) from dataframe (por_data_afdw).   
 
Calculate centroid locations for each site and timepoint and pull PC1 and PC2 locations.     
 
```{r}
por_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Porites")%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Chl_a=chla.ug.mgAFDW, Chl_c2=chlc2.ug.mgAFDW, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw)

por_data_afdw<-por_data_afdw[complete.cases(por_data_afdw), ]

scaled_por_afdw<-prcomp(por_data_afdw[c(5:15)], scale=TRUE, center=TRUE) 

por_info<-por_data_afdw[c(2,4)]

por_data<-scaled_por_afdw%>%
  augment(por_info)%>%
  group_by(timepoint, site_code)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

por.centroids<-por_data %>% 
  select(timepoint, site_code, PC1.mean, PC2.mean)%>%
  group_by(timepoint, site_code)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
```

```{r}
# scale data
vegan <- scale(por_data_afdw[ ,5:12])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis(vegan ~ timepoint*site_code, data = por_data_afdw, method='eu')
z_por<-permanova$aov.tab
z_por
```

Assemble plot with background points
```{r}
#1. make plot with dots
porPCA<-ggplot(por_data, aes(.fittedPC1, .fittedPC2, color=site_code)) + 
  geom_point(size = 4, alpha=0.2, show.legend=FALSE)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  ylab("PC2")+
  xlab("PC1")+
  ylim(-6,10)+
  xlim(-5,10)+
  ggtitle(expression(italic("Porites")))+
  geom_text(x=7, y=-2.5, label=paste("p(Timepoint)=", z_por$`Pr(>F)`[1]), size=4, color=ifelse(z_por$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  geom_text(x=7, y=-3.25, label=paste("p(Site)=", z_por$`Pr(>F)`[2]), size=4, color=ifelse(z_por$`Pr(>F)`[2] < 0.05, "black", "darkgray")) + 
  geom_text(x=7, y=-4, label=paste("p(Timepoint x Site)=", z_por$`Pr(>F)`[3]), size=4, color=ifelse(z_por$`Pr(>F)`[3] < 0.05, "black", "darkgray")) + 
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         legend.title = element_blank(), 
         axis.text = element_text(size=18), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         title = element_text(size=25, face="bold"),
         axis.title = element_text(size=18,  face="bold"));porPCA
```

Add centroids  

```{r}
#2. add centroids 
porPCAcen<-porPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site_code), data=por.centroids, size=3, show.legend=FALSE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position=c(1,0.3)); porPCAcen

#build a plot for the legend
legend_plot<-porPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site_code), data=por.centroids, size=3, show.legend=TRUE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="bottom")

# extract the legend from one of the plots
legend <- get_legend(
  # create some space to the left of the legend
  legend_plot + theme(legend.box.margin = margin(1,1,1,1))
)

```

Add segments

```{r}
#3. add segments
segpoints<-por.centroids%>%
  gather(variable, value, -(timepoint:site_code)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
porPCAfull<-porPCAcen + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = site_code), data = segpoints, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); porPCAfull
```

Add bi plot with loadings  
```{r}
#1. make plot with dots
porArrows<-ggplot2::autoplot(scaled_por_afdw, data=por_data_afdw, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=3.5, loadings.label.vjust=-0.1, loadings.label.hjust=0.1, loadings.label.repel=TRUE, size=4, alpha=0.0) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-0.5,0.1)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_blank(),
         axis.text.y=element_blank(),
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_blank());porArrows
```
 

Assemble final figure with inset biplot.  
```{r}
#porFullPCA<-ggdraw(porPCAfull)+ #+ theme_half_open(12)) +
  #draw_plot(porArrows, .5, .5, .5, .5); porFullPCA #x, y, w, h

#ggsave(filename="Figures/FullPCA_Porites.pdf", plot=porFullPCA, dpi=300, width=12, height=8, units="in")
```
 
##### Calculate plasticity using centroid travel calculations.  

1 - calculate mean distance between all points and the centroid of all points (spread)   

```{r}
#calculate mean centroid location
mean.centroid.por <- por.centroids%>%
  select(PC1.mean, PC2.mean)%>%
  summarise(x.mean = mean(PC1.mean), 
         y.mean = mean(PC2.mean))%>%
  summarise(x.mean = mean(x.mean), 
         y.mean = mean(y.mean))

#calculate average standard deviation of mean distance between mean centroid and location of each point using formula for distance between two points
spread.por<-por_data%>%
  mutate(distance=sqrt((PC1.mean-mean.centroid.por[1])^2+(PC2.mean-mean.centroid.por[2])^2))%>%
  summarise(distance=mean(distance$x.mean))%>% #summarize across groups
  summarise(distance=sd(distance))%>% #summarize across groups
  summarise(distance=mean(distance)) #summarize across groups

#spread<-acr_data[c(12,13)]
#spread<-as.matrix(dist(spread, mean.centroid, method="euclidean"))
#spread<-mean(spread)
spread.por
```


2 - calculate distance between each time point centroids for each site (distance) 

```{r}
distance.por<-por.centroids%>%
  arrange(site_code)%>%
  gather(variable, value, -(timepoint:site_code)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)%>%
  group_by(site_code)%>%
  mutate(tp1.2=sqrt((timepoint1_PC1.mean-timepoint2_PC1.mean)^2+(timepoint1_PC2.mean-timepoint2_PC2.mean)^2), #calculate distance between tp1 and tp2 centroids, do for each pair of time points
         tp2.3=sqrt((timepoint2_PC1.mean-timepoint3_PC1.mean)^2+(timepoint2_PC2.mean-timepoint3_PC2.mean)^2),
         tp3.4=sqrt((timepoint3_PC1.mean-timepoint4_PC1.mean)^2+(timepoint3_PC2.mean-timepoint4_PC2.mean)^2))
```

3 - divide distance by spread, generating a plasticity ratio for each site, higher ratio = more plasticity

```{r}
plasticity.por<-distance.por%>%
  select(site_code, tp1.2, tp2.3, tp3.4)%>% #keep desired columns
  gather(key="comparison", value="distance_time", -site_code)%>% #gather and generate new rows to designate time comparisons
  mutate(ratio=distance_time/spread.por$distance)
plasticity.por
```

4 - average these ratios across sites to generate a mean plasticity ratio for time, site, and species

Display mean plasticity scores by site:  
```{r}
por.plasticity.site<-plasticity.por%>%
  group_by(site_code)%>%
  summarise(mean_site=mean(ratio))%>%
  mutate(species="Porites")
por.plasticity.site
```

Display mean plasticity scores by timepoint comparison: 
```{r}
plasticity.por.time<-plasticity.por%>%
  group_by(comparison)%>%
  summarise(mean_timepoint=mean(ratio))%>%
  mutate(species="Porites")
plasticity.por.time
```

Display mean plasticity score for the species:  
```{r}
plasticity.por.species<-plasticity.por%>%
  summarise(mean_species=mean(ratio))%>%
  summarise(mean_species=mean(mean_species))%>%
  mutate(species="Porites")
plasticity.por.species
```


#### Pocillopora   

Generate PCA using scaled (scaled_poc_afdw) from dataframe (poc_data_afdw). 
 
```{r}
poc_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Pocillopora")%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Chl_a=chla.ug.mgAFDW, Chl_c2=chlc2.ug.mgAFDW, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw)

poc_data_afdw<-poc_data_afdw[complete.cases(poc_data_afdw), ]
 
scaled_poc_afdw<-prcomp(poc_data_afdw[c(5:15)], scale=TRUE, center=TRUE) 

poc_info<-poc_data_afdw[c(2,4)]

poc_data<-scaled_poc_afdw%>%
  augment(poc_info)%>%
  group_by(timepoint, site_code)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

poc.centroids<-poc_data %>% 
  select(timepoint, site_code, PC1.mean, PC2.mean)%>%
  group_by(timepoint, site_code)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
``` 
  
```{r}
# scale data
vegan <- scale(poc_data_afdw[ ,5:12])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis(vegan ~ timepoint*site_code, data = poc_data_afdw, method='eu')
z_poc<-permanova$aov.tab
z_poc
```

Assemble plot with background points
```{r}
#1. make plot with dots
pocPCA<-ggplot(poc_data, aes(.fittedPC1, .fittedPC2, color=site_code)) + 
  geom_point(size = 4, alpha=0.2, show.legend=FALSE)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  ylim(-6,10)+
  xlim(-5,10)+
  ylab("PC2")+
  xlab("PC1")+
  ggtitle(expression(italic("Pocillopora")))+
  geom_text(x=7, y=-2.5, label=paste("p(Timepoint)=", z_poc$`Pr(>F)`[1]), size=4, color=ifelse(z_poc$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  geom_text(x=7, y=-3.25, label=paste("p(Site)=", z_poc$`Pr(>F)`[2]), size=4, color=ifelse(z_poc$`Pr(>F)`[2] < 0.05, "black", "darkgray")) + 
  geom_text(x=7, y=-4, label=paste("p(Timepoint x Site)=", z_poc$`Pr(>F)`[3]), size=4, color=ifelse(z_poc$`Pr(>F)`[3] < 0.05, "black", "darkgray")) + 
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         plot.margin = margin(1, 1, 1, 1, "cm"),
         legend.title = element_blank(), 
         title = element_text(size=25, face="bold"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18,  face="bold"));pocPCA

```

Add centroids  

```{r}
#2. add centroids 
pocPCAcen<-pocPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site_code), data=poc.centroids, size=3, show.legend=FALSE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="none"); pocPCAcen

```

Add segments

```{r}
#3. add segments
segpoints<-poc.centroids%>%
  gather(variable, value, -(timepoint:site_code)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
pocPCAfull<-pocPCAcen + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = site_code), data = segpoints, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); pocPCAfull
```

Add bi plot with loadings  
```{r}

pocArrows<-ggplot2::autoplot(scaled_poc_afdw, data=poc_data_afdw, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=3.5, loadings.label.vjust=0, loadings.label.hjust=-0.1, loadings.label.repel=TRUE, size=4, alpha=0.0) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_blank(),
         axis.text.y=element_blank(),
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_blank());pocArrows
```

 
Assemble final figure with inset biplot.  
```{r}
#pocFullPCA<-ggdraw(pocPCAfull) + #theme_half_open(12)) +
  #draw_plot(pocArrows, .5, .5, .5, .5); pocFullPCA #x, y, w, h

#ggsave(filename="Figures/FullPCA_Pocillopora.pdf", plot=pocFullPCA, dpi=300, width=12, height=8, units="in")
```
 
Assemble all plots.  

```{r}
PCA_full_panel<-plot_grid(acrPCAfull, pocPCAfull, porPCAfull, labels = c("", "", ""), ncol=3, nrow=1, rel_heights= c(1,1,1), rel_widths = c(1,1,1), label_size = 20, label_y=1, align="vh")

# add the legend to the row we made earlier. Give it one-third of 
# the width of one plot (via rel_widths).
PCA_full_panel_legend<-plot_grid(PCA_full_panel, legend, rel_heights = c(4, .2), ncol=1, nrow=2)

ggsave(filename="Figures/Full_Panel_PCAs.png", plot=PCA_full_panel_legend, dpi=500, width=20, height=6, units="in")
```  

##### Calculate plasticity using centroid travel calculations.  

1 - calculate mean distance between all points and the centroid of all points (spread)

```{r}
#calculate mean centroid location
mean.centroid.poc <- poc.centroids%>%
  select(PC1.mean, PC2.mean)%>%
  summarise(x.mean = mean(PC1.mean), 
         y.mean = mean(PC2.mean))%>%
  summarise(x.mean = mean(x.mean), 
         y.mean = mean(y.mean))

#calculate average distance between mean centroid and location of each point using formula for distance between two points
spread.poc<-poc_data%>%
  mutate(distance=sqrt((PC1.mean-mean.centroid.poc[1])^2+(PC2.mean-mean.centroid.poc[2])^2))%>%
  summarise(distance=mean(distance$x.mean))%>% #summarize across groups
  summarise(distance=sd(distance))%>% #summarize across groups
  summarise(distance=mean(distance)) #summarize across groups

#spread<-acr_data[c(12,13)]
#spread<-as.matrix(dist(spread, mean.centroid, method="euclidean"))
#spread<-mean(spread)
spread.poc
```

 
2 - calculate distance between each time point centroids for each site (distance) 

```{r}
distance.poc<-poc.centroids%>%
  arrange(site_code)%>%
  gather(variable, value, -(timepoint:site_code)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)%>%
  group_by(site_code)%>%
  mutate(tp1.2=sqrt((timepoint1_PC1.mean-timepoint2_PC1.mean)^2+(timepoint1_PC2.mean-timepoint2_PC2.mean)^2), #calculate distance between tp1 and tp2 centroids, do for each pair of time points
         tp2.3=sqrt((timepoint2_PC1.mean-timepoint3_PC1.mean)^2+(timepoint2_PC2.mean-timepoint3_PC2.mean)^2),
         tp3.4=sqrt((timepoint3_PC1.mean-timepoint4_PC1.mean)^2+(timepoint3_PC2.mean-timepoint4_PC2.mean)^2))
```

3 - divide distance by spread, generating a plasticity ratio for each site, higher ratio = more plasticity

```{r}
plasticity.poc<-distance.poc%>%
  select(site_code, tp1.2, tp2.3, tp3.4)%>% #keep desired columns
  gather(key="comparison", value="distance_time", -site_code)%>% #gather and generate new rows to designate time comparisons
  mutate(ratio=distance_time/spread.poc$distance)
plasticity.poc
```

4 - average these ratios across sites to generate a mean plasticity ratio for time, site, and species

Display mean plasticity scores by site:  
```{r}
poc.plasticity.site<-plasticity.poc%>%
  group_by(site_code)%>%
  summarise(mean_site=mean(ratio))%>%
  mutate(species="Pocillopora")
poc.plasticity.site
```

Display mean plasticity scores by timepoint comparison: 
```{r}
plasticity.poc.time<-plasticity.poc%>%
  group_by(comparison)%>%
  summarise(mean_timepoint=mean(ratio))%>%
  mutate(species="Pocillopora")
plasticity.poc.time
```

Display mean plasticity score for the species:  
```{r}
plasticity.poc.species<-plasticity.poc%>%
  summarise(mean_species=mean(ratio))%>%
  summarise(mean_species=mean(mean_species))%>%
  mutate(species="Pocillopora")
plasticity.poc.species
```
 
### Examine plasticity scores generated from PCA's
    
Generate plasticity dataframe from calculations for each species.   
```{r}
plasticity.site<-bind_rows(acr.plasticity.site, poc.plasticity.site, por.plasticity.site);plasticity.site

plasticity.time<-bind_rows(plasticity.acr.time, plasticity.poc.time, plasticity.por.time);plasticity.time
  
plasticity.species<-bind_rows(plasticity.acr.species, plasticity.poc.species, plasticity.por.species);plasticity.species
```

Plot plasticity scores for site values.    

```{r}
plasticity_site<-plasticity.site%>%
                group_by(site_code)%>%
                summarise(mean=mean(mean_site))%>%

  ggplot(., aes(x = site_code, y = mean, fill = site_code, group=interaction(site_code))) +
    geom_point(pch = 21, size=5, position = position_jitterdodge(0)) + 
    scale_fill_manual(values = c("#374d7c", "#00cccc", "#ff6633"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    #facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold("Plasticity (Distance / Spread)")))+
    theme_classic() + 
    ylim(0,5)+
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=12),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); plasticity_site
```

Plot plasticity scores for timepoint values.    
```{r}
plasticity_time<-plasticity.time%>%
                group_by(comparison)%>%
                summarise(mean=mean(mean_timepoint))%>%
  
  ggplot(., aes(x = comparison, y = mean, group=interaction(comparison))) +
    geom_point(pch = 21, size=5, fill="gray") + 
    #scale_fill_manual(values = c("#374d7c", "#00cccc", "#ff6633"))+
    scale_x_discrete(labels=c("tp1.2" = "Jan-March", "tp2.3" = "March-Sept", "tp3.4" = "Sept-Nov"))+
    #facet_wrap(~species) +
    xlab("Timepoint") + 
    ylab(expression(bold("Plasticity (Distance / Spread)")))+
    theme_classic() + 
    ylim(0,5)+
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=12),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); plasticity_time
```

Plot plasticity scores for species values.    

```{r}
plasticity_species<-ggplot(plasticity.species, aes(x = species, y = mean_species, fill=species, group=interaction(species))) +
    geom_point(pch = 21, size=5, position = position_jitterdodge(0)) + 
    scale_fill_manual(values = c("darkgray", "orange", "purple"))+
    #scale_x_discrete(labels=c("tp1.2" = "Jan-March", "tp2.3" = "March-Sept", "tp3.4" = "Sept-Nov"))+
    #facet_wrap(~species) +
    xlab("Species") + 
    ylab(expression(bold("Plasticity (Distance / Spread)")))+
    theme_classic() + 
    ylim(0,5)+
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=12),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); plasticity_species
```

Assemble full plasticity figure.  

```{r}
plasticity_full_panel<-plot_grid(plasticity_species, plasticity_site, plasticity_time, labels = c("", "", ""), ncol=3, nrow=1, rel_heights= c(1,1,1), rel_widths = c(1,1,1), label_size = 20, label_y=1, align="vh")

ggsave(filename="Figures/Plasticity_Panel.png", plot=plasticity_full_panel, dpi=500, width=10, height=4, units="in")
```  

Generate plots for within species.  

Plot plasticity scores for site values.     

```{r}
plasticity_site2<-ggplot(plasticity.site, aes(x = site_code, y = mean_site, fill = site_code, group=interaction(site_code))) +
    geom_point(pch = 21, size=5, position = position_jitterdodge(0)) + 
    scale_fill_manual(values = c("#374d7c", "#00cccc", "#ff6633"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold("Plasticity (Distance / Spread)")))+
    theme_classic() + 
    ylim(0,5)+
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=12),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); plasticity_site2
```

Plot plasticity scores for timepoint values.    
```{r}
plasticity_time2<-ggplot(plasticity.time, aes(x = comparison, y = mean_timepoint, group=interaction(comparison))) +
    geom_point(pch = 21, size=5, fill="gray") + 
    #scale_fill_manual(values = c("#374d7c", "#00cccc", "#ff6633"))+
    scale_x_discrete(labels=c("tp1.2" = "Jan-March", "tp2.3" = "March-Sept", "tp3.4" = "Sept-Nov"))+
    facet_wrap(~species) +
    xlab("Timepoint") + 
    ylab(expression(bold("Plasticity (Distance / Spread)")))+
    theme_classic() + 
    ylim(0,5)+
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=12),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); plasticity_time2
```


Assemble full plasticity figure.  

```{r}
plasticity_full_panel2<-plot_grid(plasticity_species, plasticity_site2, plasticity_time2, labels = c("", "", ""), ncol=3, nrow=1, rel_heights= c(0.5,1,1), rel_widths = c(0.5,1,1), label_size = 20, label_y=1, align="vh")

ggsave(filename="Figures/Plasticity_Panel_species_detail.png", plot=plasticity_full_panel2, dpi=500, width=20, height=4, units="in")
```  

### Matrix of PCA's by species and time  

Generate biplot showing groupings by site for each species and time point.  ADD PERMANOVA TO ALL PLOTS 


#### Pocillopora  

```{r}
poc_tp1_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Pocillopora")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Chl_a=chla.ug.mgAFDW, Chl_c2=chlc2.ug.mgAFDW, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint1")

poc_tp1_data<-poc_tp1_data[complete.cases(poc_tp1_data), ]
 
poc_tp1_scaled<-prcomp(poc_tp1_data[c(5:15)], scale=TRUE, center=TRUE) 

pocTP1<-ggplot2::autoplot(poc_tp1_scaled, data=poc_tp1_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0, loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("January 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  annotate("text", x=-16, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 2, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP1
```

```{r}
poc_tp2_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(chla.ug.mgAFDW<2.2)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Pocillopora")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Chl_a=chla.ug.mgAFDW, Chl_c2=chlc2.ug.mgAFDW, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint2")
 
poc_tp2_data<-poc_tp2_data[complete.cases(poc_tp2_data), ]
 
poc_tp2_scaled<-prcomp(poc_tp2_data[c(5:15)], scale=TRUE, center=TRUE) 

pocTP2<-ggplot2::autoplot(poc_tp2_scaled, data=poc_tp2_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("March 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP2
```

```{r}
poc_tp3_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  #filter(chla.ug.mgAFDW<2.2)%>%
  filter(species=="Pocillopora")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Chl_a=chla.ug.mgAFDW, Chl_c2=chlc2.ug.mgAFDW, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint3")
 
poc_tp3_data<-poc_tp3_data[complete.cases(poc_tp3_data), ]
 
poc_tp3_scaled<-prcomp(poc_tp3_data[c(5:15)], scale=TRUE, center=TRUE) 

pocTP3<-ggplot2::autoplot(poc_tp3_scaled, data=poc_tp3_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("September 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP3
```

```{r}
poc_tp4_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  #filter(chla.ug.mgAFDW<2.2)%>%
  filter(species=="Pocillopora")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Chl_a=chla.ug.mgAFDW, Chl_c2=chlc2.ug.mgAFDW, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint4")
 
poc_tp4_data<-poc_tp4_data[complete.cases(poc_tp4_data), ]
 
poc_tp4_scaled<-prcomp(poc_tp4_data[c(5:15)], scale=TRUE, center=TRUE) 

pocTP4<-ggplot2::autoplot(poc_tp4_scaled, data=poc_tp4_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("November 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP4
```








#### Acropora  

```{r}
acr_tp1_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Acropora")%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Chl_a=chla.ug.mgAFDW, Chl_c2=chlc2.ug.mgAFDW, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint1")

acr_tp1_data<-acr_tp1_data[complete.cases(acr_tp1_data), ]
 
acr_tp1_scaled<-prcomp(acr_tp1_data[c(5:15)], scale=TRUE, center=TRUE) 

acrTP1<-ggplot2::autoplot(acr_tp1_scaled, data=acr_tp1_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0, loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("January 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  annotate("text", x=-16, y=0, label="italic(Acropora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 2, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP1
```

```{r}
acr_tp2_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  #filter(chla.ug.mgAFDW<2.2)%>%
  filter(species=="Acropora")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Chl_a=chla.ug.mgAFDW, Chl_c2=chlc2.ug.mgAFDW, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint2")
 
acr_tp2_data<-acr_tp2_data[complete.cases(acr_tp2_data), ]
 
acr_tp2_scaled<-prcomp(acr_tp2_data[c(5:15)], scale=TRUE, center=TRUE) 

acrTP2<-ggplot2::autoplot(acr_tp2_scaled, data=acr_tp2_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("March 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP2
```

```{r}
acr_tp3_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  #filter(chla.ug.mgAFDW<2.2)%>%
  filter(species=="Acropora")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Chl_a=chla.ug.mgAFDW, Chl_c2=chlc2.ug.mgAFDW, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint3")
 
acr_tp3_data<-acr_tp3_data[complete.cases(acr_tp3_data), ]
 
acr_tp3_scaled<-prcomp(acr_tp3_data[c(5:15)], scale=TRUE, center=TRUE) 

acrTP3<-ggplot2::autoplot(acr_tp3_scaled, data=acr_tp3_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("September 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP3
```

```{r}
acr_tp4_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  #filter(chla.ug.mgAFDW<2.2)%>%
  filter(species=="Acropora")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Chl_a=chla.ug.mgAFDW, Chl_c2=chlc2.ug.mgAFDW, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint4")
 
acr_tp4_data<-acr_tp4_data[complete.cases(acr_tp4_data), ]
 
acr_tp4_scaled<-prcomp(acr_tp4_data[c(5:15)], scale=TRUE, center=TRUE) 

acrTP4<-ggplot2::autoplot(acr_tp4_scaled, data=acr_tp4_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("November 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP4
```








#### Porites  

```{r}
por_tp1_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Porites")%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Chl_a=chla.ug.mgAFDW, Chl_c2=chlc2.ug.mgAFDW, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint1")

por_tp1_data<-por_tp1_data[complete.cases(por_tp1_data), ]
 
por_tp1_scaled<-prcomp(por_tp1_data[c(5:15)], scale=TRUE, center=TRUE) 

porTP1<-ggplot2::autoplot(por_tp1_scaled, data=por_tp1_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0, loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("January 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  annotate("text", x=-16, y=0, label="italic(Porites)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 2, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP1
```

```{r}
por_tp2_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  #filter(chla.ug.mgAFDW<2.2)%>%
  filter(species=="Porites")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Chl_a=chla.ug.mgAFDW, Chl_c2=chlc2.ug.mgAFDW, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint2")
 
por_tp2_data<-por_tp2_data[complete.cases(por_tp2_data), ]
 
por_tp2_scaled<-prcomp(por_tp2_data[c(5:15)], scale=TRUE, center=TRUE) 

porTP2<-ggplot2::autoplot(por_tp2_scaled, data=por_tp2_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("March 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP2
```

```{r}
por_tp3_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(chla.ug.mgAFDW<2.2)%>%
  filter(species=="Porites")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Chl_a=chla.ug.mgAFDW, Chl_c2=chlc2.ug.mgAFDW, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint3")
 
por_tp3_data<-por_tp3_data[complete.cases(por_tp3_data), ]
 
por_tp3_scaled<-prcomp(por_tp3_data[c(5:15)], scale=TRUE, center=TRUE) 

porTP3<-ggplot2::autoplot(por_tp3_scaled, data=por_tp3_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("September 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP3
```

```{r}
por_tp4_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  #filter(chla.ug.mgAFDW<2.2)%>%
  filter(species=="Porites")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Chl_a=chla.ug.mgAFDW, Chl_c2=chlc2.ug.mgAFDW, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint4")
 
por_tp4_data<-por_tp4_data[complete.cases(por_tp4_data), ]
 
por_tp4_scaled<-prcomp(por_tp4_data[c(5:15)], scale=TRUE, center=TRUE) 

porTP4<-ggplot2::autoplot(por_tp4_scaled, data=por_tp4_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
 # ggtitle("November 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP4
```

#### Assemble grid plot of all metrics by species and time  

```{r}
all_grid<-plot_grid(acrTP1, acrTP2, acrTP3, acrTP4, pocTP1, pocTP2, pocTP3, pocTP4, porTP1, porTP2, porTP3, porTP4, ncol=4, nrow=3)
all_grid2<-plot_grid(all_grid, legend, rel_heights = c(4, .2), ncol=1, nrow=2)

ggsave(filename="Figures/Matrix_AllResponses.pdf", plot=all_grid2, dpi=500, width=20, height=20, units="in")

```







## Host Responses  

### PCA's for centroid and trajectories  
 
#### Acropora  

Generate PCA using scaled (scaled_acr_afdw) from dataframe (acr_data_afdw).   
 
```{r}
acr_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Acropora")%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(prot_mg.mgafdw<1.5) %>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw, Respiration=Rd)

acr_data_afdw<-acr_data_afdw[complete.cases(acr_data_afdw), ]

scaled_acr_afdw<-prcomp(acr_data_afdw[c(5:8)], scale=TRUE, center=TRUE) 

acr_info<-acr_data_afdw[c(2,4)]

acr_data<-scaled_acr_afdw%>%
  augment(acr_info)%>%
  group_by(timepoint, site_code)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

acr.centroids<-acr_data %>% 
  select(timepoint, site_code, PC1.mean, PC2.mean)%>%
  group_by(timepoint, site_code)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
```

Examine PERMANOVA results.  
 
```{r}
# scale data
vegan <- scale(acr_data_afdw[ ,5:8])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis(vegan ~ timepoint*site_code, data = acr_data_afdw, method='eu')
z_acr<-permanova$aov.tab
z_acr
``` 
 
Assemble plot with background points
```{r}
#1. make plot with dots
acrPCA<-ggplot(acr_data, aes(.fittedPC1, .fittedPC2, color=site_code)) + 
  geom_point(size = 4, alpha=0.2, show.legend=FALSE)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  ylim(-5,5)+
  xlim(-5,5)+
  ylab("PC2")+
  xlab("PC1")+
  ggtitle(expression(italic("Acropora")))+
  #geom_text(x=7, y=-2.5, label=paste("p(Timepoint)=", z_acr$`Pr(>F)`[1]), size=4, color=ifelse(z_acr$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  #geom_text(x=7, y=-3.25, label=paste("p(Site)=", z_acr$`Pr(>F)`[2]), size=4, color=ifelse(z_acr$`Pr(>F)`[2] < 0.05, "black", "darkgray")) + 
  #geom_text(x=7, y=-4, label=paste("p(Timepoint x Site)=", z_acr$`Pr(>F)`[3]), size=4, color=ifelse(z_acr$`Pr(>F)`[3] < 0.05, "black", "darkgray")) + 
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         title = element_text(size=25, face="bold"), 
         axis.title = element_text(size=18));acrPCA

```

Add centroids  

```{r}
#2. add centroids 
acrPCAcen<-acrPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site_code), data=acr.centroids, size=3, show.legend=FALSE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="none"); acrPCAcen

```

Add segments

```{r}
#3. add segments
segpoints<-acr.centroids%>%
  gather(variable, value, -(timepoint:site_code)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
acrPCAfull<-acrPCAcen + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = site_code), data = segpoints, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); acrPCAfull
```

Add bi plot with loadings  
```{r}
#1. make plot with dots
acrArrows<-ggplot2::autoplot(scaled_acr_afdw, data=acr_data_afdw, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=3.5, loadings.label.vjust=0.5, loadings.label.hjust=-0.1, loadings.label.repel=TRUE, size=4, alpha=0.0) + 
  #scale_colour_manual(values=c("blue4", "darkgray", "springgreen4")) +
  #scale_fill_manual(values=c("blue4", "darkgray", "springgreen4")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_blank(),
         axis.text.y=element_blank(),
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         title = element_text(size=25, face="bold"),
         axis.title = element_blank());acrArrows
```


Asemble final figure with inset biplot.  
```{r}
#acrFullPCA<-ggdraw(acrPCAfull) + #theme_half_open(12)) +
  #draw_plot(acrArrows, .5, .5, .5, .5); acrFullPCA #x, y, w, h

#ggsave(filename="Figures/FullPCA_Acropora.pdf", plot=acrFullPCA, dpi=300, width=12, height=8, units="in")
```

#### Porites

Generate PCA using scaled (scaled_por_afdw) from dataframe (por_data_afdw).   
 
Calculate centroid locations for each site and timepoint and pull PC1 and PC2 locations.      
```{r}
por_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Porites")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Respiration=Rd, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw)

por_data_afdw<-por_data_afdw[complete.cases(por_data_afdw), ]

scaled_por_afdw<-prcomp(por_data_afdw[c(5:8)], scale=TRUE, center=TRUE) 

por_info<-por_data_afdw[c(2,4)]

por_data<-scaled_por_afdw%>%
  augment(por_info)%>%
  group_by(timepoint, site_code)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

por.centroids<-por_data %>% 
  select(timepoint, site_code, PC1.mean, PC2.mean)%>%
  group_by(timepoint, site_code)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
```

```{r}
# scale data
vegan <- scale(por_data_afdw[ ,5:8])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis(vegan ~ timepoint*site_code, data = por_data_afdw, method='eu')
z_por<-permanova$aov.tab
z_por
```

Assemble plot with background points
```{r}
#1. make plot with dots
porPCA<-ggplot(por_data, aes(.fittedPC1, .fittedPC2, color=site_code)) + 
  geom_point(size = 4, alpha=0.2, show.legend=FALSE)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  ylab("PC2")+
  xlab("PC1")+
  ylim(-5,5)+
  xlim(-5,5)+
  ggtitle(expression(italic("Porites")))+
  #geom_text(x=7, y=-2.5, label=paste("p(Timepoint)=", z_por$`Pr(>F)`[1]), size=4, color=ifelse(z_por$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  #geom_text(x=7, y=-3.25, label=paste("p(Site)=", z_por$`Pr(>F)`[2]), size=4, color=ifelse(z_por$`Pr(>F)`[2] < 0.05, "black", "darkgray")) + 
  #geom_text(x=7, y=-4, label=paste("p(Timepoint x Site)=", z_por$`Pr(>F)`[3]), size=4, color=ifelse(z_por$`Pr(>F)`[3] < 0.05, "black", "darkgray")) + 
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         legend.title = element_blank(), 
         axis.text = element_text(size=18), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         title = element_text(size=25, face="bold"),
         axis.title = element_text(size=18,  face="bold"));porPCA
```

Add centroids  

```{r}
#2. add centroids 
porPCAcen<-porPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site_code), data=por.centroids, size=3, show.legend=FALSE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position=c(1,0.3)); porPCAcen

#build a plot for the legend
legend_plot<-porPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site_code), data=por.centroids, size=3, show.legend=TRUE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="bottom")

# extract the legend from one of the plots
legend <- get_legend(
  # create some space to the left of the legend
  legend_plot + theme(legend.box.margin = margin(1,1,1,1))
)

```

Add segments

```{r}
#3. add segments
segpoints<-por.centroids%>%
  gather(variable, value, -(timepoint:site_code)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
porPCAfull<-porPCAcen + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = site_code), data = segpoints, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); porPCAfull
```

Add bi plot with loadings  
```{r}
#1. make plot with dots
porArrows<-ggplot2::autoplot(scaled_por_afdw, data=por_data_afdw, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=3.5, loadings.label.vjust=-0.1, loadings.label.hjust=0.1, loadings.label.repel=TRUE, size=4, alpha=0.0) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-0.5,0.1)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_blank(),
         axis.text.y=element_blank(),
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_blank());porArrows
```
 

Assemble final figure with inset biplot.  
```{r}
#porFullPCA<-ggdraw(porPCAfull)+ #+ theme_half_open(12)) +
  #draw_plot(porArrows, .5, .5, .5, .5); porFullPCA #x, y, w, h

#ggsave(filename="Figures/FullPCA_Porites.pdf", plot=porFullPCA, dpi=300, width=12, height=8, units="in")
```
 
#### Pocillopora   

Generate PCA using scaled (scaled_poc_afdw) from dataframe (poc_data_afdw). 
 
```{r}
poc_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Pocillopora")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Respiration=Rd, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw)

poc_data_afdw<-poc_data_afdw[complete.cases(poc_data_afdw), ]
 
scaled_poc_afdw<-prcomp(poc_data_afdw[c(5:8)], scale=TRUE, center=TRUE) 

poc_info<-poc_data_afdw[c(2,4)]

poc_data<-scaled_poc_afdw%>%
  augment(poc_info)%>%
  group_by(timepoint, site_code)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

poc.centroids<-poc_data %>% 
  select(timepoint, site_code, PC1.mean, PC2.mean)%>%
  group_by(timepoint, site_code)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
``` 
  
```{r}
# scale data
vegan <- scale(poc_data_afdw[ ,5:8])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis(vegan ~ timepoint*site_code, data = poc_data_afdw, method='eu')
z_poc<-permanova$aov.tab
z_poc
```

Assemble plot with background points
```{r}
#1. make plot with dots
pocPCA<-ggplot(poc_data, aes(.fittedPC1, .fittedPC2, color=site_code)) + 
  geom_point(size = 4, alpha=0.2, show.legend=FALSE)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  ylim(-5,5)+
  xlim(-5,5)+
  ylab("PC2")+
  xlab("PC1")+
  ggtitle(expression(italic("Pocillopora")))+
  #geom_text(x=7, y=-2.5, label=paste("p(Timepoint)=", z_poc$`Pr(>F)`[1]), size=4, color=ifelse(z_poc$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  #geom_text(x=7, y=-3.25, label=paste("p(Site)=", z_poc$`Pr(>F)`[2]), size=4, color=ifelse(z_poc$`Pr(>F)`[2] < 0.05, "black", "darkgray")) + 
  #geom_text(x=7, y=-4, label=paste("p(Timepoint x Site)=", z_poc$`Pr(>F)`[3]), size=4, color=ifelse(z_poc$`Pr(>F)`[3] < 0.05, "black", "darkgray")) + 
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         plot.margin = margin(1, 1, 1, 1, "cm"),
         legend.title = element_blank(), 
         title = element_text(size=25, face="bold"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18,  face="bold"));pocPCA

```

Add centroids  

```{r}
#2. add centroids 
pocPCAcen<-pocPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site_code), data=poc.centroids, size=3, show.legend=FALSE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="none"); pocPCAcen

```

Add segments

```{r}
#3. add segments
segpoints<-poc.centroids%>%
  gather(variable, value, -(timepoint:site_code)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
pocPCAfull<-pocPCAcen + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = site_code), data = segpoints, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); pocPCAfull
```

Add bi plot with loadings  
```{r}

pocArrows<-ggplot2::autoplot(scaled_poc_afdw, data=poc_data_afdw, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=3.5, loadings.label.vjust=0, loadings.label.hjust=-0.1, loadings.label.repel=TRUE, size=4, alpha=0.0) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_blank(),
         axis.text.y=element_blank(),
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_blank());pocArrows
```

 
Assemble final figure with inset biplot.  
```{r}
#pocFullPCA<-ggdraw(pocPCAfull) + #theme_half_open(12)) +
  #draw_plot(pocArrows, .5, .5, .5, .5); pocFullPCA #x, y, w, h

#ggsave(filename="Figures/FullPCA_Pocillopora.pdf", plot=pocFullPCA, dpi=300, width=12, height=8, units="in")
```
 
Assemble all plots.  

```{r}
PCA_full_panel<-plot_grid(acrPCAfull, pocPCAfull, porPCAfull, labels = c("", "", ""), ncol=3, nrow=1, rel_heights= c(1,1,1), rel_widths = c(1,1,1), label_size = 20, label_y=1, align="vh")

# add the legend to the row we made earlier. Give it one-third of 
# the width of one plot (via rel_widths).
PCA_full_panel_legend<-plot_grid(PCA_full_panel, legend, rel_heights = c(4, .2), ncol=1, nrow=2)

ggsave(filename="Figures/Full_Panel_PCAs_Holobiont.png", plot=PCA_full_panel_legend, dpi=500, width=20, height=6, units="in")
```  




  
  
### Matrix of PCA's by species and time  

Generate biplot showing groupings by site for each species and time point.  

#### Pocillopora  

```{r}
poc_tp1_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Pocillopora")%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint1")

poc_tp1_data<-poc_tp1_data[complete.cases(poc_tp1_data), ]
 
poc_tp1_scaled<-prcomp(poc_tp1_data[c(5:8)], scale=TRUE, center=TRUE) 

pocTP1<-ggplot2::autoplot(poc_tp1_scaled, data=poc_tp1_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0, loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("January 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  annotate("text", x=-16, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 2, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP1
```

```{r}
poc_tp2_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Pocillopora")%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint2")
 
poc_tp2_data<-poc_tp2_data[complete.cases(poc_tp2_data), ]
 
poc_tp2_scaled<-prcomp(poc_tp2_data[c(5:8)], scale=TRUE, center=TRUE) 

pocTP2<-ggplot2::autoplot(poc_tp2_scaled, data=poc_tp2_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("March 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP2
```

```{r}
poc_tp3_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Pocillopora")%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint3")
 
poc_tp3_data<-poc_tp3_data[complete.cases(poc_tp3_data), ]
 
poc_tp3_scaled<-prcomp(poc_tp3_data[c(5:8)], scale=TRUE, center=TRUE) 

pocTP3<-ggplot2::autoplot(poc_tp3_scaled, data=poc_tp3_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("September 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP3
```

```{r}
poc_tp4_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Pocillopora")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint4")
 
poc_tp4_data<-poc_tp4_data[complete.cases(poc_tp4_data), ]
 
poc_tp4_scaled<-prcomp(poc_tp4_data[c(5:8)], scale=TRUE, center=TRUE) 

pocTP4<-ggplot2::autoplot(poc_tp4_scaled, data=poc_tp4_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("November 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP4
```


#### Acropora  

```{r}
acr_tp1_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Acropora")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint1")

acr_tp1_data<-acr_tp1_data[complete.cases(acr_tp1_data), ]
 
acr_tp1_scaled<-prcomp(acr_tp1_data[c(5:8)], scale=TRUE, center=TRUE) 

acrTP1<-ggplot2::autoplot(acr_tp1_scaled, data=acr_tp1_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0, loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("January 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  annotate("text", x=-16, y=0, label="italic(Acropora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 2, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP1
```

```{r}
acr_tp2_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Acropora")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint2")
 
acr_tp2_data<-acr_tp2_data[complete.cases(acr_tp2_data), ]
 
acr_tp2_scaled<-prcomp(acr_tp2_data[c(5:8)], scale=TRUE, center=TRUE) 

acrTP2<-ggplot2::autoplot(acr_tp2_scaled, data=acr_tp2_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("March 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP2
```

```{r}
acr_tp3_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Acropora")%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint3")
 
acr_tp3_data<-acr_tp3_data[complete.cases(acr_tp3_data), ]
 
acr_tp3_scaled<-prcomp(acr_tp3_data[c(5:8)], scale=TRUE, center=TRUE) 

acrTP3<-ggplot2::autoplot(acr_tp3_scaled, data=acr_tp3_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("September 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP3
```

```{r}
acr_tp4_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Acropora")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint4")
 
acr_tp4_data<-acr_tp4_data[complete.cases(acr_tp4_data), ]
 
acr_tp4_scaled<-prcomp(acr_tp4_data[c(5:8)], scale=TRUE, center=TRUE) 

acrTP4<-ggplot2::autoplot(acr_tp4_scaled, data=acr_tp4_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("November 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP4
```



#### Porites  

```{r}
por_tp1_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Porites")%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint1")

por_tp1_data<-por_tp1_data[complete.cases(por_tp1_data), ]
 
por_tp1_scaled<-prcomp(por_tp1_data[c(5:8)], scale=TRUE, center=TRUE) 

porTP1<-ggplot2::autoplot(por_tp1_scaled, data=por_tp1_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0, loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("January 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  annotate("text", x=-16, y=0, label="italic(Porites)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 2, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP1
```

```{r}
por_tp2_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Porites")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint2")
 
por_tp2_data<-por_tp2_data[complete.cases(por_tp2_data), ]
 
por_tp2_scaled<-prcomp(por_tp2_data[c(5:8)], scale=TRUE, center=TRUE) 

porTP2<-ggplot2::autoplot(por_tp2_scaled, data=por_tp2_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("March 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP2
```

```{r}
por_tp3_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Porites")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint3")
 
por_tp3_data<-por_tp3_data[complete.cases(por_tp3_data), ]
 
por_tp3_scaled<-prcomp(por_tp3_data[c(5:8)], scale=TRUE, center=TRUE) 

porTP3<-ggplot2::autoplot(por_tp3_scaled, data=por_tp3_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("September 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP3
```

```{r}
por_tp4_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Porites")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint4")
 
por_tp4_data<-por_tp4_data[complete.cases(por_tp4_data), ]
 
por_tp4_scaled<-prcomp(por_tp4_data[c(5:8)], scale=TRUE, center=TRUE) 

porTP4<-ggplot2::autoplot(por_tp4_scaled, data=por_tp4_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
 # ggtitle("November 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP4
```

#### Assemble grid plot of all metrics by species and time  
 
```{r}
all_grid<-plot_grid(acrTP1, acrTP2, acrTP3, acrTP4, pocTP1, pocTP2, pocTP3, pocTP4, porTP1, porTP2, porTP3, porTP4, ncol=4, nrow=3)
all_grid2<-plot_grid(all_grid, legend, rel_heights = c(4, .2), ncol=1, nrow=2)

ggsave(filename="Figures/Matrix_Host_Responses.pdf", plot=all_grid2, dpi=500, width=20, height=20, units="in")

```
 

## Symbiont Responses  

### PCA's for centroid and trajectories  

#### Acropora  

Generate PCA using scaled (scaled_acr_afdw) from dataframe (acr_data_afdw).   
  
```{r}
acr_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Total_Chl<13)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Acropora")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell, SH_Ratio=Ratio_AFDW.mg.cm2)

acr_data_afdw<-acr_data_afdw[complete.cases(acr_data_afdw), ]

scaled_acr_afdw<-prcomp(acr_data_afdw[c(5:11)], scale=TRUE, center=TRUE) 

acr_info<-acr_data_afdw[c(2,4)]

acr_data<-scaled_acr_afdw%>%
  augment(acr_info)%>%
  group_by(timepoint, site_code)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

acr.centroids<-acr_data %>% 
  select(timepoint, site_code, PC1.mean, PC2.mean)%>%
  group_by(timepoint, site_code)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
```

Examine PERMANOVA results.  
 
```{r}
# scale data
vegan <- scale(acr_data_afdw[ ,5:11])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis(vegan ~ timepoint*site_code, data = acr_data_afdw, method='eu')
z_acr<-permanova$aov.tab
z_acr
``` 
 
Assemble plot with background points
```{r}
#1. make plot with dots
acrPCA<-ggplot(acr_data, aes(.fittedPC1, .fittedPC2, color=site_code)) + 
  geom_point(size = 4, alpha=0.2, show.legend=FALSE)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  ylim(-5,6)+
  xlim(-5,6)+
  ylab("PC2")+
  xlab("PC1")+
  ggtitle(expression(italic("Acropora")))+
  #geom_text(x=7, y=-2.5, label=paste("p(Timepoint)=", z_acr$`Pr(>F)`[1]), size=4, color=ifelse(z_acr$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  #geom_text(x=7, y=-3.25, label=paste("p(Site)=", z_acr$`Pr(>F)`[2]), size=4, color=ifelse(z_acr$`Pr(>F)`[2] < 0.05, "black", "darkgray")) + 
  #geom_text(x=7, y=-4, label=paste("p(Timepoint x Site)=", z_acr$`Pr(>F)`[3]), size=4, color=ifelse(z_acr$`Pr(>F)`[3] < 0.05, "black", "darkgray")) + 
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         title = element_text(size=25, face="bold"), 
         axis.title = element_text(size=18));acrPCA

```

Add centroids  

```{r}
#2. add centroids 
acrPCAcen<-acrPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site_code), data=acr.centroids, size=3, show.legend=FALSE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="none"); acrPCAcen

```

Add segments

```{r}
#3. add segments
segpoints<-acr.centroids%>%
  gather(variable, value, -(timepoint:site_code)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
acrPCAfull<-acrPCAcen + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = site_code), data = segpoints, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); acrPCAfull
```

Add bi plot with loadings  
```{r}
#1. make plot with dots
acrArrows<-ggplot2::autoplot(scaled_acr_afdw, data=acr_data_afdw, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=3.5, loadings.label.vjust=0.5, loadings.label.hjust=-0.1, loadings.label.repel=TRUE, size=4, alpha=0.0) + 
  #scale_colour_manual(values=c("blue4", "darkgray", "springgreen4")) +
  #scale_fill_manual(values=c("blue4", "darkgray", "springgreen4")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_blank(),
         axis.text.y=element_blank(),
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         title = element_text(size=25, face="bold"),
         axis.title = element_blank());acrArrows
```


Asemble final figure with inset biplot.  
```{r}
#acrFullPCA<-ggdraw(acrPCAfull) + #theme_half_open(12)) +
  #draw_plot(acrArrows, .5, .5, .5, .5); acrFullPCA #x, y, w, h

#ggsave(filename="Figures/FullPCA_Acropora.pdf", plot=acrFullPCA, dpi=300, width=12, height=8, units="in")
```

#### Porites

Generate PCA using scaled (scaled_por_afdw) from dataframe (por_data_afdw).   
 
Calculate centroid locations for each site and timepoint and pull PC1 and PC2 locations.      
 
```{r}
por_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Total_Chl<13)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Porites")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell, SH_Ratio=Ratio_AFDW.mg.cm2)

por_data_afdw<-por_data_afdw[complete.cases(por_data_afdw), ]

scaled_por_afdw<-prcomp(por_data_afdw[c(5:11)], scale=TRUE, center=TRUE) 

por_info<-por_data_afdw[c(2,4)]

por_data<-scaled_por_afdw%>%
  augment(por_info)%>%
  group_by(timepoint, site_code)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

por.centroids<-por_data %>% 
  select(timepoint, site_code, PC1.mean, PC2.mean)%>%
  group_by(timepoint, site_code)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
```

```{r}
# scale data
vegan <- scale(por_data_afdw[ ,5:11])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis(vegan ~ timepoint*site_code, data = por_data_afdw, method='eu')
z_por<-permanova$aov.tab
z_por
```

Assemble plot with background points
```{r}
#1. make plot with dots
porPCA<-ggplot(por_data, aes(.fittedPC1, .fittedPC2, color=site_code)) + 
  geom_point(size = 4, alpha=0.2, show.legend=FALSE)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  ylab("PC2")+
  xlab("PC1")+
  ylim(-5,6)+
  xlim(-5,6)+
  ggtitle(expression(italic("Porites")))+
  #geom_text(x=7, y=-2.5, label=paste("p(Timepoint)=", z_por$`Pr(>F)`[1]), size=4, color=ifelse(z_por$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  #geom_text(x=7, y=-3.25, label=paste("p(Site)=", z_por$`Pr(>F)`[2]), size=4, color=ifelse(z_por$`Pr(>F)`[2] < 0.05, "black", "darkgray")) + 
  #geom_text(x=7, y=-4, label=paste("p(Timepoint x Site)=", z_por$`Pr(>F)`[3]), size=4, color=ifelse(z_por$`Pr(>F)`[3] < 0.05, "black", "darkgray")) + 
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         legend.title = element_blank(), 
         axis.text = element_text(size=18), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         title = element_text(size=25, face="bold"),
         axis.title = element_text(size=18,  face="bold"));porPCA
```

Add centroids  

```{r}
#2. add centroids 
porPCAcen<-porPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site_code), data=por.centroids, size=3, show.legend=FALSE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position=c(1,0.3)); porPCAcen

#build a plot for the legend
legend_plot<-porPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site_code), data=por.centroids, size=3, show.legend=TRUE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="bottom")

# extract the legend from one of the plots
legend <- get_legend(
  # create some space to the left of the legend
  legend_plot + theme(legend.box.margin = margin(1,1,1,1))
)

```

Add segments

```{r}
#3. add segments
segpoints<-por.centroids%>%
  gather(variable, value, -(timepoint:site_code)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
porPCAfull<-porPCAcen + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = site_code), data = segpoints, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); porPCAfull
```

Add bi plot with loadings  
```{r}
#1. make plot with dots
porArrows<-ggplot2::autoplot(scaled_por_afdw, data=por_data_afdw, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=3.5, loadings.label.vjust=-0.1, loadings.label.hjust=0.1, loadings.label.repel=TRUE, size=4, alpha=0.0) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-0.5,0.1)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_blank(),
         axis.text.y=element_blank(),
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_blank());porArrows
```
 

Assemble final figure with inset biplot.  
```{r}
#porFullPCA<-ggdraw(porPCAfull)+ #+ theme_half_open(12)) +
 # draw_plot(porArrows, .5, .5, .5, .5); porFullPCA #x, y, w, h

#ggsave(filename="Figures/FullPCA_Porites.pdf", plot=porFullPCA, dpi=300, width=12, height=8, units="in")
```
 
#### Pocillopora   

Generate PCA using scaled (scaled_poc_afdw) from dataframe (poc_data_afdw). 
 
```{r}
poc_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Total_Chl<13)%>%
  filter(species=="Pocillopora")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell, SH_Ratio=Ratio_AFDW.mg.cm2)

poc_data_afdw<-poc_data_afdw[complete.cases(poc_data_afdw), ]
 
scaled_poc_afdw<-prcomp(poc_data_afdw[c(5:11)], scale=TRUE, center=TRUE) 

poc_info<-poc_data_afdw[c(2,4)]

poc_data<-scaled_poc_afdw%>%
  augment(poc_info)%>%
  group_by(timepoint, site_code)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

poc.centroids<-poc_data %>% 
  select(timepoint, site_code, PC1.mean, PC2.mean)%>%
  group_by(timepoint, site_code)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
``` 
  
```{r}
# scale data
vegan <- scale(poc_data_afdw[ ,5:11])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis(vegan ~ timepoint*site_code, data = poc_data_afdw, method='eu')
z_poc<-permanova$aov.tab
z_poc
```

Assemble plot with background points
```{r}
#1. make plot with dots
pocPCA<-ggplot(poc_data, aes(.fittedPC1, .fittedPC2, color=site_code)) + 
  geom_point(size = 4, alpha=0.2, show.legend=FALSE)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  ylim(-5,6)+
  xlim(-5,6)+
  ylab("PC2")+
  xlab("PC1")+
  ggtitle(expression(italic("Pocillopora")))+
  #geom_text(x=7, y=-2.5, label=paste("p(Timepoint)=", z_poc$`Pr(>F)`[1]), size=4, color=ifelse(z_poc$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  #geom_text(x=7, y=-3.25, label=paste("p(Site)=", z_poc$`Pr(>F)`[2]), size=4, color=ifelse(z_poc$`Pr(>F)`[2] < 0.05, "black", "darkgray")) + 
  #geom_text(x=7, y=-4, label=paste("p(Timepoint x Site)=", z_poc$`Pr(>F)`[3]), size=4, color=ifelse(z_poc$`Pr(>F)`[3] < 0.05, "black", "darkgray")) + 
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         plot.margin = margin(1, 1, 1, 1, "cm"),
         legend.title = element_blank(), 
         title = element_text(size=25, face="bold"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18,  face="bold"));pocPCA

```

Add centroids  

```{r}
#2. add centroids 
pocPCAcen<-pocPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site_code), data=poc.centroids, size=3, show.legend=FALSE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="none"); pocPCAcen

```

Add segments

```{r}
#3. add segments
segpoints<-poc.centroids%>%
  gather(variable, value, -(timepoint:site_code)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
pocPCAfull<-pocPCAcen + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = site_code), data = segpoints, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); pocPCAfull
```

Add bi plot with loadings  
```{r}

pocArrows<-ggplot2::autoplot(scaled_poc_afdw, data=poc_data_afdw, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=3.5, loadings.label.vjust=0, loadings.label.hjust=-0.1, loadings.label.repel=TRUE, size=4, alpha=0.0) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_blank(),
         axis.text.y=element_blank(),
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_blank());pocArrows
```

 
Assemble final figure with inset biplot.  
```{r}
#pocFullPCA<-ggdraw(pocPCAfull) + #theme_half_open(12)) +
  #draw_plot(pocArrows, .5, .5, .5, .5); pocFullPCA #x, y, w, h

#ggsave(filename="Figures/FullPCA_Pocillopora.pdf", plot=pocFullPCA, dpi=300, width=12, height=8, units="in")
```
 
Assemble all plots.  

```{r}
PCA_full_panel<-plot_grid(acrPCAfull, pocPCAfull, porPCAfull, labels = c("", "", ""), ncol=3, nrow=1, rel_heights= c(1,1,1), rel_widths = c(1,1,1), label_size = 20, label_y=1, align="vh")

# add the legend to the row we made earlier. Give it one-third of 
# the width of one plot (via rel_widths).
PCA_full_panel_legend<-plot_grid(PCA_full_panel, legend, rel_heights = c(4, .2), ncol=1, nrow=2)

ggsave(filename="Figures/Full_Panel_PCAs_Symbiont.png", plot=PCA_full_panel_legend, dpi=500, width=20, height=6, units="in")
```  

### Matrix of PCA's by species and time  

Generate biplot showing groupings by site for each species and time point.  

#### Pocillopora  

```{r}
poc_tp1_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Total_Chl<13)%>%
  filter(species=="Pocillopora")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2)%>%
  filter(timepoint=="timepoint1")

poc_tp1_data<-poc_tp1_data[complete.cases(poc_tp1_data), ]
 
poc_tp1_scaled<-prcomp(poc_tp1_data[c(5:11)], scale=TRUE, center=TRUE) 

pocTP1<-ggplot2::autoplot(poc_tp1_scaled, data=poc_tp1_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0, loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("January 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  annotate("text", x=-16, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 2, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP1
```

```{r}
poc_tp2_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Total_Chl<13)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Pocillopora")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint2")
 
poc_tp2_data<-poc_tp2_data[complete.cases(poc_tp2_data), ]
 
poc_tp2_scaled<-prcomp(poc_tp2_data[c(5:11)], scale=TRUE, center=TRUE) 

pocTP2<-ggplot2::autoplot(poc_tp2_scaled, data=poc_tp2_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("March 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP2
```

```{r}
poc_tp3_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Total_Chl<13)%>%
  filter(species=="Pocillopora")%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint3")
 
poc_tp3_data<-poc_tp3_data[complete.cases(poc_tp3_data), ]
 
poc_tp3_scaled<-prcomp(poc_tp3_data[c(5:11)], scale=TRUE, center=TRUE) 

pocTP3<-ggplot2::autoplot(poc_tp3_scaled, data=poc_tp3_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("September 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP3
```

```{r}
poc_tp4_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Total_Chl<13)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Pocillopora")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint4")
 
poc_tp4_data<-poc_tp4_data[complete.cases(poc_tp4_data), ]
 
poc_tp4_scaled<-prcomp(poc_tp4_data[c(5:11)], scale=TRUE, center=TRUE) 

pocTP4<-ggplot2::autoplot(poc_tp4_scaled, data=poc_tp4_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("November 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP4
```


#### Acropora  

```{r}
acr_tp1_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Total_Chl<13)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Acropora")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint1")

acr_tp1_data<-acr_tp1_data[complete.cases(acr_tp1_data), ]
 
acr_tp1_scaled<-prcomp(acr_tp1_data[c(5:11)], scale=TRUE, center=TRUE) 

acrTP1<-ggplot2::autoplot(acr_tp1_scaled, data=acr_tp1_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0, loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("January 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  annotate("text", x=-16, y=0, label="italic(Acropora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 2, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP1
```

```{r}
acr_tp2_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Total_Chl<13)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Acropora")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint2")
 
acr_tp2_data<-acr_tp2_data[complete.cases(acr_tp2_data), ]
 
acr_tp2_scaled<-prcomp(acr_tp2_data[c(5:11)], scale=TRUE, center=TRUE) 

acrTP2<-ggplot2::autoplot(acr_tp2_scaled, data=acr_tp2_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("March 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP2
```

```{r}
acr_tp3_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Total_Chl<13)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Acropora")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint3")
 
acr_tp3_data<-acr_tp3_data[complete.cases(acr_tp3_data), ]
 
acr_tp3_scaled<-prcomp(acr_tp3_data[c(5:11)], scale=TRUE, center=TRUE) 

acrTP3<-ggplot2::autoplot(acr_tp3_scaled, data=acr_tp3_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("September 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP3
```

```{r}
acr_tp4_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Total_Chl<13)%>%
  filter(species=="Acropora")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint4")
 
acr_tp4_data<-acr_tp4_data[complete.cases(acr_tp4_data), ]
 
acr_tp4_scaled<-prcomp(acr_tp4_data[c(5:11)], scale=TRUE, center=TRUE) 

acrTP4<-ggplot2::autoplot(acr_tp4_scaled, data=acr_tp4_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("November 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP4
```



#### Porites  

```{r}
por_tp1_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Total_Chl<13)%>%
  filter(species=="Porites")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint1")

por_tp1_data<-por_tp1_data[complete.cases(por_tp1_data), ]
 
por_tp1_scaled<-prcomp(por_tp1_data[c(5:11)], scale=TRUE, center=TRUE) 

porTP1<-ggplot2::autoplot(por_tp1_scaled, data=por_tp1_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0, loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("January 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  annotate("text", x=-16, y=0, label="italic(Porites)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 2, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP1
```

```{r}
por_tp2_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Total_Chl<13)%>%
  filter(species=="Porites")%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint2")
 
por_tp2_data<-por_tp2_data[complete.cases(por_tp2_data), ]
 
por_tp2_scaled<-prcomp(por_tp2_data[c(5:11)], scale=TRUE, center=TRUE) 

porTP2<-ggplot2::autoplot(por_tp2_scaled, data=por_tp2_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("March 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP2
```

```{r}
por_tp3_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  #filter(Total_Chl<13)%>%
  filter(species=="Porites")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint3")
 
por_tp3_data<-por_tp3_data[complete.cases(por_tp3_data), ]
 
por_tp3_scaled<-prcomp(por_tp3_data[c(5:11)], scale=TRUE, center=TRUE) 

porTP3<-ggplot2::autoplot(por_tp3_scaled, data=por_tp3_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("September 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP3
```

```{r}
por_tp4_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Total_Chl<13)%>%
  filter(species=="Porites")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint4")
 
por_tp4_data<-por_tp4_data[complete.cases(por_tp4_data), ]
 
por_tp4_scaled<-prcomp(por_tp4_data[c(5:11)], scale=TRUE, center=TRUE) 

porTP4<-ggplot2::autoplot(por_tp4_scaled, data=por_tp4_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
 # ggtitle("November 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP4
```

#### Assemble grid plot of all metrics by species and time  

```{r}
all_grid<-plot_grid(acrTP1, acrTP2, acrTP3, acrTP4, pocTP1, pocTP2, pocTP3, pocTP4, porTP1, porTP2, porTP3, porTP4, ncol=4, nrow=3)
all_grid2<-plot_grid(all_grid, legend, rel_heights = c(4, .2), ncol=1, nrow=2)

ggsave(filename="Figures/Matrix_Symbiont_Responses.pdf", plot=all_grid2, dpi=500, width=20, height=20, units="in")

```

