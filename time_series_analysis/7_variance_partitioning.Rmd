---
title: "Variance partitioning analysis"
author: "Ariana S Huffmyer, Serena Hackerott, E5 RoL Team"
date: "05/09/2023"
output: 
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
editor_options: 
  chunk_output_type: console
--- 

# Set Up    
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

```{r}
## install packages if you dont already have them
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("vegan")) install.packages("vegan")
if (!require("ggplot2")) install.packages("ggplot2")

# load packages
library(tidyverse)
library(vegan)
library(ggplot2)
```

# Load dataframe

Load in master dataframe generated from 1_assemble_data.Rmd.  
```{r}
master<-read.csv("Output/master_timeseries.csv")

#reorder site levels 
master$site_code<-as.factor(master$site_code)
master$site_code<-fct_relevel(master$site_code, "Mahana Low", "Hilton Medium", "Manava High")

master$site<-fct_relevel(master$site, "Mahana", "Hilton", "Manava")
```

Add in haplotype information
```{r}
haplotypes<-read_csv("Species_ID/master_colony_metadata_speciesID.csv")

master$haplotype<-haplotypes$Genus.Species[match(master$colony_id_corr, haplotypes$colony_id_corr)]
```

Phys matrix: master_timeseries.csv
Temp matrix: Clean_Environmental_Temp_Means.csv

# Holobiont responses   
```{r}
data_all<-master%>%
  select(colony_id_corr, haplotype, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd, Ik, Ic, calc.umol.cm2.hr, Total_Chl, Total_Chl_cell)%>%
  filter(!haplotype=="Reseq")%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  filter(Ic<1000)%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)
```

#Log+1 transform all responses
```{r}
data_all_log <-data_all
data_all_log[,-c(1:5)]<-log(data_all_log[,-c(1:5)]+1)

#change timepoint to a factor 
data_all_log$timepoint<-as.factor(data_all_log$timepoint)

#change species to a factor 
data_all_log$species<-as.factor(data_all_log$species)

#change species to a factor 
data_all_log$haplotype<-as.factor(data_all_log$haplotype)
```

#Acropora  
```{r}
acr_data_afdw_log<-data_all_log%>%
  filter(species=="Acropora")

acr_data_afdw_log<-acr_data_afdw_log[complete.cases(acr_data_afdw_log), ]
```


##Variance Partitioning
```{r}
##Run varpart function with responses and explanatory variables of interest
varpart_acr_afdw<-varpart(acr_data_afdw_log[,6:19], acr_data_afdw_log$timepoint, acr_data_afdw_log$site)

##Check variance explained by individual fractions
varpart_acr_afdw$part
#Individual fractions                                    
#[a] = X1|X2           3                 0.38366     TRUE
#[b] = X2|X1           2                 0.03135     TRUE
#[c]                   0                -0.01139    FALSE
#[d] = Residuals                         0.59637    FALSE

##Check model significance
anova(rda(acr_data_afdw_log[,6:19]~ acr_data_afdw_log$timepoint + acr_data_afdw_log$site))
#The model is significant p=0.001

##Check variance explained by model
RsquareAdj(rda(acr_data_afdw_log[,6:19]~ acr_data_afdw_log$timepoint + acr_data_afdw_log$site))$adj.r.squared*100
#The model explains 40.36% of the variation in coral physiology in Acropora

##Check effect of timepoint 
anova(rda(acr_data_afdw_log[,6:19], acr_data_afdw_log$timepoint))
#The effect of timepoint with overlap with site is significant p=0.001 
anova(rda(acr_data_afdw_log[,6:19], acr_data_afdw_log$timepoint,  acr_data_afdw_log$site))
#The effect of timepoint alone (controlling for site) is significant p=0.001 

##Check effect of site 
anova(rda(acr_data_afdw_log[,6:19], acr_data_afdw_log$site))
#The effect of site with overlap with timepoint is not significant p=0.057
anova(rda(acr_data_afdw_log[,6:19], acr_data_afdw_log$site,  acr_data_afdw_log$timepoint))
#The effect of site alone (controlling for timepoint) is significant p=0.001 
```

##Generate figure-Venn
```{r}
#par(bty="n")

varpart_acr_afdw_parts<-data.frame(Parts=c("Season", "Site", "NA","Residuals"), 
                            Variance=c(varpart_acr_afdw$part$indfract$Adj.R.square))
varpart_acr_afdw_parts$PercVar<-paste(as.character(round(varpart_acr_afdw_parts$Variance*100,2)), "%", sep="")
varpart_acr_afdw_parts$PercVar[which(varpart_acr_afdw_parts$Variance<0)]<-NA
varpart_acr_afdw_parts$Species<-rep("Acropora", nrow(varpart_acr_afdw_parts))

rows_to_keep <- c(1, 2, 4)
varpart_acr_afdw_parts <- varpart_acr_afdw_parts[rows_to_keep, ]

#showvarparts(parts=2, labels=varpart_acr_afdw_parts$PercVar, Xnames=NULL, 
#             cex=c(1.4, 1.4, 1.4, 1, 1, 1.2), 
#             bg=c("#4681F7FF", "#18DEC1FF"), alpha=125)+
#text(-0.1, .4, "Season", cex=2)+
#text(1, 0.4, "Site", cex=2)+
#text(0, -.3, substitute(paste(italic('p = 0.001'))), cex=1.1)+
#text(1, -.3, substitute(paste(italic('p = 0.003'))), cex=1.1)+
#text(0.5, 1, "Acropora", cex=2)
```

# Porites
```{r}
por_data_afdw_log<-data_all_log%>%
  filter(species=="Porites")%>%
  droplevels()

por_data_afdw_log<-por_data_afdw_log[complete.cases(por_data_afdw_log), ]
```

## Variance Partitioning
```{r}
##Run varpart function with responses and explanatory variables of interest
varpart_por_afdw<-varpart(por_data_afdw_log[,6:19], por_data_afdw_log$timepoint, por_data_afdw_log$site, por_data_afdw_log$haplotype) 

##Check variance explained by individual fractions
varpart_por_afdw$part
#[a] = X1 | X2+X3       3               0.18725     TRUE
#[b] = X2 | X1+X3       2               0.03699     TRUE
#[c] = X3 | X1+X2       1               0.05609     TRUE
#[d]                    0               0.00476    FALSE
#[e]                    0               0.06810    FALSE
#[f]                    0               0.00087    FALSE
#[g]                    0              -0.00138    FALSE
#[h] = Residuals                        0.64733    FALSE

#e is variance explained by both site and haplotype, since we have nested haplotypes 

##Check model significance
anova(rda(por_data_afdw_log[,6:19]~ por_data_afdw_log$timepoint + por_data_afdw_log$site + por_data_afdw_log$haplotype))
#The model is significant p=0.001

##Check variance explained by model
RsquareAdj(rda(por_data_afdw_log[,6:19]~ por_data_afdw_log$timepoint + por_data_afdw_log$site + por_data_afdw_log$haplotype))$adj.r.squared*100
#The model explains 35.27% of the variation in coral physiology in Porites

##Check effect of timepoint 
anova(rda(por_data_afdw_log[,6:19], por_data_afdw_log$timepoint))
#The effect of timepoint with overlap with site_code is significant p=0.001 
anova(rda(por_data_afdw_log[,6:19], por_data_afdw_log$timepoint,  por_data_afdw_log$site))
#The effect of timepoint alone (controlling for site_code) is significant p=0.001 
anova(rda(por_data_afdw_log[,6:19], por_data_afdw_log$timepoint,  por_data_afdw_log$haplotype))
#The effect of timepoint alone (controlling for haplotype) is significant p=0.001 

anova(rda(por_data_afdw_log[,6:19], por_data_afdw_log$haplotype))

anova(rda(por_data_afdw_log[,6:19], por_data_afdw_log$haplotype,  por_data_afdw_log$site))

anova(rda(por_data_afdw_log[,6:19], por_data_afdw_log$haplotype,  por_data_afdw_log$timepoint))
#haplotype is significant

##Check effect of site 
anova(rda(por_data_afdw_log[,6:19], por_data_afdw_log$site))
#The effect of site with overlap with timepoint is significant p=0.001
anova(rda(por_data_afdw_log[,6:19], por_data_afdw_log$site,  por_data_afdw_log$timepoint))
#The effect of site alone (controlling for timepoint) is significant p=0.001 
anova(rda(por_data_afdw_log[,6:19], por_data_afdw_log$site,  por_data_afdw_log$haplotype))
#The effect of site alone (controlling for haplotype) is significant p=0.001 

```

## Generate figure- Venn
```{r}
#par(bty="n")

varpart_por_afdw_parts<-data.frame(Parts=c("Season", "Site", "Haplotype","NA", "Site&Haplotype", "NA", "NA", "Residuals"), 
                            Variance=c(varpart_por_afdw$part$indfract$Adj.R.square))
varpart_por_afdw_parts$PercVar<-paste(as.character(round(varpart_por_afdw_parts$Variance*100,2)), "%", sep="")
varpart_por_afdw_parts$PercVar[which(varpart_por_afdw_parts$Variance<0)]<-NA
varpart_por_afdw_parts$Species<-rep("Porites", nrow(varpart_por_afdw_parts))

rows_to_keep <- c(1, 2, 3, 5, 8)
varpart_por_afdw_parts <- varpart_por_afdw_parts[rows_to_keep, ]

#showvarparts(parts=2, labels=varpart_por_afdw_parts$PercVar, Xnames=NULL, 
#             cex=c(1.4, 1.4, 1.4, 1, 1, 1.2), 
#             bg=c("#4681F7FF", "#18DEC1FF"), alpha=125)+
#text(-0.1, .4, "Season", cex=2)+
#text(1, 0.4, "Site", cex=2)+
#text(0, -.3, substitute(paste(italic('p = 0.001'))), cex=1.1)+
#text(1, -.3, substitute(paste(italic('p = 0.001'))), cex=1.1)+
#text(0.5, 1, "Porites", cex=2)
```


# Pocillopora   
```{r}
poc_data_afdw_log<-data_all_log%>%
  filter(species=="Pocillopora")%>%
  droplevels()

poc_data_afdw_log<-poc_data_afdw_log[complete.cases(poc_data_afdw_log), ]
```

## Variance Partitioning
```{r}
##Run varpart function with responses and explanatory variables of interest
varpart_poc_afdw<-varpart(poc_data_afdw_log[,6:19], poc_data_afdw_log$timepoint, poc_data_afdw_log$site, poc_data_afdw_log$haplotype)

##Check variance explained by individual fractions
varpart_poc_afdw$part
#Individual fractions                                   
#[a] = X1 | X2+X3       3               0.28398     TRUE
#[b] = X2 | X1+X3       2               0.01327     TRUE
#[c] = X3 | X1+X2       1               0.00394     TRUE
#[d]                    0              -0.00283    FALSE
#[e]                    0              -0.00179    FALSE
#[f]                    0               0.00010    FALSE
#[g]                    0              -0.00068    FALSE
#[h] = Residuals                        0.70401    FALSE

##Check model significance
anova(rda(poc_data_afdw_log[,6:19]~ poc_data_afdw_log$timepoint + poc_data_afdw_log$site + poc_data_afdw_log$haplotype))
#The model is significant p=0.001

##Check variance explained by model
RsquareAdj(rda(poc_data_afdw_log[,6:19]~ poc_data_afdw_log$timepoint + poc_data_afdw_log$site + poc_data_afdw_log$haplotype))$adj.r.squared*100
#The model explains 29.60% of the variation in coral physiology in Acropora

##Check effect of timepoint 
anova(rda(poc_data_afdw_log[,6:19], poc_data_afdw_log$timepoint))
#The effect of timepoint with overlap with site_code is significant p=0.001 
anova(rda(poc_data_afdw_log[,6:19], poc_data_afdw_log$timepoint,  poc_data_afdw_log$site))
#The effect of timepoint alone (controlling for site_code) is significant p=0.001 
anova(rda(poc_data_afdw_log[,6:19], poc_data_afdw_log$timepoint,  poc_data_afdw_log$haplotype))
#The effect of timepoint alone (controlling for haplotype) is significant p=0.001 

anova(rda(poc_data_afdw_log[,6:19], poc_data_afdw_log$haplotype,  poc_data_afdw_log$timepoint))
#The effect of haplotype alone (controlling for time) is not significant p=0.246
anova(rda(poc_data_afdw_log[,6:19], poc_data_afdw_log$haplotype,  poc_data_afdw_log$site))
#The effect of haplotype alone (controlling for site) is not significant p=0.165

##Check effect of site 
anova(rda(poc_data_afdw_log[,6:19], poc_data_afdw_log$site))
#The effect of site with overlap with timepoint is not significant p=0.138.
anova(rda(poc_data_afdw_log[,6:19], poc_data_afdw_log$site,  poc_data_afdw_log$timepoint))
#The effect of site alone (controlling for timepoint) is significant p=0.049 

```

##Generate figure- Venn
```{r}
par(bty="n")

varpart_poc_afdw_parts<-data.frame(Parts=c("Season", "Site", "Haplotype","NA", "NA", "NA", "NA", "Residuals"), 
                            Variance=c(varpart_poc_afdw$part$indfract$Adj.R.square))
varpart_poc_afdw_parts$PercVar<-paste(as.character(round(varpart_poc_afdw_parts$Variance*100,2)), "%", sep="")
varpart_poc_afdw_parts$PercVar[which(varpart_poc_afdw_parts$Variance<0)]<-NA
varpart_poc_afdw_parts$Species<-rep("Pocillopora", nrow(varpart_poc_afdw_parts))

rows_to_keep <- c(1, 2, 3, 8)
varpart_poc_afdw_parts <- varpart_poc_afdw_parts[rows_to_keep, ]

#showvarparts(parts=2, labels=varpart_poc_afdw_parts$PercVar, Xnames=NULL, 
 #            cex=c(1.4, 1.4, 1.4, 1, 1, 1.2), 
  #           bg=c("#4681F7FF", "#18DEC1FF", "pink"), alpha=125)+
#text(-0.1, .4, "Season", cex=2)+
#text(1, 0.4, "Site", cex=2)+
#text(1, 0.4, "Haplotype", cex=2)+
#text(0, -.3, substitute(paste(italic('p = 0.001'))), cex=1.1)+
#text(1, -.3, substitute(paste(italic('p = 0.008'))), cex=1.1)+
#text(0.5, 1, "Pocillopora", cex=2)
```


#Generate figure- Barplot all Species Holobiont

```{r}
##Combine VarPart results for all Species
varpart_afdw_parts_all<-rbind(varpart_acr_afdw_parts, varpart_por_afdw_parts, varpart_poc_afdw_parts)
varpart_afdw_parts_all<-na.omit(varpart_afdw_parts_all)
#varpart_afdw_parts_all<-varpart_afdw_parts_all%>%filter(!Parts=="Site")
varpart_afdw_parts_all$Response<-rep("Holobiont", nrow(varpart_afdw_parts_all))
varpart_afdw_parts_all$Percent<-round(varpart_afdw_parts_all$Variance*100,2)
varpart_afdw_parts_all$Parts<-factor(varpart_afdw_parts_all$Parts)

names(varpart_afdw_parts_all)

varpart_afdw_parts_all$Parts<-factor(varpart_afdw_parts_all$Parts, levels=c("Haplotype", "Site&Haplotype", "Site", "Season", "Residuals"))

varpartBarplot_all.holo<-ggplot(varpart_afdw_parts_all, aes(x=Species, y=Percent, fill=Parts)) + 
  geom_bar(position="stack", stat="identity", colour="black")+
  scale_fill_manual(name="Predictors", values = c("lightblue4", "lightblue2", "cyan2", "purple2", "gray"),)+
  theme_classic()+
  theme(axis.title.x = element_text(size = 18), axis.title.y = element_text(size = 18), 
        axis.text.x=element_text(size=14, colour="black"), axis.text.y=element_text(size=14, colour="black"), 
        legend.text=element_text(size=12), legend.title=element_text(size=15))+
  ylab("% Variance Explained")+
  geom_text(aes(label=paste0(sprintf("%1.1f",Percent),"%"), fontface = "bold"),
            position=position_stack(vjust=0.5), size=5, color="black")+
  theme(plot.title=element_text(hjust=0.5), 
        axis.text.x=element_text(face="italic", color="black"), 
        axis.text.y=element_text(color="black"), 
        axis.title = element_text(face="bold"), 
        legend.title=element_text(face="bold"));varpartBarplot_all.holo

ggsave(varpartBarplot_all.holo, file="Figures/Multivariate/VarPart_Holobiont.png", width=6, height=6.5)
ggsave(varpartBarplot_all.holo, file="Figures/Multivariate/VarPart_Holobiont.jpg", width=6, height=6.5)
ggsave(varpartBarplot_all.holo, file="Figures/Multivariate/VarPart_Holobiont.pdf", width=6, height=6.5)

```

# Generate a list of symbiont and host responses.  Holobiont = all responses
```{r}
symbiont_responses<-c("cells.mgAFDW", "Sym_AFDW.mg.cm2", "Total_Chl", "Total_Chl_cell", "Am", "AQY", "Ik", "Ic", "Ratio_AFDW.mg.cm2") 
host_responses<-c("cre.umol.mgafdw", "Host_AFDW.mg.cm2", "prot_mg.mgafdw", "Rd", "calc.umol.cm2.hr")
```

# Host responses
```{r}
data_host<-master%>%
  select(colony_id_corr, haplotype, timepoint, species, site_code, all_of(host_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)

data_host<-data_host[complete.cases(data_host), ]
```


#Log+1 transform all responses
```{r}
data_host_log <-data_host
data_host_log[,-c(1:5)]<-log(data_host_log[,-c(1:5)]+1)

#change timepoint to a factor 
data_host_log$timepoint<-as.factor(data_host_log$timepoint)

#change species to a factor 
data_host_log$species<-as.factor(data_host_log$species)

#change species to a factor 
data_host_log$haplotype<-as.factor(data_host_log$haplotype)
```


#Acropora- Host  
```{r}
acr_data_afdw_log_host<-data_host_log%>%
  filter(species=="Acropora")

acr_data_afdw_log_host<-acr_data_afdw_log_host[complete.cases(acr_data_afdw_log_host), ]
```


##Variance Partitioning
```{r}
##Run varpart function with responses and explanatory variables of interest
varpart_acr_afdw_host<-varpart(acr_data_afdw_log_host[,6:10], acr_data_afdw_log_host$timepoint, acr_data_afdw_log_host$site)

##Check variance explained by individual fractions
varpart_acr_afdw_host$part
# Individual fractions                                    
#[a] = X1|X2           3                 0.26728     TRUE
#[b] = X2|X1           2                 0.08019     TRUE
#[c]                   0                -0.01420    FALSE
#[d] = Residuals                         0.66673    FALSE

##Check model significance
anova(rda(acr_data_afdw_log_host[,6:10]~ acr_data_afdw_log_host$timepoint + acr_data_afdw_log_host$site))
#The model is significant p=0.001

##Check variance explained by model
RsquareAdj(rda(acr_data_afdw_log_host[,6:10]~ acr_data_afdw_log_host$timepoint + acr_data_afdw_log_host$site))$adj.r.squared*100
#The model explains 33.33% of the variation in coral physiology in Acropora Host

##Check effect of timepoint 
anova(rda(acr_data_afdw_log_host[,6:10], acr_data_afdw_log_host$timepoint))
#The effect of timepoint with overlap with site is significant p=0.001 
anova(rda(acr_data_afdw_log_host[,6:10], acr_data_afdw_log_host$timepoint,  acr_data_afdw_log_host$site))
#The effect of timepoint alone (controlling for site) is significant p=0.001 

##Check effect of site 
anova(rda(acr_data_afdw_log_host[,6:10], acr_data_afdw_log_host$site))
#The effect of site with overlap with timepoint is significant p=0.003 
anova(rda(acr_data_afdw_log_host[,6:10], acr_data_afdw_log_host$site,  acr_data_afdw_log_host$timepoint))
#The effect of site alone (controlling for timepoint) is significant p=0.001 
```


#Porites- Host  
```{r}
por_data_afdw_log_host<-data_host_log%>%
  filter(species=="Porites")%>%
  droplevels()

por_data_afdw_log_host<-por_data_afdw_log_host[complete.cases(por_data_afdw_log_host), ]
```


##Variance Partitioning
```{r}
##Run varpart function with responses and explanatory variables of interest
varpart_por_afdw_host<-varpart(por_data_afdw_log_host[,6:10], por_data_afdw_log_host$timepoint, por_data_afdw_log_host$site, por_data_afdw_log_host$haplotype)

##Check variance explained by individual fractions
varpart_por_afdw_host$part
#Individual fractions                                   
#[a] = X1 | X2+X3       3               0.28147     TRUE
#[b] = X2 | X1+X3       2               0.01573     TRUE
#[c] = X3 | X1+X2       2               0.00965     TRUE
#[d]                    0              -0.00769    FALSE
#[e]                    0               0.03208    FALSE
#[f]                    0              -0.00409    FALSE
#[g]                    0              -0.00152    FALSE
#[h] = Residuals                        0.67437    FALSE

#e will be site&haplotype 

##Check model significance
anova(rda(por_data_afdw_log_host[,6:10]~ por_data_afdw_log_host$timepoint + por_data_afdw_log_host$site + por_data_afdw_log_host$haplotype))
#The model is significant p=0.001

##Check variance explained by model
RsquareAdj(rda(por_data_afdw_log_host[,6:10]~ por_data_afdw_log_host$timepoint + por_data_afdw_log_host$site + por_data_afdw_log_host$haplotype))$adj.r.squared*100
#The model explains 32.56% of the variation in coral physiology in Porites Host

##Check effect of timepoint 
anova(rda(por_data_afdw_log_host[,6:10], por_data_afdw_log_host$timepoint))
#The effect of timepoint with overlap with site is significant p=0.001 
anova(rda(por_data_afdw_log_host[,6:10], por_data_afdw_log_host$timepoint,  por_data_afdw_log_host$site))
#The effect of timepoint alone (controlling for site) is significant p=0.001 
anova(rda(por_data_afdw_log_host[,6:10], por_data_afdw_log_host$timepoint,  por_data_afdw_log_host$haplotype))
#The effect of timepoint alone (controlling for haplotype) is significant p=0.001 

##Check effect of site 
anova(rda(por_data_afdw_log_host[,6:10], por_data_afdw_log_host$site))
#The effect of site with overlap with timepoint is significant p=0.002 
anova(rda(por_data_afdw_log_host[,6:10], por_data_afdw_log_host$site,  por_data_afdw_log_host$timepoint))
#The effect of site alone (controlling for timepoint) is significant p=0.001 
anova(rda(por_data_afdw_log_host[,6:10], por_data_afdw_log_host$site,  por_data_afdw_log_host$haplotype))
#The effect of site alone (controlling for timepoint) is not significant 

##Check effect of haplotype 
anova(rda(por_data_afdw_log_host[,6:10], por_data_afdw_log_host$haplotype))
#The effect of haplotype is significant p=0.005
anova(rda(por_data_afdw_log_host[,6:10], por_data_afdw_log_host$haplotype,  por_data_afdw_log_host$timepoint))
#The effect of haplotype alone (controlling for timepoint) is significant p=0.001 
anova(rda(por_data_afdw_log_host[,6:10], por_data_afdw_log_host$haplotype,  por_data_afdw_log_host$site))
#The effect of haplotype alone (controlling for site) is not significant 
```


#Pocillopora- Host  
```{r}
poc_data_afdw_log_host<-data_host_log%>%
  filter(species=="Pocillopora")%>%
  droplevels()

poc_data_afdw_log_host<-poc_data_afdw_log_host[complete.cases(poc_data_afdw_log_host), ]
```


##Variance Partitioning
```{r}
##Run varpart function with responses and explanatory variables of interest
varpart_poc_afdw_host<-varpart(poc_data_afdw_log_host[,6:10], poc_data_afdw_log_host$timepoint, poc_data_afdw_log_host$site, poc_data_afdw_log_host$haplotype)

##Check variance explained by individual fractions
varpart_poc_afdw_host$part
#Individual fractions                                   
#[a] = X1 | X2+X3       3               0.18283     TRUE
#[b] = X2 | X1+X3       2               0.03051     TRUE
#[c] = X3 | X1+X2       1              -0.00354     TRUE
#[d]                    0               0.00037    FALSE
#[e]                    0               0.01263    FALSE
#[f]                    0              -0.00041    FALSE
#[g]                    0               0.00286    FALSE
#[h] = Residuals                        0.77475    FALSE                       0.77121    FALSE

##Check model significance
anova(rda(poc_data_afdw_log_host[,6:10]~ poc_data_afdw_log_host$timepoint + poc_data_afdw_log_host$site + poc_data_afdw_log_host$haplotype))
#The model is significant p=0.001

##Check variance explained by model
RsquareAdj(rda(poc_data_afdw_log_host[,6:10]~ poc_data_afdw_log_host$timepoint + poc_data_afdw_log_host$site+ poc_data_afdw_log_host$haplotype))$adj.r.squared*100
#The model explains 22.52% of the variation in coral physiology in Pocillopora Host

##Check effect of timepoint 
anova(rda(poc_data_afdw_log_host[,6:10], poc_data_afdw_log_host$timepoint))
#The effect of timepoint with overlap with site is significant p=0.001 
anova(rda(poc_data_afdw_log_host[,6:10], poc_data_afdw_log_host$timepoint,  poc_data_afdw_log_host$site))
#The effect of timepoint alone (controlling for site) is significant p=0.001 
anova(rda(poc_data_afdw_log_host[,6:10], poc_data_afdw_log_host$timepoint,  poc_data_afdw_log_host$haplotype))
#The effect of timepoint alone (controlling for haplotype) is significant p=0.001 

##Check effect of site 
anova(rda(poc_data_afdw_log_host[,6:10], poc_data_afdw_log_host$site))
#The effect of site with overlap with timepoint is significant p=0.005 
anova(rda(poc_data_afdw_log_host[,6:10], poc_data_afdw_log_host$site,  poc_data_afdw_log_host$timepoint))
#The effect of site alone (controlling for timepoint) is significant p=0.001 
anova(rda(poc_data_afdw_log_host[,6:10], poc_data_afdw_log_host$site,  poc_data_afdw_log_host$haplotype))
#The effect of site alone (controlling for haplotype) is significant p=0.013

##Check effect of haplotype 
anova(rda(poc_data_afdw_log_host[,6:10], poc_data_afdw_log_host$haplotype))
#The effect of haplotype  is not significant p=0.068
anova(rda(poc_data_afdw_log_host[,6:10], poc_data_afdw_log_host$haplotype,  poc_data_afdw_log_host$timepoint))
#The effect of haplotype alone (controlling for timepoint) is not significant p=0.065
anova(rda(poc_data_afdw_log_host[,6:10], poc_data_afdw_log_host$haplotype,  poc_data_afdw_log_host$site))
#The effect of haplotype alone (controlling for site) is significant p=0.702
```

# Symbiont responses
```{r}
data_sym<-master%>%
  select(colony_id_corr, haplotype, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW)

data_sym<-data_sym[complete.cases(data_sym), ]
```

#Log+1 transform all responses
```{r}
data_sym_log <-data_sym
data_sym_log[,-c(1:5)]<-log(data_sym_log[,-c(1:5)]+1)

#change timepoint to a factor 
data_sym_log$timepoint<-as.factor(data_sym_log$timepoint)

#change species to a factor 
data_sym_log$species<-as.factor(data_sym_log$species)

#change species to a factor 
data_sym_log$haplotype<-as.factor(data_sym_log$haplotype)
```

#Acropora- Sym  
```{r}
acr_data_afdw_log_sym<-data_sym_log%>%
  filter(species=="Acropora")%>%
  droplevels()

acr_data_afdw_log_sym<-acr_data_afdw_log_sym[complete.cases(acr_data_afdw_log_sym), ]
```


##Variance Partitioning
```{r}
##Run varpart function with responses and explanatory variables of interest
varpart_acr_afdw_sym<-varpart(acr_data_afdw_log_sym[,6:14], acr_data_afdw_log_sym$timepoint, acr_data_afdw_log_sym$site)

##Check variance explained by individual fractions
varpart_acr_afdw_sym$part
#Individual fractions                                    
#[a] = X1|X2           3                 0.39240     TRUE
#[b] = X2|X1           2                 0.02463     TRUE
#[c]                   0                -0.01089    FALSE
#[d] = Residuals                         0.59386    FALSE

##Check model significance
anova(rda(acr_data_afdw_log_sym[,6:14]~ acr_data_afdw_log_sym$timepoint + acr_data_afdw_log_sym$site))
#The model is significant p=0.001

##Check variance explained by model
RsquareAdj(rda(acr_data_afdw_log_sym[,6:14]~ acr_data_afdw_log_sym$timepoint + acr_data_afdw_log_sym$site))$adj.r.squared*100
#The model explains 40.61% of the variation in coral physiology in Acropora Symbiont

##Check effect of timepoint 
anova(rda(acr_data_afdw_log_sym[,6:14], acr_data_afdw_log_sym$timepoint))
#The effect of timepoint with overlap with site is significant p=0.001 
anova(rda(acr_data_afdw_log_sym[,6:14], acr_data_afdw_log_sym$timepoint,  acr_data_afdw_log_sym$site))
#The effect of timepoint alone (controlling for site) is significant p=0.001 

##Check effect of site 
anova(rda(acr_data_afdw_log_sym[,6:14], acr_data_afdw_log_sym$site))
#The effect of site with overlap with timepoint is not significant p=0.082
anova(rda(acr_data_afdw_log_sym[,6:14], acr_data_afdw_log_sym$site,  acr_data_afdw_log_sym$timepoint))
#The effect of site alone (controlling for timepoint) is significant p=0.004 
```


#Porites- Sym  
```{r}
por_data_afdw_log_sym<-data_sym_log%>%
  filter(species=="Porites")%>%
  droplevels()

por_data_afdw_log_sym<-por_data_afdw_log_sym[complete.cases(por_data_afdw_log_sym), ]
```


##Variance Partitioning
```{r}
##Run varpart function with responses and explanatory variables of interest
varpart_por_afdw_sym<-varpart(por_data_afdw_log_sym[,6:14], por_data_afdw_log_sym$timepoint, por_data_afdw_log_sym$site, por_data_afdw_log_sym$haplotype)

##Check variance explained by individual fractions
varpart_por_afdw_sym$part
#Individual fractions                                   
#[a] = X1 | X2+X3       3               0.18191     TRUE
#[b] = X2 | X1+X3       2               0.04582     TRUE
#[c] = X3 | X1+X2       2               0.05827     TRUE
#[d]                    0               0.00517    FALSE
#[e]                    0               0.08077    FALSE
#[f]                    0               0.00451    FALSE
#[g]                    0               0.00127    FALSE
#[h] = Residuals                        0.62229    FALSE

##Check model significance
anova(rda(por_data_afdw_log_sym[,6:14]~ por_data_afdw_log_sym$timepoint + por_data_afdw_log_sym$site+ por_data_afdw_log_sym$haplotype))
#The model is significant p=0.001

##Check variance explained by model
RsquareAdj(rda(por_data_afdw_log_sym[,6:14]~ por_data_afdw_log_sym$timepoint + por_data_afdw_log_sym$site+ por_data_afdw_log_sym$haplotype))$adj.r.squared*100
#The model explains 37.77% of the variation in coral physiology in Porites Symbiont

##Check effect of timepoint 
anova(rda(por_data_afdw_log_sym[,6:14], por_data_afdw_log_sym$timepoint))
#The effect of timepoint with overlap with site is significant p=0.001 
anova(rda(por_data_afdw_log_sym[,6:14], por_data_afdw_log_sym$timepoint,  por_data_afdw_log_sym$site))
#The effect of timepoint alone (controlling for site) is significant p=0.001 
anova(rda(por_data_afdw_log_sym[,6:14], por_data_afdw_log_sym$timepoint,  por_data_afdw_log_sym$haplotype))


##Check effect of site 
anova(rda(por_data_afdw_log_sym[,6:14], por_data_afdw_log_sym$site))
#The effect of site with overlap with timepoint is significant p=0.001 
anova(rda(por_data_afdw_log_sym[,6:14], por_data_afdw_log_sym$site,  por_data_afdw_log_sym$timepoint))
#The effect of site alone (controlling for timepoint) is significant p=0.001 
anova(rda(por_data_afdw_log_sym[,6:14], por_data_afdw_log_sym$site,  por_data_afdw_log_sym$haplotype))

##Check effect of haplotype 
anova(rda(por_data_afdw_log_sym[,6:14], por_data_afdw_log_sym$haplotype))

anova(rda(por_data_afdw_log_sym[,6:14], por_data_afdw_log_sym$haplotype,  por_data_afdw_log_sym$timepoint))

anova(rda(por_data_afdw_log_sym[,6:14], por_data_afdw_log_sym$haplotype,  por_data_afdw_log_sym$site))
```


#Pocillopora- Sym  
```{r}
poc_data_afdw_log_sym<-data_sym_log%>%
  filter(species=="Pocillopora")%>%
  droplevels()

poc_data_afdw_log_sym<-poc_data_afdw_log_sym[complete.cases(poc_data_afdw_log_sym), ]
```


##Variance Partitioning
```{r}
##Run varpart function with responses and explanatory variables of interest
varpart_poc_afdw_sym<-varpart(poc_data_afdw_log_sym[,6:14], poc_data_afdw_log_sym$timepoint, poc_data_afdw_log_sym$site, poc_data_afdw_log_sym$haplotype)

##Check variance explained by individual fractions
varpart_poc_afdw_sym$part
#Individual fractions                                   
#[a] = X1 | X2+X3       3               0.28012     TRUE
#[b] = X2 | X1+X3       2               0.00647     TRUE
#[c] = X3 | X1+X2       1               0.00443     TRUE
#[d]                    0              -0.00299    FALSE
#[e]                    0              -0.00097    FALSE
#[f]                    0              -0.00263    FALSE
#[g]                    0              -0.00086    FALSE
#[h] = Residuals                        0.71642    FALSE

##Check model significance
anova(rda(poc_data_afdw_log_sym[,6:14]~ poc_data_afdw_log_sym$timepoint + poc_data_afdw_log_sym$site + poc_data_afdw_log_sym$haplotype))
#The model is significant p=0.001

##Check variance explained by model
RsquareAdj(rda(poc_data_afdw_log_sym[,6:14]~ poc_data_afdw_log_sym$timepoint + poc_data_afdw_log_sym$site+ poc_data_afdw_log_sym$site))$adj.r.squared*100
#The model explains 27.91% of the variation in coral physiology in Pocillopora Symbiont

##Check effect of timepoint 
anova(rda(poc_data_afdw_log_sym[,6:14], poc_data_afdw_log_sym$timepoint))
#The effect of timepoint with overlap with site is significant p=0.001 
anova(rda(poc_data_afdw_log_sym[,6:14], poc_data_afdw_log_sym$timepoint,  poc_data_afdw_log_sym$site))
#The effect of timepoint alone (controlling for site) is significant p=0.001 
anova(rda(poc_data_afdw_log_sym[,6:14], poc_data_afdw_log_sym$timepoint,  poc_data_afdw_log_sym$haplotype))

##Check effect of site 
anova(rda(poc_data_afdw_log_sym[,6:14], poc_data_afdw_log_sym$site))
#The effect of site with overlap with timepoint is not significant p=0.346
anova(rda(poc_data_afdw_log_sym[,6:14], poc_data_afdw_log_sym$site,  poc_data_afdw_log_sym$timepoint))
#The effect of site alone (controlling for timepoint) is not significant p=0.156 
anova(rda(poc_data_afdw_log_sym[,6:14], poc_data_afdw_log_sym$site,  poc_data_afdw_log_sym$haplotype))

##Check effect of site 
anova(rda(poc_data_afdw_log_sym[,6:14], poc_data_afdw_log_sym$haplotype))

anova(rda(poc_data_afdw_log_sym[,6:14], poc_data_afdw_log_sym$haplotype,  poc_data_afdw_log_sym$timepoint))

anova(rda(poc_data_afdw_log_sym[,6:14], poc_data_afdw_log_sym$haplotype,  poc_data_afdw_log_sym$site))
```

#Organize Variance Partitioning Results

Note that I am only keeping categories that account for >1% of variance explained. 

```{r}
#varpart_acr_afdw_host
varpart_acr_afdw_host_plot<-data.frame(Parts=c("Season", "Site", "NA", "Residuals"), 
                            Variance=c(varpart_acr_afdw_host$part$indfract$Adj.R.square))
varpart_acr_afdw_host_plot$PercVar<-paste(as.character(round(varpart_acr_afdw_host_plot$Variance*100,2)), "%", sep="")
varpart_acr_afdw_host_plot$PercVar[which(varpart_acr_afdw_host_plot$Variance<0)]<-NA
varpart_acr_afdw_host_plot$Species<-rep("Acropora", nrow(varpart_acr_afdw_host_plot))
rows_to_keep <- c(1, 2, 4)
varpart_acr_afdw_host_plot <- varpart_acr_afdw_host_plot[rows_to_keep, ]

#varpart_por_afdw_host
varpart_por_afdw_host_plot<-data.frame(Parts=c("Season", "Site", "Haplotype", "NA", "Site&Haplotype", "NA", "NA", "Residuals"), 
                            Variance=c(varpart_por_afdw_host$part$indfract$Adj.R.square))
varpart_por_afdw_host_plot$PercVar<-paste(as.character(round(varpart_por_afdw_host_plot$Variance*100,2)), "%", sep="")
varpart_por_afdw_host_plot$PercVar[which(varpart_por_afdw_host_plot$Variance<0)]<-NA
varpart_por_afdw_host_plot$Species<-rep("Porites", nrow(varpart_por_afdw_host_plot))

rows_to_keep <- c(1, 2, 3, 5, 8)
varpart_por_afdw_host_plot <- varpart_por_afdw_host_plot[rows_to_keep, ]

#varpart_poc_afdw_host
varpart_poc_afdw_host_plot<-data.frame(Parts=c("Season", "Site", "Haplotype", "NA", "Site&Haplotype", "NA", "NA", "Residuals"), 
                            Variance=c(varpart_poc_afdw_host$part$indfract$Adj.R.square))
varpart_poc_afdw_host_plot$PercVar<-paste(as.character(round(varpart_poc_afdw_host_plot$Variance*100,2)), "%", sep="")
varpart_poc_afdw_host_plot$PercVar[which(varpart_poc_afdw_host_plot$Variance<0)]<-NA
varpart_poc_afdw_host_plot$Species<-rep("Pocillopora", nrow(varpart_poc_afdw_host_plot))

rows_to_keep <- c(1, 2, 5, 8)
varpart_poc_afdw_host_plot <- varpart_poc_afdw_host_plot[rows_to_keep, ]

```

Host data frames: 
varpart_acr_afdw_host_plot
varpart_por_afdw_host_plot
varpart_poc_afdw_host_plot

Plot host data 

```{r}
##Combine VarPart results for all Species
varpart_afdw_host_all<-rbind(varpart_acr_afdw_host_plot, varpart_por_afdw_host_plot, varpart_poc_afdw_host_plot)

varpart_afdw_host_all<-na.omit(varpart_afdw_host_all)
varpart_afdw_host_all$Response<-rep("Host", nrow(varpart_afdw_host_all))
varpart_afdw_host_all$Percent<-round(varpart_afdw_host_all$Variance*100,2)
varpart_afdw_host_all$Parts<-factor(varpart_afdw_host_all$Parts)

names(varpart_afdw_host_all)

varpart_afdw_host_all$Parts<-factor(varpart_afdw_host_all$Parts, levels=c("Haplotype", "Site&Haplotype", "Site", "Season", "Residuals"))

varpartBarplot_all.host<-ggplot(varpart_afdw_host_all, aes(x=Species, y=Percent, fill=Parts)) + 
  geom_bar(position="stack", stat="identity", colour="black")+
  scale_fill_manual(name="Predictors", values = c("lightblue4", "lightblue2", "cyan2", "purple2", "gray"),)+
  theme_classic()+
  theme(axis.title.x = element_text(size = 18), axis.title.y = element_text(size = 18), 
        axis.text.x=element_text(size=14, colour="black"), axis.text.y=element_text(size=14, colour="black"), 
        legend.text=element_text(size=12), legend.title=element_text(size=15))+
  ylab("% Variance Explained")+
  geom_text(aes(label=paste0(sprintf("%1.1f",Percent),"%"), fontface = "bold"),
            position=position_stack(vjust=0.5), size=5, color="black")+
  theme(plot.title=element_text(hjust=0.5), 
        axis.text.x=element_text(face="italic", color="black"), 
        axis.text.y=element_text(color="black"), 
        axis.title = element_text(face="bold"), 
        legend.title=element_text(face="bold"));varpartBarplot_all.host

ggsave(varpartBarplot_all.host, file="Figures/Multivariate/VarPart_Host.png", width=6, height=6.5)
ggsave(varpartBarplot_all.host, file="Figures/Multivariate/VarPart_Host.jpg", width=6, height=6.5)
ggsave(varpartBarplot_all.host, file="Figures/Multivariate/VarPart_Host.pdf", width=6, height=6.5)
```

Symbiont data frames and ploting 

```{r}
#varpart_acr_afdw_sym
varpart_acr_afdw_sym_plot<-data.frame(Parts=c("Season", "Site", "NA", "Residuals"), 
                            Variance=c(varpart_acr_afdw_sym$part$indfract$Adj.R.square))
varpart_acr_afdw_sym_plot$PercVar<-paste(as.character(round(varpart_acr_afdw_sym_plot$Variance*100,2)), "%", sep="")
varpart_acr_afdw_sym_plot$PercVar[which(varpart_acr_afdw_sym_plot$Variance<0)]<-NA
varpart_acr_afdw_sym_plot$Species<-rep("Acropora", nrow(varpart_acr_afdw_sym_plot))
rows_to_keep <- c(1, 2, 4)
varpart_acr_afdw_sym_plot <- varpart_acr_afdw_sym_plot[rows_to_keep, ]

#varpart_por_afdw_sym
varpart_por_afdw_sym_plot<-data.frame(Parts=c("Season", "Site", "Haplotype", "NA", "Site&Haplotype", "NA", "NA", "Residuals"), 
                            Variance=c(varpart_por_afdw_sym$part$indfract$Adj.R.square))
varpart_por_afdw_sym_plot$PercVar<-paste(as.character(round(varpart_por_afdw_sym_plot$Variance*100,2)), "%", sep="")
varpart_por_afdw_sym_plot$PercVar[which(varpart_por_afdw_sym_plot$Variance<0)]<-NA
varpart_por_afdw_sym_plot$Species<-rep("Porites", nrow(varpart_por_afdw_sym_plot))

rows_to_keep <- c(1, 2, 3, 5, 8)
varpart_por_afdw_sym_plot <- varpart_por_afdw_sym_plot[rows_to_keep, ]

#varpart_poc_afdw_sym
varpart_poc_afdw_sym_plot<-data.frame(Parts=c("Season", "Site", "Haplotype", "NA", "Site&Haplotype", "NA", "NA", "Residuals"), 
                            Variance=c(varpart_poc_afdw_sym$part$indfract$Adj.R.square))
varpart_poc_afdw_sym_plot$PercVar<-paste(as.character(round(varpart_poc_afdw_sym_plot$Variance*100,2)), "%", sep="")
varpart_poc_afdw_sym_plot$PercVar[which(varpart_poc_afdw_sym_plot$Variance<0)]<-NA
varpart_poc_afdw_sym_plot$Species<-rep("Pocillopora", nrow(varpart_poc_afdw_sym_plot))

rows_to_keep <- c(1, 2, 3, 8)
varpart_poc_afdw_sym_plot <- varpart_poc_afdw_sym_plot[rows_to_keep, ]
```

Plot symbiont data 

```{r}
##Combine VarPart results for all Species
varpart_afdw_sym_all<-rbind(varpart_acr_afdw_sym_plot, varpart_por_afdw_sym_plot, varpart_poc_afdw_sym_plot)

varpart_afdw_sym_all<-na.omit(varpart_afdw_sym_all)
varpart_afdw_sym_all$Response<-rep("Symbiont", nrow(varpart_afdw_sym_all))
varpart_afdw_sym_all$Percent<-round(varpart_afdw_sym_all$Variance*100,2)
varpart_afdw_sym_all$Parts<-factor(varpart_afdw_sym_all$Parts)

names(varpart_afdw_sym_all)

varpart_afdw_sym_all$Parts<-factor(varpart_afdw_sym_all$Parts, levels=c("Haplotype", "Site&Haplotype", "Site", "Season", "Residuals"))

varpartBarplot_all.sym<-ggplot(varpart_afdw_sym_all, aes(x=Species, y=Percent, fill=Parts)) + 
  geom_bar(position="stack", stat="identity", colour="black")+
  scale_fill_manual(name="Predictors", values = c("lightblue4", "lightblue2", "cyan2", "purple2", "gray"),)+
  theme_classic()+
  theme(axis.title.x = element_text(size = 18), axis.title.y = element_text(size = 18), 
        axis.text.x=element_text(size=14, colour="black"), axis.text.y=element_text(size=14, colour="black"), 
        legend.text=element_text(size=12), legend.title=element_text(size=15))+
  ylab("% Variance Explained")+
  geom_text(aes(label=paste0(sprintf("%1.1f",Percent),"%"), fontface = "bold"),
            position=position_stack(vjust=0.5), size=5, color="black")+
  theme(plot.title=element_text(hjust=0.5), 
        axis.text.x=element_text(face="italic", color="black"), 
        axis.text.y=element_text(color="black"), 
        axis.title = element_text(face="bold"), 
        legend.title=element_text(face="bold"));varpartBarplot_all.sym

ggsave(varpartBarplot_all.sym, file="Figures/Multivariate/VarPart_Sym.png", width=6, height=6.5)
ggsave(varpartBarplot_all.sym, file="Figures/Multivariate/VarPart_Sym.jpg", width=6, height=6.5)
ggsave(varpartBarplot_all.sym, file="Figures/Multivariate/VarPart_Sym.pdf", width=6, height=6.5)
```

Arrange all in one plot
```{r}
varpartBarplot_all.sym2<-varpartBarplot_all.sym+theme(legend.position="right")
varpartBarplot_all.host2<-varpartBarplot_all.host+theme(legend.position="none")
varpartBarplot_all.holo2<-varpartBarplot_all.holo+theme(legend.position="none")

library(cowplot)
all.plots<-plot_grid(varpartBarplot_all.holo2, varpartBarplot_all.host2, varpartBarplot_all.sym2, ncol=3, rel_widths = c(0.8,0.8,1), labels =c("Holobiont", "Host", "Symbiont"), label_y=0.99, vjust=1, label_x=0.4)

ggsave(all.plots, file="Figures/Multivariate/VarPart_Panel.png", width=15, height=6.5)

```

