---
title: "Variance partitioning analysis"
author: "Ariana S Huffmyer, Serena Hackerott, E5 RoL Team"
date: "05/09/2023"
output: 
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
editor_options: 
  chunk_output_type: console
--- 

# Set Up    
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

```{r}
## install packages if you dont already have them
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("vegan")) install.packages("vegan")
if (!require("ggplot2")) install.packages("ggplot2")

# load packages
library(tidyverse)
library(vegan)
library(ggplot2)
```

# Load dataframe

Load in master dataframe generated from 1_assemble_data.Rmd.  
```{r}
master<-read.csv("Output/master_timeseries.csv")

#reorder site levels 
master$site_code<-as.factor(master$site_code)
master$site_code<-fct_relevel(master$site_code, "Mahana Low", "Hilton Medium", "Manava High")
```

#Phys matrix: master_timeseries.csv
#Temp matrix: Clean_Environmental_Temp_Means.csv


# Holobiont responses   
```{r}
data_all<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd, calc.umol.cm2.hr, Total_Chl, Total_Chl_cell)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)
```

#Log+1 transform all responses
```{r}
data_all_log <-data_all
data_all_log[,-c(1:4)]<-log(data_all_log[,-c(1:4)]+1)

#change timepoint to a factor 
data_all_log$timepoint<-as.factor(data_all_log$timepoint)

#change species to a factor 
data_all_log$species<-as.factor(data_all_log$species)
```


#Acropora  
```{r}
acr_data_afdw_log<-data_all_log%>%
  filter(species=="Acropora")

acr_data_afdw_log<-acr_data_afdw_log[complete.cases(acr_data_afdw_log), ]
```


##Variance Partitioning
```{r}
##Run varpart function with responses and explanatory variables of interest
varpart_acr_afdw<-varpart(acr_data_afdw_log[,5:15], acr_data_afdw_log$timepoint, acr_data_afdw_log$site_code)

##Check variance explained by individual fractions
varpart_acr_afdw$part
# Individual fractions                                    
# [a] = X1|X2           3                 0.46922     TRUE
# [b]                   0                -0.00386    FALSE
# [c] = X2|X1           2                 0.03321     TRUE
# [d] = Residuals                         0.50143    FALSE

##Check model significance
anova(rda(acr_data_afdw_log[,5:15]~ acr_data_afdw_log$timepoint + acr_data_afdw_log$site_code))
#The model is significant p=0.001

##Check variance explained by model
RsquareAdj(rda(acr_data_afdw_log[,5:15]~ acr_data_afdw_log$timepoint + acr_data_afdw_log$site_code))$adj.r.squared*100
#The model explains 49.86% of the variation in coral physiology in Acropora

##Check effect of timepoint 
anova(rda(acr_data_afdw_log[,5:15], acr_data_afdw_log$timepoint))
#The effect of timepoint with overlap with site is significant p=0.001 
anova(rda(acr_data_afdw_log[,5:15], acr_data_afdw_log$timepoint,  acr_data_afdw_log$site_code))
#The effect of timepoint alone (controlling for site) is significant p=0.001 

##Check effect of site 
anova(rda(acr_data_afdw_log[,5:15], acr_data_afdw_log$site_code))
#The effect of site with overlap with timepoint is significant p=0.039 
anova(rda(acr_data_afdw_log[,5:15], acr_data_afdw_log$site_code,  acr_data_afdw_log$timepoint))
#The effect of site alone (controlling for timepoint) is significant p=0.002 
```

##Generate figure-Venn
```{r}
par(bty="n")

varpart_acr_afdw_parts<-data.frame(Parts=c("Season", "Seas&Site", "Site","Residuals"), 
                            Variance=c(varpart_acr_afdw$part$indfract$Adj.R.square))
varpart_acr_afdw_parts$PercVar<-paste(as.character(round(varpart_acr_afdw_parts$Variance*100,2)), "%", sep="")
varpart_acr_afdw_parts$PercVar[which(varpart_acr_afdw_parts$Variance<0)]<-NA
varpart_acr_afdw_parts$Species<-rep("Acropora", nrow(varpart_acr_afdw_parts))

showvarparts(parts=2, labels=varpart_acr_afdw_parts$PercVar, Xnames=NULL, 
             cex=c(1.4, 1.4, 1.4, 1, 1, 1.2), 
             bg=c("#4681F7FF", "#18DEC1FF"), alpha=125)+
text(-0.1, .4, "Season", cex=2)+
text(1, 0.4, "Site", cex=2)+
text(0, -.3, substitute(paste(italic('p = 0.001'))), cex=1.1)+
text(1, -.3, substitute(paste(italic('p = 0.002'))), cex=1.1)+
text(0.5, 1, "Acropora", cex=2)
```



#Porites
```{r}
por_data_afdw_log<-data_all_log%>%
  filter(species=="Porites")

por_data_afdw_log<-por_data_afdw_log[complete.cases(por_data_afdw_log), ]
```

##Variance Partitioning
```{r}
##Run varpart function with responses and explanatory variables of interest
varpart_por_afdw<-varpart(por_data_afdw_log[,5:15], por_data_afdw_log$timepoint, por_data_afdw_log$site_code)

##Check variance explained by individual fractions
varpart_por_afdw$part
# Individual fractions                                    
# [a] = X1|X2           3                 0.21670     TRUE
# [b]                   0                -0.00002    FALSE
# [c] = X2|X1           2                 0.14138     TRUE
# [d] = Residuals                         0.64193    FALSE

##Check model significance
anova(rda(por_data_afdw_log[,5:15]~ por_data_afdw_log$timepoint + por_data_afdw_log$site_code))
#The model is significant p=0.001

##Check variance explained by model
RsquareAdj(rda(por_data_afdw_log[,5:15]~ por_data_afdw_log$timepoint + por_data_afdw_log$site_code))$adj.r.squared*100
#The model explains 35.81% of the variation in coral physiology in Acropora

##Check effect of timepoint 
anova(rda(por_data_afdw_log[,5:15], por_data_afdw_log$timepoint))
#The effect of timepoint with overlap with site_code is significant p=0.001 
anova(rda(por_data_afdw_log[,5:15], por_data_afdw_log$timepoint,  por_data_afdw_log$site_code))
#The effect of timepoint alone (controlling for site_code) is significant p=0.001 

##Check effect of site 
anova(rda(por_data_afdw_log[,5:15], por_data_afdw_log$site_code))
#The effect of site with overlap with timepoint is significant p=0.001
anova(rda(por_data_afdw_log[,5:15], por_data_afdw_log$site_code,  por_data_afdw_log$timepoint))
#The effect of site alone (controlling for timepoint) is significant p=0.001 

```

##Generate figure- Venn
```{r}
par(bty="n")

varpart_por_afdw_parts<-data.frame(Parts=c("Season", "Seas&Site", "Site","Residuals"), 
                            Variance=c(varpart_por_afdw$part$indfract$Adj.R.square))
varpart_por_afdw_parts$PercVar<-paste(as.character(round(varpart_por_afdw_parts$Variance*100,2)), "%", sep="")
varpart_por_afdw_parts$PercVar[which(varpart_por_afdw_parts$Variance<0)]<-NA
varpart_por_afdw_parts$Species<-rep("Porites", nrow(varpart_por_afdw_parts))

showvarparts(parts=2, labels=varpart_por_afdw_parts$PercVar, Xnames=NULL, 
             cex=c(1.4, 1.4, 1.4, 1, 1, 1.2), 
             bg=c("#4681F7FF", "#18DEC1FF"), alpha=125)+
text(-0.1, .4, "Season", cex=2)+
text(1, 0.4, "Site", cex=2)+
text(0, -.3, substitute(paste(italic('p = 0.001'))), cex=1.1)+
text(1, -.3, substitute(paste(italic('p = 0.001'))), cex=1.1)+
text(0.5, 1, "Porites", cex=2)
```


#Pocillopora   
```{r}
poc_data_afdw_log<-data_all_log%>%
  filter(species=="Pocillopora")

poc_data_afdw_log<-poc_data_afdw_log[complete.cases(poc_data_afdw_log), ]
```

##Variance Partitioning
```{r}
##Run varpart function with responses and explanatory variables of interest
varpart_poc_afdw<-varpart(poc_data_afdw_log[,5:15], poc_data_afdw_log$timepoint, poc_data_afdw_log$site_code)

##Check variance explained by individual fractions
varpart_poc_afdw$part
# Individual fractions                                    
# [a] = X1|X2           3                 0.34560     TRUE
# [b]                   0                -0.00164    FALSE
# [c] = X2|X1           2                 0.02397     TRUE
# [d] = Residuals                         0.63207    FALSE

##Check model significance
anova(rda(poc_data_afdw_log[,5:15]~ poc_data_afdw_log$timepoint + poc_data_afdw_log$site_code))
#The model is significant p=0.001

##Check variance explained by model
RsquareAdj(rda(poc_data_afdw_log[,5:15]~ poc_data_afdw_log$timepoint + poc_data_afdw_log$site_code))$adj.r.squared*100
#The model explains 36.79% of the variation in coral physiology in Acropora

##Check effect of timepoint 
anova(rda(poc_data_afdw_log[,5:15], poc_data_afdw_log$timepoint))
#The effect of timepoint with overlap with site_code is significant p=0.001 
anova(rda(poc_data_afdw_log[,5:15], poc_data_afdw_log$timepoint,  poc_data_afdw_log$site_code))
#The effect of timepoint alone (controlling for site_code) is significant p=0.001 

##Check effect of site 
anova(rda(poc_data_afdw_log[,5:15], poc_data_afdw_log$site_code))
#The effect of site with overlap with timepoint is not significant p=0.052 .
anova(rda(poc_data_afdw_log[,5:15], poc_data_afdw_log$site_code,  poc_data_afdw_log$timepoint))
#The effect of site alone (controlling for timepoint) is significant p=0.008 

```

##Generate figure- Venn
```{r}
par(bty="n")

varpart_poc_afdw_parts<-data.frame(Parts=c("Season", "Seas&Site", "Site","Residuals"), 
                            Variance=c(varpart_poc_afdw$part$indfract$Adj.R.square))
varpart_poc_afdw_parts$PercVar<-paste(as.character(round(varpart_poc_afdw_parts$Variance*100,2)), "%", sep="")
varpart_poc_afdw_parts$PercVar[which(varpart_poc_afdw_parts$Variance<0)]<-NA
varpart_poc_afdw_parts$Species<-rep("Pocillopora", nrow(varpart_poc_afdw_parts))

showvarparts(parts=2, labels=varpart_poc_afdw_parts$PercVar, Xnames=NULL, 
             cex=c(1.4, 1.4, 1.4, 1, 1, 1.2), 
             bg=c("#4681F7FF", "#18DEC1FF"), alpha=125)+
text(-0.1, .4, "Season", cex=2)+
text(1, 0.4, "Site", cex=2)+
text(0, -.3, substitute(paste(italic('p = 0.001'))), cex=1.1)+
text(1, -.3, substitute(paste(italic('p = 0.008'))), cex=1.1)+
text(0.5, 1, "Pocillopora", cex=2)
```


#Generate figure- Barplot all Species Holobiont

Note: Ariana added manual name for "Site", since it was coming up as NA
```{r}
##Combine VarPart results for all Species
varpart_afdw_parts_all<-rbind(varpart_acr_afdw_parts, varpart_por_afdw_parts, varpart_poc_afdw_parts)
varpart_afdw_parts_all<-na.omit(varpart_afdw_parts_all)
varpart_afdw_parts_all$Response<-rep("Holobiont", nrow(varpart_afdw_parts_all))
varpart_afdw_parts_all$Percent<-round(varpart_afdw_parts_all$Variance*100,2)
varpart_afdw_parts_all$Parts<-factor(varpart_afdw_parts_all$Parts, levels=c("Seas&Site", "Season", "Residuals"), ordered=TRUE)

names(varpart_afdw_parts_all)

varpartBarplot_all.holo<-ggplot(varpart_afdw_parts_all, aes(x=Species, y=Percent, fill=Parts)) + 
  geom_bar(position="stack", stat="identity", colour="black")+
  scale_fill_manual(name="Predictors", values = c("white", "lightgray", "darkgray"), labels = c("Site", "Season", "Residuals"))+
  theme_classic()+
  theme(axis.title.x = element_text(size = 18), axis.title.y = element_text(size = 18), 
        axis.text.x=element_text(size=14, colour="black"), axis.text.y=element_text(size=14, colour="black"), 
        legend.text=element_text(size=12), legend.title=element_text(size=15))+
  ylab("% Variance Explained")+
  geom_text(aes(label=paste0(sprintf("%1.1f",Percent),"%"), fontface = "bold"),
            position=position_stack(vjust=0.5), size=5.5)+
  theme(plot.title=element_text(hjust=0.5), 
        axis.text.x=element_text(face="italic", color="black"), 
        axis.text.y=element_text(color="black"), 
        axis.title = element_text(face="bold"), 
        legend.title=element_text(face="bold"));varpartBarplot_all.holo

ggsave(varpartBarplot_all.holo, file="Figures/Multivariate/VarPart_All_Holobiont.png", width=6, height=8)



```



#Note-Can continue with host vs symbiont responses 

# Generate a list of symbiont and host responses.  Holobiont = all responses
```{r}
symbiont_responses<-c("cells.mgAFDW", "Sym_AFDW.mg.cm2", "Total_Chl", "Total_Chl_cell", "Am", "AQY", "Ratio_AFDW.mg.cm2") 
host_responses<-c("cre.umol.mgafdw", "Host_AFDW.mg.cm2", "prot_mg.mgafdw", "Rd", "calc.umol.cm2.hr")
```

# Host responses
```{r}
data_host<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(host_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)

data_host<-data_host[complete.cases(data_host), ]
```


#Log+1 transform all responses
```{r}
data_host_log <-data_host
data_host_log[,-c(1:4)]<-log(data_host_log[,-c(1:4)]+1)

#change timepoint to a factor 
data_host_log$timepoint<-as.factor(data_host_log$timepoint)

#change species to a factor 
data_host_log$species<-as.factor(data_host_log$species)
```


#Acropora- Host  
```{r}
acr_data_afdw_log_host<-data_host_log%>%
  filter(species=="Acropora")

acr_data_afdw_log_host<-acr_data_afdw_log_host[complete.cases(acr_data_afdw_log_host), ]
```


##Variance Partitioning
```{r}
##Run varpart function with responses and explanatory variables of interest
varpart_acr_afdw_host<-varpart(acr_data_afdw_log_host[,5:9], acr_data_afdw_log_host$timepoint, acr_data_afdw_log_host$site_code)

##Check variance explained by individual fractions
varpart_acr_afdw_host$part
# Individual fractions                                    
# [a] = X1|X2           3                 0.29205     TRUE
# [b]                   0                -0.01334    FALSE
# [c] = X2|X1           2                 0.07553     TRUE
# [d] = Residuals                         0.64576    FALSE

##Check model significance
anova(rda(acr_data_afdw_log_host[,5:9]~ acr_data_afdw_log_host$timepoint + acr_data_afdw_log_host$site_code))
#The model is significant p=0.001

##Check variance explained by model
RsquareAdj(rda(acr_data_afdw_log_host[,5:9]~ acr_data_afdw_log_host$timepoint + acr_data_afdw_log_host$site_code))$adj.r.squared*100
#The model explains 35.42% of the variation in coral physiology in Acropora Host

##Check effect of timepoint 
anova(rda(acr_data_afdw_log_host[,5:9], acr_data_afdw_log_host$timepoint))
#The effect of timepoint with overlap with site is significant p=0.001 
anova(rda(acr_data_afdw_log_host[,5:9], acr_data_afdw_log_host$timepoint,  acr_data_afdw_log_host$site_code))
#The effect of timepoint alone (controlling for site) is significant p=0.001 

##Check effect of site 
anova(rda(acr_data_afdw_log_host[,5:9], acr_data_afdw_log_host$site_code))
#The effect of site with overlap with timepoint is significant p=0.002 
anova(rda(acr_data_afdw_log_host[,5:9], acr_data_afdw_log_host$site_code,  acr_data_afdw_log_host$timepoint))
#The effect of site alone (controlling for timepoint) is significant p=0.001 
```


#Porites- Host  
```{r}
por_data_afdw_log_host<-data_host_log%>%
  filter(species=="Porites")

por_data_afdw_log_host<-por_data_afdw_log_host[complete.cases(por_data_afdw_log_host), ]
```


##Variance Partitioning
```{r}
##Run varpart function with responses and explanatory variables of interest
varpart_por_afdw_host<-varpart(por_data_afdw_log_host[,5:9], por_data_afdw_log_host$timepoint, por_data_afdw_log_host$site_code)

##Check variance explained by individual fractions
varpart_por_afdw_host$part
# Individual fractions                                    
# [a] = X1|X2           3                 0.28365     TRUE
# [b]                   0                -0.00947    FALSE
# [c] = X2|X1           2                 0.05387     TRUE
# [d] = Residuals                         0.67195    FALSE

##Check model significance
anova(rda(por_data_afdw_log_host[,5:9]~ por_data_afdw_log_host$timepoint + por_data_afdw_log_host$site_code))
#The model is significant p=0.001

##Check variance explained by model
RsquareAdj(rda(por_data_afdw_log_host[,5:9]~ por_data_afdw_log_host$timepoint + por_data_afdw_log_host$site_code))$adj.r.squared*100
#The model explains 32.81% of the variation in coral physiology in Porites Host

##Check effect of timepoint 
anova(rda(por_data_afdw_log_host[,5:9], por_data_afdw_log_host$timepoint))
#The effect of timepoint with overlap with site is significant p=0.001 
anova(rda(por_data_afdw_log_host[,5:9], por_data_afdw_log_host$timepoint,  por_data_afdw_log_host$site_code))
#The effect of timepoint alone (controlling for site) is significant p=0.001 

##Check effect of site 
anova(rda(por_data_afdw_log_host[,5:9], por_data_afdw_log_host$site_code))
#The effect of site with overlap with timepoint is significant p=0.001 
anova(rda(por_data_afdw_log_host[,5:9], por_data_afdw_log_host$site_code,  por_data_afdw_log_host$timepoint))
#The effect of site alone (controlling for timepoint) is significant p=0.001 
```


#Pocillopora- Host  
```{r}
poc_data_afdw_log_host<-data_host_log%>%
  filter(species=="Pocillopora")

poc_data_afdw_log_host<-poc_data_afdw_log_host[complete.cases(poc_data_afdw_log_host), ]
```


##Variance Partitioning
```{r}
##Run varpart function with responses and explanatory variables of interest
varpart_poc_afdw_host<-varpart(poc_data_afdw_log_host[,5:9], poc_data_afdw_log_host$timepoint, poc_data_afdw_log_host$site_code)

##Check variance explained by individual fractions
varpart_poc_afdw_host$part
# Individual fractions                                    
# [a] = X1|X2           3                 0.18676     TRUE
# [b]                   0                 0.00312    FALSE
# [c] = X2|X1           2                 0.04170     TRUE
# [d] = Residuals                         0.76842    FALSE

##Check model significance
anova(rda(poc_data_afdw_log_host[,5:9]~ poc_data_afdw_log_host$timepoint + poc_data_afdw_log_host$site_code))
#The model is significant p=0.001

##Check variance explained by model
RsquareAdj(rda(poc_data_afdw_log_host[,5:9]~ poc_data_afdw_log_host$timepoint + poc_data_afdw_log_host$site_code))$adj.r.squared*100
#The model explains 23.16% of the variation in coral physiology in Pocillopora Host

##Check effect of timepoint 
anova(rda(poc_data_afdw_log_host[,5:9], poc_data_afdw_log_host$timepoint))
#The effect of timepoint with overlap with site is significant p=0.001 
anova(rda(poc_data_afdw_log_host[,5:9], poc_data_afdw_log_host$timepoint,  poc_data_afdw_log_host$site_code))
#The effect of timepoint alone (controlling for site) is significant p=0.001 

##Check effect of site 
anova(rda(poc_data_afdw_log_host[,5:9], poc_data_afdw_log_host$site_code))
#The effect of site with overlap with timepoint is significant p=0.003 
anova(rda(poc_data_afdw_log_host[,5:9], poc_data_afdw_log_host$site_code,  poc_data_afdw_log_host$timepoint))
#The effect of site alone (controlling for timepoint) is significant p=0.002 
```




# Symbiont responses
```{r}
data_sym<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW)

data_sym<-data_sym[complete.cases(data_sym), ]
```


#Log+1 transform all responses
```{r}
data_sym_log <-data_sym
data_sym_log[,-c(1:4)]<-log(data_sym_log[,-c(1:4)]+1)

#change timepoint to a factor 
data_sym_log$timepoint<-as.factor(data_sym_log$timepoint)

#change species to a factor 
data_sym_log$species<-as.factor(data_sym_log$species)
```


#Acropora- Sym  
```{r}
acr_data_afdw_log_sym<-data_sym_log%>%
  filter(species=="Acropora")

acr_data_afdw_log_sym<-acr_data_afdw_log_sym[complete.cases(acr_data_afdw_log_sym), ]
```


##Variance Partitioning
```{r}
##Run varpart function with responses and explanatory variables of interest
varpart_acr_afdw_sym<-varpart(acr_data_afdw_log_sym[,5:11], acr_data_afdw_log_sym$timepoint, acr_data_afdw_log_sym$site_code)

##Check variance explained by individual fractions
varpart_acr_afdw_sym$part
# Individual fractions                                    
# [a] = X1|X2           3                 0.47803     TRUE
# [b]                   0                -0.00570    FALSE
# [c] = X2|X1           2                 0.02526     TRUE
# [d] = Residuals                         0.50242    FALSE

##Check model significance
anova(rda(acr_data_afdw_log_sym[,5:11]~ acr_data_afdw_log_sym$timepoint + acr_data_afdw_log_sym$site_code))
#The model is significant p=0.001

##Check variance explained by model
RsquareAdj(rda(acr_data_afdw_log_sym[,5:11]~ acr_data_afdw_log_sym$timepoint + acr_data_afdw_log_sym$site_code))$adj.r.squared*100
#The model explains 49.76% of the variation in coral physiology in Acropora Symbiont

##Check effect of timepoint 
anova(rda(acr_data_afdw_log_sym[,5:11], acr_data_afdw_log_sym$timepoint))
#The effect of timepoint with overlap with site is significant p=0.001 
anova(rda(acr_data_afdw_log_sym[,5:11], acr_data_afdw_log_sym$timepoint,  acr_data_afdw_log_sym$site_code))
#The effect of timepoint alone (controlling for site) is significant p=0.001 

##Check effect of site 
anova(rda(acr_data_afdw_log_sym[,5:11], acr_data_afdw_log_sym$site_code))
#The effect of site with overlap with timepoint is not significant p=0.102 
anova(rda(acr_data_afdw_log_sym[,5:11], acr_data_afdw_log_sym$site_code,  acr_data_afdw_log_sym$timepoint))
#The effect of site alone (controlling for timepoint) is significant p=0.005 
```


#Porites- Sym  
```{r}
por_data_afdw_log_sym<-data_sym_log%>%
  filter(species=="Porites")

por_data_afdw_log_sym<-por_data_afdw_log_sym[complete.cases(por_data_afdw_log_sym), ]
```


##Variance Partitioning
```{r}
##Run varpart function with responses and explanatory variables of interest
varpart_por_afdw_sym<-varpart(por_data_afdw_log_sym[,5:11], por_data_afdw_log_sym$timepoint, por_data_afdw_log_sym$site_code)

##Check variance explained by individual fractions
varpart_por_afdw_sym$part
# Individual fractions                                    
# [a] = X1|X2           3                 0.19056     TRUE
# [b]                   0                 0.00508    FALSE
# [c] = X2|X1           2                 0.18217     TRUE
# [d] = Residuals                         0.62218    FALSE

##Check model significance
anova(rda(por_data_afdw_log_sym[,5:11]~ por_data_afdw_log_sym$timepoint + por_data_afdw_log_sym$site_code))
#The model is significant p=0.001

##Check variance explained by model
RsquareAdj(rda(por_data_afdw_log_sym[,5:11]~ por_data_afdw_log_sym$timepoint + por_data_afdw_log_sym$site_code))$adj.r.squared*100
#The model explains 37.78% of the variation in coral physiology in Porites Symbiont

##Check effect of timepoint 
anova(rda(por_data_afdw_log_sym[,5:11], por_data_afdw_log_sym$timepoint))
#The effect of timepoint with overlap with site is significant p=0.001 
anova(rda(por_data_afdw_log_sym[,5:11], por_data_afdw_log_sym$timepoint,  por_data_afdw_log_sym$site_code))
#The effect of timepoint alone (controlling for site) is significant p=0.001 

##Check effect of site 
anova(rda(por_data_afdw_log_sym[,5:11], por_data_afdw_log_sym$site_code))
#The effect of site with overlap with timepoint is significant p=0.001 
anova(rda(por_data_afdw_log_sym[,5:11], por_data_afdw_log_sym$site_code,  por_data_afdw_log_sym$timepoint))
#The effect of site alone (controlling for timepoint) is significant p=0.001 
```


#Pocillopora- Sym  
```{r}
poc_data_afdw_log_sym<-data_sym_log%>%
  filter(species=="Pocillopora")

poc_data_afdw_log_sym<-poc_data_afdw_log_sym[complete.cases(poc_data_afdw_log_sym), ]
```


##Variance Partitioning
```{r}
##Run varpart function with responses and explanatory variables of interest
varpart_poc_afdw_sym<-varpart(poc_data_afdw_log_sym[,5:11], poc_data_afdw_log_sym$timepoint, poc_data_afdw_log_sym$site_code)

##Check variance explained by individual fractions
varpart_poc_afdw_sym$part
# Individual fractions                                    
# [a] = X1|X2           3                 0.35366     TRUE
# [b]                   0                -0.00272    FALSE
# [c] = X2|X1           2                 0.01758     TRUE
# [d] = Residuals                         0.63148    FALSE

##Check model significance
anova(rda(poc_data_afdw_log_sym[,5:11]~ poc_data_afdw_log_sym$timepoint + poc_data_afdw_log_sym$site_code))
#The model is significant p=0.001

##Check variance explained by model
RsquareAdj(rda(poc_data_afdw_log_sym[,5:11]~ poc_data_afdw_log_sym$timepoint + poc_data_afdw_log_sym$site_code))$adj.r.squared*100
#The model explains 36.85% of the variation in coral physiology in Pocillopora Symbiont

##Check effect of timepoint 
anova(rda(poc_data_afdw_log_sym[,5:11], poc_data_afdw_log_sym$timepoint))
#The effect of timepoint with overlap with site is significant p=0.001 
anova(rda(poc_data_afdw_log_sym[,5:11], poc_data_afdw_log_sym$timepoint,  poc_data_afdw_log_sym$site_code))
#The effect of timepoint alone (controlling for site) is significant p=0.001 

##Check effect of site 
anova(rda(poc_data_afdw_log_sym[,5:11], poc_data_afdw_log_sym$site_code))
#The effect of site with overlap with timepoint is not significant p=0.083 
anova(rda(poc_data_afdw_log_sym[,5:11], poc_data_afdw_log_sym$site_code,  poc_data_afdw_log_sym$timepoint))
#The effect of site alone (controlling for timepoint) is significant p=0.02 
```



#Generate figures Option 1 Barplot by Species- *Need to update here

Note: Ariana added manual name for "Site", since it was coming up as NA
```{r}
##Combine VarPart results for all Species
varpart_afdw_parts_all<-rbind(varpart_acr_afdw_parts, varpart_por_afdw_parts, varpart_poc_afdw_parts)
varpart_afdw_parts_all<-na.omit(varpart_afdw_parts_all)
varpart_afdw_parts_all$Response<-rep("Holobiont", nrow(varpart_afdw_parts_all))
varpart_afdw_parts_all$Percent<-round(varpart_afdw_parts_all$Variance*100,2)
varpart_afdw_parts_all$Parts<-factor(varpart_afdw_parts_all$Parts, levels=c("Seas&Site", "Season", "Residuals"), ordered=TRUE)

names(varpart_afdw_parts_all)

varpartBarplot_all.holo<-ggplot(varpart_afdw_parts_all, aes(x=Species, y=Percent, fill=Parts)) + 
  geom_bar(position="stack", stat="identity", colour="black")+
  scale_fill_manual(name="Predictors", values = c("white", "lightgray", "darkgray"), labels = c("Site", "Season", "Residuals"))+
  theme_classic()+
  theme(axis.title.x = element_text(size = 18), axis.title.y = element_text(size = 18), 
        axis.text.x=element_text(size=14, colour="black"), axis.text.y=element_text(size=14, colour="black"), 
        legend.text=element_text(size=12), legend.title=element_text(size=15))+
  ylab("% Variance Explained")+
  geom_text(aes(label=paste0(sprintf("%1.1f",Percent),"%"), fontface = "bold"),
            position=position_stack(vjust=0.5), size=5.5)+
  theme(plot.title=element_text(hjust=0.5), 
        axis.text.x=element_text(face="italic", color="black"), 
        axis.text.y=element_text(color="black"), 
        axis.title = element_text(face="bold"), 
        legend.title=element_text(face="bold"));varpartBarplot_all.holo

ggsave(varpartBarplot_all.holo, file="Figures/Multivariate/VarPart_All_Holobiont.png", width=6, height=8)



```

