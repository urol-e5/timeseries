---
title: "Plasticity analysis of E5 time series biological data"
author: "Ariana S Huffmyer, E5 RoL Team"
date: "08/22/2022"
output: 
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
editor_options: 
  chunk_output_type: console
--- 

Note: Need to discuss how to handle colonies that we only have information for at some, not all, time points.  

# Set Up     

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

```{r}
## install packages if you dont already have them
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("RColorBrewer")) install.packages("RColorBrewer")
if (!require("lme4")) install.packages("lme4")
if (!require("lmerTest")) install.packages("lmerTest")
if (!require("car")) install.packages("car")
if (!require("effects")) install.packages("effects")
if (!require("ggfortify")) install.packages("ggfortify")
if (!require("cowplot")) install.packages("cowplot")
if (!require("vegan")) install.packages("vegan")
if (!require("corrr")) install.packages("corrr")
if (!require("ggcorrplot")) install.packages("ggcorrplot")
if (!require("GGally")) install.packages("GGally")
if (!require("broom")) install.packages("broom")
if (!require("cowplot")) install.packages("cowplot")
if (!require("reshape2")) install.packages("reshape2")

# load packages
library(tidyverse)
library(ggplot2)
library(RColorBrewer)
library(lme4)
library(lmerTest)
library(car)
library(effects)
library(ggfortify)
library(cowplot)
library(vegan)
library(corrr)
library(ggcorrplot)
library(GGally)
library(broom)
library(cowplot)
library(reshape2)
```

# Load dataframe  

Load in master dataframe generated from 1_assemble_data.Rmd.  
```{r}
master<-read.csv("Output/master_timeseries.csv")

#reorder site levels 
master$site_code<-as.factor(master$site_code)
master$site_code<-fct_relevel(master$site_code, "Mahana Low", "Hilton Medium", "Manava High")
```

# All responses   

Calculate plasticity as euclidean distance between multivariate physiology positions generated in a PCA between time points.  

```{r}
data_all<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd, calc.umol.mgAFDW.hr, Total_Chl, Total_Chl_cell)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.mgAFDW.hr)

head(data_all) 

data_all<-data_all[complete.cases(data_all), ]

scaled_all<-prcomp(data_all[c(5:16)], scale=TRUE, center=TRUE) 

all_info<-data_all[c(1:4)]

#generate a euclidean distance matrix between all samples (colony x time point)
all_data<-scaled_all%>%
  augment(all_info)%>%
  group_by(timepoint, site_code, species, colony_id_corr)%>%
  mutate(code=paste(timepoint, colony_id_corr))

all_data<-as.data.frame(all_data)

row.names(all_data)<-all_data$code

all_data<-all_data[6:17]
head(all_data)

dist_all<-dist(all_data, diag = FALSE, upper = FALSE, method="euclidean")

dist_all <- melt(as.matrix(dist_all), varnames = c("row", "col"))

head(dist_all)
```

Now only keep the comparisons we care about (comparisons between observations of the same colony). For example, we only want distances between timepoints for the same colony. We are not comparing between colonies here.  

```{r}
dist_all<-dist_all%>%
  separate(row, into=c("Timepoint1", "Colony1"), sep=" ")%>%
  separate(col, into=c("Timepoint2", "Colony2"), sep=" ")%>%
  filter(value>0.0)%>% #remove distances between the same points
  mutate(condition=if_else(Colony1==Colony2, "TRUE", "FALSE"))%>%
  filter(condition=="TRUE")%>% #keep within colony comparisons
  filter(Timepoint1=="timepoint1")%>% #only keep comparisons that are relative to TP1
  select(Timepoint1, Timepoint2, Colony1, value)
  
```

Now, add a column that accounts for the specific time series comparison.  
```{r}
dist_all_mean<-dist_all%>%
  mutate(timepoint=paste(Timepoint1, "-", Timepoint2))

head(dist_all_mean)
```

Next, generate a summary for each species at each site faceted by time point comparison and plot with points and error bars.  
```{r}
dist_all_mean$site_code<-all_info$site_code[match(dist_all_mean$Colony1, all_info$colony_id_corr)]
dist_all_mean$species<-all_info$species[match(dist_all_mean$Colony1, all_info$colony_id_corr)]

dist_all_plot<-dist_all_mean%>%
  group_by(species, site_code, timepoint)%>%
  summarise(mean=mean(value), sd=sd(value), N=length(value), se=sd/sqrt(N))%>% 
  
    ggplot(aes(x = timepoint, y = mean, fill=species, group=interaction(species, timepoint))) +
    facet_wrap(~site_code)+
    geom_point(pch = 21, size=5, position = position_dodge(0.15)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=interaction(species, timepoint)), width=0, color="black", position=position_dodge(0.15))+
    scale_fill_manual(values = c("darkgray", "orange", "purple"))+
    xlab("Site") + 
    ylab(expression(bold("Colony-Specific Euclidean Distance")))+
    theme_classic() + 
    ylim(0,7)+
    theme(
      legend.position="right",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=14, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); dist_all_plot
```

Run anova on these values.  
```{r}
dist_all_model<-aov(value~site_code*species*timepoint, data=dist_all_mean)
summary(dist_all_model)
```

Site and species as well as time point have a significant effect on intra-colony distances.  

Next, analyze by averaging all timepoint comparisons to plot only by species and site.  
```{r}
dist_all_plot2<-dist_all_mean%>%
  group_by(species, site_code)%>%
  summarise(mean=mean(value), sd=sd(value), N=length(value), se=sd/sqrt(N))%>% 
  
    ggplot(aes(x = site_code, y = mean, fill=species, group=interaction(species, site_code))) +
    geom_line(aes(group=species, color=species), position=position_dodge(0.15), size=2)+
    geom_point(pch = 21, size=5, position = position_dodge(0.15)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=interaction(species, site_code)), width=0, color="black", position=position_dodge(0.15))+
    scale_fill_manual(name="Species", values = c("darkgray", "orange", "purple"))+
    scale_color_manual(name="Species", values = c("darkgray", "orange", "purple"))+
    xlab("Site") + 
    ylab(expression(bold("Colony-Specific Euclidean Distance")))+
    geom_text(x=2, y=0.7, size=4, label="Site p<0.001", color="black")+
    geom_text(x=2, y=0.4, size=4, label="Species p<0.001", color="black")+
    geom_text(x=2, y=0.1, size=4, label="Interaction p=0.040", color="black")+
    theme_classic() + 
    ylim(0,7)+
    ggtitle("A. All Responses")+
    theme(
      legend.position="right",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14, face="italic"),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=14, color="black"), 
      strip.text.x=element_text(face="italic", size=14),
      title=element_text(face="bold", size=16)
      ); dist_all_plot2
```

Run anova on these values.  
```{r}
dist_all_model<-aov(value~site_code*species, data=dist_all_mean)
summary(dist_all_model)
```

Site and species as well as time point have a significant effect on plasticity.   

# Holobiont responses  

Calculate distances for only holobiont responses.  

Generate a list of symbiont and holobiont responses.  
```{r}
symbiont_responses<-c("cells.mgAFDW", "Sym_AFDW.mg.cm2", "Total_Chl", "Total_Chl_cell", "Am", "AQY", "Ratio_AFDW.mg.cm2") 
holobiont_responses<-c("cre.umol.mgafdw", "Host_AFDW.mg.cm2", "prot_mg.mgafdw", "Rd", "calc.umol.mgAFDW.hr")
```

Calculate plasticity as euclidean distance between multivariate physiology positions generated in a PCA between time points.  

```{r}
data_holo<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.mgAFDW.hr)

data_holo<-data_holo[complete.cases(data_holo), ]

scaled_holo<-prcomp(data_holo[c(5:9)], scale=TRUE, center=TRUE) 

holo_info<-data_holo[c(1:4)]

#generate a euclidean distance matrix between all samples (colony x time point)
holo_data<-scaled_holo%>%
  augment(holo_info)%>%
  group_by(timepoint, site_code, species, colony_id_corr)%>%
  mutate(code=paste(timepoint, colony_id_corr))

holo_data<-as.data.frame(holo_data)

row.names(holo_data)<-holo_data$code

holo_data<-holo_data[6:10]
head(holo_data)

dist_holo<-dist(holo_data, diag = FALSE, upper = FALSE, method="euclidean")

dist_holo <- melt(as.matrix(dist_holo), varnames = c("row", "col"))

head(dist_holo)
```

Now only keep the comparisons we care about (comparisons between observations of the same colony). For example, we only want distances between timepoints for the same colony. We are not comparing between colonies here.  

```{r}
dist_holo<-dist_holo%>%
  separate(row, into=c("Timepoint1", "Colony1"), sep=" ")%>%
  separate(col, into=c("Timepoint2", "Colony2"), sep=" ")%>%
  filter(value>0.0)%>% #remove distances between the same points
  mutate(condition=if_else(Colony1==Colony2, "TRUE", "FALSE"))%>%
  filter(condition=="TRUE")%>% #keep within colony comparisons
  filter(Timepoint1=="timepoint1")%>% #only keep comparisons that are relative to TP1
  select(Timepoint1, Timepoint2, Colony1, value)

head(dist_holo)
  
```

Now, add a column that accounts for the specific time series comparison.  
```{r}
dist_holo_mean<-dist_holo%>%
  mutate(timepoint=paste(Timepoint1, "-", Timepoint2))

head(dist_holo_mean)
```

Next, generate a summary for each species at each site faceted by time point comparison and plot with points and error bars.  
```{r}
dist_holo_mean$site_code<-holo_info$site_code[match(dist_holo_mean$Colony1, holo_info$colony_id_corr)]
dist_holo_mean$species<-holo_info$species[match(dist_holo_mean$Colony1, holo_info$colony_id_corr)]

dist_holo_plot<-dist_holo_mean%>%
  group_by(species, site_code, timepoint)%>%
  summarise(mean=mean(value), sd=sd(value), N=length(value), se=sd/sqrt(N))%>% 
  
    ggplot(aes(x = timepoint, y = mean, fill=species, group=interaction(species, timepoint))) +
    facet_wrap(~site_code)+
    geom_point(pch = 21, size=5, position = position_dodge(0.15)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=interaction(species, timepoint)), width=0, color="black", position=position_dodge(0.15))+
    scale_fill_manual(values = c("darkgray", "orange", "purple"))+
    xlab("Timepoint") + 
    ylab(expression(bold("Colony-Specific Euclidean Distance")))+
    theme_classic() + 
    ylim(0,7)+
    theme(
      legend.position="right",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=14, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); dist_holo_plot
```

Run anova on these values.  
```{r}
dist_holo_model<-aov(value~site_code*species*timepoint, data=dist_holo_mean)
summary(dist_holo_model)
```

Timepoint and species as well as site x species and species x timepoint have a significant effect on intra-colony distances.  

Next, analyze by averaging all timepoint comparisons to plot only by species and site.  
```{r}
dist_holo_plot2<-dist_holo_mean%>%
  group_by(species, site_code)%>%
  summarise(mean=mean(value), sd=sd(value), N=length(value), se=sd/sqrt(N))%>% 
  
    ggplot(aes(x = site_code, y = mean, fill=species, group=interaction(species, site_code))) +
    geom_line(aes(group=species, color=species), position=position_dodge(0.15), size=2)+
    geom_point(pch = 21, size=5, position = position_dodge(0.15)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=interaction(species, site_code)), width=0, color="black", position=position_dodge(0.15))+
    scale_fill_manual(name="Species", values = c("darkgray", "orange", "purple"))+
    scale_color_manual(name="Species", values = c("darkgray", "orange", "purple"))+
    xlab("Site") + 
    ylab(expression(bold("Colony-Specific Euclidean Distance")))+
    geom_text(x=2, y=0.7, size=4, label="Site p=0.866", color="darkgray")+
    geom_text(x=2, y=0.4, size=4, label="Species p<0.001", color="black")+
    geom_text(x=2, y=0.1, size=4, label="Interaction p=0.027", color="black")+
    theme_classic() + 
    ylim(0,7)+
    ggtitle("B. Holobiont Responses")+
    theme(
      legend.position="right",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14, face="italic"),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=14, color="black"), 
      strip.text.x=element_text(face="italic", size=14),
      title=element_text(face="bold", size=16)
      ); dist_holo_plot2
```

Run anova on these values.  
```{r}
dist_holo_model<-aov(value~site_code*species, data=dist_holo_mean)
summary(dist_holo_model)
```

Species and site x species have a significant effect on plasticity.   

# Symbiont responses  

Calculate plasticity as euclidean distance between multivariate physiology positions generated in a PCA between time points for symbiont specific responses.    

```{r}
data_sym<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW)

data_sym<-data_sym[complete.cases(data_sym), ]

scaled_sym<-prcomp(data_sym[c(5:11)], scale=TRUE, center=TRUE) 

sym_info<-data_sym[c(1:4)]

#generate a euclidean distance matrix between all samples (colony x time point)
sym_data<-scaled_sym%>%
  augment(sym_info)%>%
  group_by(timepoint, site_code, species, colony_id_corr)%>%
  mutate(code=paste(timepoint, colony_id_corr))

sym_data<-as.data.frame(sym_data)

row.names(sym_data)<-sym_data$code

sym_data<-sym_data[6:12]
head(sym_data)

dist_sym<-dist(sym_data, diag = FALSE, upper = FALSE, method="euclidean")

dist_sym <- melt(as.matrix(dist_sym), varnames = c("row", "col"))

head(dist_sym)
```

Now only keep the comparisons we care about (comparisons between observations of the same colony). For example, we only want distances between timepoints for the same colony. We are not comparing between colonies here.  

```{r}
dist_sym<-dist_sym%>%
  separate(row, into=c("Timepoint1", "Colony1"), sep=" ")%>%
  separate(col, into=c("Timepoint2", "Colony2"), sep=" ")%>%
  filter(value>0.0)%>% #remove distances between the same points
  mutate(condition=if_else(Colony1==Colony2, "TRUE", "FALSE"))%>%
  filter(condition=="TRUE")%>% #keep within colony comparisons
  filter(Timepoint1=="timepoint1")%>% #only keep comparisons that are relative to TP1
  select(Timepoint1, Timepoint2, Colony1, value)

head(dist_sym)
  
```

Now, add a column that accounts for the specific time series comparison.  
```{r}
dist_sym_mean<-dist_sym%>%
  mutate(timepoint=paste(Timepoint1, "-", Timepoint2))

head(dist_sym_mean)
```

Next, generate a summary for each species at each site faceted by time point comparison and plot with points and error bars.  
```{r}
dist_sym_mean$site_code<-sym_info$site_code[match(dist_sym_mean$Colony1, sym_info$colony_id_corr)]
dist_sym_mean$species<-sym_info$species[match(dist_sym_mean$Colony1, sym_info$colony_id_corr)]

dist_sym_plot<-dist_sym_mean%>%
  group_by(species, site_code, timepoint)%>%
  summarise(mean=mean(value), sd=sd(value), N=length(value), se=sd/sqrt(N))%>% 
  
    ggplot(aes(x = timepoint, y = mean, fill=species, group=interaction(species, timepoint))) +
    facet_wrap(~site_code)+
    geom_point(pch = 21, size=5, position = position_dodge(0.15)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=interaction(species, timepoint)), width=0, color="black", position=position_dodge(0.15))+
    scale_fill_manual(values = c("darkgray", "orange", "purple"))+
    xlab("Timepoint") + 
    ylab(expression(bold("Colony-Specific Euclidean Distance")))+
    theme_classic() + 
    ylim(0,7)+
    theme(
      legend.position="right",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=14, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); dist_sym_plot
```

Run anova on these values.  
```{r}
dist_sym_model<-aov(value~site_code*species*timepoint, data=dist_sym_mean)
summary(dist_sym_model)
```

Site and species as well as species x timepoint have a significant effect on intra-colony distances.  

Next, analyze by averaging all timepoint comparisons to plot only by species and site.  
```{r}
dist_sym_plot2<-dist_sym_mean%>%
  group_by(species, site_code)%>%
  summarise(mean=mean(value), sd=sd(value), N=length(value), se=sd/sqrt(N))%>% 
  
    ggplot(aes(x = site_code, y = mean, fill=species, group=interaction(species, site_code))) +
    geom_line(aes(group=species, color=species), position=position_dodge(0.15), size=2)+
    geom_point(pch = 21, size=5, position = position_dodge(0.15)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se, group=interaction(species, site_code)), width=0, color="black", position=position_dodge(0.15))+
    scale_fill_manual(name="Species", values = c("darkgray", "orange", "purple"))+
    scale_color_manual(name="Species", values = c("darkgray", "orange", "purple"))+
    xlab("Site") + 
    ylab(expression(bold("Colony-Specific Euclidean Distance")))+
    geom_text(x=2, y=0.7, size=4, label="Site p=0.001", color="black")+
    geom_text(x=2, y=0.4, size=4, label="Species p=0.004", color="black")+
    geom_text(x=2, y=0.1, size=4, label="Interaction p=0.766", color="darkgray")+
    theme_classic() + 
    ylim(0,7)+
    ggtitle("B. Symbiont Responses")+
    theme(
      legend.position="right",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14, face="italic"),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=14, color="black"), 
      strip.text.x=element_text(face="italic", size=14),
      title=element_text(face="bold", size=16)
      ); dist_sym_plot2
```

Run anova on these values.  
```{r}
dist_sym_model<-aov(value~site_code*species, data=dist_sym_mean)
summary(dist_sym_model)
```

Species and site have a significant effect on plasticity.  

## Generate figure 

Generate a panel figure.  
```{r}
dist_all_plot3<-dist_all_plot2+theme(legend.position="none")
dist_holo_plot3<-dist_holo_plot2+theme(legend.position="none")

panel<-plot_grid(dist_all_plot3, dist_holo_plot3, dist_sym_plot2, nrow=1, ncol=3, rel_widths = c(1,1,1.3))

ggsave(panel, file="Figures/Plasticity_Figure.png", width=18, height=5)
```


