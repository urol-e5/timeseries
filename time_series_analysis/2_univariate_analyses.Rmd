---
title: "Univariate analysis of E5 time series biological data"
author: "Ariana S Huffmyer, E5 RoL Team"
date: "04/14/2022"
output: 
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
editor_options: 
  chunk_output_type: console
--- 

AH TO DO: Change to Holoboint (all), Host and Symbiont responses

# Set Up    
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

```{r}
## install packages if you dont already have them
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("RColorBrewer")) install.packages("RColorBrewer")
if (!require("lme4")) install.packages("lme4")
if (!require("lmerTest")) install.packages("lmerTest")
if (!require("car")) install.packages("car")
if (!require("effects")) install.packages("effects")
if (!require("ggfortify")) install.packages("ggfortify")
if (!require("cowplot")) install.packages("cowplot")
if (!require("vegan")) install.packages("vegan")
if (!require("corrr")) install.packages("corrr")
if (!require("ggcorrplot")) install.packages("ggcorrplot")
if (!require("GGally")) install.packages("GGally")
if (!require("broom")) install.packages("broom")
if (!require("cowplot")) install.packages("cowplot")
if (!require("directlabels")) install.packages("directlabels")

# load packages
library(tidyverse)
library(ggplot2)
library(RColorBrewer)
library(lme4)
library(lmerTest)
library(car)
library(effects)
library(ggfortify)
library(cowplot)
library(vegan)
library(corrr)
library(ggcorrplot)
library(GGally)
library(broom)
library(cowplot)
library(directlabels)
```

# Load dataframe

Load in master dataframe generated from 1_assemble_data.Rmd.  
```{r}
master<-read.csv("Output/master_timeseries.csv")

#reorder site levels 
master$site_code<-as.factor(master$site_code)
master$site_code<-fct_relevel(master$site_code, "Mahana Low", "Hilton Medium", "Manava High")
```

# Univariate Responses  

Plot univariate response plots and then generate panel of all plots at the end of this section. Individual plots will not be displayed.  

## Antioxidant capacity  

### Plot: CRE umol mgprot 

View by site and timepoint for each species.   
```{r}
tacplot_prot<-master %>%
  filter(!is.na(cre.umol.mgprot)) %>% 
  filter(!is.na(species))%>%
  select(colony_id_corr, species, site_code, timepoint, cre.umol.mgprot)%>%
  
  ggplot(., aes(x = site_code, y = cre.umol.mgprot, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    ylab(expression(bold(paste("Antioxidant Capacity (", mu, "mol CRE mg protein"^-1,")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      )
```

### Plot: CRE umol mgafdw 

View by site and timepoint for each species.   
```{r}
tacplot_afdw<-master %>%
  filter(!is.na(cre.umol.mgafdw)) %>%
  filter(!is.na(species))%>%
  select(colony_id_corr, species, site_code, timepoint, cre.umol.mgafdw)%>%
  
  ggplot(., aes(x = site_code, y = cre.umol.mgafdw, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    ylab(expression(bold(paste("Antioxidant Capacity (", mu, "mol CRE mg afdw"^-1,")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      )
```


### Plot: CRE umol cm2 

View by site and timepoint for each species.   
```{r}
tacplot_cm2<-master %>%
  filter(!is.na(cre.umol.cm2)) %>%
  filter(!is.na(species))%>%
  select(colony_id_corr, species, site_code, timepoint, cre.umol.cm2)%>%
  
  ggplot(., aes(x = site_code, y = cre.umol.cm2, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
     scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    ylab(expression(bold(paste("Antioxidant Capacity (", mu, "mol CRE mg afdw"^-1,")"))))+
    theme_classic() + 
    theme(
      legend.position="right",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      )

```

Join all plots for each normalization together.  

```{r}
tac_figure<-plot_grid(tacplot_prot, tacplot_afdw, tacplot_cm2, labels = c("", "", ""), ncol=3, nrow=1, rel_widths = c(.8, .8, 1), label_size = 20, label_x = 0.1);tac_figure

ggsave(filename="Figures/Univariate/TAC_Figure.pdf", plot=tac_figure, dpi=300, width=24, height=5, units="in")
```

### Analysis 

Build a mixed model for univariate analysis and examine data distribution of biomass normalized antioxidant capacity. 

`antiox_model<-lmer(cre.umol.mgafdw~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
antiox_model<-lmer(cre.umol.mgafdw~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(antiox_model))
#hist(residuals(antiox_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`antiox_model<-lmer(log(1+cre.umol.mgafdw)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
antiox_model<-lmer(log(1+cre.umol.mgafdw)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(antiox_model))
#hist(residuals(antiox_model))
```

Generate a Type III Anova of model.    

```{r}
anova(antiox_model, type="III")
summary(antiox_model)
```

Since species is significant, run a model for site and time effects within each species.  

*Acropora*:

`antiox_model_acr<-lmer(log(1+cre.umol.mgafdw)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Acropora"))` 

```{r}
antiox_model_acr<-lmer(log(1+cre.umol.mgafdw)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Acropora"))
qqPlot(residuals(antiox_model_acr))
```

Generate a Type III Anova of model.    

```{r}
anova(antiox_model_acr, type="III")
summary(antiox_model_acr)
```

*Pocillopora*: 

`antiox_model_poc<-lmer(log(1+cre.umol.mgafdw)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Pocillopora"))` 

```{r}
antiox_model_poc<-lmer(log(1+cre.umol.mgafdw)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Pocillopora"))
qqPlot(residuals(antiox_model_poc))
#hist(residuals(antiox_model_poc))
```

Generate a Type III Anova of model.    

```{r}
anova(antiox_model_poc, type="III")
summary(antiox_model_poc)
```


*Porites*:  

`antiox_model_por<-lmer(log(1+cre.umol.mgafdw)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Porites"))` 

```{r}
antiox_model_por<-lmer(log(1+cre.umol.mgafdw)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Porites"))
qqPlot(residuals(antiox_model_por))
#hist(residuals(antiox_model_por))
```

Generate a Type III Anova of model.    

```{r}
anova(antiox_model_por, type="III")
summary(antiox_model_por)
```



## Symbiont Densities  

### Plot: Surface Area    
 
View by site and timepoint for each species.   
```{r}
symbplot_cm2<-master %>%
  filter(!is.na(cells.cm2)) %>%
  filter(!is.na(species))%>%
  select(colony_id_corr, species, site_code, timepoint, cells.cm2)%>%
  
  ggplot(., aes(x = site_code, y = cells.cm2, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Symbiont Cells cm"^-2))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      )
```

### Plot: Protein   

View by site and timepoint for each species.   
```{r}
symbplot_prot<-master %>%
  filter(!is.na(cells.mgprot)) %>%
   filter(!is.na(species))%>%
  select(colony_id_corr, species, site_code, timepoint, cells.mgprot)%>%
  
  ggplot(., aes(x = site_code, y = cells.mgprot, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Symbiont Cells mg protein"^-1))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      )

```

### Plot: Biomass   

View by site and timepoint for each species.   
```{r}
symbplot_afdw<-master %>%
  filter(!is.na(cells.mgAFDW)) %>%
    filter(!is.na(species))%>%
  select(colony_id_corr, species, site_code, timepoint, cells.mgAFDW)%>%
  
  ggplot(., aes(x = site_code, y = cells.mgAFDW, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Symbiont Cells mg afdw"^-1))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      )
```

Join all plots for each normalization together.  

```{r}
symbcells_figure<-plot_grid(symbplot_prot, symbplot_afdw, symbplot_cm2, labels = c("", "", ""), ncol=3, nrow=1, rel_widths = c(.8, .8, 1), label_size = 20, label_x = 0.1)

ggsave(filename="Figures/Univariate/CellDensity_Figure.pdf", plot=symbcells_figure, dpi=300, width=24, height=5, units="in")
```

### Analysis  

Build a mixed model for univariate analysis and examine data distribution.

`density_model<-lmer(cells.mgAFDW~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
density_model<-lmer(cells.mgAFDW~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(cells.mgAFDW>0))
qqPlot(residuals(density_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`density_model<-lmer(log(cells.mgAFDW)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
density_model<-lmer(log(cells.mgAFDW)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(cells.mgAFDW>0))
qqPlot(residuals(density_model))
```

Residuals are improved, but we need to revisit this model to improve fit.  

Generate a Type III Anova of model.    

```{r}
anova(density_model, type="III")
```

Since species is significant, test for effects of time and site within each species.  

*Acropora*  

`density_model_acr<-lmer(log(cells.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(subset=c(cells.mgAFDW>0 & species=="Acropora"))` 

```{r}
density_model_acr<-lmer(log(cells.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(cells.mgAFDW>0 & species=="Acropora"))
qqPlot(residuals(density_model_acr))
```

Generate a Type III Anova of model.    

```{r}
anova(density_model_acr, type="III")
```

*Pocillopora*  

`density_model_poc<-lmer(log(cells.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Pocillopora"))` 

```{r}
density_model_poc<-lmer(log(cells.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(cells.mgAFDW>0 & species=="Pocillopora"))
qqPlot(residuals(density_model_poc))
```

Generate a Type III Anova of model.    

```{r}
anova(density_model_poc, type="III")
```

*Porites*  

`density_model_por<-lmer(log(cells.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Porites"))` 

```{r}
density_model_por<-lmer(log(cells.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(cells.mgAFDW>0 & species=="Porites"))
qqPlot(residuals(density_model_por))
```

Generate a Type III Anova of model.    

```{r}
anova(density_model_por, type="III")
```


## Biomass

### Plot Host Biomass  
 
View by site and timepoint for each species in the host.  
```{r} 
hAFDWplot<-master %>%
  filter(!is.na(Host_AFDW.mg.cm2)) %>%
  filter(!is.na(species))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  select(colony_id_corr, species, site_code, timepoint, Host_AFDW.mg.cm2)%>%
  
  ggplot(., aes(x = site_code, y = Host_AFDW.mg.cm2, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Host Biomass (mg AFDW cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      )
```


### Plot Symbiont biomass  

View by site and timepoint for each species in the symbiont   
```{r} 
sAFDWplot<-master %>%
  filter(!is.na(Sym_AFDW.mg.cm2)) %>%
  filter(!is.na(species))%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  select(colony_id_corr, species, site_code, timepoint, Sym_AFDW.mg.cm2)%>%
  
  ggplot(., aes(x = site_code, y = Sym_AFDW.mg.cm2, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Symbiont Biomass (mg AFDW cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      )
```

### Plot S:H Ratio  

Calculate biomass as a ratio of host to symbiont and plot.  

```{r} 
#master <- master %>% 
  #mutate(Ratio_AFDW.mg.cm2=Sym_AFDW.mg.cm2/(Sym_AFDW.mg.cm2+Host_AFDW.mg.cm2))

ratioAFDWplot<-master %>%
  filter(!is.na(Host_AFDW.mg.cm2)) %>%
  filter(!is.na(species))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  select(colony_id_corr, species, site_code, timepoint, Ratio_AFDW.mg.cm2)%>%
  
  ggplot(., aes(x = site_code, y = Ratio_AFDW.mg.cm2, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Symbiont : Holobiont Biomass"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      )
```


Join all plots together.  

```{r}
afdw_figure<-plot_grid(hAFDWplot, sAFDWplot, ratioAFDWplot, labels = c("", "", ""), ncol=3, nrow=1, rel_widths = c(.8, .8, 1), label_size = 20, label_x = 0.1)

ggsave(filename="Figures/Univariate/Biomass_Figure.pdf", plot=afdw_figure, dpi=300, width=24, height=5, units="in")
```

### Analysis  

Build a mixed model for univariate analysis and examine data distribution.

#### Host Biomass:  

`hAFDW_model<-lmer(Host_AFDW.mg.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0))` 

```{r}
hAFDW_model<-lmer(Host_AFDW.mg.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0))
qqPlot(residuals(hAFDW_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`hAFDW_model<-lmer(log(1+Host_AFDW.mg.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0))` 

```{r}
hAFDW_model<-lmer(log(1+Host_AFDW.mg.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0))
qqPlot(residuals(hAFDW_model))
```

Residuals are improved.

Generate a Type III Anova of model.    

```{r}
anova(hAFDW_model, type="III")
summary(hAFDW_model)
```

Since species is significant, test for effects of site and time within each species.  

*Acropora*  
 
`hAFDW_model_acr<-lmer(log(1+Host_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0 & species=="Acropora"))` 

```{r}
hAFDW_model_acr<-lmer(log(1+Host_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0 & species=="Acropora"))
qqPlot(residuals(hAFDW_model_acr))
```

Generate a Type III Anova of model.    

```{r}
anova(hAFDW_model_acr, type="III")
summary(hAFDW_model_acr)
```

*Pocillopora*  
 
`hAFDW_model_poc<-lmer(log(1+Host_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0 & species=="Pocillopora"))` 

```{r}
hAFDW_model_poc<-lmer(log(1+Host_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0 & species=="Pocillopora"))
qqPlot(residuals(hAFDW_model_poc))
```

Generate a Type III Anova of model.    

```{r}
anova(hAFDW_model_poc, type="III")
summary(hAFDW_model_poc)
```

*Porites*  
 
`hAFDW_model_por<-lmer(log(1+Host_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0 & species=="Porites"))` 

```{r}
hAFDW_model_por<-lmer(log(1+Host_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0 & species=="Porites"))
qqPlot(residuals(hAFDW_model_por))
```

Generate a Type III Anova of model.    

```{r}
anova(hAFDW_model_por, type="III")
summary(hAFDW_model_por)
```

#### Symbiont Biomass:  

`sAFDW_model<-lmer(Sym_AFDW.mg.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0))` 
```{r}
sAFDW_model<-lmer(Sym_AFDW.mg.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0))
qqPlot(residuals(sAFDW_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`sAFDW_model<-lmer(log(1+Sym_AFDW.mg.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0))` 

```{r}
sAFDW_model<-lmer(log(1+Sym_AFDW.mg.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0))
qqPlot(residuals(sAFDW_model))
```

Residuals are improved.  

Generate a Type III Anova of model.    

```{r}
anova(sAFDW_model, type="III")
summary(sAFDW_model)
```

Since species is significant, test for effects of site and time within each species.  

*Acropora* 

`sAFDW_model_acr<-lmer(log(1+Sym_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0 & species=="Acropora"))` 

```{r}
sAFDW_model_acr<-lmer(log(1+Sym_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0 & species=="Acropora"))
qqPlot(residuals(sAFDW_model_acr))
```

Generate a Type III Anova of model.    

```{r}
anova(sAFDW_model_acr, type="III")
summary(sAFDW_model_acr)
```

*Pocillopora* 

`sAFDW_model_poc<-lmer(log(1+Sym_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0 & species=="Pocillopora"))` 

```{r}
sAFDW_model_poc<-lmer(log(1+Sym_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0 & species=="Pocillopora"))
qqPlot(residuals(sAFDW_model_poc))
```

Generate a Type III Anova of model.    

```{r}
anova(sAFDW_model_poc, type="III")
summary(sAFDW_model_poc)
```

*Porites* 

`sAFDW_model_poc<-lmer(log(1+Sym_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0 & species=="Porites"))` 

```{r}
sAFDW_model_por<-lmer(log(1+Sym_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0 & species=="Porites"))
qqPlot(residuals(sAFDW_model_por))
```

Generate a Type III Anova of model.    

```{r}
anova(sAFDW_model_por, type="III")
summary(sAFDW_model_por)
```


#### S:H Biomass: 

`shAFDW_model<-lmer(Ratio_AFDW.mg.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0))` 

```{r}
shAFDW_model<-lmer(Ratio_AFDW.mg.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0))
qqPlot(residuals(shAFDW_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`shAFDW_model<-lmer(log(1+Ratio_AFDW.mg.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0))` 

```{r}
shAFDW_model<-lmer(log(1+Ratio_AFDW.mg.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0))
qqPlot(residuals(shAFDW_model))
```

Residuals are improved. 

Generate a Type III Anova of model.    

```{r}
anova(shAFDW_model, type="III")
summary(shAFDW_model)
```

Since species is significant, test for effects of time and site within species.  

*Acropora*   

`shAFDW_model_acr<-lmer(log(1+Ratio_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0 & species=="Acropora"))` 

```{r}
shAFDW_model_acr<-lmer(log(1+Ratio_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0 & species=="Acropora"))
qqPlot(residuals(shAFDW_model_acr))
```

Generate a Type III Anova of model.    

```{r}
anova(shAFDW_model_acr, type="III")
summary(shAFDW_model_acr)
```

*Pocillopora*   

`shAFDW_model_poc<-lmer(log(1+Ratio_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0 & species=="Pocillopora"))` 

```{r}
shAFDW_model_poc<-lmer(log(1+Ratio_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0 & species=="Pocillopora"))
qqPlot(residuals(shAFDW_model_poc))
```

Generate a Type III Anova of model.    

```{r}
anova(shAFDW_model_poc, type="III")
summary(shAFDW_model_poc)
```

*Porites*   

`shAFDW_model_por<-lmer(log(1+Ratio_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0 & species=="Porites"))` 

```{r}
shAFDW_model_por<-lmer(log(1+Ratio_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0 & species=="Porites"))
qqPlot(residuals(shAFDW_model_por))
```

Generate a Type III Anova of model.    

```{r}
anova(shAFDW_model_por, type="III")
summary(shAFDW_model_por)
```

## Chlorophyll  

### Plot: Surface area     

View by site and timepoint for each species in Chl a.    
```{r}
chlaplot_cm2<-master %>%
  filter(!is.na(chla.ug.cm2)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, chla.ug.cm2)%>%
  
  ggplot(., aes(x = site_code, y = chla.ug.cm2, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Chlorophyll a (", mu, "g cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      )
```

View by site and timepoint for each species in Chl c2.   
```{r}
chlc2plot_cm2<-master %>%
  filter(!is.na(chlc2.ug.cm2)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, chlc2.ug.cm2)%>%
  
  ggplot(., aes(x = site_code, y = chlc2.ug.cm2, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Chlorophyll c2 (", mu, "g cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      )
```

### Plot: Protein    

View by site and timepoint for each species in Chl a.    
```{r}
chlaplot_prot<-master %>%
  filter(!is.na(chla.ug.mgprot)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, chla.ug.mgprot)%>%
  
  ggplot(., aes(x = site_code, y = chla.ug.mgprot, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Chlorophyll a (", mu, "g mg protein"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      )
```

View by site and timepoint for each species in Chl c2.   
```{r}
chlc2plot_prot<-master %>%
  filter(!is.na(chlc2.ug.mgprot)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, chlc2.ug.mgprot)%>%
  
  ggplot(., aes(x = site_code, y = chlc2.ug.mgprot, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Chlorophyll c2 (", mu, "g mg protein"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      )
```

### Plot: Biomass    

View by site and timepoint for each species in Chl a.    
```{r}
chlaplot_afdw<-master %>%
  filter(!is.na(chla.ug.mgAFDW)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, chla.ug.mgAFDW)%>%
  
  ggplot(., aes(x = site_code, y = chla.ug.mgAFDW, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Chlorophyll a (", mu, "g mg afdw"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      )
```

View by site and timepoint for each species in Chl c2.   
```{r}
chlc2plot_afdw<-master %>%
  filter(!is.na(chlc2.ug.mgAFDW)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, chlc2.ug.mgAFDW)%>%
  
  ggplot(., aes(x = site_code, y = chlc2.ug.mgAFDW, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Chlorophyll c2 (", mu, "g mg afdw"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      )
```

### Plot: Per cell    

View by site and timepoint for each species in Chl a.    
```{r}
chlaplot_cell<-master %>%
  filter(!is.na(chla.ug.cell)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, chla.ug.cell)%>%
  
  ggplot(., aes(x = site_code, y = chla.ug.cell, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Chlorophyll a (", mu, "g cell"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      )
```

View by site and timepoint for each species in Chl c2.   
```{r}
chlc2plot_cell<-master %>%
  filter(!is.na(chlc2.ug.cell)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, chlc2.ug.cell)%>%
  
  ggplot(., aes(x = site_code, y = chlc2.ug.cell, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Chlorophyll c2 (", mu, "g cell"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      )
```

Join all plots for each normalization together.  

```{r}
chl_figure<-plot_grid(chlaplot_prot, chlaplot_afdw, chlaplot_cell, chlaplot_cm2,chlc2plot_prot, chlc2plot_afdw, chlc2plot_cell, chlc2plot_cm2,  labels = c("", "", ""), ncol=4, nrow=2, rel_widths = c(.8, .8, .8, 1, .8, .8, .8, 1), label_size = 20, label_x = 0.1)

ggsave(filename="Figures/Univariate/Chlorophyll_Figure.pdf", plot=chl_figure, dpi=300, width=32, height=10, units="in")
```

### Plot: Total chl  

View by site and timepoint for each species for total chl per unit AFDW.     
```{r}
chlplot_total<-master %>%
  filter(!is.na(Total_Chl)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, Total_Chl)%>%
  
  ggplot(., aes(x = site_code, y = Total_Chl, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Total Chlorophyll (", mu, "g mg afdw"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      )
```

View by site and timepoint for each species for total chl per cell.     
```{r}
chlplot_total_cell<-master %>%
  filter(!is.na(Total_Chl_cell)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, Total_Chl_cell)%>%
  
  ggplot(., aes(x = site_code, y = Total_Chl_cell, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Total Chlorophyll (", mu, "g cell"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      )
```

### Analysis  

Build a mixed model for univariate analysis and examine data distribution.

#### Chlorophyll a: 

`chla_model<-lmer(chla.ug.mgAFDW~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
chla_model<-lmer(chla.ug.mgAFDW~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(chla_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`chla_model<-lmer(log(1+chla.ug.mgAFDW)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chla.ug.mgAFDW>0))` 

```{r}
chla_model<-lmer(log(1+chla.ug.mgAFDW)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chla.ug.mgAFDW>0))
qqPlot(residuals(chla_model))
```

Generate a Type III Anova of model.    

```{r}
anova(chla_model, type="III")
summary(chla_model)
```

Since species is significant, test for effects of site and time within each species.  

*Acropora*  

`chla_model_acr<-lmer(log(1+chla.ug.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chla.ug.mgAFDW>0 & species=="Acropora"))` 

```{r}
chla_model_acr<-lmer(log(1+chla.ug.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chla.ug.mgAFDW>0 & species=="Acropora"))
qqPlot(residuals(chla_model_acr))
```

Generate a Type III Anova of model.    

```{r}
anova(chla_model_acr, type="III")
summary(chla_model_acr)
```

*Pocillopora*  

`chla_model_poc<-lmer(log(1+chla.ug.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chla.ug.mgAFDW>0 & species=="Pocillopora"))` 

```{r}
chla_model_poc<-lmer(log(1+chla.ug.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chla.ug.mgAFDW>0 & species=="Pocillopora"))
qqPlot(residuals(chla_model_poc))
```

Generate a Type III Anova of model.    

```{r}
anova(chla_model_poc, type="III")
summary(chla_model_poc)
```

*Porites*  

`chla_model_por<-lmer(log(1+chla.ug.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chla.ug.mgAFDW>0 & species=="Porites"))` 

```{r}
chla_model_por<-lmer(log(1+chla.ug.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chla.ug.mgAFDW>0 & species=="Porites"))
qqPlot(residuals(chla_model_por))
```

Generate a Type III Anova of model.    

```{r}
anova(chla_model_por, type="III")
summary(chla_model_por)
```


#### Chlorophyll c2: 

Build a mixed model for univariate analysis and examine data distribution.

`chlc2_model<-lmer(chlc2.ug.mgAFDW~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chlc2.ug.mgAFDW>0))` 

```{r}
chlc2_model<-lmer(chlc2.ug.mgAFDW~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chlc2.ug.mgAFDW>0))
qqPlot(residuals(chlc2_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`chlc2_model<-lmer(log(1+chlc2.ug.mgAFDW)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chlc2.ug.mgAFDW>0))` 

```{r}
chlc2_model<-lmer(log(1+chlc2.ug.mgAFDW)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chlc2.ug.mgAFDW>0))
qqPlot(residuals(chlc2_model))
```

Return to check residual distribution in this model.  

Generate a Type III Anova of model.    

```{r}
anova(chlc2_model, type="III")
summary(chlc2_model)
```

Since species is significant, test for effects of site and time within species.  

*Acropora* 

`chlc2_model_acr<-lmer(log(1+chlc2.ug.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chlc2.ug.mgAFDW>0 & species=="Acropora))` 

```{r}
chlc2_model_acr<-lmer(log(1+chlc2.ug.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chlc2.ug.mgAFDW>0 & species=="Acropora"))
qqPlot(residuals(chlc2_model_acr))
```

Generate a Type III Anova of model.    

```{r}
anova(chlc2_model_acr, type="III")
summary(chlc2_model_acr)
```


*Pocillopora* 

`chlc2_model_poc<-lmer(log(1+chlc2.ug.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chlc2.ug.mgAFDW>0 & species=="Pocillopora))` 

```{r}
chlc2_model_poc<-lmer(log(1+chlc2.ug.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chlc2.ug.mgAFDW>0 & species=="Pocillopora"))
qqPlot(residuals(chlc2_model_poc))
```

Generate a Type III Anova of model.    

```{r}
anova(chlc2_model_poc, type="III")
summary(chlc2_model_poc)
```


*Porites* 

`chlc2_model_por<-lmer(log(1+chlc2.ug.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chlc2.ug.mgAFDW>0 & species=="Porites))` 

```{r}
chlc2_model_por<-lmer(log(1+chlc2.ug.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chlc2.ug.mgAFDW>0 & species=="Porites"))
qqPlot(residuals(chlc2_model_por))
```

Generate a Type III Anova of model.    

```{r}
anova(chlc2_model_por, type="III")
summary(chlc2_model_por)
```

#### Total Chlorophyll (a + c2): 

Build a mixed model for univariate analysis and examine data distribution.

`chltotal_model<-lmer(Total_Chl~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl>0))` 

```{r}
chltotal_model<-lmer(Total_Chl~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl>0))
qqPlot(residuals(chltotal_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`chltotal_model<-lmer(log(1+Total_Chl)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl>0))` 

```{r}
chltotal_model<-lmer(log(1+Total_Chl)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl>0))
qqPlot(residuals(chltotal_model))
```

Generate a Type III Anova of model.    

```{r}
anova(chltotal_model, type="III")
summary(chltotal_model)
```

Since species is significant, test for effects of time and site within species.  

*Acropora*  

`chltotal_model_acr<-lmer(log(1+Total_Chl)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl>0 & species=="Acropora"))` 

```{r}
chltotal_model_acr<-lmer(log(1+Total_Chl)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl>0 & species=="Acropora"))
qqPlot(residuals(chltotal_model_acr))
```

Generate a Type III Anova of model.    

```{r}
anova(chltotal_model_acr, type="III")
summary(chltotal_model_acr)
```

*Pocillopora*  

`chltotal_model_poc<-lmer(log(1+Total_Chl)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl>0 & species=="Pocillopora"))` 

```{r}
chltotal_model_poc<-lmer(log(1+Total_Chl)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl>0 & species=="Pocillopora"))
qqPlot(residuals(chltotal_model_poc))
```

Generate a Type III Anova of model.    

```{r}
anova(chltotal_model_poc, type="III")
summary(chltotal_model_poc)
```

*Porites*  

`chltotal_model_poc<-lmer(log(1+Total_Chl)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl>0 & species=="Porites"))` 

```{r}
chltotal_model_por<-lmer(log(1+Total_Chl)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl>0 & species=="Porites"))
qqPlot(residuals(chltotal_model_por))
```

Generate a Type III Anova of model.    

```{r}
anova(chltotal_model_por, type="III")
summary(chltotal_model_por)
```

#### Total Chlorophyll per cell (a + c2): 

Build a mixed model for univariate analysis and examine data distribution.

`chltotalcell_model<-lmer(Total_Chl_cell~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl_cell>0))` 

```{r}
chltotalcell_model<-lmer(Total_Chl_cell~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl_cell>0))
qqPlot(residuals(chltotalcell_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`chltotalcell_model<-lmer(log(1+Total_Chl_cell)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl_cell>0))` 

```{r}
chltotalcell_model<-lmer(log(1+Total_Chl_cell)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl_cell>0))
qqPlot(residuals(chltotalcell_model))
```

Return to check distribution of residuals.  

Generate a Type III Anova of model.    

```{r}
anova(chltotalcell_model, type="III")
summary(chltotalcell_model)
```

Since species is significant, test for effects of time and set within species.  

*Acropora*   

`chltotalcell_model_acr<-lmer(log(1+Total_Chl_cell)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl_cell>0 & species=="Acropora"))` 

```{r}
chltotalcell_model_acr<-lmer(log(1+Total_Chl_cell)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl_cell>0 & species=="Acropora"))
qqPlot(residuals(chltotalcell_model_acr))
```

Generate a Type III Anova of model.    

```{r}
anova(chltotalcell_model_acr, type="III")
summary(chltotalcell_model_acr)
```

*Pocillopora*   

`chltotalcell_model_poc<-lmer(log(1+Total_Chl_cell)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl_cell>0 & species=="Pocillopora"))` 

```{r}
chltotalcell_model_poc<-lmer(log(1+Total_Chl_cell)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl_cell>0 & species=="Pocillopora"))
qqPlot(residuals(chltotalcell_model_poc))
```

Generate a Type III Anova of model.    

```{r}
anova(chltotalcell_model_poc, type="III")
summary(chltotalcell_model_poc)
```

*Porites*   

`chltotalcell_model_por<-lmer(log(1+Total_Chl_cell)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl_cell>0 & species=="Porites"))` 

```{r}
chltotalcell_model_por<-lmer(log(1+Total_Chl_cell)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl_cell>0 & species=="Porites"))
qqPlot(residuals(chltotalcell_model_por))
```

Generate a Type III Anova of model.    

```{r}
anova(chltotalcell_model_por, type="III")
summary(chltotalcell_model_por)
```

## Protein 

### Plot: Surface Area  

View by site and timepoint for each species.    
```{r}
protplot_cm2<-master %>%
  filter(!is.na(prot_mg.cm2)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, prot_mg.cm2)%>%
  
  ggplot(., aes(x = site_code, y = prot_mg.cm2, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Protein (mg cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      )
```

### Plot: AFDW  

View by site and timepoint for each species.    
```{r}
protplot_afdw<-master %>%
  filter(!is.na(prot_mg.mgafdw)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, prot_mg.mgafdw)%>%
  
  ggplot(., aes(x = site_code, y = prot_mg.mgafdw, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Protein (mg mg afdw"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      )
```

Join all plots for each normalization together.  

```{r}
prot_figure<-plot_grid(protplot_afdw, protplot_cm2, labels = c("", "", ""), ncol=2, nrow=1, rel_widths = c(.8, 1), label_size = 20, label_x = 0.1)

ggsave(filename="Figures/Univariate/Protein_Figure.pdf", plot=prot_figure, dpi=300, width=16, height=5, units="in")
```

### Analysis  

Build a mixed model for univariate analysis and examine data distribution. 

`prot_model<-lmer(prot_mg.mgafdw~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(prot_ug.mgAFDW>0))` 

```{r}
prot_model<-lmer(prot_mg.mgafdw~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(prot_mg.mgafdw>0))
qqPlot(residuals(prot_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`prot_model<-lmer(log(1+prot_mg.mgafdw)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(prot_ug.mgafdw>0))` 

```{r}
prot_model<-lmer(log(1+prot_mg.mgafdw)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(prot_mg.mgafdw>0))
qqPlot(residuals(prot_model))
```

Generate a Type III Anova of model.    

```{r}
anova(prot_model, type="III")
summary(prot_model)
```

Since species is significant, test for effects of site and time within each species.  

*Acropora*  

`prot_model_acr<-lmer(log(1+prot_mg.mgafdw)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(prot_ug.mgafdw>0 & species=="Acropora"))` 

```{r}
prot_model_acr<-lmer(log(1+prot_mg.mgafdw)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(prot_mg.mgafdw>0 & species=="Acropora"))
qqPlot(residuals(prot_model_acr))
```

Generate a Type III Anova of model.    

```{r}
anova(prot_model_acr, type="III")
summary(prot_model_acr)
```

*Pocillopora*  

`prot_model_poc<-lmer(log(1+prot_mg.mgafdw)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(prot_ug.mgafdw>0 & species=="Pocillopora"))` 

```{r}
prot_model_poc<-lmer(log(1+prot_mg.mgafdw)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(prot_mg.mgafdw>0 & species=="Pocillopora"))
qqPlot(residuals(prot_model_poc))
```

Generate a Type III Anova of model.    

```{r}
anova(prot_model_poc, type="III")
summary(prot_model_poc)
```

*Porites*  

`prot_model_por<-lmer(log(1+prot_mg.mgafdw)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(prot_ug.mgafdw>0 & species=="Porites"))` 

```{r}
prot_model_por<-lmer(log(1+prot_mg.mgafdw)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(prot_mg.mgafdw>0 & species=="Porites"))
qqPlot(residuals(prot_model_por))
```

Generate a Type III Anova of model.    

```{r}
anova(prot_model_por, type="III")
summary(prot_model_por)
```

## PI Curve Parameters   

### Plot: Am   

View by site and timepoint for each species.    
```{r}
am_plot<-master %>%
  filter(!is.na(AQY)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, AQY, Am, Rd)%>%
  
  ggplot(., aes(x = site_code, y = Am, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Am"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      )
```

### Plot: AQY  

View by site and timepoint for each species.    
```{r}
aqy_plot<-master %>%
  filter(!is.na(AQY)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, AQY, Am, Rd)%>%
  
  ggplot(., aes(x = site_code, y = AQY, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("AQY"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      )
```

### Plot: Rd  

View by site and timepoint for each species.    
```{r}
rd_plot<-master %>%
  filter(!is.na(AQY)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, AQY, Am, Rd)%>%
  
  ggplot(., aes(x = site_code, y = Rd, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Respiration"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      )
```

Join all plots together.  

```{r}
pi_figure<-plot_grid(am_plot, aqy_plot, rd_plot, labels = c("", "", ""), ncol=3, nrow=1, rel_widths = c(.8, .8, 1), label_size = 20, label_x = 0.1)

ggsave(filename="Figures/Univariate/PI_Figure.pdf", plot=pi_figure, dpi=300, width=22, height=5, units="in")
```

### Analysis of Am   

Build a mixed model for univariate analysis and examine data distribution. 

`am_model<-lmer(Am~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
am_model<-lmer(Am~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(am_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`am_model<-lmer(log(Am)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
am_model<-lmer(log(Am)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(am_model))
```

Generate a Type III Anova of model.    

```{r}
anova(am_model, type="III")
summary(am_model)
```

Since species is significant, test for effects of time and site within species.  

*Acropora*  

`am_model<-lmer(log(Am)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Acropora"))` 

```{r}
am_model_acr<-lmer(log(Am)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Acropora"))
qqPlot(residuals(am_model_acr))
```

Generate a Type III Anova of model.    

```{r}
anova(am_model_acr, type="III")
summary(am_model_acr)
```

*Pocillopora*  

`am_model_poc<-lmer(log(Am)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Pocillopora"))` 

```{r}
am_model_poc<-lmer(log(Am)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Pocillopora"))
qqPlot(residuals(am_model_poc))
```

Generate a Type III Anova of model.    

```{r}
anova(am_model_poc, type="III")
summary(am_model_poc)
```

*Porites*  

`am_model_por<-lmer(log(Am)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Porites"))` 

```{r}
am_model_por<-lmer(log(Am)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Porites"))
qqPlot(residuals(am_model_por))
```

Generate a Type III Anova of model.    

```{r}
anova(am_model_por, type="III")
summary(am_model_por)
```


### Analysis of AQY   

Build a mixed model for univariate analysis and examine data distribution. 

`aqy_model<-lmer(AQY~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
aqy_model<-lmer(AQY~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(aqy_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`aqy_model<-lmer(log(AQY)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
aqy_model<-lmer(log(AQY)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(aqy_model))
```

Generate a Type II Anova of model.    

```{r}
anova(aqy_model, type="II")
summary(aqy_model)
```

Since species is significant, test for effect of site and time within species.  

*Acropora*  

`aqy_model_acr<-lmer(log(AQY)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Acropora"))` 

```{r}
aqy_model_acr<-lmer(log(AQY)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Acropora"))
qqPlot(residuals(aqy_model_acr))
```

Generate a Type III Anova of model.    

```{r}
anova(aqy_model_acr, type="III")
summary(aqy_model_acr)
```

*Pocillopora*  

`aqy_model_poc<-lmer(log(AQY)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Pocillopora"))` 

```{r}
aqy_model_poc<-lmer(log(AQY)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Pocillopora"))
qqPlot(residuals(aqy_model_poc))
```

Generate a Type III Anova of model.    

```{r}
anova(aqy_model_poc, type="III")
summary(aqy_model_poc)
```

*Porites*  

`aqy_model_por<-lmer(log(AQY)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Porites"))` 

```{r}
aqy_model_por<-lmer(log(AQY)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Porites"))
qqPlot(residuals(aqy_model_por))
```

Generate a Type III Anova of model.    

```{r}
anova(aqy_model_por, type="III")
summary(aqy_model_por)
```

### Analysis of Rd   

Build a mixed model for univariate analysis and examine data distribution. 

`rd_model<-lmer(Rd~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
rd_model<-lmer(Rd~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(rd_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`rd_model<-lmer(log(Rd)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
rd_model<-lmer(log(Rd)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(rd_model))
```

Generate a Type II Anova of model.    

```{r}
anova(rd_model, type="III")
summary(rd_model)
```

Since species is significant, test for effects of site and time within species.  

*Acropora*  

`rd_model_acr<-lmer(log(Rd)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Acropora"))` 

```{r}
rd_model_acr<-lmer(log(Rd)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Acropora"))
qqPlot(residuals(rd_model_acr))
```

Generate a Type II Anova of model.    

```{r}
anova(rd_model_acr, type="III")
summary(rd_model_acr)
```

*Pocillopora*  

`rd_model_poc<-lmer(log(Rd)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Pocillopora"))` 

```{r}
rd_model_poc<-lmer(log(Rd)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Pocillopora"))
qqPlot(residuals(rd_model_poc))
```

Generate a Type II Anova of model.    

```{r}
anova(rd_model_poc, type="III")
summary(rd_model_poc)
```

*Porites*  

`rd_model_por<-lmer(log(Rd)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Porites"))` 

```{r}
rd_model_por<-lmer(log(Rd)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Porites"))
qqPlot(residuals(rd_model_por))
```

Generate a Type II Anova of model.    

```{r}
anova(rd_model_por, type="III")
summary(rd_model_por)
```


## Calcification    

### Plot: Calcification mgprot 

View by site and timepoint for each species.   
```{r}
calcplot_prot<-master %>%
  filter(!is.na(calc.umol.mgprot.hr)) %>% 
  filter(calc.umol.mgprot.hr<3)%>%
  filter(!is.na(species))%>%
  select(colony_id_corr, species, site_code, timepoint, calc.umol.mgprot.hr)%>%
  
  ggplot(., aes(x = site_code, y = calc.umol.mgprot.hr, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    ylab(expression(bold(paste(mu,"mol Ca", CO[3], " mg protein"^-1, " hr"^-1))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      )
```

### Plot: Calcification mgafdw 

View by site and timepoint for each species.   
```{r}
calcplot_afdw<-master %>%
  filter(!is.na(calc.umol.mgAFDW.hr)) %>% 
  filter(calc.umol.mgAFDW.hr>-.06)%>%
  filter(!is.na(species))%>%
  select(colony_id_corr, species, site_code, timepoint, calc.umol.mgAFDW.hr)%>%
  
  ggplot(., aes(x = site_code, y = calc.umol.mgAFDW.hr, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    ylab(expression(bold(paste(mu,"mol Ca", CO[3], " mg AFDW"^-1, " hr"^-1))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      )
```


### Plot: CRE umol cm2 

View by site and timepoint for each species.   
```{r}
calcplot_cm2<-master %>%
  filter(!is.na(calc.umol.cm2.hr)) %>% 
  filter(!is.na(species))%>%
  select(colony_id_corr, species, site_code, timepoint, calc.umol.cm2.hr)%>%
  
  ggplot(., aes(x = site_code, y = calc.umol.cm2.hr, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    ylab(expression(bold(paste(mu,"mol Ca", CO[3], " cm"^-2, " hr"^-1))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      )
```

Join all plots for each normalization together.  

```{r}
calc_figure<-plot_grid(calcplot_prot, calcplot_afdw, calcplot_cm2, labels = c("", "", ""), ncol=3, nrow=1, rel_widths = c(.8, .8, 1), label_size = 20, label_x = 0.1);calc_figure

ggsave(filename="Figures/Univariate/Calcification_Figure.pdf", plot=calc_figure, dpi=300, width=24, height=5, units="in")
```

### Analysis 

Build a mixed model for univariate analysis and examine data distribution of biomass normalized antioxidant capacity. 

`calc_model<-lmer(calc.umol.mgAFDW.hr~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
calc_model<-lmer(calc.umol.mgAFDW.hr~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(calc_model))
#hist(residuals(antiox_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`calc_model<-lmer(log(1+calc.umol.mgAFDW.hr)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
calc_model<-lmer(log(1+calc.umol.mgAFDW.hr)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(calc_model))
#hist(residuals(antiox_model))
```

We are going to need to find a stronger transformation for this data.  

Generate a Type III Anova of model.    

```{r}
anova(calc_model, type="III")
summary(calc_model)
```

Since species is significant, run a model for site and time effects within each species.  

*Acropora*:

`calc_model_acr<-lmer(log(1+calc.umol.mgAFDW.hr)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Acropora"))` 

```{r}
calc_model_acr<-lmer(log(1+calc.umol.mgAFDW.hr)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Acropora"))
qqPlot(residuals(calc_model_acr))
```

Generate a Type III Anova of model.    

```{r}
anova(calc_model_acr, type="III")
summary(calc_model_acr)
```

*Pocillopora*: 

`calc_model_poc<-lmer(log(1+calc.umol.mgAFDW.hr)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Pocillopora"))` 

```{r}
calc_model_poc<-lmer(log(1+calc.umol.mgAFDW.hr)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Pocillopora"))
qqPlot(residuals(calc_model_poc))
#hist(residuals(calc_model_poc))
```

Generate a Type III Anova of model.    

```{r}
anova(calc_model_poc, type="III")
summary(calc_model_poc)
```


*Porites*:  

`calc_model_por<-lmer(log(1+calc.umol.mgAFDW.hr)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Porites"))` 

```{r}
calc_model_por<-lmer(log(1+calc.umol.mgAFDW.hr)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Porites"))
qqPlot(residuals(calc_model_por))
#hist(residuals(calc_model_por))
```

Generate a Type III Anova of model.    

```{r}
anova(calc_model_por, type="III")
summary(calc_model_por)
```


## Generating univariate response panels  

First, specify symbiont and holobiont responses for plotting in separate panels.  
```{r}
symbiont_responses<-c("cells.mgAFDW", "Sym_AFDW.mg.cm2", "Total_Chl", "Total_Chl_cell", "Am", "AQY", "Ratio_AFDW.mg.cm2") 
host_responses<-c("cre.umol.mgafdw", "Host_AFDW.mg.cm2", "prot_mg.mgafdw", "Rd", "calc.umol.mgAFDW.hr")
```

Generate a panel of responses for symbiont metrics.  

```{r}
#build a plot for the legend
legend_plot<-chlplot_total_cell+theme(legend.position="bottom")

# extract the legend from one of the plots
legend <- get_legend(
  # create some space to the left of the legend
  legend_plot + theme(legend.box.margin = margin(1,1,1,1))
)

symbiont_univ<-plot_grid(symbplot_afdw, sAFDWplot, am_plot, aqy_plot, chlplot_total, chlplot_total_cell, ncol=3, nrow=2, rel_widths = c(1,1), align="h", label_y=1, labels=c("A", "B", "C", "D", "E", "F"), label_size=20)

symbiont_univ2<-plot_grid(symbiont_univ, legend, ncol=1, nrow=2, rel_heights = c(4, .2))

ggsave(filename="Figures/Univariate/Symbiont_Univariate_Panel.png", plot=symbiont_univ2, dpi=150, width=30, height=11, units="in")
```
 
Generate a panel of responses for host/holobiont metrics.  

```{r}
#build a plot for the legend
legend_plot<-calcplot_afdw+theme(legend.position="bottom")
rd_plot<-rd_plot+theme(legend.position="none")
calcplot_afdw<-calcplot_afdw+theme(legend.position="none") 

host_univ<-plot_grid(tacplot_afdw, hAFDWplot, ratioAFDWplot, protplot_afdw, rd_plot, calcplot_afdw, ncol=3, nrow=2, rel_widths = c(1, 1), align="h", label_y=1, labels=c("A", "B", "C", "D", "E", "F"), label_size=20)

host_univ2<-plot_grid(host_univ, legend, ncol=1, nrow=2, rel_heights = c(4, .2))

ggsave(filename="Figures/Univariate/Host_Univariate_Panel.png", plot=host_univ2, dpi=150, width=30, height=11, units="in")
```

# Correlations  

Generate a correlation matrix to examine relationships between responses of interest. Use normalizations by afdw for all responses.     
 
Generating network plot with corrr package.  
```{r}
master%>%
  select(cre.umol.mgafdw, prot_mg.mgafdw, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chlc2.ug.mgAFDW, chla.ug.mgAFDW, cells.mgAFDW, chla.ug.cell, chlc2.ug.cell, Am, AQY, Rd, calc.umol.mgAFDW.hr)%>%
  corrr::correlate(., method="spearman", diagonal=1)%>% #generate correlation matrix
  rearrange(.)%>%
  #shave(.)%>% #remove upper triangle
  network_plot(min_cor=.2)
```

Generating matrix with ggcorrplot for all colonies of all species.    

```{r}
p<-master%>%
  select(species, cre.umol.mgafdw, prot_mg.mgafdw, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chlc2.ug.mgAFDW, chla.ug.mgAFDW, cells.mgAFDW, chla.ug.cell, chlc2.ug.cell, Am, AQY, Rd, calc.umol.mgAFDW.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(!is.na(species))%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(prot_mg.mgafdw<1.5)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(calc.umol.mgAFDW.hr>-.06)%>%
  ggpairs(., columns=2:15, ggplot2::aes(colour=species)) #try to bold significant stats

#change colors
for(i in 1:p$nrow) {
  for(j in 1:p$ncol){
    p[i,j] <- p[i,j] + 
        scale_fill_manual(values=c("orange", "gray", "purple")) +
        scale_color_manual(values=c("orange", "gray", "purple")) +
        theme_classic()+
        theme(text=element_text(size=14, face="bold"))+
        theme(strip.text.x=element_text(face="bold", size=14))
  }
}

p

ggsave(plot=p, "Figures/Univariate/Correlation_Matrix.pdf", width=20, height=12, unit="in", dpi=300)
```
 
Acropora: 
```{r}
p<-master%>%
  filter(species=="Acropora")%>%
  select(site_code, cre.umol.mgafdw, prot_mg.mgafdw, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chlc2.ug.mgAFDW, chla.ug.mgAFDW, cells.mgAFDW, chla.ug.cell, chlc2.ug.cell, Am, AQY, Rd, calc.umol.mgAFDW.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(calc.umol.mgAFDW.hr>-.06)%>%
  ggpairs(., columns=2:15, ggplot2::aes(colour=site_code)) 

#change colors
for(i in 1:p$nrow) {
  for(j in 1:p$ncol){
    p[i,j] <- p[i,j] + 
        scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
        scale_color_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
        theme_classic()+
        theme(text=element_text(size=14, face="bold"))+
        theme(strip.text.x=element_text(face="bold", size=14))
  }
}

p

ggsave(plot=p, "Figures/Univariate/Correlation_Matrix_Acropora.pdf", width=20, height=12, unit="in", dpi=300)
```

Pocillopora
```{r}
p<-master%>%
  filter(species=="Pocillopora")%>%
  select(site_code, cre.umol.mgafdw, prot_mg.mgafdw, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chlc2.ug.mgAFDW, chla.ug.mgAFDW, cells.mgAFDW, chla.ug.cell, chlc2.ug.cell, Am, AQY, Rd, calc.umol.mgAFDW.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(calc.umol.mgAFDW.hr>-.06)%>%
  ggpairs(., columns=2:15, ggplot2::aes(colour=site_code)) 

#change colors
for(i in 1:p$nrow) {
  for(j in 1:p$ncol){
    p[i,j] <- p[i,j] + 
        scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
        scale_color_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
        theme_classic()+
        theme(text=element_text(size=14, face="bold"))+
        theme(strip.text.x=element_text(face="bold", size=14))
  }
}

p

ggsave(plot=p, "Figures/Univariate/Correlation_Matrix_Pocillopora.pdf", width=20, height=12, unit="in", dpi=300)
```

Porites 
```{r}
p<-master%>%
  filter(species=="Porites")%>%
  select(site_code, cre.umol.mgafdw, prot_mg.mgafdw, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chlc2.ug.mgAFDW, chla.ug.mgAFDW, cells.mgAFDW, chla.ug.cell, chlc2.ug.cell, Am, AQY, Rd, calc.umol.mgAFDW.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(prot_mg.mgafdw<1.5)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(calc.umol.mgAFDW.hr>-.06)%>%
  ggpairs(., columns=2:15, ggplot2::aes(colour=site_code)) 

#change colors
for(i in 1:p$nrow) {
  for(j in 1:p$ncol){
    p[i,j] <- p[i,j] + 
        scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
        scale_color_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
        theme_classic()+
        theme(text=element_text(size=14, face="bold"))+
        theme(strip.text.x=element_text(face="bold", size=14))
  }
}

p

ggsave(plot=p, "Figures/Univariate/Correlation_Matrix_Porites.pdf", width=20, height=12, unit="in", dpi=300)
```

Plot the most highly correlated variables across all species to determine which variables to plot over time.

View top 10.  
```{r}
p<-master%>%
  select(cre.umol.mgafdw, prot_mg.mgafdw, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chlc2.ug.mgAFDW, chla.ug.mgAFDW, cells.mgAFDW, chla.ug.cell, chlc2.ug.cell, Am, AQY, Rd, calc.umol.mgAFDW.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(prot_mg.mgafdw<1.5)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(calc.umol.mgAFDW.hr>-.06)

p<-na.omit(p)

z<-cor(p)
  
z[lower.tri(z,diag=TRUE)]=NA  #Prepare to drop duplicates and meaningless information
z=as.data.frame(as.table(z))  #Turn into a 3-column table
z=na.omit(z)  #Get rid of the junk we flagged above
z=z[order(-abs(z$Freq)),]    #Sort by highest correlation (whether +ve or -ve)

head(z, 10)
```

# Plotting relative change over time in each species  

## Over time    

Prepare data frame and calculate relative change in each metric compared to January 2020 timepoint. Not including calcification, relative change is far off the scale of other metrics. 

```{r}
timeseries<-master%>%
  select(species, site_code, month, colony_id_corr, timepoint, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2,  cells.mgAFDW, Total_Chl_cell, Total_Chl, prot_mg.mgafdw, cre.umol.mgafdw, Am, AQY, Rd, Ratio_AFDW.mg.cm2)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(prot_mg.mgafdw<1.5)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  gather(key="Metric", value="Value", -species, -site_code, -month, -colony_id_corr, -timepoint)%>%
  group_by(Metric, colony_id_corr, timepoint)%>%
  arrange(colony_id_corr, .by_group = TRUE)%>%
  group_by(colony_id_corr, Metric)%>%
  mutate(rel_change=((Value-first(Value))/abs(first(Value))))

head(timeseries)
```

Plot relative change in each metric over time for all species together.  
```{r}
timeseries$month<-factor(timeseries$month, levels = c("January 2020", "March 2020", "September 2020", "November 2020"))

time_plot1<-timeseries%>%
  
  ggplot(., aes(x=month, y=rel_change, colour=Metric))+
  scale_colour_brewer(palette="Paired")+
  geom_hline(yintercept=0)+
  ylab("Relative Change")+
  xlab("Time Point")+
  geom_smooth(inherit.aes=T, method="loess", aes(group = Metric), se=FALSE)+
  theme_classic(); time_plot1

ggsave(plot=time_plot1, "Figures/Univariate/Relative_Change_AllSpecies.png", width=9, height=6, unit="in", dpi=300)
```

Plot by species.   
```{r}
time_plot2<-timeseries%>%
  
  ggplot(., aes(x=month, y=rel_change,  colour=Metric))+
  facet_wrap(~species) +
  scale_colour_brewer(palette="Paired")+
  geom_hline(yintercept=0)+
  ylab("Relative Change")+
  xlab("Time Point")+
  geom_smooth(inherit.aes=T, method="loess", aes(group = Metric), se=FALSE)+
  theme_classic(); time_plot2

ggsave(plot=time_plot2, "Figures/Univariate/Relative_Change_EachSpecies.png", width=15, height=6, unit="in", dpi=300)
```


