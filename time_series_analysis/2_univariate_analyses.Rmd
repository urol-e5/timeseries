---
title: "Univariate analysis of E5 time series biological data"
author: "Ariana S Huffmyer, E5 RoL Team"
date: "03/15/2023"
output: 
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
editor_options: 
  chunk_output_type: console
--- 

# Set Up    
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

```{r}
## install packages if you dont already have them
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("RColorBrewer")) install.packages("RColorBrewer")
if (!require("lme4")) install.packages("lme4")
if (!require("lmerTest")) install.packages("lmerTest")
if (!require("car")) install.packages("car")
if (!require("effects")) install.packages("effects")
if (!require("ggfortify")) install.packages("ggfortify")
if (!require("cowplot")) install.packages("cowplot")
if (!require("vegan")) install.packages("vegan")
if (!require("corrr")) install.packages("corrr")
if (!require("ggcorrplot")) install.packages("ggcorrplot")
if (!require("GGally")) install.packages("GGally")
if (!require("broom")) install.packages("broom")
if (!require("cowplot")) install.packages("cowplot")
if (!require("directlabels")) install.packages("directlabels")
if (!require("broom")) install.packages("broom")

# load packages
library(tidyverse)
library(ggplot2)
library(RColorBrewer)
library(lme4)
library(lmerTest)
library(car)
library(effects)
library(ggfortify)
library(cowplot)
library(vegan)
library(corrr)
library(ggcorrplot)
library(GGally)
library(broom)
library(cowplot)
library(directlabels)
library(broom)
library(emmeans)
```

# Load dataframe

Load in master dataframe generated from 1_assemble_data.Rmd.  
```{r}
master<-read.csv("Output/master_timeseries.csv")

#reorder site levels 
master$site_code<-as.factor(master$site_code)
master$site_code<-fct_relevel(master$site_code, "Mahana Low", "Hilton Medium", "Manava High")

master$site<-as.factor(master$site)
master$site<-fct_relevel(master$site, "Mahana", "Hilton", "Manava")

master$month<-as.factor(master$month)
master$month<-fct_relevel(master$month, "January 2020", "March 2020", "September 2020", "November 2020")
```

# Univariate Responses  

Plot univariate response plots and then generate panel of all plots at the end of this section. Individual plots will not be displayed.  

## Antioxidant capacity  

### Plot: CRE umol mgprot 

View by site and timepoint for each species.   
```{r}
tacplot_prot<-master %>%
  filter(!is.na(cre.umol.mgprot)) %>% 
  filter(!is.na(species))%>%
  select(colony_id_corr, species, site, timepoint, cre.umol.mgprot)%>%
  
  ggplot(., aes(x = site, y = log(1+cre.umol.mgprot), fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    ylab(expression(bold(paste("log Antioxidant Capacity (", mu, "mol CRE mg protein"^-1,")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      );tacplot_prot
```

### Plot: CRE umol mgafdw 

View by site and timepoint for each species.   
```{r}
tacplot_afdw_box<-master %>%
  filter(!is.na(cre.umol.mgafdw)) %>%
  filter(!is.na(species))%>%
  select(colony_id_corr, species, site, timepoint, cre.umol.mgafdw)%>%
  
  ggplot(., aes(x = site, y = log(1+cre.umol.mgafdw), fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    ylab(expression(bold(paste("log Antioxidant Capacity (", mu, "mol CRE mg afdw"^-1,")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      );tacplot_afdw_box
```

View by means
```{r}
tacplot_afdw<-master %>%
  filter(!is.na(cre.umol.mgafdw)) %>%
  filter(!is.na(species))%>%
  select(colony_id_corr, species, site, month, cre.umol.mgafdw)%>%
  
  group_by(species, site, month)%>%
  summarise(mean=mean(cre.umol.mgafdw, na.rm=TRUE), se=sd(cre.umol.mgafdw, na.rm=TRUE)/sqrt(length(cre.umol.mgafdw)))%>%
  
  ggplot(., aes(x = month, y = mean, fill = site, group=interaction(site,month))) +
    geom_point(pch = 21, size=4, position = position_dodge(0.5)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0, linewidth=0.8, position=position_dodge(0.5))+
  
    labs(fill = "Site") +
    facet_wrap(~species) +
  
    scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
    scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  
    xlab("Month") + 
    ylab(expression(bold(paste("Antioxidant Capacity (", mu, "mol CRE mg afdw"^-1,")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      axis.text.x=element_text(size=10, color="black", angle=45, hjust=1, vjust=1),
      strip.text.x=element_text(face="italic", size=14), 
      panel.border = element_rect(fill=NA) 
      );tacplot_afdw
```

### Plot: CRE umol cm2 

View by site and timepoint for each species.   
```{r}
tacplot_cm2<-master %>%
  filter(!is.na(cre.umol.cm2)) %>%
  filter(!is.na(species))%>%
  select(colony_id_corr, species, site, timepoint, cre.umol.cm2)%>%
  
  ggplot(., aes(x = site, y = log(1+cre.umol.cm2), fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
     scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    ylab(expression(bold(paste("log Antioxidant Capacity (", mu, "mol CRE mg cm"^-2,")"))))+
    theme_classic() + 
    theme(
      legend.position="right",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      );tacplot_cm2

```

Join all plots for each normalization together.  

```{r}
tac_figure<-plot_grid(tacplot_prot, tacplot_afdw_box, tacplot_cm2, labels = c("", "", ""), ncol=3, nrow=1, rel_widths = c(.8, .8, 1), label_size = 20, label_x = 0.1)

ggsave(filename="Figures/Univariate/TAC_Figure.pdf", plot=tac_figure, dpi=300, width=24, height=5, units="in")
```

### Analysis 

Build a mixed model for univariate analysis and examine data distribution of biomass normalized antioxidant capacity. 

`antiox_model<-lmer(cre.umol.mgafdw~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
antiox_model<-lmer(cre.umol.mgafdw~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(antiox_model))
#hist(residuals(antiox_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`antiox_model<-lmer(log(1+cre.umol.mgafdw)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
antiox_model<-lmer(log(1+cre.umol.mgafdw)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(antiox_model))
#hist(residuals(antiox_model))
```

Generate a Type III Anova of model.    

```{r}
anova(antiox_model, type="III")
summary(antiox_model)

emm<-emmeans(antiox_model, ~ species)
pairs(emm)
```

Since species is significant, run a model for site and time effects within each species.  

*Acropora*:

`antiox_model_acr<-lmer(log(1+cre.umol.mgafdw)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Acropora"))` 

```{r}
antiox_model_acr<-lmer(log(1+cre.umol.mgafdw)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Acropora"))
qqPlot(residuals(antiox_model_acr))
```

Generate a Type III Anova of model.    

```{r}
anova(antiox_model_acr, type="III")
summary(antiox_model_acr)

emm<-emmeans(antiox_model_acr, ~ site | timepoint)
pairs(emm)

emm<-emmeans(antiox_model_acr, ~ timepoint | site)
pairs(emm)

emm<-emmeans(antiox_model_acr, ~ timepoint)
pairs(emm)
```

*Pocillopora*: 

`antiox_model_poc<-lmer(log(1+cre.umol.mgafdw)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Pocillopora"))` 

```{r}
antiox_model_poc<-lmer(log(1+cre.umol.mgafdw)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Pocillopora"))
qqPlot(residuals(antiox_model_poc))
#hist(residuals(antiox_model_poc))
```

Generate a Type III Anova of model.    

```{r}
anova(antiox_model_poc, type="III")
summary(antiox_model_poc)

emm<-emmeans(antiox_model_poc, ~ timepoint)
pairs(emm)
```


*Porites*:  

`antiox_model_por<-lmer(log(1+cre.umol.mgafdw)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Porites"))` 

```{r}
antiox_model_por<-lmer(log(1+cre.umol.mgafdw)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Porites"))
qqPlot(residuals(antiox_model_por))
#hist(residuals(antiox_model_por))
```

Generate a Type III Anova of model.    

```{r}
anova(antiox_model_por, type="III")
summary(antiox_model_por)

emm<-emmeans(antiox_model_por, ~ timepoint)
pairs(emm)

emm<-emmeans(antiox_model_por, ~ timepoint)
pairs(emm)
```


## Symbiont Densities  

### Plot: Surface Area    
 
View by site and timepoint for each species.   
```{r}
symbplot_cm2<-master %>%
  filter(!is.na(cells.cm2)) %>%
  filter(!is.na(species))%>%
  select(colony_id_corr, species, site, timepoint, cells.cm2)%>%
  
  ggplot(., aes(x = site, y = log(1+cells.cm2), fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("log Symbiont Cells cm"^-2))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      );symbplot_cm2
```

### Plot: Protein   

View by site and timepoint for each species.   
```{r}
symbplot_prot<-master %>%
  filter(!is.na(cells.mgprot)) %>%
   filter(!is.na(species))%>%
  select(colony_id_corr, species, site, timepoint, cells.mgprot)%>%
  
  ggplot(., aes(x = site, y = log(1+cells.mgprot), fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("log Symbiont Cells mg protein"^-1))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      );symbplot_prot

```

### Plot: Biomass   

View by site and timepoint for each species.   
```{r}
symbplot_afdw_box<-master %>%
  filter(!is.na(cells.mgAFDW)) %>%
    filter(!is.na(species))%>%
  select(colony_id_corr, species, site, timepoint, cells.mgAFDW)%>%
  
  ggplot(., aes(x = site, y = log(1+cells.mgAFDW), fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("log Symbiont Cells mg afdw"^-1))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      );symbplot_afdw_box
```

View by means
```{r}
symbplot_afdw<-master %>%
  filter(!is.na(cells.mgAFDW)) %>%
  filter(!is.na(species))%>%
  select(colony_id_corr, species, site, month, cells.mgAFDW)%>%
  
  group_by(species, site, month)%>%
  summarise(mean=mean(cells.mgAFDW, na.rm=TRUE), se=sd(cells.mgAFDW, na.rm=TRUE)/sqrt(length(cells.mgAFDW)))%>%
  
  ggplot(., aes(x = month, y = mean, fill = site, group=interaction(site,month))) +
    geom_point(pch = 21, size=4, position = position_dodge(0.5)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0, linewidth=0.8, position=position_dodge(0.5))+
  
    labs(fill = "Site") +
    facet_wrap(~species) +
  
    scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
    scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  
    ylim(1e+04, 9e+05)+
  
    xlab("Month") + 
    ylab(expression(bold(paste("Symbiont Density (cells mg afdw"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      axis.text.x=element_text(size=10, color="black", angle=45, hjust=1, vjust=1),
      strip.text.x=element_text(face="italic", size=14), 
      panel.border = element_rect(fill=NA) 
      );symbplot_afdw
```

Join all plots for each normalization together.  

```{r}
symbcells_figure<-plot_grid(symbplot_prot, symbplot_afdw_box, symbplot_cm2, labels = c("", "", ""), ncol=3, nrow=1, rel_widths = c(.8, .8, 1), label_size = 20, label_x = 0.1)

ggsave(filename="Figures/Univariate/CellDensity_Figure.pdf", plot=symbcells_figure, dpi=300, width=24, height=5, units="in")
```

### Analysis  

Build a mixed model for univariate analysis and examine data distribution.

`density_model<-lmer(cells.mgAFDW~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
density_model<-lmer(cells.mgAFDW~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(cells.mgAFDW>0))
qqPlot(residuals(density_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`density_model<-lmer(log(cells.mgAFDW)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
density_model<-lmer(log(cells.mgAFDW)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(cells.mgAFDW>0))
qqPlot(residuals(density_model))
```

Residuals are improved, but we need to revisit this model to improve fit.  

Generate a Type III Anova of model.    

```{r}
anova(density_model, type="III")

emm<-emmeans(density_model, ~ species)
pairs(emm)
```

Since species is significant, test for effects of time and site within each species.  

*Acropora*  

`density_model_acr<-lmer(log(cells.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(subset=c(cells.mgAFDW>0 & species=="Acropora"))` 

```{r}
density_model_acr<-lmer(log(cells.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(cells.mgAFDW>0 & species=="Acropora"))
qqPlot(residuals(density_model_acr))
```

Generate a Type III Anova of model.    

```{r}
anova(density_model_acr, type="III")

emm<-emmeans(density_model_acr, ~ timepoint)
pairs(emm)

emm<-emmeans(density_model_acr, ~ site | timepoint)
pairs(emm)

emm<-emmeans(density_model_acr, ~ timepoint | site)
pairs(emm)
```

*Pocillopora*  

`density_model_poc<-lmer(log(cells.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Pocillopora"))` 

```{r}
density_model_poc<-lmer(log(cells.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(cells.mgAFDW>0 & species=="Pocillopora"))
qqPlot(residuals(density_model_poc))
```

Generate a Type III Anova of model.    

```{r}
anova(density_model_poc, type="III")

emm<-emmeans(density_model_poc, ~ timepoint)
pairs(emm)

emm<-emmeans(density_model_poc, ~ site | timepoint)
pairs(emm)

emm<-emmeans(density_model_poc, ~ timepoint | site)
pairs(emm)
```

*Porites*  

`density_model_por<-lmer(log(cells.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Porites"))` 

```{r}
density_model_por<-lmer(log(cells.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(cells.mgAFDW>0 & species=="Porites"))
qqPlot(residuals(density_model_por))
```

Generate a Type III Anova of model.    

```{r}
anova(density_model_por, type="III")

emm<-emmeans(density_model_poc, ~ timepoint)
pairs(emm)

emm<-emmeans(density_model_poc, ~ site)
pairs(emm)

emm<-emmeans(density_model_poc, ~ site | timepoint)
pairs(emm)

emm<-emmeans(density_model_poc, ~ timepoint | site)
pairs(emm)
```


## Biomass

### Plot Host Biomass  
 
View by site and timepoint for each species in the host.  
```{r} 
hAFDWplot_box<-master %>%
  filter(!is.na(Host_AFDW.mg.cm2)) %>%
  filter(!is.na(species))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  select(colony_id_corr, species, site, timepoint, Host_AFDW.mg.cm2)%>%
  
  ggplot(., aes(x = site, y = log(1+Host_AFDW.mg.cm2), fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("log Host Biomass (mg afdw cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      );hAFDWplot_box
```

View by means
```{r}
hAFDWplot<-master %>%
  filter(!is.na(Host_AFDW.mg.cm2)) %>%
  filter(!is.na(species))%>%
  select(colony_id_corr, species, site, month, Host_AFDW.mg.cm2)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  
  group_by(species, site, month)%>%
  summarise(mean=mean(Host_AFDW.mg.cm2, na.rm=TRUE), se=sd(Host_AFDW.mg.cm2, na.rm=TRUE)/sqrt(length(Host_AFDW.mg.cm2)))%>%
  
  ggplot(., aes(x = month, y = mean, fill = site, group=interaction(site,month))) +
    geom_point(pch = 21, size=4, position = position_dodge(0.5)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0, linewidth=0.8, position=position_dodge(0.5))+
  
    labs(fill = "Site") +
    facet_wrap(~species) +
  
    scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
    scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  
    ylim(0, 10)+
  
    xlab("Month") + 
    ylab(expression(bold(paste("Host Biomass (mg afdw cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      axis.text.x=element_text(size=10, color="black", angle=45, hjust=1, vjust=1),
      strip.text.x=element_text(face="italic", size=14), 
      panel.border = element_rect(fill=NA) 
      );hAFDWplot
```

### Plot Symbiont biomass  

View by site and timepoint for each species in the symbiont   
```{r} 
sAFDWplot_box<-master %>%
  filter(!is.na(Sym_AFDW.mg.cm2)) %>%
  filter(!is.na(species))%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  select(colony_id_corr, species, site, timepoint, Sym_AFDW.mg.cm2)%>%
  
  ggplot(., aes(x = site, y = log(1+Sym_AFDW.mg.cm2), fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("log Sym. Biomass (mg afdw cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      );sAFDWplot_box
```

View by means
```{r}
sAFDWplot<-master %>%
  filter(!is.na(Sym_AFDW.mg.cm2)) %>%
  filter(!is.na(species))%>%
  select(colony_id_corr, species, site, month, Sym_AFDW.mg.cm2)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  
  group_by(species, site, month)%>%
  summarise(mean=mean(Sym_AFDW.mg.cm2, na.rm=TRUE), se=sd(Sym_AFDW.mg.cm2, na.rm=TRUE)/sqrt(length(Sym_AFDW.mg.cm2)))%>%
  
  ggplot(., aes(x = month, y = mean, fill = site, group=interaction(site,month))) +
    geom_point(pch = 21, size=4, position = position_dodge(0.5)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0, linewidth=0.8, position=position_dodge(0.5))+
  
    labs(fill = "Site") +
    facet_wrap(~species) +
  
    scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
    scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  
    ylim(0, 5)+
  
    xlab("Month") + 
    ylab(expression(bold(paste("Symbiont Biomass (mg afdw cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      axis.text.x=element_text(size=10, color="black", angle=45, hjust=1, vjust=1),
      strip.text.x=element_text(face="italic", size=14), 
      panel.border = element_rect(fill=NA) 
      );sAFDWplot
```

### Plot S:H Ratio  

Calculate biomass as a ratio of host to symbiont and plot.  

```{r} 
ratioAFDWplot_box<-master %>%
  filter(!is.na(Host_AFDW.mg.cm2)) %>%
  filter(!is.na(species))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  select(colony_id_corr, species, site, timepoint, Ratio_AFDW.mg.cm2)%>%
  
  ggplot(., aes(x = site, y = log(1+Ratio_AFDW.mg.cm2), fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("log Symbiont : Holobiont Biomass"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      );ratioAFDWplot_box
```

View by means
```{r}
ratioAFDWplot<-master %>%
  filter(!is.na(Sym_AFDW.mg.cm2)) %>%
  filter(!is.na(species))%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  select(colony_id_corr, species, site, month, Ratio_AFDW.mg.cm2)%>%
  
  group_by(species, site, month)%>%
  summarise(mean=mean(Ratio_AFDW.mg.cm2, na.rm=TRUE), se=sd(Ratio_AFDW.mg.cm2, na.rm=TRUE)/sqrt(length(Ratio_AFDW.mg.cm2)))%>%
  
  ggplot(., aes(x = month, y = mean, fill = site, group=interaction(site,month))) +
    geom_point(pch = 21, size=4, position = position_dodge(0.5)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0, linewidth=0.8, position=position_dodge(0.5))+
  
    labs(fill = "Site") +
    facet_wrap(~species) +
  
    scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
    scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  
    ylim(0, 0.5)+
  
    xlab("Month") + 
    ylab(expression(bold(paste("Symbiont : Host Biomass"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      axis.text.x=element_text(size=10, color="black", angle=45, hjust=1, vjust=1),
      strip.text.x=element_text(face="italic", size=14), 
      panel.border = element_rect(fill=NA) 
      );ratioAFDWplot
```

Join all plots together.  

```{r}
afdw_figure<-plot_grid(hAFDWplot_box, sAFDWplot_box, ratioAFDWplot_box, labels = c("", "", ""), ncol=3, nrow=1, rel_widths = c(.8, .8, 1), label_size = 20, label_x = 0.1)

ggsave(filename="Figures/Univariate/Biomass_Figure.pdf", plot=afdw_figure, dpi=300, width=24, height=5, units="in")
```

### Analysis  

Build a mixed model for univariate analysis and examine data distribution.

#### Host Biomass:  

`hAFDW_model<-lmer(Host_AFDW.mg.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0))` 

```{r}
hAFDW_model<-lmer(Host_AFDW.mg.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0))
qqPlot(residuals(hAFDW_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`hAFDW_model<-lmer(log(1+Host_AFDW.mg.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0))` 

```{r}
hAFDW_model<-lmer(log(1+Host_AFDW.mg.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0))
qqPlot(residuals(hAFDW_model))
```

Residuals are improved.

Generate a Type III Anova of model.    

```{r}
anova(hAFDW_model, type="III")
summary(hAFDW_model)

emm<-emmeans(hAFDW_model, ~ species)
pairs(emm)
```

Since species is significant, test for effects of site and time within each species.  

*Acropora*  
 
`hAFDW_model_acr<-lmer(log(1+Host_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0 & species=="Acropora"))` 

```{r}
hAFDW_model_acr<-lmer(log(1+Host_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0 & species=="Acropora"))
qqPlot(residuals(hAFDW_model_acr))
```

Generate a Type III Anova of model.    

```{r}
anova(hAFDW_model_acr, type="III")
summary(hAFDW_model_acr)

emm<-emmeans(hAFDW_model_acr, ~ timepoint)
pairs(emm)

emm<-emmeans(hAFDW_model_acr, ~ site)
pairs(emm)
```

*Pocillopora*  
 
`hAFDW_model_poc<-lmer(log(1+Host_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0 & species=="Pocillopora"))` 

```{r}
hAFDW_model_poc<-lmer(log(1+Host_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0 & species=="Pocillopora"))
qqPlot(residuals(hAFDW_model_poc))
```

Generate a Type III Anova of model.    

```{r}
anova(hAFDW_model_poc, type="III")
summary(hAFDW_model_poc)

emm<-emmeans(hAFDW_model_poc, ~ timepoint)
pairs(emm)

emm<-emmeans(hAFDW_model_poc, ~ site)
pairs(emm)

emm<-emmeans(hAFDW_model_poc, ~ site | timepoint)
pairs(emm)

emm<-emmeans(hAFDW_model_poc, ~ timepoint | site)
pairs(emm)
```

*Porites*  
 
`hAFDW_model_por<-lmer(log(1+Host_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0 & species=="Porites"))` 

```{r}
hAFDW_model_por<-lmer(log(1+Host_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0 & species=="Porites"))
qqPlot(residuals(hAFDW_model_por))
```

Generate a Type III Anova of model.    

```{r}
anova(hAFDW_model_por, type="III")
summary(hAFDW_model_por)

emm<-emmeans(hAFDW_model_por, ~ site)
pairs(emm)
```

#### Symbiont Biomass:  

`sAFDW_model<-lmer(Sym_AFDW.mg.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0))` 
```{r}
sAFDW_model<-lmer(Sym_AFDW.mg.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0))
qqPlot(residuals(sAFDW_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`sAFDW_model<-lmer(log(1+Sym_AFDW.mg.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0))` 

```{r}
sAFDW_model<-lmer(log(1+Sym_AFDW.mg.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0))
qqPlot(residuals(sAFDW_model))
```

Residuals are improved.  

Generate a Type III Anova of model.    

```{r}
anova(sAFDW_model, type="III")
summary(sAFDW_model)

emm<-emmeans(sAFDW_model, ~ species)
pairs(emm)
```

Since species is significant, test for effects of site and time within each species.  

*Acropora* 

`sAFDW_model_acr<-lmer(log(1+Sym_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0 & species=="Acropora"))` 

```{r}
sAFDW_model_acr<-lmer(log(1+Sym_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0 & species=="Acropora"))
qqPlot(residuals(sAFDW_model_acr))
```

Generate a Type III Anova of model.    

```{r}
anova(sAFDW_model_acr, type="III")
summary(sAFDW_model_acr)

emm<-emmeans(sAFDW_model_acr, ~ timepoint)
pairs(emm)

emm<-emmeans(sAFDW_model_acr, ~ site)
pairs(emm)

emm<-emmeans(sAFDW_model_acr, ~ timepoint | site)
pairs(emm)

emm<-emmeans(sAFDW_model_acr, ~ site | timepoint)
pairs(emm)
```

*Pocillopora* 

`sAFDW_model_poc<-lmer(log(1+Sym_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0 & species=="Pocillopora"))` 

```{r}
sAFDW_model_poc<-lmer(log(1+Sym_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0 & species=="Pocillopora"))
qqPlot(residuals(sAFDW_model_poc))
```

Generate a Type III Anova of model.    

```{r}
anova(sAFDW_model_poc, type="III")
summary(sAFDW_model_poc)

emm<-emmeans(sAFDW_model_poc, ~ timepoint)
pairs(emm)

emm<-emmeans(sAFDW_model_poc, ~ timepoint | site)
pairs(emm)

emm<-emmeans(sAFDW_model_poc, ~ site | timepoint)
pairs(emm)
```

*Porites* 

`sAFDW_model_poc<-lmer(log(1+Sym_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0 & species=="Porites"))` 

```{r}
sAFDW_model_por<-lmer(log(1+Sym_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0 & species=="Porites"))
qqPlot(residuals(sAFDW_model_por))
```

Generate a Type III Anova of model.    

```{r}
anova(sAFDW_model_por, type="III")
summary(sAFDW_model_por)

emm<-emmeans(sAFDW_model_por, ~ site)
pairs(emm)
```


#### S:H Biomass: 

`shAFDW_model<-lmer(Ratio_AFDW.mg.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0))` 

```{r}
shAFDW_model<-lmer(Ratio_AFDW.mg.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0))
qqPlot(residuals(shAFDW_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`shAFDW_model<-lmer(log(1+Ratio_AFDW.mg.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0))` 

```{r}
shAFDW_model<-lmer(log(1+Ratio_AFDW.mg.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0))
qqPlot(residuals(shAFDW_model))
```

Residuals are improved. 

Generate a Type III Anova of model.    

```{r}
anova(shAFDW_model, type="III")
summary(shAFDW_model)

emm<-emmeans(shAFDW_model, ~ species)
pairs(emm)
```

Since species is significant, test for effects of time and site within species.  

*Acropora*   

`shAFDW_model_acr<-lmer(log(1+Ratio_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0 & species=="Acropora"))` 

```{r}
shAFDW_model_acr<-lmer(log(1+Ratio_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0 & species=="Acropora"))
qqPlot(residuals(shAFDW_model_acr))
```

Generate a Type III Anova of model.    

```{r}
anova(shAFDW_model_acr, type="III")
summary(shAFDW_model_acr)

emm<-emmeans(shAFDW_model_acr, ~ timepoint)
pairs(emm)

emm<-emmeans(shAFDW_model_acr, ~ site)
pairs(emm)

emm<-emmeans(shAFDW_model_acr, ~ site | timepoint)
pairs(emm)

emm<-emmeans(shAFDW_model_acr, ~ timepoint | site)
pairs(emm)
```

*Pocillopora*   

`shAFDW_model_poc<-lmer(log(1+Ratio_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0 & species=="Pocillopora"))` 

```{r}
shAFDW_model_poc<-lmer(log(1+Ratio_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0 & species=="Pocillopora"))
qqPlot(residuals(shAFDW_model_poc))
```

Generate a Type III Anova of model.    

```{r}
anova(shAFDW_model_poc, type="III")
summary(shAFDW_model_poc)

emm<-emmeans(shAFDW_model_poc, ~ timepoint)
pairs(emm)

emm<-emmeans(shAFDW_model_poc, ~ site)
pairs(emm)

emm<-emmeans(shAFDW_model_poc, ~ site | timepoint)
pairs(emm)

emm<-emmeans(shAFDW_model_poc, ~ timepoint | site)
pairs(emm)
```

*Porites*   

`shAFDW_model_por<-lmer(log(1+Ratio_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0 & species=="Porites"))` 

```{r}
shAFDW_model_por<-lmer(log(1+Ratio_AFDW.mg.cm2)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0 & species=="Porites"))
qqPlot(residuals(shAFDW_model_por))
```

Generate a Type III Anova of model.    

```{r}
anova(shAFDW_model_por, type="III")
summary(shAFDW_model_por)

emm<-emmeans(shAFDW_model_poc, ~ timepoint)
pairs(emm)

emm<-emmeans(shAFDW_model_poc, ~ site)
pairs(emm)
```

## Chlorophyll  

### Plot: Surface area     

View by site and timepoint for each species in Chl a.    
```{r}
chlaplot_cm2<-master %>%
  filter(!is.na(chla.ug.cm2)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site, timepoint, chla.ug.cm2)%>%
  
  ggplot(., aes(x = site, y = log(1+chla.ug.cm2), fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("log Chlorophyll a (", mu, "g cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      );chlaplot_cm2
```

View by site and timepoint for each species in Chl c2.   
```{r}
chlc2plot_cm2<-master %>%
  filter(!is.na(chlc2.ug.cm2)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site, timepoint, chlc2.ug.cm2)%>%
  
  ggplot(., aes(x = site, y = log(1+chlc2.ug.cm2), fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("log Chlorophyll c2 (", mu, "g cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      );chlc2plot_cm2
```

### Plot: Protein    

View by site and timepoint for each species in Chl a.    
```{r}
chlaplot_prot<-master %>%
  filter(!is.na(chla.ug.mgprot)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site, timepoint, chla.ug.mgprot)%>%
  
  ggplot(., aes(x = site, y = log(1+chla.ug.mgprot), fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("log Chlorophyll a (", mu, "g mg protein"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      );chlaplot_prot
```

View by site and timepoint for each species in Chl c2.   
```{r}
chlc2plot_prot<-master %>%
  filter(!is.na(chlc2.ug.mgprot)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site, timepoint, chlc2.ug.mgprot)%>%
  
  ggplot(., aes(x = site, y = log(1+chlc2.ug.mgprot), fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("log Chlorophyll c2 (", mu, "g mg protein"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      );chlc2plot_prot
```

### Plot: Biomass    

View by site and timepoint for each species in Chl a.    
```{r}
chlaplot_afdw<-master %>%
  filter(!is.na(chla.ug.mgAFDW)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site, timepoint, chla.ug.mgAFDW)%>%
  
  ggplot(., aes(x = site, y = log(1+chla.ug.mgAFDW), fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("log Chlorophyll a (", mu, "g mg afdw"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      );chlaplot_afdw
```

View by site and timepoint for each species in Chl c2.   
```{r}
chlc2plot_afdw<-master %>%
  filter(!is.na(chlc2.ug.mgAFDW)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site, timepoint, chlc2.ug.mgAFDW)%>%
  
  ggplot(., aes(x = site, y = log(1+chlc2.ug.mgAFDW), fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("log Chlorophyll c2 (", mu, "g mg afdw"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      );chlc2plot_afdw
```

### Plot: Per cell    

View by site and timepoint for each species in Chl a.    
```{r}
chlaplot_cell<-master %>%
  filter(!is.na(chla.ug.cell)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site, timepoint, chla.ug.cell)%>%
  
  ggplot(., aes(x = site, y = log(1+chla.ug.cell), fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("log Chlorophyll a (", mu, "g cell"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      );chlaplot_cell
```

View by site and timepoint for each species in Chl c2.   
```{r}
chlc2plot_cell<-master %>%
  filter(!is.na(chlc2.ug.cell)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site, timepoint, chlc2.ug.cell)%>%
  
  ggplot(., aes(x = site, y = log(1+chlc2.ug.cell), fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("log Chlorophyll c2 (", mu, "g cell"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      );chlc2plot_cell
```

### Plot: Total chl  

View by site and timepoint for each species for total chl per unit AFDW.     
```{r}
chlplot_total_box<-master %>%
  filter(!is.na(Total_Chl)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site, timepoint, Total_Chl)%>%
  filter(Total_Chl>0)%>%
  
  ggplot(., aes(x = site, y = log(1+Total_Chl), fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("log Total Chlorophyll (", mu, "g mg afdw"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      );chlplot_total_box
```

View by means
```{r}
chlplot_total<-master %>%
  filter(!is.na(Total_Chl)) %>%
  filter(!is.na(species))%>%
  filter(Total_Chl>0)%>%
  select(colony_id_corr, species, site, month, Total_Chl)%>%
  
  group_by(species, site, month)%>%
  summarise(mean=mean(Total_Chl, na.rm=TRUE), se=sd(Total_Chl, na.rm=TRUE)/sqrt(length(Total_Chl)))%>%
  
  ggplot(., aes(x = month, y = mean, fill = site, group=interaction(site,month))) +
    geom_point(pch = 21, size=4, position = position_dodge(0.5)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0, linewidth=0.8, position=position_dodge(0.5))+
  
    labs(fill = "Site") +
    facet_wrap(~species) +
  
    scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
    scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  
    ylim(0, 7)+
  
    xlab("Month") + 
    ylab(expression(bold(paste("Total Chlorophyll (", mu, "g mg afdw"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      axis.text.x=element_text(size=10, color="black", angle=45, hjust=1, vjust=1),
      strip.text.x=element_text(face="italic", size=14), 
      panel.border = element_rect(fill=NA) 
      );chlplot_total
```

View by site and timepoint for each species for total chl per cell.     
```{r}
chlplot_total_cell_box<-master %>%
  filter(!is.na(Total_Chl_cell)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site, timepoint, Total_Chl_cell)%>%
  filter(Total_Chl_cell>0)%>%
  
  ggplot(., aes(x = site, y = log(1+Total_Chl_cell), fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Total Chlorophyll (", mu, "g cell"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      );chlplot_total_cell_box
```

View by means
```{r}
chlplot_total_cell<-master %>%
  filter(!is.na(Total_Chl_cell)) %>%
  filter(!is.na(species))%>%
  filter(Total_Chl_cell>0)%>%
  select(colony_id_corr, species, site, month, Total_Chl_cell)%>%
  
  group_by(species, site, month)%>%
  summarise(mean=mean(Total_Chl_cell, na.rm=TRUE), se=sd(Total_Chl_cell, na.rm=TRUE)/sqrt(length(Total_Chl_cell)))%>%
  
  ggplot(., aes(x = month, y = mean, fill = site, group=interaction(site,month))) +
    geom_point(pch = 21, size=4, position = position_dodge(0.5)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0, linewidth=0.8, position=position_dodge(0.5))+
  
    labs(fill = "Site") +
    facet_wrap(~species) +
  
    scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
    scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  
    ylim(0, 3e-05)+
  
    xlab("Month") + 
    ylab(expression(bold(paste("Total Chlorophyll (", mu, "g cell"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      axis.text.x=element_text(size=10, color="black", angle=45, hjust=1, vjust=1),
      strip.text.x=element_text(face="italic", size=14), 
      panel.border = element_rect(fill=NA) 
      );chlplot_total_cell
```

Join all plots for each normalization together.  

```{r}
chl_figure<-plot_grid(chlplot_total_box, chlaplot_prot, chlaplot_afdw, chlaplot_cell, chlaplot_cm2, chlplot_total_cell_box, chlc2plot_prot, chlc2plot_afdw, chlc2plot_cell, chlc2plot_cm2,  labels = c("", "", ""), ncol=5, nrow=2, rel_widths = c(.8, .8, .8, .8, 1, .8, .8, .8, .8, 1), label_size = 20, label_x = 0.1)

ggsave(filename="Figures/Univariate/Chlorophyll_Figure.pdf", plot=chl_figure, dpi=300, width=36, height=10, units="in")
```


### Analysis  

Build a mixed model for univariate analysis and examine data distribution.

#### Chlorophyll a: 

`chla_model<-lmer(chla.ug.mgAFDW~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
chla_model<-lmer(chla.ug.mgAFDW~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(chla_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`chla_model<-lmer(log(1+chla.ug.mgAFDW)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chla.ug.mgAFDW>0))` 

```{r}
chla_model<-lmer(log(1+chla.ug.mgAFDW)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chla.ug.mgAFDW>0))
qqPlot(residuals(chla_model))
```

Generate a Type III Anova of model.    

```{r}
anova(chla_model, type="III")
summary(chla_model)

emm<-emmeans(chla_model, ~ species)
pairs(emm)
```

Since species is significant, test for effects of site and time within each species.  

*Acropora*  

`chla_model_acr<-lmer(log(1+chla.ug.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chla.ug.mgAFDW>0 & species=="Acropora"))` 

```{r}
chla_model_acr<-lmer(log(1+chla.ug.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chla.ug.mgAFDW>0 & species=="Acropora"))
qqPlot(residuals(chla_model_acr))
```

Generate a Type III Anova of model.    

```{r}
anova(chla_model_acr, type="III")
summary(chla_model_acr)

emm<-emmeans(chla_model_acr, ~ timepoint)
pairs(emm)

emm<-emmeans(chla_model_acr, ~ timepoint | site)
pairs(emm)

emm<-emmeans(chla_model_acr, ~ site | timepoint)
pairs(emm)
```

*Pocillopora*  

`chla_model_poc<-lmer(log(1+chla.ug.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chla.ug.mgAFDW>0 & species=="Pocillopora"))` 

```{r}
chla_model_poc<-lmer(log(1+chla.ug.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chla.ug.mgAFDW>0 & species=="Pocillopora"))
qqPlot(residuals(chla_model_poc))
```

Generate a Type III Anova of model.    

```{r}
anova(chla_model_poc, type="III")
summary(chla_model_poc)

emm<-emmeans(chla_model_poc, ~ timepoint)
pairs(emm)

emm<-emmeans(chla_model_poc, ~ site)
pairs(emm)

emm<-emmeans(chla_model_poc, ~ site | timepoint)
pairs(emm)

emm<-emmeans(chla_model_poc, ~ timepoint | site)
pairs(emm)
```

*Porites*  

`chla_model_por<-lmer(log(1+chla.ug.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chla.ug.mgAFDW>0 & species=="Porites"))` 

```{r}
chla_model_por<-lmer(log(1+chla.ug.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chla.ug.mgAFDW>0 & species=="Porites"))
qqPlot(residuals(chla_model_por))
```

Generate a Type III Anova of model.    

```{r}
anova(chla_model_por, type="III")
summary(chla_model_por)

emm<-emmeans(chla_model_por, ~ timepoint)
pairs(emm)

emm<-emmeans(chla_model_por, ~ site)
pairs(emm)

emm<-emmeans(chla_model_por, ~ timepoint | site)
pairs(emm)

emm<-emmeans(chla_model_por, ~ site | timepoint)
pairs(emm)
```


#### Chlorophyll c2: 

Build a mixed model for univariate analysis and examine data distribution.

`chlc2_model<-lmer(chlc2.ug.mgAFDW~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chlc2.ug.mgAFDW>0))` 

```{r}
chlc2_model<-lmer(chlc2.ug.mgAFDW~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chlc2.ug.mgAFDW>0))
qqPlot(residuals(chlc2_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`chlc2_model<-lmer(log(1+chlc2.ug.mgAFDW)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chlc2.ug.mgAFDW>0))` 

```{r}
chlc2_model<-lmer(log(1+chlc2.ug.mgAFDW)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chlc2.ug.mgAFDW>0))
qqPlot(residuals(chlc2_model))
```

Return to check residual distribution in this model.  

Generate a Type III Anova of model.    

```{r}
anova(chlc2_model, type="III")
summary(chlc2_model)

emm<-emmeans(chlc2_model, ~ species)
pairs(emm)
```

Since species is significant, test for effects of site and time within species.  

*Acropora* 

`chlc2_model_acr<-lmer(log(1+chlc2.ug.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chlc2.ug.mgAFDW>0 & species=="Acropora))` 

```{r}
chlc2_model_acr<-lmer(log(1+chlc2.ug.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chlc2.ug.mgAFDW>0 & species=="Acropora"))
qqPlot(residuals(chlc2_model_acr))
```

Generate a Type III Anova of model.    

```{r}
anova(chlc2_model_acr, type="III")
summary(chlc2_model_acr)

emm<-emmeans(chlc2_model_acr, ~ timepoint)
pairs(emm)

emm<-emmeans(chlc2_model_acr, ~ site)
pairs(emm)

emm<-emmeans(chlc2_model_acr, ~ timepoint | site)
pairs(emm)

emm<-emmeans(chlc2_model_acr, ~ site | timepoint)
pairs(emm)
```


*Pocillopora* 

`chlc2_model_poc<-lmer(log(1+chlc2.ug.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chlc2.ug.mgAFDW>0 & species=="Pocillopora))` 

```{r}
chlc2_model_poc<-lmer(log(1+chlc2.ug.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chlc2.ug.mgAFDW>0 & species=="Pocillopora"))
qqPlot(residuals(chlc2_model_poc))
```

Generate a Type III Anova of model.    

```{r}
anova(chlc2_model_poc, type="III")
summary(chlc2_model_poc)

emm<-emmeans(chlc2_model_poc, ~ timepoint)
pairs(emm)

emm<-emmeans(chlc2_model_poc, ~ site)
pairs(emm)

emm<-emmeans(chlc2_model_poc, ~ timepoint | site)
pairs(emm)

emm<-emmeans(chlc2_model_poc, ~ site | timepoint)
pairs(emm)
```

*Porites* 

`chlc2_model_por<-lmer(log(1+chlc2.ug.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chlc2.ug.mgAFDW>0 & species=="Porites))` 

```{r}
chlc2_model_por<-lmer(log(1+chlc2.ug.mgAFDW)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(chlc2.ug.mgAFDW>0 & species=="Porites"))
qqPlot(residuals(chlc2_model_por))
```

Generate a Type III Anova of model.    

```{r}
anova(chlc2_model_por, type="III")
summary(chlc2_model_por)

emm<-emmeans(chlc2_model_por, ~ timepoint)
pairs(emm)

emm<-emmeans(chlc2_model_por, ~ site)
pairs(emm)

emm<-emmeans(chlc2_model_por, ~ timepoint | site)
pairs(emm)

emm<-emmeans(chlc2_model_por, ~ site | timepoint)
pairs(emm)
```

#### Total Chlorophyll (a + c2): 

Build a mixed model for univariate analysis and examine data distribution.

`chltotal_model<-lmer(Total_Chl~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl>0))` 

```{r}
chltotal_model<-lmer(Total_Chl~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl>0))
qqPlot(residuals(chltotal_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`chltotal_model<-lmer(log(1+Total_Chl)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl>0))` 

```{r}
chltotal_model<-lmer(log(1+Total_Chl)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl>0))
qqPlot(residuals(chltotal_model))
```

Generate a Type III Anova of model.    

```{r}
anova(chltotal_model, type="III")
summary(chltotal_model)

emm<-emmeans(chltotal_model, ~ species)
pairs(emm)
```

Since species is significant, test for effects of time and site within species.  

*Acropora*  

`chltotal_model_acr<-lmer(log(1+Total_Chl)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl>0 & species=="Acropora"))` 

```{r}
chltotal_model_acr<-lmer(log(1+Total_Chl)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl>0 & species=="Acropora"))
qqPlot(residuals(chltotal_model_acr))
```

Generate a Type III Anova of model.    

```{r}
anova(chltotal_model_acr, type="III")
summary(chltotal_model_acr)

emm<-emmeans(chltotal_model_acr, ~ timepoint)
pairs(emm)

emm<-emmeans(chltotal_model_acr, ~ site)
pairs(emm)

emm<-emmeans(chltotal_model_acr, ~ timepoint | site)
pairs(emm)

emm<-emmeans(chltotal_model_acr, ~ site | timepoint)
pairs(emm)
```

*Pocillopora*  

`chltotal_model_poc<-lmer(log(1+Total_Chl)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl>0 & species=="Pocillopora"))` 

```{r}
chltotal_model_poc<-lmer(log(1+Total_Chl)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl>0 & species=="Pocillopora"))
qqPlot(residuals(chltotal_model_poc))
```

Generate a Type III Anova of model.    

```{r}
anova(chltotal_model_poc, type="III")
summary(chltotal_model_poc)

emm<-emmeans(chltotal_model_poc, ~ timepoint)
pairs(emm)

emm<-emmeans(chltotal_model_poc, ~ site)
pairs(emm)

emm<-emmeans(chltotal_model_poc, ~ timepoint | site)
pairs(emm)

emm<-emmeans(chltotal_model_poc, ~ site | timepoint)
pairs(emm)
```

*Porites*  

`chltotal_model_poc<-lmer(log(1+Total_Chl)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl>0 & species=="Porites"))` 

```{r}
chltotal_model_por<-lmer(log(1+Total_Chl)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl>0 & species=="Porites"))
qqPlot(residuals(chltotal_model_por))
```

Generate a Type III Anova of model.    

```{r}
anova(chltotal_model_por, type="III")
summary(chltotal_model_por)

emm<-emmeans(chltotal_model_por, ~ timepoint)
pairs(emm)

emm<-emmeans(chltotal_model_por, ~ site)
pairs(emm)

emm<-emmeans(chltotal_model_por, ~ timepoint | site)
pairs(emm)

emm<-emmeans(chltotal_model_por, ~ site | timepoint)
pairs(emm)
```

#### Total Chlorophyll per cell (a + c2): 

Build a mixed model for univariate analysis and examine data distribution.

`chltotalcell_model<-lmer(Total_Chl_cell~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl_cell>0))` 

```{r}
chltotalcell_model<-lmer(Total_Chl_cell~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl_cell>0))
qqPlot(residuals(chltotalcell_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`chltotalcell_model<-lmer(log(1+Total_Chl_cell)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl_cell>0))` 

```{r}
chltotalcell_model<-lmer(log(1+Total_Chl_cell)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl_cell>0))
qqPlot(residuals(chltotalcell_model))
```

Return to check distribution of residuals.  

Generate a Type III Anova of model.    

```{r}
anova(chltotalcell_model, type="III")
summary(chltotalcell_model)

emm<-emmeans(chltotalcell_model, ~ species)
pairs(emm)
```

Since species is significant, test for effects of time and set within species.  

*Acropora*   

`chltotalcell_model_acr<-lmer(log(1+Total_Chl_cell)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl_cell>0 & species=="Acropora"))` 

```{r}
chltotalcell_model_acr<-lmer(log(1+Total_Chl_cell)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl_cell>0 & species=="Acropora"))
qqPlot(residuals(chltotalcell_model_acr))
```

Generate a Type III Anova of model.    

```{r}
anova(chltotalcell_model_acr, type="III")
summary(chltotalcell_model_acr)

emm<-emmeans(chltotalcell_model_acr, ~ timepoint)
pairs(emm)
```

*Pocillopora*   

`chltotalcell_model_poc<-lmer(log(1+Total_Chl_cell)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl_cell>0 & species=="Pocillopora"))` 

```{r}
chltotalcell_model_poc<-lmer(log(1+Total_Chl_cell)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl_cell>0 & species=="Pocillopora"))
qqPlot(residuals(chltotalcell_model_poc))
```

Generate a Type III Anova of model.    

```{r}
anova(chltotalcell_model_poc, type="III")
summary(chltotalcell_model_poc)

emm<-emmeans(chltotalcell_model_poc, ~ timepoint)
pairs(emm)

emm<-emmeans(chltotalcell_model_poc, ~ site)
pairs(emm)
```

*Porites*   

`chltotalcell_model_por<-lmer(log(1+Total_Chl_cell)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl_cell>0 & species=="Porites"))` 

```{r}
chltotalcell_model_por<-lmer(log(1+Total_Chl_cell)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Total_Chl_cell>0 & species=="Porites"))
qqPlot(residuals(chltotalcell_model_por))
```

Generate a Type III Anova of model.    

```{r}
anova(chltotalcell_model_por, type="III")
summary(chltotalcell_model_por)

emm<-emmeans(chltotalcell_model_por, ~ timepoint)
pairs(emm)

emm<-emmeans(chltotalcell_model_por, ~ site)
pairs(emm)
```

## Protein 

### Plot: Surface Area  

View by site and timepoint for each species.    
```{r}
protplot_cm2<-master %>%
  filter(!is.na(prot_mg.cm2)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site, timepoint, prot_mg.cm2)%>%
  
  ggplot(., aes(x = site, y = log(1+prot_mg.cm2), fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("log Protein (mg cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      );protplot_cm2
```

### Plot: AFDW  

View by site and timepoint for each species.    
```{r}
protplot_afdw_box<-master %>%
  filter(!is.na(prot_mg.mgafdw)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site, timepoint, prot_mg.mgafdw)%>%
  filter(prot_mg.mgafdw>0)%>%
  
  ggplot(., aes(x = site, y = log(1+prot_mg.mgafdw), fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("log Protein (mg mg afdw"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      );protplot_afdw_box
```

View by means
```{r}
protplot_afdw<-master %>%
  filter(!is.na(prot_mg.mgafdw)) %>%
  filter(!is.na(species))%>%
  select(colony_id_corr, species, site, month, prot_mg.mgafdw)%>%
  filter(prot_mg.mgafdw>0)%>%
  filter(prot_mg.mgafdw<1)%>%
  
  group_by(species, site, month)%>%
  summarise(mean=mean(prot_mg.mgafdw, na.rm=TRUE), se=sd(prot_mg.mgafdw, na.rm=TRUE)/sqrt(length(prot_mg.mgafdw)))%>%
  
  ggplot(., aes(x = month, y = mean, fill = site, group=interaction(site,month))) +
    geom_point(pch = 21, size=4, position = position_dodge(0.5)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0, linewidth=0.8, position=position_dodge(0.5))+
  
    labs(fill = "Site") +
    facet_wrap(~species) +
  
    scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
    scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  
    ylim(0, 0.5)+
  
    xlab("Month") + 
    ylab(expression(bold(paste("Protein (mg mg afdw"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      axis.text.x=element_text(size=10, color="black", angle=45, hjust=1, vjust=1),
      strip.text.x=element_text(face="italic", size=14), 
      panel.border = element_rect(fill=NA) 
      );protplot_afdw
```

Join all plots for each normalization together.  

```{r}
prot_figure<-plot_grid(protplot_afdw_box, protplot_cm2, labels = c("", "", ""), ncol=2, nrow=1, rel_widths = c(.8, 1), label_size = 20, label_x = 0.1)

ggsave(filename="Figures/Univariate/Protein_Figure.pdf", plot=prot_figure, dpi=300, width=16, height=5, units="in")
```

### Analysis  

Build a mixed model for univariate analysis and examine data distribution. 

`prot_model<-lmer(prot_mg.mgafdw~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(prot_ug.mgAFDW>0))` 

```{r}
prot_model<-lmer(prot_mg.mgafdw~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(prot_mg.mgafdw>0 & prot_mg.mgafdw<1))
qqPlot(residuals(prot_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`prot_model<-lmer(log(1+prot_mg.mgafdw)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(prot_ug.mgafdw>0))` 

```{r}
prot_model<-lmer(log(1+prot_mg.mgafdw)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(prot_mg.mgafdw>0 & prot_mg.mgafdw<1))
qqPlot(residuals(prot_model))
```

Generate a Type III Anova of model.    

```{r}
anova(prot_model, type="III")
summary(prot_model)

emm<-emmeans(prot_model, ~ species)
pairs(emm)
```

Since species is significant, test for effects of site and time within each species.  

*Acropora*  

`prot_model_acr<-lmer(log(1+prot_mg.mgafdw)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(prot_ug.mgafdw>0 & species=="Acropora"))` 

```{r}
prot_model_acr<-lmer(log(1+prot_mg.mgafdw)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(prot_mg.mgafdw>0 & prot_mg.mgafdw<1 & species=="Acropora"))
qqPlot(residuals(prot_model_acr))
```

Generate a Type III Anova of model.    

```{r}
anova(prot_model_acr, type="III")
summary(prot_model_acr)

emm<-emmeans(prot_model_acr, ~ timepoint)
pairs(emm)

emm<-emmeans(prot_model_acr, ~ timepoint | site)
pairs(emm)

emm<-emmeans(prot_model_acr, ~ site | timepoint)
pairs(emm)
```

*Pocillopora*  

`prot_model_poc<-lmer(log(1+prot_mg.mgafdw)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(prot_ug.mgafdw>0 & species=="Pocillopora"))` 

```{r}
prot_model_poc<-lmer(log(1+prot_mg.mgafdw)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(prot_mg.mgafdw>0 & prot_mg.mgafdw<1 & species=="Pocillopora"))
qqPlot(residuals(prot_model_poc))
```

Generate a Type III Anova of model.    

```{r}
anova(prot_model_poc, type="III")
summary(prot_model_poc)

emm<-emmeans(prot_model_poc, ~ timepoint)
pairs(emm)

emm<-emmeans(prot_model_poc, ~ site)
pairs(emm)

emm<-emmeans(prot_model_poc, ~ timepoint | site)
pairs(emm)

emm<-emmeans(prot_model_poc, ~ site | timepoint)
pairs(emm)
```

*Porites*  

`prot_model_por<-lmer(log(1+prot_mg.mgafdw)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(prot_ug.mgafdw>0 & species=="Porites"))` 

```{r}
prot_model_por<-lmer(log(1+prot_mg.mgafdw)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(prot_mg.mgafdw>0 & prot_mg.mgafdw<1 & species=="Porites"))
qqPlot(residuals(prot_model_por))
```

Generate a Type III Anova of model.    

```{r}
anova(prot_model_por, type="III")
summary(prot_model_por)

emm<-emmeans(prot_model_por, ~ timepoint)
pairs(emm)

emm<-emmeans(prot_model_por, ~ site)
pairs(emm)

emm<-emmeans(prot_model_por, ~ timepoint | site)
pairs(emm)

emm<-emmeans(prot_model_por, ~ site | timepoint)
pairs(emm)
```

## PI Curve Parameters   

### Plot: Am   

View by site and timepoint for each species.    
```{r}
am_plot_box<-master %>%
  filter(!is.na(AQY)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site, timepoint, AQY, Am, Rd)%>%
  
  ggplot(., aes(x = site, y = log(1+Am), fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("log P" [Max], " (mol O" [2], " cm"^-2, " h"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      );am_plot_box
```

View by means
```{r}
am_plot<-master %>%
  filter(!is.na(Am)) %>%
  filter(!is.na(species))%>%
  select(colony_id_corr, species, site, month, Am)%>%
  
  group_by(species, site, month)%>%
  summarise(mean=mean(Am, na.rm=TRUE), se=sd(Am, na.rm=TRUE)/sqrt(length(Am)))%>%
  
  ggplot(., aes(x = month, y = mean, fill = site, group=interaction(site,month))) +
    geom_point(pch = 21, size=4, position = position_dodge(0.5)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0, linewidth=0.8, position=position_dodge(0.5))+
  
    labs(fill = "Site") +
    facet_wrap(~species) +
  
    scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
    scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  
    ylim(0, 3)+
  
    xlab("Month") + 
    ylab(expression(bold(paste("P" [Max], " (mol O" [2], " cm"^-2, " h"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      axis.text.x=element_text(size=10, color="black", angle=45, hjust=1, vjust=1),
      strip.text.x=element_text(face="italic", size=14), 
      panel.border = element_rect(fill=NA) 
      );am_plot
```

### Plot: AQY  

View by site and timepoint for each species.    
```{r}
aqy_plot_box<-master %>%
  filter(!is.na(AQY)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site, timepoint, AQY, Am, Rd)%>%
  
  ggplot(., aes(x = site, y = log(1+AQY), fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("log Quantum Yield (alpha)"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      );aqy_plot_box
```

View by means
```{r}
aqy_plot<-master %>%
  filter(!is.na(AQY)) %>%
  filter(!is.na(species))%>%
  select(colony_id_corr, species, site, month, AQY)%>%
  
  group_by(species, site, month)%>%
  summarise(mean=mean(AQY, na.rm=TRUE), se=sd(AQY, na.rm=TRUE)/sqrt(length(AQY)))%>%
  
  ggplot(., aes(x = month, y = mean, fill = site, group=interaction(site,month))) +
    geom_point(pch = 21, size=4, position = position_dodge(0.5)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0, linewidth=0.8, position=position_dodge(0.5))+
  
    labs(fill = "Site") +
    facet_wrap(~species) +
  
    scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
    scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  
    ylim(0, 0.012)+
  
    xlab("Month") + 
    ylab(expression(bold(paste("Apparent Quantum Yield (AQY)"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      axis.text.x=element_text(size=10, color="black", angle=45, hjust=1, vjust=1),
      strip.text.x=element_text(face="italic", size=14), 
      panel.border = element_rect(fill=NA) 
      );aqy_plot
```

### Plot: Rd  

View by site and timepoint for each species.    
```{r}
rd_plot_box<-master %>%
  filter(!is.na(AQY)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site, timepoint, AQY, Am, Rd)%>%
  
  ggplot(., aes(x = site, y = log(1+Rd), fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("log Respiration (mol O" [2], " cm"^-2, " h"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.position="none",
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      );rd_plot_box
```

View by means
```{r}
rd_plot<-master %>%
  filter(!is.na(Rd)) %>%
  filter(!is.na(species))%>%
  select(colony_id_corr, species, site, month, Rd)%>%
  
  group_by(species, site, month)%>%
  summarise(mean=mean(Rd, na.rm=TRUE), se=sd(Rd, na.rm=TRUE)/sqrt(length(Rd)))%>%
  
  ggplot(., aes(x = month, y = mean, fill = site, group=interaction(site,month))) +
    geom_point(pch = 21, size=4, position = position_dodge(0.5)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0, linewidth=0.8, position=position_dodge(0.5))+
  
    labs(fill = "Site") +
    facet_wrap(~species) +
  
    scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
    scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  
    ylim(0, 1.25)+
  
    xlab("Month") + 
    ylab(expression(bold(paste("Respiration (R" [D], ") (mol O" [2], " cm"^-2, " h"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      axis.text.x=element_text(size=10, color="black", angle=45, hjust=1, vjust=1),
      strip.text.x=element_text(face="italic", size=14), 
      panel.border = element_rect(fill=NA) 
      );rd_plot
```

### Plot: Ik  

View by site and timepoint for each species.    
```{r}
Ik_plot_box<-master %>%
  filter(!is.na(AQY)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site, timepoint, AQY, Am, Rd, Ik, Ic)%>%
  
  ggplot(., aes(x = site, y = Ik, fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Ik (PAR)"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      legend.position="none",
      strip.text.x=element_text(face="italic", size=14)
      );Ik_plot_box
```

View by means
```{r}
Ik_plot<-master %>%
  filter(!is.na(Ik)) %>%
  filter(!is.na(species))%>%
  select(colony_id_corr, species, site, month, Ik)%>%
  
  group_by(species, site, month)%>%
  summarise(mean=mean(Ik, na.rm=TRUE), se=sd(Ik, na.rm=TRUE)/sqrt(length(Ik)))%>%
  
  ggplot(., aes(x = month, y = mean, fill = site, group=interaction(site,month))) +
    geom_point(pch = 21, size=4, position = position_dodge(0.5)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0, linewidth=0.8, position=position_dodge(0.5))+
  
    labs(fill = "Site") +
    facet_wrap(~species) +
  
    scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
    scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  
    ylim(0, 650)+
  
    xlab("Month") + 
    ylab(expression(bold(paste("I" [K], " (PAR)"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      axis.text.x=element_text(size=10, color="black", angle=45, hjust=1, vjust=1),
      strip.text.x=element_text(face="italic", size=14), 
      panel.border = element_rect(fill=NA) 
      );Ik_plot
```

View species means 
```{r}
master %>%
  filter(!is.na(Ik)) %>%
  filter(!is.na(species))%>%
  select(colony_id_corr, species, site, month, Ik)%>%
  group_by(species)%>%
  summarise(mean=mean(Ik, na.rm=TRUE), se=sd(Ik, na.rm=TRUE)/sqrt(length(Ik)))

```

### Plot: Ic  

View by site and timepoint for each species.    
```{r}
Ic_plot_box<-master %>%
  filter(!is.na(AQY)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site, timepoint, AQY, Am, Rd, Ik, Ic)%>%
  filter(Ic<1000)%>% #remove outliers
  
  ggplot(., aes(x = site, y = Ic, fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Ic (PAR)"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      );Ic_plot_box
```

View by means
```{r}
Ic_plot<-master %>%
  filter(!is.na(Ic)) %>%
  filter(!is.na(species))%>%
  select(colony_id_corr, species, site, month, Ic)%>%
  filter(Ic<1000)%>%
  
  group_by(species, site, month)%>%
  summarise(mean=mean(Ic, na.rm=TRUE), se=sd(Ic, na.rm=TRUE)/sqrt(length(Ic)))%>%
  
  ggplot(., aes(x = month, y = mean, fill = site, group=interaction(site,month))) +
    geom_point(pch = 21, size=4, position = position_dodge(0.5)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0, linewidth=0.8, position=position_dodge(0.5))+
  
    labs(fill = "Site") +
    facet_wrap(~species) +
  
    scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
    scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  
    ylim(0, 650)+
  
    xlab("Month") + 
    ylab(expression(bold(paste("I" [C], " (PAR)"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      axis.text.x=element_text(size=10, color="black", angle=45, hjust=1, vjust=1),
      strip.text.x=element_text(face="italic", size=14), 
      panel.border = element_rect(fill=NA) 
      );Ic_plot
```

View species means. 

```{r}
master %>%
  filter(!is.na(Ic)) %>%
  filter(!is.na(species))%>%
  select(colony_id_corr, species, site, month, Ic)%>%
  group_by(species)%>%
  summarise(mean=mean(Ic, na.rm=TRUE), se=sd(Ic, na.rm=TRUE)/sqrt(length(Ic)))

```

Join all plots together.  

```{r}
pi_figure<-plot_grid(am_plot_box, aqy_plot_box, rd_plot_box, Ik_plot_box, Ic_plot_box, labels = c("", "", "", "", ""), ncol=5, nrow=1, rel_widths = c(.8, .8, .8, .8, 1), label_size = 20, label_x = 0.1)

ggsave(filename="Figures/Univariate/PI_Figure.pdf", plot=pi_figure, dpi=300, width=30, height=5, units="in")
```

### Analysis of Am   

Build a mixed model for univariate analysis and examine data distribution. 

`am_model<-lmer(Am~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
am_model<-lmer(Am~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(am_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`am_model<-lmer(log(Am)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 
```{r}
am_model<-lmer(log(Am)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(am_model))
```

Generate a Type III Anova of model.    

```{r}
anova(am_model, type="III")
summary(am_model)

emm<-emmeans(am_model, ~ species)
pairs(emm)
```

Since species is significant, test for effects of time and site within species.  

*Acropora*  

`am_model<-lmer(log(Am)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Acropora"))` 

```{r}
am_model_acr<-lmer(log(Am)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Acropora"))
qqPlot(residuals(am_model_acr))
```

Generate a Type III Anova of model.    

```{r}
anova(am_model_acr, type="III")
summary(am_model_acr)

emm<-emmeans(am_model_acr, ~ timepoint)
pairs(emm)

emm<-emmeans(am_model_acr, ~ site)
pairs(emm)
```

*Pocillopora*  

`am_model_poc<-lmer(log(Am)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Pocillopora"))` 

```{r}
am_model_poc<-lmer(log(Am)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Pocillopora"))
qqPlot(residuals(am_model_poc))
```

Generate a Type III Anova of model.    

```{r}
anova(am_model_poc, type="III")
summary(am_model_poc)

emm<-emmeans(am_model_poc, ~ timepoint)
pairs(emm)
```

*Porites*  

`am_model_por<-lmer(log(Am)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Porites"))` 

```{r}
am_model_por<-lmer(log(Am)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Porites"))
qqPlot(residuals(am_model_por))
```

Generate a Type III Anova of model.    

```{r}
anova(am_model_por, type="III")
summary(am_model_por)

emm<-emmeans(am_model_por, ~ timepoint)
pairs(emm)

emm<-emmeans(am_model_por, ~ site)
pairs(emm)
```

### Analysis of AQY   

Build a mixed model for univariate analysis and examine data distribution. 

`aqy_model<-lmer(AQY~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
aqy_model<-lmer(AQY~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(aqy_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`aqy_model<-lmer(log(AQY)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
aqy_model<-lmer(log(AQY)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(aqy_model))
```

Generate a Type II Anova of model.    

```{r}
anova(aqy_model, type="II")
summary(aqy_model)

emm<-emmeans(aqy_model, ~ species)
pairs(emm)
```

Since species is significant, test for effect of site and time within species.  

*Acropora*  

`aqy_model_acr<-lmer(log(AQY)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Acropora"))` 

```{r}
aqy_model_acr<-lmer(log(AQY)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Acropora"))
qqPlot(residuals(aqy_model_acr))
```

Generate a Type III Anova of model.    

```{r}
anova(aqy_model_acr, type="III")
summary(aqy_model_acr)

#no significant effects, no posthoc 
```

*Pocillopora*  

`aqy_model_poc<-lmer(log(AQY)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Pocillopora"))` 

```{r}
aqy_model_poc<-lmer(log(AQY)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Pocillopora"))
qqPlot(residuals(aqy_model_poc))
```

Generate a Type III Anova of model.    

```{r}
anova(aqy_model_poc, type="III")
summary(aqy_model_poc)

emm<-emmeans(aqy_model_poc, ~ timepoint)
pairs(emm)

emm<-emmeans(aqy_model_poc, ~ site)
pairs(emm)
```

*Porites*  

`aqy_model_por<-lmer(log(AQY)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Porites"))` 

```{r}
aqy_model_por<-lmer(log(AQY)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Porites"))
qqPlot(residuals(aqy_model_por))
```

Generate a Type III Anova of model.    

```{r}
anova(aqy_model_por, type="III")
summary(aqy_model_por)

emm<-emmeans(aqy_model_por, ~ timepoint)
pairs(emm)
```

### Analysis of Rd   

Build a mixed model for univariate analysis and examine data distribution. 

`rd_model<-lmer(Rd~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
rd_model<-lmer(Rd~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(rd_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`rd_model<-lmer(log(Rd)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
rd_model<-lmer(log(Rd)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(rd_model))
```

Generate a Type II Anova of model.    

```{r}
anova(rd_model, type="III")
summary(rd_model)

emm<-emmeans(rd_model, ~ species)
pairs(emm)
```

Since species is significant, test for effects of site and time within species.  

*Acropora*  

`rd_model_acr<-lmer(log(Rd)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Acropora"))` 

```{r}
rd_model_acr<-lmer(log(Rd)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Acropora"))
qqPlot(residuals(rd_model_acr))
```

Generate a Type II Anova of model.    

```{r}
anova(rd_model_acr, type="III")
summary(rd_model_acr)

emm<-emmeans(rd_model_acr, ~ timepoint)
pairs(emm)

emm<-emmeans(rd_model_acr, ~ site)
pairs(emm)
```

*Pocillopora*  

`rd_model_poc<-lmer(log(Rd)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Pocillopora"))` 

```{r}
rd_model_poc<-lmer(log(Rd)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Pocillopora"))
qqPlot(residuals(rd_model_poc))
```

Generate a Type II Anova of model.    

```{r}
anova(rd_model_poc, type="III")
summary(rd_model_poc)

emm<-emmeans(rd_model_poc, ~ timepoint | site)
pairs(emm)

emm<-emmeans(rd_model_poc, ~ site)
pairs(emm)

emm<-emmeans(rd_model_poc, ~ site | timepoint)
pairs(emm)
```

*Porites*  

`rd_model_por<-lmer(log(Rd)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Porites"))` 

```{r}
rd_model_por<-lmer(log(Rd)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Porites"))
qqPlot(residuals(rd_model_por))
```

Generate a Type II Anova of model.    

```{r}
anova(rd_model_por, type="III")
summary(rd_model_por)

emm<-emmeans(rd_model_por, ~ timepoint)
pairs(emm)

emm<-emmeans(rd_model_por, ~ site)
pairs(emm)
```


### Analysis of Ik   

Build a mixed model for univariate analysis and examine data distribution. 

`Ik_model<-lmer(Ik~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
Ik_model<-lmer(Ik~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(Ik_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`Ik_model<-lmer(log(Ik)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 
```{r}
Ik_model<-lmer(log(Ik)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(Ik_model))
```

Generate a Type II Anova of model.    

```{r}
anova(Ik_model, type="III")
summary(Ik_model)

emm<-emmeans(Ik_model, ~ species)
pairs(emm)
```

Since species is significant, test for effects of site and time within species.  

*Acropora*  

`Ik_model_acr<-lmer(log(Ik)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Acropora"))` 

```{r}
Ik_model_acr<-lmer(log(Ik)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Acropora"))
qqPlot(residuals(Ik_model_acr))
```

Generate a Type II Anova of model.    

```{r}
anova(Ik_model_acr, type="III")
summary(Ik_model_acr)

emm<-emmeans(Ik_model_acr, ~ timepoint)
pairs(emm)
```

*Pocillopora*  

`Ik_model_poc<-lmer(log(Ik)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Pocillopora"))` 

```{r}
Ik_model_poc<-lmer(log(Ik)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Pocillopora"))
qqPlot(residuals(Ik_model_poc))
```

Generate a Type II Anova of model.    

```{r}
anova(Ik_model_poc, type="III")
summary(Ik_model_poc)

emm<-emmeans(Ik_model_poc, ~ timepoint)
pairs(emm)
```

*Porites*  

`Ik_model_por<-lmer(log(Ik)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Porites"))` 

```{r}
Ik_model_por<-lmer(log(Ik)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Porites"))
qqPlot(residuals(Ik_model_por))
```

Generate a Type II Anova of model.    

```{r}
anova(Ik_model_por, type="III")
summary(Ik_model_por)

emm<-emmeans(Ik_model_por, ~ timepoint)
pairs(emm)

emm<-emmeans(Ik_model_por, ~ site)
pairs(emm)

emm<-emmeans(Ik_model_por, ~ timepoint | site)
pairs(emm)

emm<-emmeans(Ik_model_por, ~ site | timepoint)
pairs(emm)
```

Ik is different by site and time for POR, but only by time in other species. 


### Analysis of Ic   

Build a mixed model for univariate analysis and examine data distribution. 

`Ic_model<-lmer(Ic~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
Ic_model<-lmer(Ic~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(Ic_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`Ik_model<-lmer(log(Ik)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 
```{r}
Ic_model<-lmer(log(Ic)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(Ic_model))
```

Generate a Type II Anova of model.    

```{r}
anova(Ic_model, type="III")
summary(Ic_model)

emm<-emmeans(Ic_model, ~ species)
pairs(emm)
```

Since species is significant, test for effects of site and time within species.  

*Acropora*  

`Ic_model_acr<-lmer(log(Ic)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Acropora"))` 

```{r}
Ic_model_acr<-lmer(log(Ic)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Acropora"))
qqPlot(residuals(Ic_model_acr))
```

Generate a Type II Anova of model.    

```{r}
anova(Ic_model_acr, type="III")
summary(Ic_model_acr)

emm<-emmeans(Ic_model_acr, ~ timepoint)
pairs(emm)

emm<-emmeans(Ic_model_acr, ~ site)
pairs(emm)
```

*Pocillopora*  

`Ic_model_poc<-lmer(log(Ic)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Pocillopora"))` 

```{r}
Ic_model_poc<-lmer(log(Ic)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Pocillopora"))
qqPlot(residuals(Ic_model_poc))
```

Generate a Type II Anova of model.    

```{r}
anova(Ic_model_poc, type="III")
summary(Ic_model_poc)

emm<-emmeans(Ic_model_poc, ~ timepoint)
pairs(emm)

emm<-emmeans(Ic_model_poc, ~ site | timepoint)
pairs(emm)

emm<-emmeans(Ic_model_poc, ~ timepoint | site)
pairs(emm)
```

*Porites*  

`Ic_model_por<-lmer(log(Ic)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Porites"))` 

```{r}
Ic_model_por<-lmer(log(Ic)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Porites"))
qqPlot(residuals(Ic_model_por))
```

Generate a Type II Anova of model.    

```{r}
anova(Ic_model_por, type="III")
summary(Ic_model_por)

emm<-emmeans(Ic_model_por, ~ timepoint)
pairs(emm)

emm<-emmeans(Ic_model_por, ~ timepoint | site)
pairs(emm)

emm<-emmeans(Ic_model_por, ~ site | timepoint)
pairs(emm)
```

## Calcification    

### Plot: Calcification mgprot 

View by site and timepoint for each species.   
```{r}
calcplot_prot<-master %>%
  filter(!is.na(calc.umol.mgprot.hr)) %>% 
  filter(calc.umol.mgprot.hr<3)%>%
  filter(!is.na(species))%>%
  select(colony_id_corr, species, site, timepoint, calc.umol.mgprot.hr)%>%
  
  ggplot(., aes(x = site, y = log(1+calc.umol.mgprot.hr), fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    ylab(expression(bold(paste("log Calcification (", mu,"mol Ca", CO[3], " mg protein"^-1, " hr"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      );calcplot_prot
```

### Plot: Calcification mgafdw 

View by site and timepoint for each species.   
```{r}
calcplot_afdw<-master %>%
  filter(!is.na(calc.umol.mgAFDW.hr)) %>% 
  filter(calc.umol.mgAFDW.hr>-.06)%>%
  filter(!is.na(species))%>%
  select(colony_id_corr, species, site, timepoint, calc.umol.mgAFDW.hr)%>%
  
  ggplot(., aes(x = site, y = log(1+calc.umol.mgAFDW.hr), fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    ylab(expression(bold(paste("log Calcification (", mu,"mol Ca", CO[3], " mg protein"^-1, " hr"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      );calcplot_afdw
```

### Plot: Calcification umol cm2 

View by site and timepoint for each species.   
```{r}
calcplot_cm2_box<-master %>%
  filter(!is.na(calc.umol.cm2.hr)) %>% 
  filter(!is.na(species))%>%
  select(colony_id_corr, species, site, timepoint, calc.umol.cm2.hr)%>%
  
  ggplot(., aes(x = site, y = log(1+calc.umol.cm2.hr), fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    ylab(expression(bold(paste("log Calcification (", mu,"mol Ca", CO[3], " cm"^-2, " hr"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      );calcplot_cm2_box
```

View by means
```{r}
calcplot_cm2<-master %>%
  filter(!is.na(calc.umol.cm2.hr)) %>%
  filter(calc.umol.cm2.hr>0)%>%
  filter(!is.na(species))%>%
  select(colony_id_corr, species, site, month, calc.umol.cm2.hr)%>%
  
  group_by(species, site, month)%>%
  summarise(mean=mean(calc.umol.cm2.hr, na.rm=TRUE), se=sd(calc.umol.cm2.hr, na.rm=TRUE)/sqrt(length(calc.umol.cm2.hr)))%>%
  
  ggplot(., aes(x = month, y = mean, fill = site, group=interaction(site,month))) +
    geom_point(pch = 21, size=4, position = position_dodge(0.5)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0, linewidth=0.8, position=position_dodge(0.5))+
  
    labs(fill = "Site") +
    facet_wrap(~species) +
  
    scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
    scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  
    ylim(0, 1.5)+
  
    xlab("Month") + 
    ylab(expression(bold(paste("Calcification (", mu,"mol Ca", CO[3], " cm"^-2, " hr"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      axis.text.x=element_text(size=10, color="black", angle=45, hjust=1, vjust=1),
      strip.text.x=element_text(face="italic", size=14), 
      panel.border = element_rect(fill=NA) 
      );calcplot_cm2
```

Join all plots for each normalization together.  

```{r}
calc_figure<-plot_grid(calcplot_prot, calcplot_afdw, calcplot_cm2_box, labels = c("", "", ""), ncol=3, nrow=1, rel_widths = c(.8, .8, 1), label_size = 20, label_x = 0.1);calc_figure

ggsave(filename="Figures/Univariate/Calcification_Figure.pdf", plot=calc_figure, dpi=300, width=24, height=5, units="in")
```

### Analysis 

Build a mixed model for univariate analysis and examine data distribution of surface area normalized antioxidant capacity. 

`calc_model<-lmer(calc.umol.cm2.hr~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
calc_model<-lmer(calc.umol.mgAFDW.hr~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(calc_model))
#hist(residuals(antiox_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`calc_model<-lmer(log(1+calc.umol.cm2.hr)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
calc_model<-lmer(log(1+calc.umol.cm2.hr)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(calc_model))
#hist(residuals(antiox_model))
```

Generate a Type III Anova of model.    

```{r}
anova(calc_model, type="III")
summary(calc_model)

emm<-emmeans(calc_model, ~ species)
pairs(emm)
```

Since species is significant, run a model for site and time effects within each species to see if this helps assumptions.  

*Acropora*:

`calc_model_acr<-lmer(log(1+calc.umol.cm2.hr)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Acropora"))` 

```{r}
calc_model_acr<-lmer(log(1+calc.umol.cm2.hr)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Acropora"))
qqPlot(residuals(calc_model_acr))
```

Generate a Type III Anova of model.    

```{r}
anova(calc_model_acr, type="III")
summary(calc_model_acr)

emm<-emmeans(calc_model_acr, ~ timepoint)
pairs(emm)

emm<-emmeans(calc_model_acr, ~ timepoint | site)
pairs(emm)

emm<-emmeans(calc_model_acr, ~ site | timepoint)
pairs(emm)
```

*Pocillopora*: 

`calc_model_poc<-lmer(log(1+calc.umol.cm2.hr)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Pocillopora"))` 

```{r}
calc_model_poc<-lmer(log(1+calc.umol.cm2.hr)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Pocillopora"))
qqPlot(residuals(calc_model_poc))
#hist(residuals(calc_model_poc))
```

Generate a Type III Anova of model.    

```{r}
anova(calc_model_poc, type="III")
summary(calc_model_poc)

emm<-emmeans(calc_model_poc, ~ timepoint)
pairs(emm)
```
Time is significant. 

*Porites*:  

`calc_model_por<-lmer(log(1+calc.umol.cm2.hr)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Porites"))` 

```{r}
calc_model_por<-lmer(log(1+calc.umol.cm2.hr)~timepoint*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(species=="Porites"))
qqPlot(residuals(calc_model_por))
#hist(residuals(calc_model_por))
```

Generate a Type III Anova of model.    

```{r}
anova(calc_model_por, type="III")
summary(calc_model_por)

emm<-emmeans(calc_model_por, ~ timepoint)
pairs(emm)

emm<-emmeans(calc_model_por, ~ site)
pairs(emm)

emm<-emmeans(calc_model_por, ~ timepoint | site)
pairs(emm)

emm<-emmeans(calc_model_por, ~ site | timepoint)
pairs(emm)
```
Time, site, and time x site are significant. 

## Generating univariate response panels  

First, specify symbiont and holobiont responses for plotting in separate panels.  
```{r}
symbiont_responses<-c("cells.mgAFDW", "Sym_AFDW.mg.cm2", "Total_Chl", "Total_Chl_cell", "Am", "AQY", "Ratio_AFDW.mg.cm2", "Ik", "Ic") 
host_responses<-c("cre.umol.mgafdw", "Host_AFDW.mg.cm2", "prot_mg.mgafdw", "Rd", "calc.umol.cm2.hr")
```

Generate a panel of responses for symbiont metrics.  

```{r}
#build a plot for the legend
legend_plot<-chlplot_total_cell+theme(legend.position="bottom")

# extract the legend from one of the plots
legend <- get_legend(
  # create some space to the left of the legend
  legend_plot + theme(legend.box.margin = margin(1,1,1,1))
)

Ic_plot<-Ic_plot + theme(legend.position="none")

symbplot_afdw<-symbplot_afdw+theme(axis.text.x=element_blank())
sAFDWplot<-sAFDWplot+theme(axis.text.x=element_blank())
am_plot<-am_plot+theme(axis.text.x=element_blank())
aqy_plot<-aqy_plot+theme(axis.text.x=element_blank())
Ik_plot<-Ik_plot+theme(axis.text.x=element_blank())
Ic_plot<-Ic_plot+theme(axis.text.x=element_blank())

symbiont_univ<-plot_grid(symbplot_afdw, sAFDWplot, am_plot, aqy_plot, Ik_plot, Ic_plot, chlplot_total, chlplot_total_cell, ratioAFDWplot, ncol=3, nrow=3, rel_widths = c(1,1,1), rel_heights = c(0.8, 0.8, 1), align="v", label_y=1, labels=c("A", "B", "C", "D", "E", "F", "G", "H", "I"), label_size=20)

symbiont_univ2<-plot_grid(symbiont_univ, legend, ncol=1, nrow=2, rel_heights = c(4, .2))

ggsave(filename="Figures/Univariate/Symbiont_Univariate_Panel.png", plot=symbiont_univ2, dpi=150, width=20, height=15, units="in")
```
 
Generate a panel of responses for host/holobiont metrics.  

```{r}
#build a plot for the legend
legend_plot<-calcplot_cm2+theme(legend.position="bottom")
rd_plot<-rd_plot+theme(legend.position="none")
calcplot_cm2<-calcplot_cm2+theme(legend.position="none") 

tacplot_afdw<-tacplot_afdw+theme(axis.text.x=element_blank()) + theme(axis.title.x=element_blank()) + theme(axis.title.y=element_text(size=12))
hAFDWplot<-hAFDWplot+theme(axis.text.x=element_blank()) + theme(axis.title.x=element_blank())+ theme(axis.title.y=element_text(size=12))
protplot_afdw<-protplot_afdw+theme(axis.text.x=element_blank()) + theme(axis.title.x=element_blank()) + theme(axis.title.y=element_text(size=12))
rd_plot<-rd_plot+theme(axis.text.x=element_blank()) + theme(axis.title.x=element_blank())+ theme(axis.title.y=element_text(size=12))
calcplot_cm2<-calcplot_cm2+ theme(axis.title.y=element_text(size=12))
 
host_univ<-plot_grid(tacplot_afdw, hAFDWplot, protplot_afdw, rd_plot, calcplot_cm2, ncol=1, nrow=5, rel_heights = c(0.8, 0.8, 0.8, 0.8, 1), align="v", label_y=1, labels=c("A", "B", "C", "D", "E"), label_size=20)

host_univ2<-plot_grid(host_univ, legend, ncol=1, nrow=2, rel_heights = c(4, .2))

ggsave(filename="Figures/Univariate/Host_Univariate_Panel.png", plot=host_univ2, dpi=150, width=8, height=22, units="in")
```

# Correlations  

Generate a correlation matrix to examine relationships between responses of interest. Use normalizations by afdw for all responses.     
 
Generating network plot with corrr package.  
```{r}
master%>%
  select(cre.umol.mgafdw, prot_mg.mgafdw, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chlc2.ug.mgAFDW, chla.ug.mgAFDW, cells.mgAFDW, chla.ug.cell, chlc2.ug.cell, Am, AQY, Rd, Ik, Ic, calc.umol.cm2.hr)%>%
  mutate(across(everything(), ~log(. + 1)))%>%# log transform all data 
  corrr::correlate(., method="spearman", diagonal=1)%>% #generate correlation matrix
  rearrange(.)%>%
  #shave(.)%>% #remove upper triangle
  network_plot(min_cor=.2)
```

Generating matrix with ggcorrplot for all colonies of all species.    

```{r}
p<-master%>%
  select(species, cre.umol.mgafdw, prot_mg.mgafdw, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chlc2.ug.mgAFDW, chla.ug.mgAFDW, cells.mgAFDW, chla.ug.cell, chlc2.ug.cell, Am, AQY, Rd, Ik, Ic, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(!is.na(species))%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(prot_mg.mgafdw<1.5)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  #filter(calc.umol.mgAFDW.hr>-.06)%>%
  mutate(across(c(2:17), ~log(. + 1)))%>%# log transform all data 
  ggpairs(., columns=2:17, ggplot2::aes(colour=species)) #try to bold significant stats

#change colors
for(i in 1:p$nrow) {
  for(j in 1:p$ncol){
    p[i,j] <- p[i,j] + 
        scale_fill_manual(values=c("orange", "gray", "purple")) +
        scale_color_manual(values=c("orange", "gray", "purple")) +
        theme_classic()+
        theme(text=element_text(size=14, face="bold"))+
        theme(strip.text.x=element_text(face="bold", size=14))
  }
}

p

ggsave(plot=p, "Figures/Univariate/Correlation_Matrix.pdf", width=20, height=12, unit="in", dpi=300)
```
 
Acropora: 
```{r}
p<-master%>%
  filter(species=="Acropora")%>%
  select(site, cre.umol.mgafdw, prot_mg.mgafdw, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chlc2.ug.mgAFDW, chla.ug.mgAFDW, cells.mgAFDW, chla.ug.cell, chlc2.ug.cell, Am, AQY, Rd, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  #filter(calc.umol.mgAFDW.hr>-.06)%>%
  mutate(across(c(2:17), ~log(. + 1)))%>%# log transform all data 
  ggpairs(., columns=2:17, ggplot2::aes(colour=site)) 

#change colors
for(i in 1:p$nrow) {
  for(j in 1:p$ncol){
    p[i,j] <- p[i,j] + 
        scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
        scale_color_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
        theme_classic()+
        theme(text=element_text(size=14, face="bold"))+
        theme(strip.text.x=element_text(face="bold", size=14))
  }
}

p

ggsave(plot=p, "Figures/Univariate/Correlation_Matrix_Acropora.pdf", width=20, height=12, unit="in", dpi=300)
```

Pocillopora
```{r}
p<-master%>%
  filter(species=="Pocillopora")%>%
  select(site, cre.umol.mgafdw, prot_mg.mgafdw, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chlc2.ug.mgAFDW, chla.ug.mgAFDW, cells.mgAFDW, chla.ug.cell, chlc2.ug.cell, Am, AQY, Rd, Ik, Ic, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  #filter(calc.umol.mgAFDW.hr>-.06)%>%
  mutate(across(c(2:17), ~log(. + 1)))%>%# log transform all data 
  ggpairs(., columns=2:17, ggplot2::aes(colour=site)) 

#change colors
for(i in 1:p$nrow) {
  for(j in 1:p$ncol){
    p[i,j] <- p[i,j] + 
        scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
        scale_color_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
        theme_classic()+
        theme(text=element_text(size=14, face="bold"))+
        theme(strip.text.x=element_text(face="bold", size=14))
  }
}

p

ggsave(plot=p, "Figures/Univariate/Correlation_Matrix_Pocillopora.pdf", width=20, height=12, unit="in", dpi=300)
```

Porites 
```{r}
p<-master%>%
  filter(species=="Porites")%>%
  select(site, cre.umol.mgafdw, prot_mg.mgafdw, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chlc2.ug.mgAFDW, chla.ug.mgAFDW, cells.mgAFDW, chla.ug.cell, chlc2.ug.cell, Am, AQY, Rd, Ik, Ic, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(prot_mg.mgafdw<1.5)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  #filter(calc.umol.mgAFDW.hr>-.06)%>%
  mutate(across(c(2:17), ~log(. + 1)))%>%# log transform all data 
  ggpairs(., columns=2:17, ggplot2::aes(colour=site)) 

#change colors
for(i in 1:p$nrow) {
  for(j in 1:p$ncol){
    p[i,j] <- p[i,j] + 
        scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
        scale_color_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
        theme_classic()+
        theme(text=element_text(size=14, face="bold"))+
        theme(strip.text.x=element_text(face="bold", size=14))
  }
}

p

ggsave(plot=p, "Figures/Univariate/Correlation_Matrix_Porites.pdf", width=20, height=12, unit="in", dpi=300)
```

Plot the most highly correlated variables across all species to determine which variables to plot over time.

View top 10 correlated variables.  
```{r}
p<-master%>%
  select(cre.umol.mgafdw, prot_mg.mgafdw, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chlc2.ug.mgAFDW, chla.ug.mgAFDW, cells.mgAFDW, chla.ug.cell, chlc2.ug.cell, Am, AQY, Rd, Ik, Ic, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(prot_mg.mgafdw<1.5)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  mutate(across(everything(), ~log(. + 1)))# log transform all data 

p<-na.omit(p)

z<-cor(p)
  
z[lower.tri(z,diag=TRUE)]=NA  #Prepare to drop duplicates and meaningless information
z=as.data.frame(as.table(z))  #Turn into a 3-column table
z=na.omit(z)  #Get rid of the junk we flagged above
z=z[order(-abs(z$Freq)),]    #Sort by highest correlation (whether +ve or -ve)

head(z, 10)
```

The most highly correlated variables include host and symbiont biomass, max photosynthesis, respiration, cell density, and chlorophyll content. 

## Plotting correlation network 

First view correlation network for a low correlation threshold (r=0.3). 
```{r}
p<-master%>%
  select(cre.umol.mgafdw, prot_mg.mgafdw, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chlc2.ug.mgAFDW, chla.ug.mgAFDW, cells.mgAFDW, chla.ug.cell, chlc2.ug.cell, Am, AQY, Rd, Ik, Ic, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(prot_mg.mgafdw<1.5)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  mutate(across(everything(), ~log(. + 1)))# log transform all data 

p<-na.omit(p)

p %>% correlate() %>%
  network_plot(min_cor=0.3, colours = c("skyblue1", "white", "indianred2"), repel = TRUE)

```

Variables clustered together are more highly correlated. Wider paths indicate a stronger correlation. The color represents the direction of the correlation. 

View correlation network for a medium correlation threshold (r=0.5). 
```{r}
p %>% correlate() %>%
  network_plot(min_cor=0.5, colours = c("skyblue1", "white", "indianred2"), repel = TRUE)
```

View correlation network for a high correlation threshold (r=0.7). 
```{r}
p %>% correlate() %>%
  network_plot(min_cor=0.7, colours = c("skyblue1", "white", "indianred2"), repel = TRUE)
```

The strongest correlations are between metabolic rates and Host/Symbiont biomass and antioxidant capacity. There is also a strong correlation between chlorophyll content and cell density. 

# Plotting relative change over time in each species  

## Over time    

Prepare data frame and calculate relative change in each metric compared to January 2020 timepoint. Not including calcification, relative change is far off the scale of other metrics. 

```{r}
timeseries<-master%>%
  select(species, site, month, colony_id_corr, timepoint, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2,  cells.mgAFDW, Total_Chl_cell, Total_Chl, prot_mg.mgafdw, cre.umol.mgafdw, Am, AQY, Rd, Ik, Ic, Ratio_AFDW.mg.cm2, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(prot_mg.mgafdw<1.5)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Ic<1000)%>%
  mutate(across(c(6:19), ~log(. + 1)))%>%# log transform all data 
  gather(key="Metric", value="Value", -species, -site, -month, -colony_id_corr, -timepoint)%>%
  group_by(Metric, colony_id_corr, timepoint)%>%
  arrange(colony_id_corr, .by_group = TRUE)%>%
  group_by(colony_id_corr, Metric)%>%
  mutate(rel_change=((Value-first(Value))/abs(first(Value))))

head(timeseries)
```

Plot relative change in each metric over time for all species together.  
```{r}
timeseries$month<-factor(timeseries$month, levels = c("January 2020", "March 2020", "September 2020", "November 2020"))

time_plot1<-timeseries%>%
  filter(!Metric=="calc.umol.cm2.hr")%>%
  
  ggplot(., aes(x=month, y=rel_change, colour=Metric))+
  scale_colour_brewer(palette="Paired")+
  geom_hline(yintercept=0)+
  ylab("Relative Change")+
  xlab("Time Point")+
  geom_smooth(inherit.aes=T, method="loess", aes(group = Metric), se=FALSE)+
  theme_classic(); time_plot1

ggsave(plot=time_plot1, "Figures/Univariate/Relative_Change_AllSpecies.png", width=9, height=6, unit="in", dpi=300)
```

Plot by species.   
```{r}
time_plot2<-timeseries%>%
  filter(!Metric=="calc.umol.cm2.hr")%>%
  
  ggplot(., aes(x=month, y=rel_change,  colour=Metric))+
  facet_wrap(~species) +
  scale_colour_brewer(palette="Paired")+
  geom_hline(yintercept=0)+
  ylab("Relative Change")+
  xlab("Time Point")+
  geom_smooth(inherit.aes=T, method="loess", aes(group = Metric), se=FALSE)+
  theme_classic(); time_plot2

ggsave(plot=time_plot2, "Figures/Univariate/Relative_Change_EachSpecies.png", width=15, height=6, unit="in", dpi=300)
```

Calcification is not displayed due to relative change being beyond the scale we can display here. 

Display calcification separately here. 

```{r}
time_plot3<-timeseries%>%
  filter(Metric=="calc.umol.cm2.hr")%>%
  filter(!rel_change=="Inf")%>%
  filter(!rel_change=="NaN")%>%
  
  ggplot(., aes(x=month, y=rel_change, colour=species))+
  scale_color_manual(values=c("orange", "gray", "purple")) +
  geom_hline(yintercept=0)+
  ylab("Relative Change")+
  xlab("Time Point")+
  geom_smooth(inherit.aes=T, method="loess", aes(group = species), se=FALSE)+
  theme_classic(); time_plot3

ggsave(plot=time_plot3, "Figures/Univariate/Relative_Change_Calcification.png", width=9, height=6, unit="in", dpi=300)
```


# Run and summarize models for all metrics and generate output table 

```{r}
# Assuming 'master' is your dataframe

# Create a list to store model summaries
model_summaries <- list()

# Loop through each numeric column
for (col_name in names(master)) {
  if (is.numeric(master[[col_name]])) {
    # Perform log+1 transformation
    transformed_data <- log1p(master[[col_name]])
    
    # Fit a linear mixed-effects model
    model <- lmer(transformed_data ~ timepoint * site * species + (1 | colony_id_corr), data = master)  # Change 'Group' to your grouping variable
    
    # Store model summary
    model_summary <- anova(model, type="III")
    model_summaries[[col_name]] <- model_summary
  }
}

# Print or process the model summaries
for (col_name in names(model_summaries)) {
  cat("Summary for", col_name, ":\n")
  print(model_summaries[[col_name]])
  cat("\n")
}

model_summaries

write.csv(model_summaries, file="Output/univariate_model_results.csv")
```