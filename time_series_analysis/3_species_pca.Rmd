---
title: "Examining normalizers and preliminary PCA plots"
author: "Ariana S Huffmyer, E5 RoL Team"
date: "03/15/2023"
output: 
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
editor_options: 
  chunk_output_type: console
--- 

# Set Up    
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

```{r}
## install packages if you dont already have them
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("RColorBrewer")) install.packages("RColorBrewer")
if (!require("lme4")) install.packages("lme4")
if (!require("lmerTest")) install.packages("lmerTest")
if (!require("car")) install.packages("car")
if (!require("effects")) install.packages("effects")
if (!require("ggfortify")) install.packages("ggfortify")
if (!require("cowplot")) install.packages("cowplot")
if (!require("vegan")) install.packages("vegan")
if (!require("corrr")) install.packages("corrr")
if (!require("ggcorrplot")) install.packages("ggcorrplot")
if (!require("GGally")) install.packages("GGally")
if (!require("broom")) install.packages("broom")
if (!require("cowplot")) install.packages("cowplot")
if (!require("pairwiseAdonis")) BiocManager::install("pairwiseAdonis")
devtools::install_github("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis")

# load packages
library(tidyverse)
library(ggplot2)
library(RColorBrewer)
library(lme4)
library(lmerTest)
library(car)
library(effects)
library(ggfortify)
library(cowplot)
library(vegan)
library(corrr)
library(ggcorrplot)
library(GGally)
library(broom)
library(cowplot)
library(pairwiseAdonis)
```

# Load dataframe

Load in master dataframe generated from 1_assemble_data.Rmd.  
```{r}
master<-read.csv("Output/master_timeseries.csv")

#reorder site levels 
master$site_code<-as.factor(master$site_code)
master$site_code<-fct_relevel(master$site_code, "Mahana Low", "Hilton Medium", "Manava High")

master$site<-as.factor(master$site)
master$site<-fct_relevel(master$site, "Mahana", "Hilton", "Manava")
```

# Examine multivariate profiles for each normalizer    

## All Responses (host and symbiont)    
### PCA's of each normalizer  
#### PCAs: Surface Area normalizers  

##### Combined PCA's   
 
Plot PCA using prcomp to center and scale.     
 
```{r}
pca_data_cm2<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.cm2, chlc2.ug.cm2, prot_mg.cm2, cells.cm2, cre.umol.cm2, Am, AQY, Rd, Ik, Ic, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Ic<1000)

pca_data_cm2<-pca_data_cm2[complete.cases(pca_data_cm2), ]

scaled_data_cm2<-prcomp(pca_data_cm2[c(5:18)], scale=TRUE, center=TRUE) 
```

Groupings by species:  
```{r}
pcaSpecies_cm2<-ggplot2::autoplot(scaled_data_cm2, data=pca_data_cm2, frame.colour="species", loadings=FALSE,  colour="species", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("orange", "darkgray", "purple")) +
  scale_fill_manual(values=c("orange", "darkgray", "purple")) + 
  theme_classic()+
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaSpecies_cm2

```

PERMANOVA of the effect of species  
```{r}
# scale data
vegan_cm2 <- scale(pca_data_cm2[ ,5:18])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis2(vegan_cm2 ~ species, data = pca_data_cm2, method='eu')
```


Groupings by timepoint:  
```{r}
pcaTimepoint_cm2<-ggplot2::autoplot(scaled_data_cm2, data=pca_data_cm2, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaTimepoint_cm2
```

PERMANOVA of the effect of timepoint  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis2(vegan_cm2 ~ timepoint, data = pca_data_cm2, method='eu')
```

Groupings by site:  
```{r}
pcaSite_cm2<-ggplot2::autoplot(scaled_data_cm2, data=pca_data_cm2, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaSite_cm2

```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis2(vegan_cm2 ~ site_code, data = pca_data_cm2, method='eu')
```

Generate a plot of all PCA's for surface area normalization.  

```{r}
pcaplots_cm2<-plot_grid(pcaSpecies_cm2, pcaSite_cm2, pcaTimepoint_cm2, labels = c("Species: Surface Area", "Site: Surface Area", "Timepoint: Surface Area"), ncol=3, nrow=1, rel_widths = c(1, 1, 1), label_size = 20, label_x = 0.01)

```  

##### Species-specific PCA's   

Next generate PCA for site and timepoint for each species separately.  

Separate by species.  
```{r}
#porites
por_data_cm2<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.cm2, chlc2.ug.cm2, prot_mg.cm2, cells.cm2, cre.umol.cm2, Am, AQY, Rd, Ik, Ic, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  filter(species=="Porites")

por_data_cm2<-por_data_cm2[complete.cases(por_data_cm2), ]

scaled_por_cm2<-prcomp(por_data_cm2[c(5:18)], scale=TRUE, center=TRUE) 

#acropora
acr_data_cm2<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.cm2, chlc2.ug.cm2, prot_mg.cm2, cells.cm2, cre.umol.cm2, Am, AQY, Rd, Ik, Ic, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  filter(species=="Acropora")

acr_data_cm2<-acr_data_cm2[complete.cases(acr_data_cm2), ]

scaled_acr_cm2<-prcomp(acr_data_cm2[c(5:18)], scale=TRUE, center=TRUE) 

#pocillopora
poc_data_cm2<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.cm2, chlc2.ug.cm2, prot_mg.cm2, cells.cm2, cre.umol.cm2, Am, AQY, Rd, Ik, Ic, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  filter(species=="Pocillopora")

poc_data_cm2<-poc_data_cm2[complete.cases(poc_data_cm2), ]

scaled_poc_cm2<-prcomp(poc_data_cm2[c(5:18)], scale=TRUE, center=TRUE) 
```

###### Porites PCA's   

Groupings by timepoint:  
```{r}
porTimepoint_cm2<-ggplot2::autoplot(scaled_por_cm2, data=por_data_cm2, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.7,0.5)+
  #ylim(-0.7, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));porTimepoint_cm2
```

PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_cm2 <- scale(por_data_cm2[ ,5:18])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis2(vegan_cm2 ~ timepoint, data = por_data_cm2, method='eu')
```

Groupings by site:  
```{r}
porSite_cm2<-ggplot2::autoplot(scaled_por_cm2, data=por_data_cm2, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.7,0.5)+
  #ylim(-0.7, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));porSite_cm2
```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis2(vegan_cm2 ~ site_code, data = por_data_cm2, method='eu')
```

###### Acropora PCA's  
 
Groupings by timepoint:  
```{r}
acrTimepoint_cm2<-ggplot2::autoplot(scaled_acr_cm2, data=acr_data_cm2, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.5,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));acrTimepoint_cm2
```

PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_cm2 <- scale(acr_data_cm2[ ,5:18])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis2(vegan_cm2 ~ timepoint, data = acr_data_cm2, method='eu')
```

Groupings by site:  
```{r}
acrSite_cm2<-ggplot2::autoplot(scaled_acr_cm2, data=acr_data_cm2, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.5,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));acrSite_cm2
```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis2(vegan_cm2 ~ site_code, data = acr_data_cm2, method='eu')
```

###### Pocillopora PCA's  

Groupings by timepoint:   
```{r}
pocTimepoint_cm2<-ggplot2::autoplot(scaled_poc_cm2, data=poc_data_cm2, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.6,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pocTimepoint_cm2
```
 
PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_cm2 <- scale(poc_data_cm2[ ,5:18])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis2(vegan_cm2 ~ timepoint, data = poc_data_cm2, method='eu')
```

Groupings by site:  
```{r}
pocSite_cm2<-ggplot2::autoplot(scaled_poc_cm2, data=poc_data_cm2, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.5,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pocSite_cm2
```

PERMANOVA of the effect of site  
```{r}

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis2(vegan_cm2 ~ site_code, data = poc_data_cm2, method='eu')
```

Generate a plot of all PCA's for all Species    

```{r}
species_plots_cm2<-plot_grid(porSite_cm2, porTimepoint_cm2, acrSite_cm2, acrTimepoint_cm2, pocSite_cm2, pocTimepoint_cm2, labels = c("Porites: Surface Area", "Porites: Surface Area", "Acropora: Surface Area", "Acropora: Surface Area", "Pocillopora: Surface Area", "Pocillopora: Surface Area"), ncol=2, nrow=3, rel_widths = c(1, 1, 1, 1, 1, 1), label_size = 20, label_x = 0.01, label_y=1.0)

``` 

#### PCAs: Protein normalizers  

##### Combined PCA's  

Plot PCA using prcomp to center and scale.    
 
```{r}
pca_data_prot<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgprot, chlc2.ug.mgprot, prot_mg.cm2, cells.mgprot, cre.umol.mgprot, Am, AQY, Rd, Ik, Ic, calc.umol.mgprot.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Ic<1000)

pca_data_prot<-pca_data_prot[complete.cases(pca_data_prot), ]

scaled_data_prot<-prcomp(pca_data_prot[c(5:18)], scale=TRUE, center=TRUE) 
```

Groupings by species:  
```{r}
pcaSpecies_prot<-ggplot2::autoplot(scaled_data_prot, data=pca_data_prot, frame.colour="species", loadings=FALSE,  colour="species", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("orange", "darkgray", "purple")) +
  scale_fill_manual(values=c("orange", "darkgray", "purple")) + 
  theme_classic()+
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaSpecies_prot

```

PERMANOVA of the effect of species  
```{r}
# scale data
vegan_prot <- scale(pca_data_prot[ ,5:18])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis2(vegan_prot ~ species, data = pca_data_prot, method='eu')
```


Groupings by timepoint:  
```{r}
pcaTimepoint_prot<-ggplot2::autoplot(scaled_data_prot, data=pca_data_prot, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaTimepoint_prot
```

PERMANOVA of the effect of timepoint  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis2(vegan_prot ~ timepoint, data = pca_data_prot, method='eu')
```

Groupings by site:  
```{r}
pcaSite_prot<-ggplot2::autoplot(scaled_data_prot, data=pca_data_prot, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaSite_prot

```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis2(vegan_prot ~ site_code, data = pca_data_prot, method='eu')
```

Generate a plot of all PCA's for protein normalization.  

```{r}
pcaplots_prot<-plot_grid(pcaSpecies_prot, pcaSite_prot, pcaTimepoint_prot, labels = c("Species: Protein", "Site: Protein", "Timepoint: Protein"), ncol=3, nrow=1, rel_widths = c(1, 1, 1), label_size = 20, label_x = 0.02)

```  

##### Species-specific PCA's   

Next generate PCA for site and timepoint for each species separately.  

Separate by species.  
```{r}
#porites
por_data_prot<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgprot, chlc2.ug.mgprot, prot_mg.cm2, cells.mgprot, cre.umol.mgprot, Am, AQY, Rd, Ik, Ic, calc.umol.mgprot.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Ic<1000)%>%
  filter(species=="Porites")

por_data_prot<-por_data_prot[complete.cases(por_data_prot), ]

scaled_por_prot<-prcomp(por_data_prot[c(5:18)], scale=TRUE, center=TRUE) 

#acropora
acr_data_prot<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgprot, chlc2.ug.mgprot, prot_mg.cm2, cells.mgprot, cre.umol.mgprot, Am, AQY, Rd, Ik, Ic, calc.umol.mgprot.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  filter(species=="Acropora")

acr_data_prot<-acr_data_prot[complete.cases(acr_data_prot), ]

scaled_acr_prot<-prcomp(acr_data_prot[c(5:18)], scale=TRUE, center=TRUE) 

#pocillopora
poc_data_prot<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgprot, chlc2.ug.mgprot, prot_mg.cm2, cells.mgprot, cre.umol.mgprot, Am, AQY, Rd, Ik, Ic, calc.umol.mgprot.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  filter(species=="Pocillopora")

poc_data_prot<-poc_data_prot[complete.cases(poc_data_prot), ]

scaled_poc_prot<-prcomp(poc_data_prot[c(5:18)], scale=TRUE, center=TRUE) 
```

###### Porites PCA's   

Groupings by timepoint:  
```{r}
porTimepoint_prot<-ggplot2::autoplot(scaled_por_prot, data=por_data_prot, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.7,0.5)+
  #ylim(-0.7, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));porTimepoint_prot
```

PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_prot <- scale(por_data_prot[ ,5:18])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis2(vegan_prot ~ timepoint, data = por_data_prot, method='eu')
```

Groupings by site:  
```{r}
porSite_prot<-ggplot2::autoplot(scaled_por_prot, data=por_data_prot, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.7,0.5)+
  #ylim(-0.7, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));porSite_prot
```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis2(vegan_prot ~ site_code, data = por_data_prot, method='eu')
```

###### Acropora PCA's  
 
Groupings by timepoint:  
```{r}
acrTimepoint_prot<-ggplot2::autoplot(scaled_acr_prot, data=acr_data_prot, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.5,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));acrTimepoint_prot
```

PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_prot <- scale(acr_data_prot[ ,5:18])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis2(vegan_prot ~ timepoint, data = acr_data_prot, method='eu')
```

Groupings by site:  
```{r}
acrSite_prot<-ggplot2::autoplot(scaled_acr_prot, data=acr_data_prot, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.5,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));acrSite_prot
```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis2(vegan_prot ~ site_code, data = acr_data_prot, method='eu')
```

###### Pocillopora PCA's  
 
Groupings by timepoint:   
```{r}
pocTimepoint_prot<-ggplot2::autoplot(scaled_poc_prot, data=poc_data_prot, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.6,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pocTimepoint_prot
```
 
PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_prot <- scale(poc_data_prot[ ,5:18])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis2(vegan_prot ~ timepoint, data = poc_data_prot, method='eu')
```

Groupings by site:  
```{r}
pocSite_prot<-ggplot2::autoplot(scaled_poc_prot, data=poc_data_prot, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.5,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pocSite_prot
```

PERMANOVA of the effect of site  
```{r}

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis2(vegan_prot ~ site_code, data = poc_data_prot, method='eu')
```

Generate a plot of all PCA's for all Species    

```{r}
species_plots_prot<-plot_grid(porSite_prot, porTimepoint_prot, acrSite_prot, acrTimepoint_prot, pocSite_prot, pocTimepoint_prot, labels = c("Porites: Protein", "Porites: Protein", "Acropora: Protein", "Acropora: Protein", "Pocillopora: Protein", "Pocillopora: Protein"), ncol=2, nrow=3, rel_widths = c(1, 1, 1, 1, 1, 1), label_size = 20, label_x = 0.01, label_y=1.0)

``` 

#### PCAs: Biomass normalizers  

##### Combined PCA's  

Plot PCA using prcomp to center and scale.    
  
```{r}
pca_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd, Ik, Ic, calc.umol.mgAFDW.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  filter(prot_mg.mgafdw<1.5) #remove outliers

pca_data_afdw<-pca_data_afdw[complete.cases(pca_data_afdw), ]

scaled_data_afdw<-prcomp(pca_data_afdw[c(5:18)], scale=TRUE, center=TRUE) 
```

```{r}
# scale data
vegan <- scale(pca_data_afdw[ ,5:18])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis2(vegan ~ species, data = pca_data_afdw, method='eu')
z_species<-permanova
z_species
``` 
 
Groupings by species:  
```{r}
pcaSpecies_afdw<-ggplot2::autoplot(scaled_data_afdw, data=pca_data_afdw, frame.colour="species", loadings=FALSE,  colour="species", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm', alpha=0.5) + 
  scale_colour_manual(values=c("darkgray", "orange", "purple")) +
  scale_fill_manual(values=c("darkgray", "orange", "purple")) + 
  theme_classic()+
  geom_text(x=0.15, y=-0.1, label=paste("p(Species)=", z_species$`Pr(>F)`[1]), size=4, color=ifelse(z_species$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
  #geom_text(x=0.3, y=-0.15, label=paste("p(Species)=", z_species$`Pr(>F)`[1]), size=6, color="black") + 
  xlab("PC1")+
  ylab("PC2")+
   theme(legend.text = element_text(size=18, face="italic"), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_blank(), 
        axis.text = element_text(size=18, color="black"), 
        axis.title = element_text(size=18, color="black"));pcaSpecies_afdw
```

PERMANOVA of the effect of species  
```{r}
# scale data
vegan_afdw <- scale(pca_data_afdw[ ,5:18])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis2(vegan_afdw ~ species, data = pca_data_afdw, method='eu')
```
 
Groupings by timepoint:  
```{r}
pcaTimepoint_afdw<-ggplot2::autoplot(scaled_data_afdw, data=pca_data_afdw, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaTimepoint_afdw
```

PERMANOVA of the effect of timepoint  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis2(vegan_afdw ~ timepoint, data = pca_data_afdw, method='eu')
```

Groupings by site:  
```{r}
pcaSite_afdw<-ggplot2::autoplot(scaled_data_afdw, data=pca_data_afdw, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaSite_afdw

```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis2(vegan_afdw ~ site_code, data = pca_data_afdw, method='eu')
```

Generate a plot of all PCA's for afdw normalization.  

```{r}
pcaplots_afdw<-plot_grid(pcaSpecies_afdw, pcaSite_afdw, pcaTimepoint_afdw, labels = c("Species: Biomass", "Site: Biomass", "Timepoint: Biomass"), ncol=3, nrow=1, rel_widths = c(1, 1, 1), label_size = 20, label_x = 0.02)
```  

##### Species-specific PCA's   

Next generate PCA for site and timepoint for each species separately.  
 
Separate by species.  
```{r}
#porites
por_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd, Ik, Ic, calc.umol.mgAFDW.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  filter(species=="Porites")

por_data_afdw<-por_data_afdw[complete.cases(por_data_afdw), ]

scaled_por_afdw<-prcomp(por_data_afdw[c(5:18)], scale=TRUE, center=TRUE) 

#acropora
acr_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd, Ik, Ic, calc.umol.mgAFDW.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Ic<1000)%>%
  filter(species=="Acropora")

acr_data_afdw<-acr_data_afdw[complete.cases(acr_data_afdw), ]

scaled_acr_afdw<-prcomp(acr_data_afdw[c(5:18)], scale=TRUE, center=TRUE) 

#pocillopora
poc_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd, Ik, Ic, calc.umol.mgAFDW.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  filter(species=="Pocillopora")

poc_data_afdw<-poc_data_afdw[complete.cases(poc_data_afdw), ]

scaled_poc_afdw<-prcomp(poc_data_afdw[c(5:18)], scale=TRUE, center=TRUE) 
```

###### Porites PCA's   

Groupings by timepoint:  
```{r}
porTimepoint_afdw<-ggplot2::autoplot(scaled_por_afdw, data=por_data_afdw, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.7,0.5)+
  #ylim(-0.7, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));porTimepoint_afdw
```

PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_afdw <- scale(por_data_afdw[ ,5:18])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis2(vegan_afdw ~ timepoint, data = por_data_afdw, method='eu')
```

Groupings by site:  
```{r}
porSite_afdw<-ggplot2::autoplot(scaled_por_afdw, data=por_data_afdw, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
 # xlim(-0.7,0.5)+
 # ylim(-0.7, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));porSite_afdw
```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis2(vegan_afdw ~ site_code, data = por_data_afdw, method='eu')
```

###### Acropora PCA's  
 
Groupings by timepoint:  
```{r}
acrTimepoint_afdw<-ggplot2::autoplot(scaled_acr_afdw, data=acr_data_afdw, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.5,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));acrTimepoint_afdw
```

PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_afdw <- scale(acr_data_afdw[ ,5:18])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis2(vegan_afdw ~ timepoint, data = acr_data_afdw, method='eu')
```

Groupings by site:  
```{r}
acrSite_afdw<-ggplot2::autoplot(scaled_acr_afdw, data=acr_data_afdw, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.5,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));acrSite_afdw
```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis2(vegan_afdw ~ site_code, data = acr_data_afdw, method='eu')
```

###### Pocillopora PCA's  

Groupings by timepoint:   
```{r}
pocTimepoint_afdw<-ggplot2::autoplot(scaled_poc_afdw, data=poc_data_afdw, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
 # xlim(-0.6,0.5)+
  #ylim(-0.5, 0.8)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pocTimepoint_afdw
```
 
PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_afdw <- scale(poc_data_afdw[ ,5:18])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis2(vegan_afdw ~ timepoint, data = poc_data_afdw, method='eu')
```

Groupings by site:  
```{r}
pocSite_afdw<-ggplot2::autoplot(scaled_poc_afdw, data=poc_data_afdw, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.5,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pocSite_afdw
```

PERMANOVA of the effect of site  
```{r}

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis2(vegan_afdw ~ site_code, data = poc_data_afdw, method='eu')
```

Generate a plot of all PCA's for all Species    

```{r}
species_plots_afdw<-plot_grid(porSite_afdw, porTimepoint_afdw, acrSite_afdw, acrTimepoint_afdw, pocSite_afdw, pocTimepoint_afdw, labels = c("Porites: Biomass", "Porites: Biomass", "Acropora: Biomass", "Acropora: Biomass", "Pocillopora: Biomass", "Pocillopora: Biomass"), ncol=2, nrow=3, rel_widths = c(1, 1, 1, 1, 1, 1), label_size = 20, label_x = 0.01, label_y=1.0)

``` 

#### Assemble all PCA plots  

Generate plot of all combined PCA's

```{r}
All_PCAs<-plot_grid(pcaSpecies_prot, pcaSite_prot, pcaTimepoint_prot, pcaSpecies_afdw, pcaSite_afdw, pcaTimepoint_afdw, pcaSpecies_cm2, pcaSite_cm2, pcaTimepoint_cm2, labels = c("Protein", "Protein", "Protein", "Biomass", "Biomass", "Biomass","Surface Area", "Surface Area", "Surface Area"), ncol=3, nrow=3, rel_widths = c(1, 1, 1, 1, 1, 1, 1, 1, 1), label_size = 20, label_x = 0.06, label_y=1.0)

ggsave(filename="Figures/NormalizerPCA/All_PCAs.pdf", plot=All_PCAs, dpi=300, width=24, height=15, units="in")
``` 

Generate plot of all species specific PCA's

```{r}
All_PCAs_species<-plot_grid(porSite_prot, porTimepoint_prot, porSite_afdw, porTimepoint_afdw, porSite_cm2, porTimepoint_cm2, 
                    acrSite_prot, acrTimepoint_prot, acrSite_afdw, acrTimepoint_afdw, acrSite_cm2, acrTimepoint_cm2,
                    pocSite_prot, pocTimepoint_prot, pocSite_afdw, pocTimepoint_afdw, pocSite_cm2, pocTimepoint_cm2,
                    labels = c("Porites: Protein", "Porites: Protein", "Porites: Biomass", "Porites: Biomass", "Porites: SA", "Porites: SA",
                               "Acropora: Protein", "Acropora: Protein", "Acropora: Biomass", "Acropora: Biomass", "Acropora: SA", "Acropora: SA",
                               "Pocillopora: Protein", "Pocillopora: Protein", "Pocillopora: Biomass", "Pocillopora: Biomass", "Pocillopora: SA", "Pocillopora: SA"), ncol=6, nrow=3, rel_widths = c(1), label_size = 20, label_x = 0.06, label_y=1.0)

ggsave(filename="Figures/NormalizerPCA/All_Species_PCAs.pdf", plot=All_PCAs_species, dpi=300, width=48, height=15, units="in")
``` 

# Final species PCA of selected normalizers  

## Holobiont 

Plot PCA using prcomp to center and scale using biomass normalized tissue responses and surface area normalized metabolic rates and calcification rates. 
  
```{r}
pca_data_species<-master%>%
  select(colony_id_corr, timepoint, species, haplotype, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, Total_Chl, Total_Chl_cell, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd, Ik, Ic, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(prot_mg.mgafdw<1.5)%>%
  filter(Total_Chl<14)%>%
  filter(Total_Chl_cell<6e-05)%>%
  filter(Ic<1000)#remove outliers

pca_data_species<-pca_data_species[complete.cases(pca_data_species), ]

scaled_data_species<-prcomp(pca_data_species[c(5:18)], scale=TRUE, center=TRUE) 
```

```{r}
# scale data
vegan <- scale(pca_data_species[ ,5:18])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis2(vegan ~ species, data = pca_data_species, method='eu')
z_species<-permanova
z_species

#adonis2(formula = vegan ~ species, data = pca_data_species, method = "eu")
#          Df SumOfSqs      R2      F Pr(>F)    
#species    2   1872.9 0.36059 104.05  0.001 ***
#Residual 369   3321.1 0.63941                  
#Total    371   5194.0 1.00000  

#conduct pairwise adonis to look at pairwise permanova comparisons
pairwise.adonis(x=pca_data_species[ ,5:18],factors=pca_data_species$species, sim.function="vegdist",  sim.method='euclidean', p.adjust.m='bonferroni')

#                    pairs Df    SumsOfSqs  F.Model        R2 p.value p.adjusted
#1 Acropora vs Pocillopora  1 4.536182e+12 181.3893 0.4387857   0.001      0.003
#2     Acropora vs Porites  1 1.998949e+12  72.5289 0.2335657   0.001      0.003
#3  Pocillopora vs Porites  1 6.239125e+11 100.7953 0.2733095   0.001      0.003
#  sig
#1   *
#2   *
#3   *
``` 

Examine dispersion for this model by species 
```{r}
#evaluate dispersion
beta_species<-betadisper(vegdist(pca_data_species[ ,5:18], "euclidian"), pca_data_species$species)
anova(beta_species)

#conduct posthoc analysis of betadispersion
TukeyHSD(beta_species)
```
 
Groupings by species:  
```{r}
pcaSpecies_afdw<-ggplot2::autoplot(scaled_data_species, data=pca_data_species, frame.colour="species", loadings=FALSE,  colour="species", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm', alpha=0.5) + 
  scale_colour_manual(values=c("darkgray", "orange", "purple")) +
  scale_fill_manual(values=c("darkgray", "orange", "purple")) + 
  theme_classic()+
  geom_text(x=0, y=0.28, label=paste("PERMANOVA p =", z_species$`Pr(>F)`[1]), size=6, color=ifelse(z_species$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  geom_text(x=-0, y=0.26, label="PERMDISP p < 0.001", size=6, color="black") + 
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
  xlab("PC1")+
  ylab("PC2")+
   theme(legend.text = element_text(size=18, face="italic"), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_blank(), 
        axis.text = element_text(size=18, color="black"), 
        axis.title = element_text(size=18, color="black"));pcaSpecies_afdw

ggsave(filename="Figures/NormalizerPCA/Species_Overall_PCA.png", plot=pcaSpecies_afdw, dpi=300, width=7, height=5, units="in")
ggsave(filename="Figures/NormalizerPCA/Species_Overall_PCA.jpeg", plot=pcaSpecies_afdw, dpi=300, width=7, height=5, units="in")
ggsave(filename="Figures/NormalizerPCA/Species_Overall_PCA.pdf", plot=pcaSpecies_afdw, dpi=300, width=7, height=5, units="in")
```

Generate a biplot for this PCA. 
```{r}
pcaSpecies_afdw_biplot<-ggplot2::autoplot(scaled_data_species, data=pca_data_species, frame.colour="species", loadings=TRUE,  colour="species", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm', alpha=0.0) + 
  scale_colour_manual(values=c("darkgray", "orange", "purple")) +
  scale_fill_manual(values=c("darkgray", "orange", "purple")) + 
  theme_classic()+
  #geom_text(x=-0.04, y=0.3, label=paste("p =", z_species$`Pr(>F)`[1]), size=6, color=ifelse(z_species$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
  xlab("PC1")+
  ylab("PC2")+
   theme(legend.text = element_text(size=18, face="italic"), 
         legend.position="none",
        plot.background = element_blank(),
        legend.title = element_blank(), 
        axis.text = element_text(size=18, color="black"), 
        axis.title = element_text(size=18, color="black"));pcaSpecies_afdw_biplot

ggsave(filename="Figures/NormalizerPCA/Species_Overall_BiPlot.png", plot=pcaSpecies_afdw_biplot, dpi=300, width=5, height=5, units="in")
ggsave(filename="Figures/NormalizerPCA/Species_Overall_BiPlot.jpeg", plot=pcaSpecies_afdw_biplot, dpi=300, width=5, height=5, units="in")
ggsave(filename="Figures/NormalizerPCA/Species_Overall_BiPlot.pdf", plot=pcaSpecies_afdw_biplot, dpi=300, width=5, height=5, units="in")
```

Species specific PCAs and PERMANOVAs are in the next script, `4_multivariate_analysis.RmD`.  

Run this analysis for haplotypes. 

```{r}
# scale data
vegan <- scale(pca_data_species[ ,5:18])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis2(vegan ~ species/haplotype, data = pca_data_species, method='eu')
z_haplotype<-permanova
z_haplotype

#adonis2(formula = vegan ~ species, data = pca_data_species, method = "eu")
#                   Df SumOfSqs      R2       F Pr(>F)    
#species             2   1872.9 0.36059 110.615  0.001 ***
#species:haplotype   2    214.2 0.04124  12.651  0.001 ***
#Residual          367   3106.9 0.59817                   
#Total             371   5194.0 1.00000  

#conduct pairwise adonis to look at pairwise permanova comparisons
pairwise.adonis(x=pca_data_species[ ,5:18],factors=c(pca_data_species$haplotype), sim.function="vegdist",  sim.method='euclidean', p.adjust.m='bonferroni')

#                                              pairs Df    SumsOfSqs     F.Model          R2 p.value
#1          Acropora pulchra vs Pocillopora meandrina  1 2.270677e+12  58.8276619 0.292926091   0.001
#2       Acropora pulchra vs Pocillopora tuahiniensis  1 3.826130e+12 128.1948211 0.402881545   0.001
#3           Acropora pulchra vs Porites lobata lutea  1 1.917337e+12  48.7929782 0.261214199   0.001
#4              Acropora pulchra vs Porites evermanni  1 1.209507e+12  39.2418179 0.164025747   0.001
#5  Pocillopora meandrina vs Pocillopora tuahiniensis  1 1.252778e+09   0.3624017 0.002779955   0.551
#6      Pocillopora meandrina vs Porites lobata lutea  1 3.428749e+09   1.3281125 0.016742016   0.242
#7         Pocillopora meandrina vs Porites evermanni  1 4.366501e+11  64.8266197 0.316495091   0.001
#8   Pocillopora tuahiniensis vs Porites lobata lutea  1 1.039437e+10   3.3485531 0.025887828   0.053
#9      Pocillopora tuahiniensis vs Porites evermanni  1 7.775034e+11 129.0412675 0.407017258   0.001
#10         Porites lobata lutea vs Porites evermanni  1 3.235264e+11  49.7328045 0.267765323   0.001
#   p.adjusted sig
#1        0.01   *
#2        0.01   *
#3        0.01   *
#4        0.01   *
#5        1.00    
#6        1.00    
#7        0.01   *
#8        0.53    
#9        0.01   *
#10       0.01   *
``` 
PERMANOVA results are different between Porites haplotypes but are not different between Pocillopora haplotypes. 

Examine dispersion for this model by haplotype. No difference between Porites haplotypes or Pocillopora haplotypes.  
```{r}
#evaluate dispersion
beta_haplotype<-betadisper(vegdist(pca_data_species[ ,5:18], "euclidian"), pca_data_species$haplotype)
anova(beta_haplotype)

#conduct posthoc analysis of betadispersion
TukeyHSD(beta_haplotype)

#$group
#                                                      diff         lwr         upr     p adj
#Pocillopora meandrina-Acropora pulchra         -131194.750 -174116.367  -88273.134 0.0000000
#Pocillopora tuahiniensis-Acropora pulchra      -129922.627 -163779.655  -96065.600 0.0000000
#Porites evermanni-Acropora pulchra             -105411.358 -138356.785  -72465.930 0.0000000
#Porites lobata lutea-Acropora pulchra          -145488.407 -189981.407 -100995.407 0.0000000
#Pocillopora tuahiniensis-Pocillopora meandrina    1272.123  -42476.120   45020.366 0.9999908
#Porites evermanni-Pocillopora meandrina          25783.393  -17263.229   68830.015 0.4715220
#Porites lobata lutea-Pocillopora meandrina      -14293.656  -66707.753   38120.440 0.9450254
#Porites evermanni-Pocillopora tuahiniensis       24511.270   -9504.092   58526.632 0.2800943
#Porites lobata lutea-Pocillopora tuahiniensis   -15565.780  -60856.735   29725.176 0.8802181
#Porites lobata lutea-Porites evermanni          -40077.049  -84690.652    4536.554 0.1015460
```
 
Groupings by haplotype:  
```{r}
pcaHaplotype_afdw<-ggplot2::autoplot(scaled_data_species, data=pca_data_species, frame.colour="haplotype", loadings=FALSE,  colour="haplotype", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm', alpha=0.5) + 
  scale_colour_manual(values=c("darkgray", "yellow3", "orange", "pink3", "purple2")) +
  scale_fill_manual(values=c("darkgray", "yellow3", "orange", "pink3", "purple2")) + 
  theme_classic()+
  #geom_text(x=0, y=0.28, label=paste("PERMANOVA p =", z_species$`Pr(>F)`[1]), size=6, color=ifelse(z_species$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  geom_text(x=0.01, y=0.24, label="PERMANOVA POC posthoc p=0.551", size=4, color="darkgray") + 
  geom_text(x=0.01, y=0.26, label="PERMDISP POC posthoc p=0.999", size=4, color="darkgray") + 
  
  geom_text(x=0.1, y=0.18, label="PERMANOVA POR posthoc p=0.010", size=4, color="black") + 
  geom_text(x=0.11, y=0.2, label="PERMDISP POR posthoc p=0.102", size=4, color="darkgray") + 
  
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
  xlab("PC1")+
  ylab("PC2")+
   theme(legend.text = element_text(size=18, face="italic"), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_blank(), 
        axis.text = element_text(size=18, color="black"), 
        axis.title = element_text(size=18, color="black"));pcaHaplotype_afdw

ggsave(filename="Figures/NormalizerPCA/Haplotype_Overall_PCA.png", plot=pcaHaplotype_afdw, dpi=300, width=9, height=5, units="in")
ggsave(filename="Figures/NormalizerPCA/Haplotype_Overall_PCA.jpeg", plot=pcaHaplotype_afdw, dpi=300, width=9, height=5, units="in")
ggsave(filename="Figures/NormalizerPCA/Haplotype_Overall_PCA.pdf", plot=pcaHaplotype_afdw, dpi=300, width=9, height=5, units="in")
```

Generate a biplot for this PCA. 
```{r}
pcaHaplotype_afdw_biplot<-ggplot2::autoplot(scaled_data_species, data=pca_data_species, frame.colour="haplotype", loadings=TRUE,  colour="haplotype", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm', alpha=0.0) + 
  scale_colour_manual(values=c("darkgray", "yellow3", "orange", "pink3", "purple2")) +
  scale_fill_manual(values=c("darkgray", "yellow3", "orange", "pink3", "purple2")) + 
  theme_classic()+
  xlab("PC1")+
  ylab("PC2")+
   theme(legend.text = element_text(size=18, face="italic"), 
         legend.position="none",
        plot.background = element_blank(),
        legend.title = element_blank(), 
        axis.text = element_text(size=18, color="black"), 
        axis.title = element_text(size=18, color="black"));pcaHaplotype_afdw_biplot

ggsave(filename="Figures/NormalizerPCA/Haplotype_Overall_BiPlot.png", plot=pcaHaplotype_afdw_biplot, dpi=300, width=5, height=5, units="in")
ggsave(filename="Figures/NormalizerPCA/Haplotype_Overall_BiPlot.jpeg", plot=pcaHaplotype_afdw_biplot, dpi=300, width=5, height=5, units="in")
ggsave(filename="Figures/NormalizerPCA/Haplotype_Overall_BiPlot.pdf", plot=pcaHaplotype_afdw_biplot, dpi=300, width=5, height=5, units="in")
```

## Host 

Plot PCA using prcomp to center and scale using biomass normalized tissue responses and surface area normalized metabolic rates and calcification rates. 
  
```{r}
pca_data_species_host<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, prot_mg.mgafdw, cre.umol.mgafdw, Rd, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(prot_mg.mgafdw<1.5) #%>%
  #filter(Total_Chl<14)%>%
  #filter(Total_Chl_cell<6e-05)%>%
  #filter(Ic<1000)#remove outliers

pca_data_species_host<-pca_data_species_host[complete.cases(pca_data_species_host), ]

scaled_data_species_host<-prcomp(pca_data_species_host[c(5:9)], scale=TRUE, center=TRUE) 
```

```{r}
# scale data
vegan <- scale(pca_data_species_host[ ,5:9])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis2(vegan ~ species, data = pca_data_species_host, method='eu')
z_species<-permanova
z_species

#adonis2(formula = vegan ~ species, data = pca_data_species_host, method = "eu")
#          Df SumOfSqs     R2      F Pr(>F)    
#species    2   835.18 0.4283 145.34  0.001 ***
#Residual 388  1114.82 0.5717                  
#Total    390  1950.00 1.0000        

#conduct pairwise adonis to look at pairwise permanova comparisons
pairwise.adonis(x=pca_data_species_host[ ,5:9],factors=pca_data_species_host$species, sim.function="vegdist",  sim.method='euclidean', p.adjust.m='bonferroni')

#                    pairs Df  SumsOfSqs   F.Model        R2 p.value p.adjusted sig
#1 Acropora vs Pocillopora  1   34.77993  80.33426 0.2446722   0.001      0.003   *
#2     Acropora vs Porites  1 1998.46501 607.08105 0.7141449   0.001      0.003   *
#3  Pocillopora vs Porites  1 1818.04340 618.79392 0.6846626   0.001      0.003   *
``` 

Examine dispersion for this model by species 
```{r}
#evaluate dispersion
beta_species<-betadisper(vegdist(pca_data_species_host[ ,5:9], "euclidian"), pca_data_species_host$species)
anova(beta_species)

#conduct posthoc analysis of betadispersion
#TukeyHSD(beta_site)
```
 
Groupings by species:  
```{r}
pcaSpecies_afdw_host<-ggplot2::autoplot(scaled_data_species_host, data=pca_data_species_host, frame.colour="species", loadings=FALSE,  colour="species", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm', alpha=0.5) + 
  scale_colour_manual(values=c("darkgray", "orange", "purple")) +
  scale_fill_manual(values=c("darkgray", "orange", "purple")) + 
  theme_classic()+
  geom_text(x=0, y=0.29, label=paste("PERMANOVA p =", z_species$`Pr(>F)`[1]), size=6, color=ifelse(z_species$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  geom_text(x=0, y=0.26, label="PERMDISP p < 0.001", size=6, color="black") +
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
  xlab("PC1")+
  ylab("PC2")+
  ggtitle("A. Host Responses")+
   theme(legend.text = element_text(size=18, face="italic"), 
         legend.position="none",
        plot.background = element_blank(),
        plot.title = element_text(size=18, color="black", face="bold"),
        legend.title = element_blank(), 
        axis.text = element_text(size=18, color="black"), 
        axis.title = element_text(size=18, color="black"));pcaSpecies_afdw_host

ggsave(filename="Figures/NormalizerPCA/Species_Host_PCA.jpeg", plot=pcaSpecies_afdw_host, dpi=300, width=5, height=5, units="in")
```

Generate a biplot for this PCA. 
```{r}
pcaSpecies_afdw_host_biplot<-ggplot2::autoplot(scaled_data_species_host, data=pca_data_species_host, frame.colour="species", loadings=TRUE,  colour="species", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm', alpha=0.0) + 
  scale_colour_manual(values=c("darkgray", "orange", "purple")) +
  scale_fill_manual(values=c("darkgray", "orange", "purple")) + 
  theme_classic()+
  #geom_text(x=-0.04, y=0.3, label=paste("p =", z_species$`Pr(>F)`[1]), size=6, color=ifelse(z_species$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
  xlab("PC1")+
  ylab("PC2")+
   theme(legend.text = element_text(size=18, face="italic"), 
         legend.position="none",
        plot.background = element_blank(),
        legend.title = element_blank(), 
        axis.text = element_text(size=18, color="black"), 
        axis.title = element_text(size=18, color="black"));pcaSpecies_afdw_host_biplot

ggsave(filename="Figures/NormalizerPCA/Species_Host_BiPlot.jpeg", plot=pcaSpecies_afdw_host_biplot, dpi=300, width=5, height=5, units="in")
```

Species specific PCAs and PERMANOVAs are in the next script, `4_multivariate_analysis.RmD`.  

Run haplpotype level analyses. 

```{r}
pca_data_haplotype_host<-master%>%
  select(colony_id_corr, timepoint, species, haplotype, Host_AFDW.mg.cm2, prot_mg.mgafdw, cre.umol.mgafdw, Rd, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(prot_mg.mgafdw<1.5) #%>%
  #filter(Total_Chl<14)%>%
  #filter(Total_Chl_cell<6e-05)%>%
  #filter(Ic<1000)#remove outliers

pca_data_haplotype_host<-pca_data_haplotype_host[complete.cases(pca_data_haplotype_host), ]

scaled_data_haplotype_host<-prcomp(pca_data_haplotype_host[c(5:9)], scale=TRUE, center=TRUE) 
```

```{r}
# scale data
vegan <- scale(pca_data_haplotype_host[ ,5:9])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis2(vegan ~ haplotype, data = pca_data_haplotype_host, method='eu')
z_haplotype<-permanova
z_haplotype

# adonis2(formula = vegan ~ haplotype, data = pca_data_haplotype_host, method = "eu")
#            Df SumOfSqs      R2      F Pr(>F)    
# haplotype   4   922.14 0.47289 86.575  0.001 ***
# Residual  386  1027.86 0.52711                  
# Total     390  1950.00 1.00000       

#conduct pairwise adonis to look at pairwise permanova comparisons
pairwise.adonis(x=pca_data_haplotype_host[ ,5:9],factors=pca_data_haplotype_host$haplotype, sim.function="vegdist",  sim.method='euclidean', p.adjust.m='bonferroni')

#                                                pairs Df  SumsOfSqs    F.Model         R2 p.value p.adjusted sig
# 1          Acropora pulchra vs Pocillopora meandrina  1   12.28551  32.467489 0.17793575   0.001       0.01   *
# 2       Acropora pulchra vs Pocillopora tuahiniensis  1   34.59426  82.318862 0.29158116   0.001       0.01   *
# 3           Acropora pulchra vs Porites lobata lutea  1  755.16109 348.043705 0.71314045   0.001       0.01   *
# 4              Acropora pulchra vs Porites evermanni  1 1856.36196 741.647046 0.78344622   0.001       0.01   *
# 5  Pocillopora meandrina vs Pocillopora tuahiniensis  1    1.54284   3.136027 0.02131380   0.054       0.54    
# 6      Pocillopora meandrina vs Porites lobata lutea  1  450.43626 130.221089 0.60788174   0.001       0.01   *
# 7         Pocillopora meandrina vs Porites evermanni  1  951.58593 283.620794 0.65558752   0.001       0.01   *
# 8   Pocillopora tuahiniensis vs Porites lobata lutea  1  528.14478 222.658537 0.62429050   0.001       0.01   *
# 9      Pocillopora tuahiniensis vs Porites evermanni  1 1345.14800 507.742329 0.71842637   0.001       0.01   *
# 10         Porites lobata lutea vs Porites evermanni  1   18.03724   3.356695 0.02357947   0.064       0.64   
``` 
No difference in centroid for POC haplotypes. 
No difference in centroid for POR haplotypes.

Examine dispersion for this model by species 
```{r}
#evaluate dispersion
beta_haplotype<-betadisper(vegdist(pca_data_haplotype_host[ ,5:9], "euclidian"), pca_data_haplotype_host$haplotype)
anova(beta_haplotype)

# Response: Distances
#            Df Sum Sq Mean Sq F value    Pr(>F)    
# Groups      4 158.21  39.553  46.119 < 2.2e-16 ***
# Residuals 386 331.05   0.858     

#conduct posthoc analysis of betadispersion
TukeyHSD(beta_haplotype)

# $group
#                                                        diff         lwr       upr     p adj
# Pocillopora meandrina-Acropora pulchra         -0.003236086 -0.44612876 0.4396566 1.0000000
# Pocillopora tuahiniensis-Acropora pulchra       0.073432336 -0.28388984 0.4307545 0.9802291
# Porites evermanni-Acropora pulchra              1.226468207  0.87363953 1.5792969 0.0000000
# Porites lobata lutea-Acropora pulchra           1.622335389  1.14121951 2.1034513 0.0000000
# Pocillopora tuahiniensis-Pocillopora meandrina  0.076668422 -0.37048521 0.5238220 0.9899841
# Porites evermanni-Pocillopora meandrina         1.229704293  0.78613321 1.6732754 0.0000000
# Porites lobata lutea-Pocillopora meandrina      1.625571475  1.07444561 2.1766973 0.0000000
# Porites evermanni-Pocillopora tuahiniensis      1.153035871  0.79487316 1.5111986 0.0000000
# Porites lobata lutea-Pocillopora tuahiniensis   1.548903053  1.06386188 2.0339442 0.0000000
# Porites lobata lutea-Porites evermanni          0.395867182 -0.08587329 0.8776077 0.1630355
```
No differences in beta dispersion in host of POC or POR haplotypes 

Groupings by haplotype:  
```{r}
pcaHaplotype_afdw_host<-ggplot2::autoplot(scaled_data_haplotype_host, data=pca_data_haplotype_host, frame.colour="haplotype", loadings=FALSE,  colour="haplotype", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm', alpha=0.5) + 
  scale_colour_manual(values=c("darkgray", "yellow3", "orange", "pink3", "purple2")) +
  scale_fill_manual(values=c("darkgray", "yellow3", "orange", "pink3", "purple2")) + 
  theme_classic()+
  geom_text(x=0.05, y=0.26, label="PERMDISP POC&POR posthoc p > 0.05", size=4, color="darkgray") +
  geom_text(x=0.05, y=0.22, label="PERMANOVA POC&POR posthoc p > 0.05", size=4, color="darkgray") +
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
  xlab("PC1")+
  ylab("PC2")+
  ggtitle("A. Host Responses")+
   theme(legend.text = element_text(size=18, face="italic"), 
         legend.position="none",
        plot.background = element_blank(),
        plot.title = element_text(size=18, color="black", face="bold"),
        legend.title = element_blank(), 
        axis.text = element_text(size=18, color="black"), 
        axis.title = element_text(size=18, color="black"));pcaHaplotype_afdw_host

ggsave(filename="Figures/NormalizerPCA/Haplotype_Host_PCA.jpeg", plot=pcaHaplotype_afdw_host, dpi=300, width=5, height=5, units="in")
```

Generate a biplot for this PCA. 
```{r}
pcaHaplotype_afdw_host_biplot<-ggplot2::autoplot(scaled_data_haplotype_host, data=pca_data_haplotype_host, frame.colour="haplotype", loadings=TRUE,  colour="haplotype", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm', alpha=0.0) + 
  scale_colour_manual(values=c("darkgray", "yellow3", "orange", "pink3", "purple2")) +
  scale_fill_manual(values=c("darkgray", "yellow3", "orange", "pink3", "purple2")) + 
  theme_classic()+
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
  xlab("PC1")+
  ylab("PC2")+
   theme(legend.text = element_text(size=18, face="italic"), 
         legend.position="none",
        plot.background = element_blank(),
        legend.title = element_blank(), 
        axis.text = element_text(size=18, color="black"), 
        axis.title = element_text(size=18, color="black"));pcaHaplotype_afdw_host_biplot

ggsave(filename="Figures/NormalizerPCA/Haplotype_Host_BiPlot.jpeg", plot=pcaHaplotype_afdw_host_biplot, dpi=300, width=5, height=5, units="in")
```

## Symbiont 

Plot PCA using prcomp to center and scale using biomass normalized tissue responses and surface area normalized metabolic rates and calcification rates. 
  
```{r}
pca_data_species_sym<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, Total_Chl, Total_Chl_cell, cells.mgAFDW, Am, AQY, Ik, Ic)%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  #filter(prot_mg.mgafdw<1.5)%>%
  filter(Total_Chl<14)%>%
  filter(Total_Chl_cell<6e-05)%>%
  filter(Ic<1000)#remove outliers

pca_data_species_sym<-pca_data_species_sym[complete.cases(pca_data_species_sym), ]

scaled_data_species_sym<-prcomp(pca_data_species_sym[c(5:13)], scale=TRUE, center=TRUE) 
```

```{r}
# scale data
vegan <- scale(pca_data_species_sym[ ,5:13])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis2(vegan ~ species, data = pca_data_species_sym, method='eu')
z_species<-permanova
z_species

#adonis2(formula = vegan ~ species, data = pca_data_species_sym, method = "eu")
#          Df SumOfSqs      R2      F Pr(>F)    
#species    2   1174.5 0.31829 95.248  0.001 ***
#Residual 408   2515.5 0.68171                  
#Total    410   3690.0 1.00000      

#conduct pairwise adonis to look at pairwise permanova comparisons
pairwise.adonis(x=pca_data_species_sym[ ,5:9],factors=pca_data_species_sym$species, sim.function="vegdist",  sim.method='euclidean', p.adjust.m='bonferroni')

#                    pairs Df    SumsOfSqs   F.Model        R2 p.value p.adjusted
#1 Acropora vs Pocillopora  1 5.049196e+12 196.22623 0.4368094   0.001      0.003
#2     Acropora vs Porites  1 2.183380e+12  78.96107 0.2302333   0.001      0.003
#3  Pocillopora vs Porites  1 7.537429e+11 121.37191 0.2887251   0.001      0.003
#  sig
#1   *
#2   *
#3   *
``` 
 
 Examine dispersion for this model by species 
```{r}
#evaluate dispersion
beta_species<-betadisper(vegdist(pca_data_species_sym[ ,5:9], "euclidian"), pca_data_species_sym$species)
anova(beta_species)

#conduct posthoc analysis of betadispersion
#TukeyHSD(beta_site)
```

Groupings by species:  
```{r}
pcaSpecies_afdw_sym<-ggplot2::autoplot(scaled_data_species_sym, data=pca_data_species_sym, frame.colour="species", loadings=FALSE,  colour="species", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm', alpha=0.5) + 
  scale_colour_manual(values=c("darkgray", "orange", "purple")) +
  scale_fill_manual(values=c("darkgray", "orange", "purple")) + 
  theme_classic()+
  geom_text(x=-0.05, y=0.17, label=paste("PERMANOVA p =", z_species$`Pr(>F)`[1]), size=6, color=ifelse(z_species$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  geom_text(x=-0.05, y=0.14, label="PERMDISP p < 0.001", size=6, color="black") +
  xlim(-0.2,0.2)+
  ylim(-0.22, 0.18)+
  xlab("PC1")+
  ylab("PC2")+
  ggtitle("B. Symbiont Responses")+
   theme(legend.text = element_text(size=18, face="italic"), 
         legend.position="right",
        plot.background = element_blank(),
        plot.title = element_text(size=18, color="black", face="bold"),
        legend.title = element_blank(), 
        axis.text = element_text(size=18, color="black"), 
        axis.title = element_text(size=18, color="black"));pcaSpecies_afdw_sym

ggsave(filename="Figures/NormalizerPCA/Species_Symbiont_PCA.jpeg", plot=pcaSpecies_afdw_sym, dpi=300, width=7, height=5, units="in")
```

Generate a biplot for this PCA. 
```{r}
pcaSpecies_afdw_sym_biplot<-ggplot2::autoplot(scaled_data_species_sym, data=pca_data_species_sym, frame.colour="species", loadings=TRUE,  colour="species", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm', alpha=0.0) + 
  scale_colour_manual(values=c("darkgray", "orange", "purple")) +
  scale_fill_manual(values=c("darkgray", "orange", "purple")) + 
  theme_classic()+
  #geom_text(x=-0.04, y=0.3, label=paste("p =", z_species$`Pr(>F)`[1]), size=6, color=ifelse(z_species$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
  xlab("PC1")+
  ylab("PC2")+
   theme(legend.text = element_text(size=18, face="italic"), 
         legend.position="none",
        plot.background = element_blank(),
        legend.title = element_blank(), 
        axis.text = element_text(size=18, color="black"), 
        axis.title = element_text(size=18, color="black"));pcaSpecies_afdw_sym_biplot

ggsave(filename="Figures/NormalizerPCA/Species_Sym_BiPlot.jpeg", plot=pcaSpecies_afdw_sym_biplot, dpi=300, width=5, height=5, units="in")
```

Species specific PCAs and PERMANOVAs are in the next script, `4_multivariate_analysis.RmD`.  

Run now by haplotype 
  
```{r}
pca_data_haplotype_sym<-master%>%
  select(colony_id_corr, timepoint, species, haplotype, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, Total_Chl, Total_Chl_cell, cells.mgAFDW, Am, AQY, Ik, Ic)%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  #filter(prot_mg.mgafdw<1.5)%>%
  filter(Total_Chl<14)%>%
  filter(Total_Chl_cell<6e-05)%>%
  filter(Ic<1000)#remove outliers

pca_data_haplotype_sym<-pca_data_haplotype_sym[complete.cases(pca_data_haplotype_sym), ]

scaled_data_haplotype_sym<-prcomp(pca_data_haplotype_sym[c(5:13)], scale=TRUE, center=TRUE) 
```

```{r}
# scale data
vegan <- scale(pca_data_haplotype_sym[ ,5:13])

# PerMANOVA - partitioning the euclidean distance matrix by haplotype
permanova<-adonis2(vegan ~ haplotype, data = pca_data_haplotype_sym, method='eu')
z_haplotype<-permanova
z_haplotype

# adonis2(formula = vegan ~ haplotype, data = pca_data_haplotype_sym, method = "eu")
#            Df SumOfSqs      R2      F Pr(>F)    
# haplotype   4     1303 0.35313 55.408  0.001 ***
# Residual  406     2387 0.64687                  
# Total     410     3690 1.00000         

#conduct pairwise adonis to look at pairwise permanova comparisons
pairwise.adonis(x=pca_data_haplotype_sym[ ,5:9],factors=pca_data_haplotype_sym$haplotype, sim.function="vegdist",  sim.method='euclidean', p.adjust.m='bonferroni')

#                                                pairs Df    SumsOfSqs      F.Model           R2 p.value p.adjusted sig
# 1          Acropora pulchra vs Pocillopora meandrina  1 2.581946e+12 6.462240e+01 2.969474e-01   0.001       0.01   *
# 2       Acropora pulchra vs Pocillopora tuahiniensis  1 4.225446e+12 1.378949e+02 3.986613e-01   0.001       0.01   *
# 3           Acropora pulchra vs Porites lobata lutea  1 2.142490e+12 5.336425e+01 2.611232e-01   0.001       0.01   *
# 4              Acropora pulchra vs Porites evermanni  1 1.318496e+12 4.259440e+01 1.615907e-01   0.001       0.01   *
# 5  Pocillopora meandrina vs Pocillopora tuahiniensis  1 3.154181e+06 8.454861e-04 5.912455e-06   0.972       1.00    
# 6      Pocillopora meandrina vs Porites lobata lutea  1 9.776107e+09 3.782928e+00 4.213416e-02   0.047       0.47    
# 7         Pocillopora meandrina vs Porites evermanni  1 5.484236e+11 8.548393e+01 3.539943e-01   0.001       0.01   *
# 8   Pocillopora tuahiniensis vs Porites lobata lutea  1 1.296783e+10 3.786631e+00 2.615318e-02   0.065       0.65    
# 9      Pocillopora tuahiniensis vs Porites evermanni  1 8.996162e+11 1.504772e+02 4.162841e-01   0.001       0.01   *
# 10         Porites lobata lutea vs Porites evermanni  1 3.731502e+11 6.047583e+01 2.819704e-01   0.001       0.01   *
``` 
 
Significant differences between POR centroids. 
No difference in centroids for POC. 

 Examine dispersion for this model by haplotype 
```{r}
#evaluate dispersion
beta_haplotype<-betadisper(vegdist(pca_data_haplotype_sym[ ,5:9], "euclidian"), pca_data_haplotype_sym$haplotype)
anova(beta_haplotype)

# Response: Distances
#            Df     Sum Sq    Mean Sq F value    Pr(>F)    
# Groups      4 1.3796e+12 3.4491e+11  47.036 < 2.2e-16 ***
# Residuals 406 2.9772e+12 7.3330e+09  

#conduct posthoc analysis of betadispersion
TukeyHSD(beta_haplotype)

# $group
#                                                       diff        lwr         upr     p adj
# Pocillopora meandrina-Acropora pulchra         -137127.164 -178648.00  -95606.331 0.0000000
# Pocillopora tuahiniensis-Acropora pulchra      -132942.853 -165363.08 -100522.622 0.0000000
# Porites evermanni-Acropora pulchra             -113553.505 -144981.72  -82125.293 0.0000000
# Porites lobata lutea-Acropora pulchra          -148801.554 -191002.09 -106601.020 0.0000000
# Pocillopora tuahiniensis-Pocillopora meandrina    4184.311  -37934.93   46303.552 0.9987927
# Porites evermanni-Pocillopora meandrina          23573.659  -17786.85   64934.167 0.5229260
# Porites lobata lutea-Pocillopora meandrina      -11674.390  -61712.82   38364.037 0.9685401
# Porites evermanni-Pocillopora tuahiniensis       19389.348  -12825.30   51603.996 0.4668531
# Porites lobata lutea-Pocillopora tuahiniensis   -15858.701  -58648.14   26930.738 0.8481796
# Porites lobata lutea-Porites evermanni          -35248.049  -77290.85    6794.753 0.1478352
```
No difference in dispersion between POC haplotypes, no difference in dispersion in POR haplotypes. 

Groupings by haplotype:  
```{r}
pcaHaplotype_afdw_sym<-ggplot2::autoplot(scaled_data_haplotype_sym, data=pca_data_haplotype_sym, frame.colour="haplotype", loadings=FALSE,  colour="haplotype", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm', alpha=0.5) + 
  scale_colour_manual(values=c("darkgray", "yellow3", "orange", "pink3", "purple2")) +
  scale_fill_manual(values=c("darkgray", "yellow3", "orange", "pink3", "purple2")) + 
  theme_classic()+
  geom_text(x=-0.05, y=0.18, label="PERMANOVA POC posthoc p > 0.05", size=4, color="darkgray") +
    geom_text(x=-0.05, y=0.16, label="PERMANOVA POR posthoc p = 0.01", size=4, color="black") +
    geom_text(x=-0.05, y=0.14, label="PERMDISP POC&POR posthoc p > 0.05", size=4, color="darkgray") +
  xlim(-0.2,0.2)+
  ylim(-0.22, 0.18)+
  xlab("PC1")+
  ylab("PC2")+
  ggtitle("B. Symbiont Responses")+
   theme(legend.text = element_text(size=18, face="italic"), 
         legend.position="right",
        plot.background = element_blank(),
        plot.title = element_text(size=18, color="black", face="bold"),
        legend.title = element_blank(), 
        axis.text = element_text(size=18, color="black"), 
        axis.title = element_text(size=18, color="black"));pcaHaplotype_afdw_sym

ggsave(filename="Figures/NormalizerPCA/Haplotype_Symbiont_PCA.jpeg", plot=pcaHaplotype_afdw_sym, dpi=300, width=8, height=5, units="in")
```

Generate a biplot for this PCA. 
```{r}
pcaHaplotype_afdw_sym_biplot<-ggplot2::autoplot(scaled_data_haplotype_sym, data=pca_data_haplotype_sym, frame.colour="haplotype", loadings=TRUE,  colour="haplotype", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm', alpha=0.0) + 
  theme_classic()+
  #geom_text(x=-0.04, y=0.3, label=paste("p =", z_species$`Pr(>F)`[1]), size=6, color=ifelse(z_species$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
  xlab("PC1")+
  ylab("PC2")+
   theme(legend.text = element_text(size=18, face="italic"), 
         legend.position="none",
        plot.background = element_blank(),
        legend.title = element_blank(), 
        axis.text = element_text(size=18, color="black"), 
        axis.title = element_text(size=18, color="black"));pcaHaplotype_afdw_sym_biplot

ggsave(filename="Figures/NormalizerPCA/Haplotype_Sym_BiPlot.jpeg", plot=pcaHaplotype_afdw_sym_biplot, dpi=300, width=5, height=5, units="in")
```
