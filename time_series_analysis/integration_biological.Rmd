---
title: "Integrating E5 time series biological data"
author: "Ariana S Huffmyer"
date: "1/18/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Set Up  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

```{r}
## install packages if you dont already have them
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("RColorBrewer")) install.packages("RColorBrewer")
if (!require("lme4")) install.packages("lme4")
if (!require("lmerTest")) install.packages("lmerTest")
if (!require("car")) install.packages("car")
if (!require("effects")) install.packages("effects")
if (!require("ggfortify")) install.packages("ggfortify")
if (!require("cowplot")) install.packages("cowplot")
if (!require("vegan")) install.packages("vegan")
if (!require("corrr")) install.packages("corrr")
if (!require("ggcorrplot")) install.packages("ggcorrplot")
if (!require("GGally")) install.packages("GGally")

# load packages
library(tidyverse)
library(ggplot2)
library(RColorBrewer)
library(lme4)
library(lmerTest)
library(car)
library(effects)
library(ggfortify)
library(cowplot)
library(vegan)
library(corrr)
library(ggcorrplot)
library(GGally)
```
 
# Load and manipulate data  

## Loading data files   

Load all .csv files from output of all timepoints for each biological response   
 
```{r}
biomass_files<-list.files("../", pattern = "biomass.csv", recursive=T, full.names=T)
antioxidant_files<-list.files("../", pattern = "antioxidant_capacity.csv", recursive=T, full.names=T)
pi_curve_rate_files<-list.files("../", pattern = "pi_curve_rates.csv", recursive=T, full.names=T)
surface_area_files<-list.files("../", pattern = "surface_area.csv", recursive=T, full.names=T)
pi_curve_pars_files<-list.files("../", pattern = "pi_curve_pars.csv", recursive=T, full.names=T)
protein_files<-list.files("../", pattern = "protein.csv", recursive=T, full.names=T)
symb_densities_files<-list.files("../", pattern = "symb_densities.csv", recursive=T, full.names=T)
chlorophyll_files<-list.files("../", pattern = "chlorophyll.csv", recursive=T, full.names=T)

#need to add calcification
```
 

## Read data files 

Load all data frames.  

```{r}
#biomass WORKS
biomass_dataset <- data.frame()

for (i in 1:length(biomass_files)){
  biomass_df <- read.csv(biomass_files[i]) #each file will be read in
  biomass_dataset <- rbind(biomass_dataset, biomass_df) #for each iteration, bind the new data to the building dataset
}

```

```{r}
#antioxidant capacity WORKS
antioxidant_dataset <- data.frame()

for (i in 1:length(antioxidant_files)){
  antioxidant_df <- read.csv(antioxidant_files[i]) #each file will be read in
  antioxidant_dataset <- rbind(antioxidant_dataset, antioxidant_df) #for each iteration, bind the new data to the building dataset
}

```

```{r}
#PI curve rates- NOT READY
#pi_curve_rate_dataset <- data.frame()

#for (i in 1:length(pi_curve_rate_files)){
  #pi_curve_rate_df <- read.csv(pi_curve_rate_files[i]) #each file will be read in
  #pi_curve_rate_dataset <- rbind(pi_curve_rate_dataset, pi_curve_rate_df) #for each iteration, bind the new data to the building dataset
#}
```

```{r}
#surface area 
surface_area_dataset <- data.frame()

for (i in 1:length(surface_area_files)){
  surface_area_df <- read.csv(surface_area_files[i]) #each file will be read in
  surface_area_dataset <- rbind(surface_area_dataset, surface_area_df) #for each iteration, bind the new data to the building dataset
}
```

```{r}
#PI Curve parameters - NOT READY
#pi_curve_pars_dataset <- data.frame()

#for (i in 1:length(pi_curve_pars_files)){
  #pi_curve_pars_df <- read.csv(pi_curve_pars_files[i]) #each file will be read in
  #pi_curve_pars_dataset <- rbind(pi_curve_pars_dataset, pi_curve_pars_df) #for each iteration, bind the new data to the building dataset
#}
```

```{r}
#protein WORKS
protein_dataset <- data.frame()

for (i in 1:length(protein_files)){
  protein_df <- read.csv(protein_files[i]) #each file will be read in
  protein_dataset <- rbind(protein_dataset, protein_df) #for each iteration, bind the new data to the building dataset
}
```

```{r}
#symb densities WORKS, NEEDS TP4
symb_densities_dataset <- data.frame()

for (i in 1:length(symb_densities_files)){
  symb_densities_df <- read.csv(symb_densities_files[i]) #each file will be read in
  symb_densities_dataset <- rbind(symb_densities_dataset, symb_densities_df) #for each iteration, bind the new data to the building dataset
}
```

```{r}
#chlorophyll files WORKS
chlorophyll_dataset <- data.frame()

for (i in 1:length(chlorophyll_files)){
  chlorophyll_df <- read.csv(chlorophyll_files[i]) #each file will be read in
  chlorophyll_dataset <- rbind(chlorophyll_dataset, chlorophyll_df) #for each iteration, bind the new data to the building dataset
}

```

```{r}
#remove files that are not needed from loops
rm(list = ls(pattern = "*_df"))
```


## Generate master data frame    

Read in metadata frame. 
```{r}
#Load tag metadata sheet 
tags<-read.csv("../metadata/coral_id_metadata.csv")
```

Prepare datasets for merging by renaming columns and spreading dataframes. Each file needs to have one line per colony per response variable in order to merge and should be without site/species columns as these will be added from metadata sheet.   
```{r}
#antioxidant data 
antioxidant_dataset<-antioxidant_dataset%>%
  select(colony_id, cre.umol.mgprot, timepoint)

#biomass data 
biomass_dataset<- biomass_dataset %>%
  filter(!colony_id=="1xPBS")%>%
  nest(value_col = c(AFDW.mg.cm2, DW.mg.cm2)) %>%
  spread(key = partner, value = value_col) %>%
  unnest(Host, Sym, .sep = '_')%>%
  select(colony_id, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Host_DW.mg.cm2, Sym_DW.mg.cm2, timepoint)

#protein data
protein_dataset<-protein_dataset%>%
  select(colony_id, prot_ug.cm2, timepoint)
  
#symbiont densitites
symb_densities_dataset<-symb_densities_dataset%>%
  select(colony_id, cells.cm2, timepoint)
```

```{r}
#can also use "join_all" - E. Strand
master <- full_join(full_join(full_join(full_join(full_join(
  antioxidant_dataset,
  biomass_dataset, by=c("colony_id", "timepoint")),
  chlorophyll_dataset, by=c("colony_id", "timepoint")),
  protein_dataset, by=c("colony_id", "timepoint")),
  surface_area_dataset, by=c("colony_id", "timepoint")), 
  symb_densities_dataset, by=c("colony_id", "timepoint"))

head(master)
```

Control for colony id, site name, and timepoint names. 
```{r}
#Add column for month of year for each timepoint
master$month[master$timepoint == "timepoint1"] <- "January 2020"
master$month[master$timepoint == "timepoint2"] <- "March 2020"
master$month[master$timepoint == "timepoint3"] <- "September 2020"
master$month[master$timepoint == "timepoint4"] <- "November 2020"

#replace colony id with the original tag number if the tag was changed during the timeseries, as shown by a new tag id at the end of the time series
master$colony_id_corr<-tags$Original_Tag[match(master$colony_id, tags$Tag_ID_Nov)] 

#if there is an na (because the colony tag id did not change over the timesereis), populate with the colonyid number from colony_id column
master$colony_id_corr[is.na(master$colony_id_corr)] <- master$colony_id[is.na(master$colony_id_corr)]

#match site name by site number and species from tag sheet 
master$site<-tags$Site[match(master$colony_id_corr, tags$Original_Tag)]
master$species<-tags$Coral_Species[match(master$colony_id_corr, tags$Original_Tag)]

#add a nutrient level for each site  
master<-master%>%
  mutate(nutrient = if_else(site == "Hilton", "Medium", 
                            if_else(site == "Mahana", "Low", 
                                    if_else(site == "Manava", "High", "NA"))))%>%
  mutate(site_code = paste(site, nutrient))

master$site_code <- factor(master$site_code, levels = c("Mahana Low", "Hilton Medium", "Manava High"))
```

# Normalization  

In order to examine the effect of normalizer on all response variables, normalize each response to: 
(1) Protein  (ug/cm2)  
(2) AFDW  (mg/cm2)   
(3) Surface area (cm2)  

To do this, back-normalize variables that are already normalized and divide by each new normalizer.  

```{r}
master<-master%>%
  mutate(mgprot = (prot_ug.cm2*surface.area.cm2)/1000)%>% #get absolute values of normaliers for each coral sample, change from ug to mg
  mutate(mgafdw = Host_AFDW.mg.cm2*surface.area.cm2)%>% #get absolute values of normaliers for each coral sample
  mutate(cells = cells.cm2 * surface.area.cm2)%>% #get absolute number of symbiont cells
  mutate(cells.mgprot = (cells.cm2 * surface.area.cm2)/mgprot)%>% #convert cells per cm2 to cells per mg protein
  mutate(cells.mgAFDW = (cells.cm2 * surface.area.cm2)/mgafdw)%>% #converts cells per cm2 to cells per mg afdw
  mutate(chla.ug.mgprot = (chla.ug.cm2 * surface.area.cm2)/mgprot)%>% #normalize chla to protein
  mutate(chla.ug.mgAFDW = (chla.ug.cm2 * surface.area.cm2)/mgafdw)%>% #normalize chla to afdw
  mutate(chlc2.ug.mgprot = (chlc2.ug.cm2 * surface.area.cm2)/mgprot)%>% #normalize chlc2 to protein
  mutate(chlc2.ug.mgAFDW = (chlc2.ug.cm2 * surface.area.cm2)/mgafdw)%>% #normalize chlc2 to afdw
  mutate(prot_mg.cm2=prot_ug.cm2/1000)%>% #change protein to mg
  mutate(prot_mg.mgafdw=(prot_mg.cm2*surface.area.cm2)/mgafdw)%>% #normalize protein to afdw
  mutate(cre.umol.mgafdw=(cre.umol.mgprot*mgprot)/mgafdw)%>% #normalize tac to afdw
  mutate(cre.umol.cm2=(cre.umol.mgprot*mgprot)/surface.area.cm2)%>% #normalize tac to surface area
  mutate(chla.ug.cell = (chla.ug.cm2 * surface.area.cm2)/cells) %>% #normalize to chl per cell
  mutate(chlc2.ug.cell = (chlc2.ug.cm2 * surface.area.cm2)/cells) #normalize to chl per cell
```

Write master file to csv.  
```{r}
write_csv(master, "Output/master_timeseries.csv")
```


# Generating summary by groups   

Summarize all response values by group (species + timepoint + site).  

```{r}
summary_colony<-master%>%
  select(., -c(colony_id, timepoint, site_code))%>%
  group_by(colony_id_corr, month, site, nutrient, species)%>%
  summarise(across(.cols=everything(), ~mean(.x, na.rm = TRUE)))%>%
  drop_na("site")%>%
  write_csv(., "Output/Summary_Colony_Responses.csv")

summary_group<-master%>%
  select(., -c(colony_id, timepoint, site_code, colony_id_corr))%>%
  group_by(month, site, nutrient, species)%>%
  summarise(across(.cols=everything(), ~mean(.x, na.rm = TRUE)))%>%
  drop_na("site")%>%
  write_csv(., "Output/Summary_Responses.csv")
           
```


# Examine Responses  

## Antioxidant capacity  

### Plot: CRE umol mgprot 

View by site and timepoint for each species.   
```{r}
tacplot_prot<-master %>%
  filter(!is.na(cre.umol.mgprot)) %>% 
  select(colony_id_corr, species, site_code, timepoint, cre.umol.mgprot)%>%
  
  ggplot(., aes(x = site_code, y = cre.umol.mgprot, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    ylab(expression(bold(paste("Copper Reducing Elements (", mu, "mol mg protein"^-1,")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); tacplot_prot
```

### Plot: CRE umol mgafdw 

View by site and timepoint for each species.   
```{r}
tacplot_afdw<-master %>%
  filter(!is.na(cre.umol.mgafdw)) %>%
  select(colony_id_corr, species, site_code, timepoint, cre.umol.mgafdw)%>%
  
  ggplot(., aes(x = site_code, y = cre.umol.mgafdw, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    ylab(expression(bold(paste("Copper Reducing Elements (", mu, "mol mg afdw"^-1,")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); tacplot_afdw
```


### Plot: CRE umol cm2 

View by site and timepoint for each species.   
```{r}
tacplot_cm2<-master %>%
  filter(!is.na(cre.umol.cm2)) %>%
  select(colony_id_corr, species, site_code, timepoint, cre.umol.cm2)%>%
  
  ggplot(., aes(x = site_code, y = cre.umol.cm2, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
     scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    ylab(expression(bold(paste("Copper Reducing Elements (", mu, "mol cm"^-2,")"))))+
    theme_classic() + 
    theme(
      legend.position="right",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); tacplot_cm2

```

Join all plots for each normalization together.  

```{r}
tac_figure<-plot_grid(tacplot_prot, tacplot_afdw, tacplot_cm2, labels = c("", "", ""), ncol=3, nrow=1, rel_widths = c(.8, .8, 1), label_size = 20, label_x = 0.1)

ggsave(filename="Figures/TAC_Figure.pdf", plot=tac_figure, dpi=300, width=24, height=5, units="in")
```

### Analysis 

Build a mixed model for univariate analysis and examine data distribution.

`antiox_model<-lmer(cre.umol.mgprot~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
antiox_model<-lmer(cre.umol.mgprot~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(antiox_model))
hist(residuals(antiox_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`antiox_model<-lmer(log(cre.umol.mgprot)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
antiox_model<-lmer(log(cre.umol.mgprot)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(antiox_model))
hist(residuals(antiox_model))
```

Residuals are improved, but we need to revisit this model to improve fit.  

Generate a Type II Anova of model.    

```{r}
anova(antiox_model, type="II")
```

Generate model effect plots.  

```{r}
plot(allEffects(antiox_model))
```

## Symbiont Densities  

### Plot: Surface Area   

View by site and timepoint for each species.   
```{r}
symbplot_cm2<-master %>%
  filter(!is.na(cells.cm2)) %>%
  filter(!is.na(species))%>%
  select(colony_id_corr, species, site_code, timepoint, cells.cm2)%>%
  
  ggplot(., aes(x = site_code, y = cells.cm2, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Symbiont Cells cm"^-2))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); symbplot_cm2
```

### Plot: Protein   

View by site and timepoint for each species.   
```{r}
symbplot_prot<-master %>%
  filter(!is.na(cells.mgprot)) %>%
   filter(!is.na(species))%>%
  select(colony_id_corr, species, site_code, timepoint, cells.mgprot)%>%
  
  ggplot(., aes(x = site_code, y = cells.mgprot, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Symbiont Cells mg protein"^-1))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); symbplot_prot

```

### Plot: Biomass   

View by site and timepoint for each species.   
```{r}
symbplot_afdw<-master %>%
  filter(!is.na(cells.mgAFDW)) %>%
    filter(!is.na(species))%>%
  select(colony_id_corr, species, site_code, timepoint, cells.mgAFDW)%>%
  
  ggplot(., aes(x = site_code, y = cells.mgAFDW, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Symbiont Cells mg afdw"^-1))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); symbplot_afdw
```

Join all plots for each normalization together.  

```{r}
symbcells_figure<-plot_grid(symbplot_prot, symbplot_afdw, symbplot_cm2, labels = c("", "", ""), ncol=3, nrow=1, rel_widths = c(.8, .8, 1), label_size = 20, label_x = 0.1)

ggsave(filename="Figures/CellDensity_Figure.pdf", plot=symbcells_figure, dpi=300, width=24, height=5, units="in")
```

### Analysis  

Build a mixed model for univariate analysis and examine data distribution.

`density_model<-lmer(cells.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
density_model<-lmer(cells.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(density_model))
hist(residuals(density_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`density_model<-lmer(log(cells.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
density_model<-lmer(log(cells.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(density_model))
hist(residuals(density_model))
```

Residuals are improved, but we need to revisit this model to improve fit.  

Generate a Type II Anova of model.    

```{r}
anova(density_model, type="II")
```

Generate model effect plots.  

```{r}
#plot(allEffects(density_model)) #currently not working, need TP4 data 
```


## Biomass

### Host Biomass  

View by site and timepoint for each species in the host.  
```{r} 
hAFDWplot<-master %>%
  filter(!is.na(Host_AFDW.mg.cm2)) %>%
  filter(!is.na(species))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  select(colony_id_corr, species, site_code, timepoint, Host_AFDW.mg.cm2)%>%
  
  ggplot(., aes(x = site_code, y = Host_AFDW.mg.cm2, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Host Biomass (mg AFDW cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); hAFDWplot
```


### Symbiont biomass  

View by site and timepoint for each species in the symbiont  
```{r} 
sAFDWplot<-master %>%
  filter(!is.na(Sym_AFDW.mg.cm2)) %>%
  filter(!is.na(species))%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  select(colony_id_corr, species, site_code, timepoint, Sym_AFDW.mg.cm2)%>%
  
  ggplot(., aes(x = site_code, y = Sym_AFDW.mg.cm2, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Symbiont Biomass (mg AFDW cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); sAFDWplot
```

### S:H Ratio  

Calculate biomass as a ratio of host to symbiont and plot.  

```{r} 
master <- master %>% 
  mutate(Ratio_AFDW.mg.cm2=Sym_AFDW.mg.cm2/Host_AFDW.mg.cm2)

ratioAFDWplot<-master %>%
  filter(!is.na(Host_AFDW.mg.cm2)) %>%
  filter(!is.na(species))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  select(colony_id_corr, species, site_code, timepoint, Ratio_AFDW.mg.cm2)%>%
  
  ggplot(., aes(x = site_code, y = Ratio_AFDW.mg.cm2, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Symbiont : Host Biomass"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); ratioAFDWplot
```


Join all plots together.  

```{r}
afdw_figure<-plot_grid(hAFDWplot, sAFDWplot, ratioAFDWplot, labels = c("", "", ""), ncol=3, nrow=1, rel_widths = c(.8, .8, 1), label_size = 20, label_x = 0.1)

ggsave(filename="Figures/Biomass_Figure.pdf", plot=afdw_figure, dpi=300, width=24, height=5, units="in")
```

### Analysis  

Build a mixed model for univariate analysis and examine data distribution.

Host Biomass:  

`hAFDW_model<-lmer(Host_AFDW.mg.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0))` 

```{r}
hAFDW_model<-lmer(Host_AFDW.mg.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0))
qqPlot(residuals(hAFDW_model))
hist(residuals(hAFDW_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`hAFDW_model<-lmer(log(Host_AFDW.mg.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0))` 

```{r}
hAFDW_model<-lmer(log(Host_AFDW.mg.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0))
qqPlot(residuals(hAFDW_model))
hist(residuals(hAFDW_model))
```

Residuals are improved, but we need to revisit this model to improve fit.  

Generate a Type II Anova of model.    

```{r}
anova(hAFDW_model, type="II")
```

Generate model effect plots.  

```{r}
plot(allEffects(hAFDW_model))
```

Symbiont Biomass:  

`sAFDW_model<-lmer(Sym_AFDW.mg.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0))` 

```{r}
sAFDW_model<-lmer(Sym_AFDW.mg.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0))
qqPlot(residuals(sAFDW_model))
hist(residuals(sAFDW_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`sAFDW_model<-lmer(log(Sym_AFDW.mg.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0))` 

```{r}
sAFDW_model<-lmer(log(Sym_AFDW.mg.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0))
qqPlot(residuals(sAFDW_model))
hist(residuals(sAFDW_model))
```

Residuals are improved, but we need to revisit this model to improve fit.  

Generate a Type II Anova of model.    

```{r}
anova(sAFDW_model, type="II")
```

Generate model effect plots.  

```{r}
plot(allEffects(sAFDW_model))
```


S:H Biomass: 

`shAFDW_model<-lmer(Ratio_AFDW.mg.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0))` 

```{r}
shAFDW_model<-lmer(Ratio_AFDW.mg.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0))
qqPlot(residuals(shAFDW_model))
hist(residuals(shAFDW_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`shAFDW_model<-lmer(log(Ratio_AFDW.mg.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0))` 

```{r}
shAFDW_model<-lmer(log(Ratio_AFDW.mg.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0))
qqPlot(residuals(shAFDW_model))
hist(residuals(shAFDW_model))
```

Residuals are improved, but we need to revisit this model to improve fit.  

Generate a Type II Anova of model.    

```{r}
anova(shAFDW_model, type="II")
```

Generate model effect plots.  

```{r}
plot(allEffects(shAFDW_model))
```

## Chlorophyll  

### Plot: Surface area     

View by site and timepoint for each species in Chl a.    
```{r}
chlaplot_cm2<-master %>%
  filter(!is.na(chla.ug.cm2)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, chla.ug.cm2)%>%
  
  ggplot(., aes(x = site_code, y = chla.ug.cm2, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Chlorophyll a (", mu, "g cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); chlaplot_cm2
```

View by site and timepoint for each species in Chl c2.   
```{r}
chlc2plot_cm2<-master %>%
  filter(!is.na(chlc2.ug.cm2)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, chlc2.ug.cm2)%>%
  
  ggplot(., aes(x = site_code, y = chlc2.ug.cm2, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Chlorophyll c2 (", mu, "g cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); chlc2plot_cm2
```

### Plot: Protein    

View by site and timepoint for each species in Chl a.    
```{r}
chlaplot_prot<-master %>%
  filter(!is.na(chla.ug.mgprot)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, chla.ug.mgprot)%>%
  
  ggplot(., aes(x = site_code, y = chla.ug.mgprot, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Chlorophyll a (", mu, "g mg protein"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); chlaplot_prot
```

View by site and timepoint for each species in Chl c2.   
```{r}
chlc2plot_prot<-master %>%
  filter(!is.na(chlc2.ug.mgprot)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, chlc2.ug.mgprot)%>%
  
  ggplot(., aes(x = site_code, y = chlc2.ug.mgprot, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Chlorophyll c2 (", mu, "g mg protein"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); chlc2plot_prot
```

### Plot: Biomass    

View by site and timepoint for each species in Chl a.    
```{r}
chlaplot_afdw<-master %>%
  filter(!is.na(chla.ug.mgAFDW)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, chla.ug.mgAFDW)%>%
  
  ggplot(., aes(x = site_code, y = chla.ug.mgAFDW, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Chlorophyll a (", mu, "g mg afdw"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); chlaplot_afdw
```

View by site and timepoint for each species in Chl c2.   
```{r}
chlc2plot_afdw<-master %>%
  filter(!is.na(chlc2.ug.mgAFDW)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, chlc2.ug.mgAFDW)%>%
  
  ggplot(., aes(x = site_code, y = chlc2.ug.mgAFDW, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Chlorophyll c2 (", mu, "g mg afdw"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); chlc2plot_afdw
```

### Plot: Per cell    

View by site and timepoint for each species in Chl a.    
```{r}
chlaplot_cell<-master %>%
  filter(!is.na(chla.ug.cell)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, chla.ug.cell)%>%
  
  ggplot(., aes(x = site_code, y = chla.ug.cell, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Chlorophyll a (", mu, "g cell"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); chlaplot_cell
```

View by site and timepoint for each species in Chl c2.   
```{r}
chlc2plot_cell<-master %>%
  filter(!is.na(chlc2.ug.cell)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, chlc2.ug.cell)%>%
  
  ggplot(., aes(x = site_code, y = chlc2.ug.cell, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Chlorophyll c2 (", mu, "g cell"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); chlc2plot_cell
```

Join all plots for each normalization together.  

```{r}
chl_figure<-plot_grid(chlaplot_prot, chlaplot_afdw, chlaplot_cell, chlaplot_cm2,chlc2plot_prot, chlc2plot_afdw, chlc2plot_cell, chlc2plot_cm2,  labels = c("", "", ""), ncol=4, nrow=2, rel_widths = c(.8, .8, .8, 1, .8, .8, .8, 1), label_size = 20, label_x = 0.1)

ggsave(filename="Figures/Chlorophyll_Figure.pdf", plot=chl_figure, dpi=300, width=32, height=10, units="in")
```

### Analysis  

Build a mixed model for univariate analysis and examine data distribution.

Chlorophyll a: 

`chla_model<-lmer(chla.ug.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
chla_model<-lmer(chla.ug.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(chla_model))
hist(residuals(chla_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`chla_model<-lmer(log(chla.ug.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
chla_model<-lmer(log(chla.ug.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(chla_model))
hist(residuals(chla_model))
```

Generate a Type II Anova of model.    

```{r}
anova(chla_model, type="II")
```

Generate model effect plots.  

```{r}
plot(allEffects(chla_model))
```


Chlorophyll c2: 

Build a mixed model for univariate analysis and examine data distribution.

`chlc2_model<-lmer(chlc2.ug.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
chlc2_model<-lmer(chlc2.ug.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(chlc2_model))
hist(residuals(chlc2_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`chlc2_model<-lmer(log(chlc2.ug.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
chlc2_model<-lmer(log(chlc2.ug.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(chlc2_model))
hist(residuals(chlc2_model))
```

Return to check outliers in this model.  

Generate a Type II Anova of model.    

```{r}
anova(chlc2_model, type="II")
```

Generate model effect plots.  

```{r}
plot(allEffects(chlc2_model))
```


## Protein 

### Plot: Surface Area  

View by site and timepoint for each species.    
```{r}
protplot_cm2<-master %>%
  filter(!is.na(prot_mg.cm2)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, prot_mg.cm2)%>%
  
  ggplot(., aes(x = site_code, y = prot_mg.cm2, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Protein (mg cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); protplot_cm2
```

### Plot: AFDW  

View by site and timepoint for each species.    
```{r}
protplot_afdw<-master %>%
  filter(!is.na(prot_mg.mgafdw)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, prot_mg.mgafdw)%>%
  
  ggplot(., aes(x = site_code, y = prot_mg.mgafdw, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Protein (mg mg afdw"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); protplot_afdw
```

Join all plots for each normalization together.  

```{r}
prot_figure<-plot_grid(protplot_afdw, protplot_cm2, labels = c("", "", ""), ncol=2, nrow=1, rel_widths = c(.8, 1), label_size = 20, label_x = 0.1)

ggsave(filename="Figures/Protein_Figure.pdf", plot=prot_figure, dpi=300, width=16, height=5, units="in")
```

### Analysis  

Build a mixed model for univariate analysis and examine data distribution.

`prot_model<-lmer(prot_ug.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
prot_model<-lmer(prot_ug.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(prot_model))
hist(residuals(prot_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`prot_model<-lmer(log(prot_ug.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
prot_model<-lmer(log(prot_ug.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(prot_model))
hist(residuals(prot_model))
```

Return to check outliers in this model.  

Generate a Type II Anova of model.    

```{r}
anova(prot_model, type="II")
```

Generate model effect plots.  

```{r}
plot(allEffects(prot_model))
```

# Correlations  

Generate a correlation matrix to examine relationships between responses of interest. Use normalizations by afdw for all responses.   

Generating network plot with corrr package.  
```{r}
master%>%
  select(cre.umol.mgafdw, prot_mg.mgafdw, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chlc2.ug.mgAFDW, chla.ug.mgAFDW, cells.mgAFDW, chla.ug.cell, chlc2.ug.cell)%>%
  corrr::correlate(., method="spearman", diagonal=1)%>% #generate correlation matrix
  rearrange(.)%>%
  #shave(.)%>% #remove upper triangle
  network_plot(min_cor=.2)
```

Generating matrix with ggcorrplot.  

```{r}
p<-master%>%
  select(species, cre.umol.mgafdw, prot_mg.mgafdw, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chlc2.ug.mgAFDW, chla.ug.mgAFDW, cells.mgAFDW, chla.ug.cell, chlc2.ug.cell)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  ggpairs(., columns=2:11, ggplot2::aes(colour=species)) #try to bold significant stats

#change colors
for(i in 1:p$nrow) {
  for(j in 1:p$ncol){
    p[i,j] <- p[i,j] + 
        scale_fill_manual(values=c("orange", "gray", "purple")) +
        scale_color_manual(values=c("orange", "gray", "purple")) +
        theme_classic()+
        theme(text=element_text(size=14, face="bold"))+
        theme(strip.text.x=element_text(face="bold", size=14))
  }
}

p

ggsave(plot=p, "Figures/Correlation_Matrix.pdf", width=20, height=12, unit="in", dpi=300)
```


# Multivariate analyses  

## PCAs: Surface Area normalizers  

### Combined PCA's  

Plot PCA using prcomp to center and scale.    
 
```{r}
pca_data_cm2<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.cm2, chlc2.ug.cm2, prot_mg.cm2, cells.cm2, cre.umol.cm2)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)

pca_data_cm2<-pca_data_cm2[complete.cases(pca_data_cm2), ]

scaled_data_cm2<-prcomp(pca_data_cm2[c(5:12)], scale=TRUE, center=TRUE) 
```

Groupings by species:  
```{r}
pcaSpecies_cm2<-ggplot2::autoplot(scaled_data_cm2, data=pca_data_cm2, frame.colour="species", loadings=FALSE,  colour="species", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("orange", "darkgray", "purple")) +
  scale_fill_manual(values=c("orange", "darkgray", "purple")) + 
  theme_classic()+
  xlim(-0.3,0.5)+
  ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaSpecies_cm2

```

PERMANOVA of the effect of species  
```{r}
# scale data
vegan_cm2 <- scale(pca_data_cm2[ ,5:12])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_cm2 ~ species, data = pca_data_cm2, method='eu')
```


Groupings by timepoint:  
```{r}
pcaTimepoint_cm2<-ggplot2::autoplot(scaled_data_cm2, data=pca_data_cm2, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) + 
  theme_classic()+
  xlim(-0.3,0.5)+
  ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaTimepoint_cm2
```

PERMANOVA of the effect of timepoint  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_cm2 ~ timepoint, data = pca_data_cm2, method='eu')
```

Groupings by site:  
```{r}
pcaSite_cm2<-ggplot2::autoplot(scaled_data_cm2, data=pca_data_cm2, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  xlim(-0.3,0.5)+
  ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaSite_cm2

```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_cm2 ~ site_code, data = pca_data_cm2, method='eu')
```

Generate a plot of all PCA's for surface area normalization.  

```{r}
pcaplots_cm2<-plot_grid(pcaSpecies_cm2, pcaSite_cm2, pcaTimepoint_cm2, labels = c("Species: Surface Area", "Site: Surface Area", "Timepoint: Surface Area"), ncol=3, nrow=1, rel_widths = c(1, 1, 1), label_size = 20, label_x = 0.01)

ggsave(filename="Figures/All_PCAs_cm2.pdf", plot=pcaplots_cm2, dpi=300, width=24, height=5, units="in")
```  

### Species-specific PCA's   

Next generate PCA for site and timepoint for each species separately.  

Separate by species.  
```{r}
#porites
por_data_cm2<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.cm2, chlc2.ug.cm2, prot_mg.cm2, cells.cm2, cre.umol.cm2)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Porites")

por_data_cm2<-por_data_cm2[complete.cases(por_data_cm2), ]

scaled_por_cm2<-prcomp(por_data_cm2[c(5:12)], scale=TRUE, center=TRUE) 

#acropora
acr_data_cm2<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.cm2, chlc2.ug.cm2, prot_mg.cm2, cells.cm2, cre.umol.cm2)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Acropora")

acr_data_cm2<-acr_data_cm2[complete.cases(acr_data_cm2), ]

scaled_acr_cm2<-prcomp(acr_data_cm2[c(5:12)], scale=TRUE, center=TRUE) 

#pocillopora
poc_data_cm2<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.cm2, chlc2.ug.cm2, prot_mg.cm2, cells.cm2, cre.umol.cm2)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Pocillopora")

poc_data_cm2<-poc_data_cm2[complete.cases(poc_data_cm2), ]

scaled_poc_cm2<-prcomp(poc_data_cm2[c(5:12)], scale=TRUE, center=TRUE) 
```

#### Porites PCA's   

Groupings by timepoint:  
```{r}
porTimepoint_cm2<-ggplot2::autoplot(scaled_por_cm2, data=por_data_cm2, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) + 
  theme_classic()+
  xlim(-0.7,0.5)+
  ylim(-0.7, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));porTimepoint_cm2
```

PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_cm2 <- scale(por_data_cm2[ ,5:12])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_cm2 ~ timepoint, data = por_data_cm2, method='eu')
```

Groupings by site:  
```{r}
porSite_cm2<-ggplot2::autoplot(scaled_por_cm2, data=por_data_cm2, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  xlim(-0.7,0.5)+
  ylim(-0.7, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));porSite_cm2
```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_cm2 ~ site_code, data = por_data_cm2, method='eu')
```

#### Acropora PCA's  
 
Groupings by timepoint:  
```{r}
acrTimepoint_cm2<-ggplot2::autoplot(scaled_acr_cm2, data=acr_data_cm2, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) + 
  theme_classic()+
  xlim(-0.5,0.5)+
  ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));acrTimepoint_cm2
```

PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_cm2 <- scale(acr_data_cm2[ ,5:12])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_cm2 ~ timepoint, data = acr_data_cm2, method='eu')
```

Groupings by site:  
```{r}
acrSite_cm2<-ggplot2::autoplot(scaled_acr_cm2, data=acr_data_cm2, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  xlim(-0.5,0.5)+
  ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));acrSite_cm2
```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_cm2 ~ site_code, data = acr_data_cm2, method='eu')
```

#### Pocillopora PCA's  

Groupings by timepoint:   
```{r}
pocTimepoint_cm2<-ggplot2::autoplot(scaled_poc_cm2, data=poc_data_cm2, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) + 
  theme_classic()+
  xlim(-0.6,0.5)+
  ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pocTimepoint_cm2
```
 
PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_cm2 <- scale(poc_data_cm2[ ,5:12])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_cm2 ~ timepoint, data = poc_data_cm2, method='eu')
```

Groupings by site:  
```{r}
pocSite_cm2<-ggplot2::autoplot(scaled_poc_cm2, data=poc_data_cm2, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  xlim(-0.5,0.5)+
  ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pocSite_cm2
```

PERMANOVA of the effect of site  
```{r}

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_cm2 ~ site_code, data = poc_data_cm2, method='eu')
```

Generate a plot of all PCA's for all Species    

```{r}
species_plots_cm2<-plot_grid(porSite_cm2, porTimepoint_cm2, acrSite_cm2, acrTimepoint_cm2, pocSite_cm2, pocTimepoint_cm2, labels = c("Porites: Surface Area", "Porites: Surface Area", "Acropora: Surface Area", "Acropora: Surface Area", "Pocillopora: Surface Area", "Pocillopora: Surface Area"), ncol=2, nrow=3, rel_widths = c(1, 1, 1, 1, 1, 1), label_size = 20, label_x = 0.01, label_y=1.0)

ggsave(filename="Figures/Species_PCAs_cm2.pdf", plot=species_plots_cm2, dpi=300, width=18, height=15, units="in")
``` 

 












## PCAs: Protein normalizers  

### Combined PCA's  

Plot PCA using prcomp to center and scale.    
 
```{r}
pca_data_prot<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgprot, chlc2.ug.mgprot, prot_mg.cm2, cells.mgprot, cre.umol.mgprot)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)

pca_data_prot<-pca_data_prot[complete.cases(pca_data_prot), ]

scaled_data_prot<-prcomp(pca_data_prot[c(5:12)], scale=TRUE, center=TRUE) 
```

Groupings by species:  
```{r}
pcaSpecies_prot<-ggplot2::autoplot(scaled_data_prot, data=pca_data_prot, frame.colour="species", loadings=FALSE,  colour="species", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("orange", "darkgray", "purple")) +
  scale_fill_manual(values=c("orange", "darkgray", "purple")) + 
  theme_classic()+
  xlim(-0.3,0.5)+
  ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaSpecies_prot

```

PERMANOVA of the effect of species  
```{r}
# scale data
vegan_prot <- scale(pca_data_prot[ ,5:12])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_prot ~ species, data = pca_data_prot, method='eu')
```


Groupings by timepoint:  
```{r}
pcaTimepoint_prot<-ggplot2::autoplot(scaled_data_prot, data=pca_data_prot, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) + 
  theme_classic()+
  xlim(-0.3,0.5)+
  ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaTimepoint_prot
```

PERMANOVA of the effect of timepoint  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_prot ~ timepoint, data = pca_data_prot, method='eu')
```

Groupings by site:  
```{r}
pcaSite_prot<-ggplot2::autoplot(scaled_data_prot, data=pca_data_prot, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  xlim(-0.3,0.5)+
  ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaSite_prot

```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_prot ~ site_code, data = pca_data_prot, method='eu')
```

Generate a plot of all PCA's for protein normalization.  

```{r}
pcaplots_prot<-plot_grid(pcaSpecies_prot, pcaSite_prot, pcaTimepoint_prot, labels = c("Species: Protein", "Site: Protein", "Timepoint: Protein"), ncol=3, nrow=1, rel_widths = c(1, 1, 1), label_size = 20, label_x = 0.02)

ggsave(filename="Figures/All_PCAs_prot.pdf", plot=pcaplots_prot, dpi=300, width=24, height=5, units="in")
```  

### Species-specific PCA's   

Next generate PCA for site and timepoint for each species separately.  

Separate by species.  
```{r}
#porites
por_data_prot<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgprot, chlc2.ug.mgprot, prot_mg.cm2, cells.mgprot, cre.umol.mgprot)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Porites")

por_data_prot<-por_data_prot[complete.cases(por_data_prot), ]

scaled_por_prot<-prcomp(por_data_prot[c(5:12)], scale=TRUE, center=TRUE) 

#acropora
acr_data_prot<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgprot, chlc2.ug.mgprot, prot_mg.cm2, cells.mgprot, cre.umol.mgprot)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Acropora")

acr_data_prot<-acr_data_prot[complete.cases(acr_data_prot), ]

scaled_acr_prot<-prcomp(acr_data_prot[c(5:12)], scale=TRUE, center=TRUE) 

#pocillopora
poc_data_prot<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgprot, chlc2.ug.mgprot, prot_mg.cm2, cells.mgprot, cre.umol.mgprot)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Pocillopora")

poc_data_prot<-poc_data_prot[complete.cases(poc_data_prot), ]

scaled_poc_prot<-prcomp(poc_data_prot[c(5:12)], scale=TRUE, center=TRUE) 
```

#### Porites PCA's   

Groupings by timepoint:  
```{r}
porTimepoint_prot<-ggplot2::autoplot(scaled_por_prot, data=por_data_prot, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) + 
  theme_classic()+
  xlim(-0.7,0.5)+
  ylim(-0.7, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));porTimepoint_prot
```

PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_prot <- scale(por_data_prot[ ,5:12])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_prot ~ timepoint, data = por_data_prot, method='eu')
```

Groupings by site:  
```{r}
porSite_prot<-ggplot2::autoplot(scaled_por_prot, data=por_data_prot, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  xlim(-0.7,0.5)+
  ylim(-0.7, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));porSite_prot
```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_prot ~ site_code, data = por_data_prot, method='eu')
```

#### Acropora PCA's  
 
Groupings by timepoint:  
```{r}
acrTimepoint_prot<-ggplot2::autoplot(scaled_acr_prot, data=acr_data_prot, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) + 
  theme_classic()+
  xlim(-0.5,0.5)+
  ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));acrTimepoint_prot
```

PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_prot <- scale(acr_data_prot[ ,5:12])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_prot ~ timepoint, data = acr_data_prot, method='eu')
```

Groupings by site:  
```{r}
acrSite_prot<-ggplot2::autoplot(scaled_acr_prot, data=acr_data_prot, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  xlim(-0.5,0.5)+
  ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));acrSite_prot
```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_prot ~ site_code, data = acr_data_prot, method='eu')
```

#### Pocillopora PCA's  

Groupings by timepoint:   
```{r}
pocTimepoint_prot<-ggplot2::autoplot(scaled_poc_prot, data=poc_data_prot, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) + 
  theme_classic()+
  xlim(-0.6,0.5)+
  ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pocTimepoint_prot
```
 
PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_prot <- scale(poc_data_prot[ ,5:12])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_prot ~ timepoint, data = poc_data_prot, method='eu')
```

Groupings by site:  
```{r}
pocSite_prot<-ggplot2::autoplot(scaled_poc_prot, data=poc_data_prot, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  xlim(-0.5,0.5)+
  ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pocSite_prot
```

PERMANOVA of the effect of site  
```{r}

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_prot ~ site_code, data = poc_data_prot, method='eu')
```

Generate a plot of all PCA's for all Species    

```{r}
species_plots_prot<-plot_grid(porSite_prot, porTimepoint_prot, acrSite_prot, acrTimepoint_prot, pocSite_prot, pocTimepoint_prot, labels = c("Porites: Protein", "Porites: Protein", "Acropora: Protein", "Acropora: Protein", "Pocillopora: Protein", "Pocillopora: Protein"), ncol=2, nrow=3, rel_widths = c(1, 1, 1, 1, 1, 1), label_size = 20, label_x = 0.01, label_y=1.0)

ggsave(filename="Figures/Species_PCAs_prot.pdf", plot=species_plots_prot, dpi=300, width=18, height=15, units="in")
``` 

 











## PCAs: Biomass normalizers  

### Combined PCA's  

Plot PCA using prcomp to center and scale.    
 
```{r}
pca_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)

pca_data_afdw<-pca_data_afdw[complete.cases(pca_data_afdw), ]

scaled_data_afdw<-prcomp(pca_data_afdw[c(5:12)], scale=TRUE, center=TRUE) 
```

Groupings by species:  
```{r}
pcaSpecies_afdw<-ggplot2::autoplot(scaled_data_afdw, data=pca_data_afdw, frame.colour="species", loadings=FALSE,  colour="species", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("orange", "darkgray", "purple")) +
  scale_fill_manual(values=c("orange", "darkgray", "purple")) + 
  theme_classic()+
  xlim(-0.3,0.5)+
  ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaSpecies_afdw

```

PERMANOVA of the effect of species  
```{r}
# scale data
vegan_afdw <- scale(pca_data_afdw[ ,5:12])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_afdw ~ species, data = pca_data_afdw, method='eu')
```


Groupings by timepoint:  
```{r}
pcaTimepoint_afdw<-ggplot2::autoplot(scaled_data_afdw, data=pca_data_afdw, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) + 
  theme_classic()+
  xlim(-0.3,0.5)+
  ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaTimepoint_afdw
```

PERMANOVA of the effect of timepoint  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_afdw ~ timepoint, data = pca_data_afdw, method='eu')
```

Groupings by site:  
```{r}
pcaSite_afdw<-ggplot2::autoplot(scaled_data_afdw, data=pca_data_afdw, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  xlim(-0.3,0.5)+
  ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaSite_afdw

```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_afdw ~ site_code, data = pca_data_afdw, method='eu')
```

Generate a plot of all PCA's for afdw normalization.  

```{r}
pcaplots_afdw<-plot_grid(pcaSpecies_afdw, pcaSite_afdw, pcaTimepoint_afdw, labels = c("Species: Biomass", "Site: Biomass", "Timepoint: Biomass"), ncol=3, nrow=1, rel_widths = c(1, 1, 1), label_size = 20, label_x = 0.02)

ggsave(filename="Figures/All_PCAs_afdw.pdf", plot=pcaplots_afdw, dpi=300, width=24, height=5, units="in")
```  

### Species-specific PCA's   

Next generate PCA for site and timepoint for each species separately.  

Separate by species.  
```{r}
#porites
por_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Porites")

por_data_afdw<-por_data_afdw[complete.cases(por_data_afdw), ]

scaled_por_afdw<-prcomp(por_data_afdw[c(5:12)], scale=TRUE, center=TRUE) 

#acropora
acr_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Acropora")

acr_data_afdw<-acr_data_afdw[complete.cases(acr_data_afdw), ]

scaled_acr_afdw<-prcomp(acr_data_afdw[c(5:12)], scale=TRUE, center=TRUE) 

#pocillopora
poc_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Pocillopora")

poc_data_afdw<-poc_data_afdw[complete.cases(poc_data_afdw), ]

scaled_poc_afdw<-prcomp(poc_data_afdw[c(5:12)], scale=TRUE, center=TRUE) 
```

#### Porites PCA's   

Groupings by timepoint:  
```{r}
porTimepoint_afdw<-ggplot2::autoplot(scaled_por_afdw, data=por_data_afdw, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) + 
  theme_classic()+
  xlim(-0.7,0.5)+
  ylim(-0.7, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));porTimepoint_afdw
```

PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_afdw <- scale(por_data_afdw[ ,5:12])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_afdw ~ timepoint, data = por_data_afdw, method='eu')
```

Groupings by site:  
```{r}
porSite_afdw<-ggplot2::autoplot(scaled_por_afdw, data=por_data_afdw, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  xlim(-0.7,0.5)+
  ylim(-0.7, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));porSite_afdw
```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_afdw ~ site_code, data = por_data_afdw, method='eu')
```

#### Acropora PCA's  
 
Groupings by timepoint:  
```{r}
acrTimepoint_afdw<-ggplot2::autoplot(scaled_acr_afdw, data=acr_data_afdw, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) + 
  theme_classic()+
  xlim(-0.5,0.5)+
  ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));acrTimepoint_afdw
```

PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_afdw <- scale(acr_data_afdw[ ,5:12])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_afdw ~ timepoint, data = acr_data_afdw, method='eu')
```

Groupings by site:  
```{r}
acrSite_afdw<-ggplot2::autoplot(scaled_acr_afdw, data=acr_data_afdw, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  xlim(-0.5,0.5)+
  ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));acrSite_afdw
```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_afdw ~ site_code, data = acr_data_afdw, method='eu')
```

#### Pocillopora PCA's  

Groupings by timepoint:   
```{r}
pocTimepoint_afdw<-ggplot2::autoplot(scaled_poc_afdw, data=poc_data_afdw, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) + 
  theme_classic()+
  xlim(-0.6,0.5)+
  ylim(-0.5, 0.8)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pocTimepoint_afdw
```
 
PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_afdw <- scale(poc_data_afdw[ ,5:12])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_afdw ~ timepoint, data = poc_data_afdw, method='eu')
```

Groupings by site:  
```{r}
pocSite_afdw<-ggplot2::autoplot(scaled_poc_afdw, data=poc_data_afdw, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  xlim(-0.5,0.5)+
  ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pocSite_afdw
```

PERMANOVA of the effect of site  
```{r}

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_afdw ~ site_code, data = poc_data_afdw, method='eu')
```

Generate a plot of all PCA's for all Species    

```{r}
species_plots_afdw<-plot_grid(porSite_afdw, porTimepoint_afdw, acrSite_afdw, acrTimepoint_afdw, pocSite_afdw, pocTimepoint_afdw, labels = c("Porites: Biomass", "Porites: Biomass", "Acropora: Biomass", "Acropora: Biomass", "Pocillopora: Biomass", "Pocillopora: Biomass"), ncol=2, nrow=3, rel_widths = c(1, 1, 1, 1, 1, 1), label_size = 20, label_x = 0.01, label_y=1.0)

ggsave(filename="Figures/Species_PCAs_afdw.pdf", plot=species_plots_afdw, dpi=300, width=18, height=15, units="in")
``` 













## Assemble all PCA plots  

Generate plot of all combined PCA's

```{r}
All_PCAs<-plot_grid(pcaSpecies_prot, pcaSite_prot, pcaTimepoint_prot, pcaSpecies_afdw, pcaSite_afdw, pcaTimepoint_afdw, pcaSpecies_cm2, pcaSite_cm2, pcaTimepoint_cm2, labels = c("Protein", "Protein", "Protein", "Biomass", "Biomass", "Biomass","Surface Area", "Surface Area", "Surface Area"), ncol=3, nrow=3, rel_widths = c(1, 1, 1, 1, 1, 1, 1, 1, 1), label_size = 20, label_x = 0.06, label_y=1.0)

ggsave(filename="Figures/All_PCAs.pdf", plot=All_PCAs, dpi=300, width=24, height=15, units="in")
``` 

Generate plot of all species specific PCA's

```{r}
All_PCAs_species<-plot_grid(porSite_prot, porTimepoint_prot, porSite_afdw, porTimepoint_afdw, porSite_cm2, porTimepoint_cm2, 
                    acrSite_prot, acrTimepoint_prot, acrSite_afdw, acrTimepoint_afdw, acrSite_cm2, acrTimepoint_cm2,
                    pocSite_prot, pocTimepoint_prot, pocSite_afdw, pocTimepoint_afdw, pocSite_cm2, pocTimepoint_cm2,
                    labels = c("Porites: Protein", "Porites: Protein", "Porites: Biomass", "Porites: Biomass", "Porites: SA", "Porites: SA",
                               "Acropora: Protein", "Acropora: Protein", "Acropora: Biomass", "Acropora: Biomass", "Acropora: SA", "Acropora: SA",
                               "Pocillopora: Protein", "Pocillopora: Protein", "Pocillopora: Biomass", "Pocillopora: Biomass", "Pocillopora: SA", "Pocillopora: SA"), ncol=6, nrow=3, rel_widths = c(1), label_size = 20, label_x = 0.06, label_y=1.0)

ggsave(filename="Figures/All_Species_PCAs.pdf", plot=All_PCAs_species, dpi=300, width=48, height=15, units="in")
``` 