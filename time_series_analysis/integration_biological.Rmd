---
title: "Integrating E5 time series biological data"
author: "Ariana S Huffmyer"
date: "8/18/2021"
output: html_document
editor_options: 
  chunk_output_type: console
--- 
 
# Set Up    
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

```{r}
## install packages if you dont already have them
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("RColorBrewer")) install.packages("RColorBrewer")
if (!require("lme4")) install.packages("lme4")
if (!require("lmerTest")) install.packages("lmerTest")
if (!require("car")) install.packages("car")
if (!require("effects")) install.packages("effects")
if (!require("ggfortify")) install.packages("ggfortify")
if (!require("cowplot")) install.packages("cowplot")
if (!require("vegan")) install.packages("vegan")
if (!require("corrr")) install.packages("corrr")
if (!require("ggcorrplot")) install.packages("ggcorrplot")
if (!require("GGally")) install.packages("GGally")
if (!require("broom")) install.packages("broom")
if (!require("cowplot")) install.packages("cowplot")

# load packages
library(tidyverse)
library(ggplot2)
library(RColorBrewer)
library(lme4)
library(lmerTest)
library(car)
library(effects)
library(ggfortify)
library(cowplot)
library(vegan)
library(corrr)
library(ggcorrplot)
library(GGally)
library(broom)
library(cowplot)
```
 
# Load and manipulate data  

## Loading data files     

Load all .csv files from output of all timepoints for each biological response     
 
```{r}
biomass_files<-list.files("../", pattern = "biomass.csv", recursive=T, full.names=T)
antioxidant_files<-list.files("../", pattern = "antioxidant_capacity.csv", recursive=T, full.names=T)
pi_curve_pars_files<-list.files("../", pattern = "pi_curve_pars_nls.csv", recursive=T, full.names=T)
surface_area_files<-list.files("../", pattern = "surface_area.csv", recursive=T, full.names=T)
protein_files<-list.files("../", pattern = "protein.csv", recursive=T, full.names=T)
symb_densities_files<-list.files("../", pattern = "symb_densities.csv", recursive=T, full.names=T)
chlorophyll_files<-list.files("../", pattern = "chlorophyll.csv", recursive=T, full.names=T)

#need to add calcification
```
 

## Read data files 

Load all data frames.  

```{r}
#biomass 
biomass_dataset <- data.frame()

for (i in 1:length(biomass_files)){
  biomass_df <- read.csv(biomass_files[i]) #each file will be read in
  biomass_dataset <- rbind(biomass_dataset, biomass_df) #for each iteration, bind the new data to the building dataset
}

```

```{r}
#antioxidant capacity 
antioxidant_dataset <- data.frame()

for (i in 1:length(antioxidant_files)){
  antioxidant_df <- read.csv(antioxidant_files[i]) #each file will be read in
  antioxidant_dataset <- rbind(antioxidant_dataset, antioxidant_df) #for each iteration, bind the new data to the building dataset
}

```

```{r}
#PI curve pars
pi_curve_pars_dataset <- data.frame()

for (i in 1:length(pi_curve_pars_files)){
  pi_curve_pars_df <- read.csv(pi_curve_pars_files[i]) #each file will be read in
  pi_curve_pars_dataset <- rbind(pi_curve_pars_dataset, pi_curve_pars_df) #for each iteration, bind the new data to the building dataset
}
```

```{r}
#surface area 
surface_area_dataset <- data.frame()

for (i in 1:length(surface_area_files)){
  surface_area_df <- read.csv(surface_area_files[i]) #each file will be read in
  surface_area_dataset <- rbind(surface_area_dataset, surface_area_df) #for each iteration, bind the new data to the building dataset
}
```

```{r}
#protein 
protein_dataset <- data.frame()

for (i in 1:length(protein_files)){
  protein_df <- read.csv(protein_files[i]) #each file will be read in
  protein_dataset <- rbind(protein_dataset, protein_df) #for each iteration, bind the new data to the building dataset
}
```

```{r}
#symb densities 
symb_densities_dataset <- data.frame()

for (i in 1:length(symb_densities_files)){
  symb_densities_df <- read.csv(symb_densities_files[i]) #each file will be read in
  symb_densities_dataset <- rbind(symb_densities_dataset, symb_densities_df) #for each iteration, bind the new data to the building dataset
}
```

```{r}
#chlorophyll files 
chlorophyll_dataset <- data.frame()

for (i in 1:length(chlorophyll_files)){
  chlorophyll_df <- read.csv(chlorophyll_files[i]) #each file will be read in
  chlorophyll_dataset <- rbind(chlorophyll_dataset, chlorophyll_df) #for each iteration, bind the new data to the building dataset
}

```

```{r}
#remove files that are not needed from loops
rm(list = ls(pattern = "*_df"))
```


## Generate master data frame    

Read in metadata frame. 
```{r}
#Load tag metadata sheet 
tags<-read.csv("../metadata/coral_id_metadata.csv")
```

Prepare datasets for merging by renaming columns and spreading dataframes. Each file needs to have one line per colony per response variable in order to merge and should be without site/species columns as these will be added from metadata sheet.   
```{r}
#antioxidant data 
antioxidant_dataset<-antioxidant_dataset%>%
  select(colony_id, cre.umol.mgprot, timepoint)

#biomass data 
biomass_dataset<- biomass_dataset %>%
  filter(!colony_id=="1xPBS")%>%
  nest(value_col = c(AFDW.mg.cm2, DW.mg.cm2)) %>%
  spread(key = partner, value = value_col) %>%
  unnest(Host, Sym, .sep = '_')%>%
  select(colony_id, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Host_DW.mg.cm2, Sym_DW.mg.cm2, timepoint)

#protein data
protein_dataset<-protein_dataset%>%
  select(colony_id, prot_ug.cm2, timepoint)
  
#symbiont densitites
symb_densities_dataset<-symb_densities_dataset%>%
  select(colony_id, cells.cm2, timepoint)

```




```{r}
#can also use "join_all" - E. Strand
master <- full_join(full_join(full_join(full_join(full_join(full_join(
  antioxidant_dataset,
  biomass_dataset, by=c("colony_id", "timepoint")),
  chlorophyll_dataset, by=c("colony_id", "timepoint")),
  protein_dataset, by=c("colony_id", "timepoint")),
  surface_area_dataset, by=c("colony_id", "timepoint")), 
  symb_densities_dataset, by=c("colony_id", "timepoint")), 
  pi_curve_pars_dataset, by=c("colony_id", "timepoint")) 

head(master)
```

Control for colony id, site name, and timepoint names. 
```{r}
#Add column for month of year for each timepoint
master$month[master$timepoint == "timepoint1"] <- "January 2020"
master$month[master$timepoint == "timepoint2"] <- "March 2020"
master$month[master$timepoint == "timepoint3"] <- "September 2020"
master$month[master$timepoint == "timepoint4"] <- "November 2020"

#replace colony id with the original tag number if the tag was changed during the timeseries, as shown by a new tag id at the end of the time series
master$colony_id_corr<-tags$Original_Tag[match(master$colony_id, tags$Tag_ID_Nov)] 

#if there is an na (because the colony tag id did not change over the timesereis), populate with the colonyid number from colony_id column
master$colony_id_corr[is.na(master$colony_id_corr)] <- master$colony_id[is.na(master$colony_id_corr)]

#match site name by site number and species from tag sheet 
master$site<-tags$Site[match(master$colony_id_corr, tags$Original_Tag)]
master$species<-tags$Coral_Species[match(master$colony_id_corr, tags$Original_Tag)]

#add a nutrient level for each site  
master<-master%>%
  mutate(nutrient = if_else(site == "Hilton", "Medium", 
                            if_else(site == "Mahana", "Low", 
                                    if_else(site == "Manava", "High", "NA"))))%>%
  mutate(site_code = paste(site, nutrient))

master$site_code <- factor(master$site_code, levels = c("Mahana Low", "Hilton Medium", "Manava High"))
```

# Normalization  

In order to examine the effect of normalizer on all response variables, normalize each response to: 
(1) Protein  (ug/cm2)  
(2) AFDW  (mg/cm2)   
(3) Surface area (cm2)  

To do this, back-normalize variables that are already normalized and divide by each new normalizer.   

```{r}
master<-master%>%
  mutate(mgprot = (prot_ug.cm2*surface.area.cm2)/1000)%>% #get absolute values of normaliers for each coral sample, change from ug to mg
  mutate(mgafdw = Host_AFDW.mg.cm2*surface.area.cm2)%>% #get absolute values of normaliers for each coral sample
  mutate(cells = cells.cm2 * surface.area.cm2)%>% #get absolute number of symbiont cells
  mutate(cells.mgprot = (cells.cm2 * surface.area.cm2)/mgprot)%>% #convert cells per cm2 to cells per mg protein
  mutate(cells.mgAFDW = (cells.cm2 * surface.area.cm2)/mgafdw)%>% #converts cells per cm2 to cells per mg afdw
  mutate(chla.ug.mgprot = (chla.ug.cm2 * surface.area.cm2)/mgprot)%>% #normalize chla to protein
  mutate(chla.ug.mgAFDW = (chla.ug.cm2 * surface.area.cm2)/mgafdw)%>% #normalize chla to afdw
  mutate(chlc2.ug.mgprot = (chlc2.ug.cm2 * surface.area.cm2)/mgprot)%>% #normalize chlc2 to protein
  mutate(chlc2.ug.mgAFDW = (chlc2.ug.cm2 * surface.area.cm2)/mgafdw)%>% #normalize chlc2 to afdw
  mutate(prot_mg.cm2=prot_ug.cm2/1000)%>% #change protein to mg
  mutate(prot_mg.mgafdw=(prot_mg.cm2*surface.area.cm2)/mgafdw)%>% #normalize protein to afdw
  mutate(cre.umol.mgafdw=(cre.umol.mgprot*mgprot)/mgafdw)%>% #normalize tac to afdw
  mutate(cre.umol.cm2=(cre.umol.mgprot*mgprot)/surface.area.cm2)%>% #normalize tac to surface area
  mutate(chla.ug.cell = (chla.ug.cm2 * surface.area.cm2)/cells) %>% #normalize to chl per cell
  mutate(chlc2.ug.cell = (chlc2.ug.cm2 * surface.area.cm2)/cells) #normalize to chl per cell
```
 
Write master file to csv.  
```{r}
write_csv(master, "Output/master_timeseries.csv")
```


# Generating summary by groups   

Summarize all response values by group (species + timepoint + site).     

```{r}
summary_colony<-master%>%
  select(., -c(colony_id, timepoint, site_code))%>%
  group_by(colony_id_corr, month, site, nutrient, species)%>%
  summarise(across(.cols=everything(), ~mean(.x, na.rm = TRUE)))%>%
  drop_na("site")%>%
  write_csv(., "Output/Summary_Colony_Responses.csv")

summary_group<-master%>%
  select(., -c(colony_id, timepoint, site_code, colony_id_corr))%>%
  group_by(month, site, nutrient, species)%>%
  summarise(across(.cols=everything(), ~mean(.x, na.rm = TRUE)))%>%
  drop_na("site")%>%
  write_csv(., "Output/Summary_Responses.csv")
           
```


# Univariate Responses  

## Antioxidant capacity  

### Plot: CRE umol mgprot 

View by site and timepoint for each species.   
```{r}
tacplot_prot<-master %>%
  filter(!is.na(cre.umol.mgprot)) %>% 
  select(colony_id_corr, species, site_code, timepoint, cre.umol.mgprot)%>%
  
  ggplot(., aes(x = site_code, y = cre.umol.mgprot, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    ylab(expression(bold(paste("Antioxidant Capacity (", mu, "mol CRE mg afdw"^-1,")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); tacplot_prot
```

### Plot: CRE umol mgafdw 

View by site and timepoint for each species.   
```{r}
tacplot_afdw<-master %>%
  filter(!is.na(cre.umol.mgafdw)) %>%
  select(colony_id_corr, species, site_code, timepoint, cre.umol.mgafdw)%>%
  
  ggplot(., aes(x = site_code, y = cre.umol.mgafdw, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    ylab(expression(bold(paste("Antioxidant Capacity (", mu, "mol CRE mg afdw"^-1,")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); tacplot_afdw
```


### Plot: CRE umol cm2 

View by site and timepoint for each species.   
```{r}
tacplot_cm2<-master %>%
  filter(!is.na(cre.umol.cm2)) %>%
  select(colony_id_corr, species, site_code, timepoint, cre.umol.cm2)%>%
  
  ggplot(., aes(x = site_code, y = cre.umol.cm2, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
     scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    ylab(expression(bold(paste("Antioxidant Capacity (", mu, "mol CRE mg afdw"^-1,")"))))+
    theme_classic() + 
    theme(
      legend.position="right",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); tacplot_cm2

```

Join all plots for each normalization together.  

```{r}
tac_figure<-plot_grid(tacplot_prot, tacplot_afdw, tacplot_cm2, labels = c("", "", ""), ncol=3, nrow=1, rel_widths = c(.8, .8, 1), label_size = 20, label_x = 0.1)

ggsave(filename="Figures/TAC_Figure.pdf", plot=tac_figure, dpi=300, width=24, height=5, units="in")
```

### Analysis 

Build a mixed model for univariate analysis and examine data distribution.

`antiox_model<-lmer(cre.umol.mgprot~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
antiox_model<-lmer(cre.umol.mgprot~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(antiox_model))
hist(residuals(antiox_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`antiox_model<-lmer(log(cre.umol.mgprot)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
antiox_model<-lmer(log(cre.umol.mgprot)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(antiox_model))
hist(residuals(antiox_model))
```

Residuals are improved, but we need to revisit this model to improve fit.  

Generate a Type II Anova of model.    

```{r}
anova(antiox_model, type="II")
```

Generate model effect plots.  

```{r}
plot(allEffects(antiox_model))
```

## Symbiont Densities  

### Plot: Surface Area    
 
View by site and timepoint for each species.   
```{r}
symbplot_cm2<-master %>%
  filter(!is.na(cells.cm2)) %>%
  filter(!is.na(species))%>%
  select(colony_id_corr, species, site_code, timepoint, cells.cm2)%>%
  
  ggplot(., aes(x = site_code, y = cells.cm2, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Symbiont Cells cm"^-2))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); symbplot_cm2
```

### Plot: Protein   

View by site and timepoint for each species.   
```{r}
symbplot_prot<-master %>%
  filter(!is.na(cells.mgprot)) %>%
   filter(!is.na(species))%>%
  select(colony_id_corr, species, site_code, timepoint, cells.mgprot)%>%
  
  ggplot(., aes(x = site_code, y = cells.mgprot, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Symbiont Cells mg protein"^-1))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); symbplot_prot

```

### Plot: Biomass   

View by site and timepoint for each species.   
```{r}
symbplot_afdw<-master %>%
  filter(!is.na(cells.mgAFDW)) %>%
    filter(!is.na(species))%>%
  select(colony_id_corr, species, site_code, timepoint, cells.mgAFDW)%>%
  
  ggplot(., aes(x = site_code, y = cells.mgAFDW, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Symbiont Cells mg afdw"^-1))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); symbplot_afdw
```

Join all plots for each normalization together.  

```{r}
symbcells_figure<-plot_grid(symbplot_prot, symbplot_afdw, symbplot_cm2, labels = c("", "", ""), ncol=3, nrow=1, rel_widths = c(.8, .8, 1), label_size = 20, label_x = 0.1)

ggsave(filename="Figures/CellDensity_Figure.pdf", plot=symbcells_figure, dpi=300, width=24, height=5, units="in")
```

### Analysis  

Build a mixed model for univariate analysis and examine data distribution.

`density_model<-lmer(cells.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
density_model<-lmer(cells.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(density_model))
hist(residuals(density_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`density_model<-lmer(log(cells.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
density_model<-lmer(log(cells.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(density_model))
hist(residuals(density_model))
```

Residuals are improved, but we need to revisit this model to improve fit.  

Generate a Type II Anova of model.    

```{r}
anova(density_model, type="II")
```

Generate model effect plots.  

```{r}
#plot(allEffects(density_model)) #currently not working, need TP4 data 
```


## Biomass

### Host Biomass  

View by site and timepoint for each species in the host.  
```{r} 
hAFDWplot<-master %>%
  filter(!is.na(Host_AFDW.mg.cm2)) %>%
  filter(!is.na(species))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  select(colony_id_corr, species, site_code, timepoint, Host_AFDW.mg.cm2)%>%
  
  ggplot(., aes(x = site_code, y = Host_AFDW.mg.cm2, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Host Biomass (mg AFDW cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); hAFDWplot
```


### Symbiont biomass  

View by site and timepoint for each species in the symbiont  
```{r} 
sAFDWplot<-master %>%
  filter(!is.na(Sym_AFDW.mg.cm2)) %>%
  filter(!is.na(species))%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  select(colony_id_corr, species, site_code, timepoint, Sym_AFDW.mg.cm2)%>%
  
  ggplot(., aes(x = site_code, y = Sym_AFDW.mg.cm2, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Symbiont Biomass (mg AFDW cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); sAFDWplot
```

### S:H Ratio  

Calculate biomass as a ratio of host to symbiont and plot.  

```{r} 
master <- master %>% 
  mutate(Ratio_AFDW.mg.cm2=Sym_AFDW.mg.cm2/(Sym_AFDW.mg.cm2+Host_AFDW.mg.cm2))

ratioAFDWplot<-master %>%
  filter(!is.na(Host_AFDW.mg.cm2)) %>%
  filter(!is.na(species))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  select(colony_id_corr, species, site_code, timepoint, Ratio_AFDW.mg.cm2)%>%
  
  ggplot(., aes(x = site_code, y = Ratio_AFDW.mg.cm2, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Symbiont : Holobiont Biomass"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); ratioAFDWplot
```


Join all plots together.  

```{r}
afdw_figure<-plot_grid(hAFDWplot, sAFDWplot, ratioAFDWplot, labels = c("", "", ""), ncol=3, nrow=1, rel_widths = c(.8, .8, 1), label_size = 20, label_x = 0.1)

ggsave(filename="Figures/Biomass_Figure.pdf", plot=afdw_figure, dpi=300, width=24, height=5, units="in")
```

### Analysis  

Build a mixed model for univariate analysis and examine data distribution.

Host Biomass:  

`hAFDW_model<-lmer(Host_AFDW.mg.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0))` 

```{r}
hAFDW_model<-lmer(Host_AFDW.mg.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0))
qqPlot(residuals(hAFDW_model))
hist(residuals(hAFDW_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`hAFDW_model<-lmer(log(Host_AFDW.mg.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0))` 

```{r}
hAFDW_model<-lmer(log(Host_AFDW.mg.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0))
qqPlot(residuals(hAFDW_model))
hist(residuals(hAFDW_model))
```

Residuals are improved, but we need to revisit this model to improve fit.  

Generate a Type II Anova of model.    

```{r}
anova(hAFDW_model, type="II")
```

Generate model effect plots.  

```{r}
plot(allEffects(hAFDW_model))
```

Symbiont Biomass:  

`sAFDW_model<-lmer(Sym_AFDW.mg.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0))` 

```{r}
sAFDW_model<-lmer(Sym_AFDW.mg.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0))
qqPlot(residuals(sAFDW_model))
hist(residuals(sAFDW_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`sAFDW_model<-lmer(log(Sym_AFDW.mg.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0))` 

```{r}
sAFDW_model<-lmer(log(Sym_AFDW.mg.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0))
qqPlot(residuals(sAFDW_model))
hist(residuals(sAFDW_model))
```

Residuals are improved, but we need to revisit this model to improve fit.  

Generate a Type II Anova of model.    

```{r}
anova(sAFDW_model, type="II")
```

Generate model effect plots.  

```{r}
plot(allEffects(sAFDW_model))
```


S:H Biomass: 

`shAFDW_model<-lmer(Ratio_AFDW.mg.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0))` 

```{r}
shAFDW_model<-lmer(Ratio_AFDW.mg.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0))
qqPlot(residuals(shAFDW_model))
hist(residuals(shAFDW_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`shAFDW_model<-lmer(log(Ratio_AFDW.mg.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0))` 

```{r}
shAFDW_model<-lmer(log(Ratio_AFDW.mg.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0))
qqPlot(residuals(shAFDW_model))
hist(residuals(shAFDW_model))
```

Residuals are improved, but we need to revisit this model to improve fit.  

Generate a Type II Anova of model.    

```{r}
anova(shAFDW_model, type="II")
```

Generate model effect plots.  

```{r}
plot(allEffects(shAFDW_model))
```

## Chlorophyll  

First, calculate chlorophyll as total chlorophyll per surface area (c2 + a) and per cell (c2+a) as a and c2 are highly correlated.  

```{r}
master<-master%>%
  mutate(Total_Chl=chla.ug.mgAFDW+chlc2.ug.mgAFDW)%>%
  mutate(Total_Chl_cell=chla.ug.cell+chlc2.ug.cell)
```

### Plot: Surface area     

View by site and timepoint for each species in Chl a.    
```{r}
chlaplot_cm2<-master %>%
  filter(!is.na(chla.ug.cm2)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, chla.ug.cm2)%>%
  
  ggplot(., aes(x = site_code, y = chla.ug.cm2, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Chlorophyll a (", mu, "g cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); chlaplot_cm2
```

View by site and timepoint for each species in Chl c2.   
```{r}
chlc2plot_cm2<-master %>%
  filter(!is.na(chlc2.ug.cm2)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, chlc2.ug.cm2)%>%
  
  ggplot(., aes(x = site_code, y = chlc2.ug.cm2, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Chlorophyll c2 (", mu, "g cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); chlc2plot_cm2
```

### Plot: Protein    

View by site and timepoint for each species in Chl a.    
```{r}
chlaplot_prot<-master %>%
  filter(!is.na(chla.ug.mgprot)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, chla.ug.mgprot)%>%
  
  ggplot(., aes(x = site_code, y = chla.ug.mgprot, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Chlorophyll a (", mu, "g mg protein"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); chlaplot_prot
```

View by site and timepoint for each species in Chl c2.   
```{r}
chlc2plot_prot<-master %>%
  filter(!is.na(chlc2.ug.mgprot)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, chlc2.ug.mgprot)%>%
  
  ggplot(., aes(x = site_code, y = chlc2.ug.mgprot, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Chlorophyll c2 (", mu, "g mg protein"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); chlc2plot_prot
```

### Plot: Biomass    

View by site and timepoint for each species in Chl a.    
```{r}
chlaplot_afdw<-master %>%
  filter(!is.na(chla.ug.mgAFDW)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, chla.ug.mgAFDW)%>%
  
  ggplot(., aes(x = site_code, y = chla.ug.mgAFDW, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Chlorophyll a (", mu, "g mg afdw"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); chlaplot_afdw
```

View by site and timepoint for each species in Chl c2.   
```{r}
chlc2plot_afdw<-master %>%
  filter(!is.na(chlc2.ug.mgAFDW)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, chlc2.ug.mgAFDW)%>%
  
  ggplot(., aes(x = site_code, y = chlc2.ug.mgAFDW, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Chlorophyll c2 (", mu, "g mg afdw"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); chlc2plot_afdw
```

### Plot: Per cell    

View by site and timepoint for each species in Chl a.    
```{r}
chlaplot_cell<-master %>%
  filter(!is.na(chla.ug.cell)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, chla.ug.cell)%>%
  
  ggplot(., aes(x = site_code, y = chla.ug.cell, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Chlorophyll a (", mu, "g cell"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); chlaplot_cell
```

View by site and timepoint for each species in Chl c2.   
```{r}
chlc2plot_cell<-master %>%
  filter(!is.na(chlc2.ug.cell)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, chlc2.ug.cell)%>%
  
  ggplot(., aes(x = site_code, y = chlc2.ug.cell, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Chlorophyll c2 (", mu, "g cell"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); chlc2plot_cell
```

Join all plots for each normalization together.  

```{r}
chl_figure<-plot_grid(chlaplot_prot, chlaplot_afdw, chlaplot_cell, chlaplot_cm2,chlc2plot_prot, chlc2plot_afdw, chlc2plot_cell, chlc2plot_cm2,  labels = c("", "", ""), ncol=4, nrow=2, rel_widths = c(.8, .8, .8, 1, .8, .8, .8, 1), label_size = 20, label_x = 0.1)

ggsave(filename="Figures/Chlorophyll_Figure.pdf", plot=chl_figure, dpi=300, width=32, height=10, units="in")
```

### Plot: Total chl  

View by site and timepoint for each species for total chl per unit AFDW.     
```{r}
chlplot_total<-master %>%
  filter(!is.na(Total_Chl)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, Total_Chl)%>%
  
  ggplot(., aes(x = site_code, y = Total_Chl, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Total Chlorophyll (", mu, "g mg afdw"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); chlplot_total
```

View by site and timepoint for each species for total chl per cell.     
```{r}
chlplot_total_cell<-master %>%
  filter(!is.na(Total_Chl_cell)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, Total_Chl_cell)%>%
  
  ggplot(., aes(x = site_code, y = Total_Chl_cell, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Total Chlorophyll (", mu, "g cell"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); chlplot_total_cell
```

### Analysis  

Build a mixed model for univariate analysis and examine data distribution.

Chlorophyll a: 

`chla_model<-lmer(chla.ug.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
chla_model<-lmer(chla.ug.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(chla_model))
hist(residuals(chla_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`chla_model<-lmer(log(chla.ug.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
chla_model<-lmer(log(chla.ug.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(chla_model))
hist(residuals(chla_model))
```

Generate a Type II Anova of model.    

```{r}
anova(chla_model, type="II")
```

Generate model effect plots.  

```{r}
plot(allEffects(chla_model))
```


Chlorophyll c2: 

Build a mixed model for univariate analysis and examine data distribution.

`chlc2_model<-lmer(chlc2.ug.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
chlc2_model<-lmer(chlc2.ug.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(chlc2_model))
hist(residuals(chlc2_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`chlc2_model<-lmer(log(chlc2.ug.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
chlc2_model<-lmer(log(chlc2.ug.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(chlc2_model))
hist(residuals(chlc2_model))
```

Return to check outliers in this model.  

Generate a Type II Anova of model.    

```{r}
anova(chlc2_model, type="II")
```

Generate model effect plots.  

```{r}
plot(allEffects(chlc2_model))
```

Total Chlorophyll (a + c2): 

Build a mixed model for univariate analysis and examine data distribution.

`chltotal_model<-lmer(Total_Chl~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
chltotal_model<-lmer(Total_Chl~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(chltotal_model))
hist(residuals(chltotal_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`chltotal_model<-lmer(log(Total_Chl)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
chltotal_model<-lmer(log(Total_Chl)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(chlc2_model))
hist(residuals(chlc2_model))
```

Generate a Type II Anova of model.    

```{r}
anova(chltotal_model, type="II")
```

Generate model effect plots.  

```{r}
plot(allEffects(chltotal_model))
```


Total Chlorophyll per cell (a + c2): 

Build a mixed model for univariate analysis and examine data distribution.

`chltotalcell_model<-lmer(Total_Chl_cell~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
chltotalcell_model<-lmer(Total_Chl_cell~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(chltotalcell_model))
hist(residuals(chltotalcell_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`chltotalcell_model<-lmer(log(Total_Chl_cell)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
chltotalcell_model<-lmer(log(Total_Chl_cell)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(chltotalcell_model))
hist(residuals(chltotalcell_model))
```

Generate a Type II Anova of model.    

```{r}
anova(chltotalcell_model, type="II")
```

Generate model effect plots.  

```{r}
plot(allEffects(chltotalcell_model))
```


## Protein 

### Plot: Surface Area  

View by site and timepoint for each species.    
```{r}
protplot_cm2<-master %>%
  filter(!is.na(prot_mg.cm2)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, prot_mg.cm2)%>%
  
  ggplot(., aes(x = site_code, y = prot_mg.cm2, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Protein (mg cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); protplot_cm2
```

### Plot: AFDW  

View by site and timepoint for each species.    
```{r}
protplot_afdw<-master %>%
  filter(!is.na(prot_mg.mgafdw)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, prot_mg.mgafdw)%>%
  
  ggplot(., aes(x = site_code, y = prot_mg.mgafdw, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Protein (mg mg afdw"^-1, ")"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); protplot_afdw
```

Join all plots for each normalization together.  

```{r}
prot_figure<-plot_grid(protplot_afdw, protplot_cm2, labels = c("", "", ""), ncol=2, nrow=1, rel_widths = c(.8, 1), label_size = 20, label_x = 0.1)

ggsave(filename="Figures/Protein_Figure.pdf", plot=prot_figure, dpi=300, width=16, height=5, units="in")
```

### Analysis  

Build a mixed model for univariate analysis and examine data distribution.

`prot_model<-lmer(prot_ug.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
prot_model<-lmer(prot_ug.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(prot_model))
hist(residuals(prot_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`prot_model<-lmer(log(prot_ug.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
prot_model<-lmer(log(prot_ug.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(prot_model))
hist(residuals(prot_model))
```

Return to check outliers in this model.  

Generate a Type II Anova of model.    

```{r}
anova(prot_model, type="II")
```

Generate model effect plots.  

```{r}
plot(allEffects(prot_model))
```

## PI Curve Parameters   

### Plot: Am  

View by site and timepoint for each species.    
```{r}
am_plot<-master %>%
  filter(!is.na(AQY)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, AQY, Am, Rd)%>%
  
  ggplot(., aes(x = site_code, y = Am, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Am"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); am_plot
```

### Plot: AQY  

View by site and timepoint for each species.    
```{r}
aqy_plot<-master %>%
  filter(!is.na(AQY)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, AQY, Am, Rd)%>%
  
  ggplot(., aes(x = site_code, y = AQY, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("AQY"))))+
    theme_classic() + 
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); aqy_plot
```

### Plot: Rd  

View by site and timepoint for each species.    
```{r}
rd_plot<-master %>%
  filter(!is.na(AQY)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site_code, timepoint, AQY, Am, Rd)%>%
  
  ggplot(., aes(x = site_code, y = Rd, fill = timepoint, group=interaction(site_code,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Respiration"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); rd_plot
```

Join all plots together.  

```{r}
pi_figure<-plot_grid(am_plot, aqy_plot, rd_plot, labels = c("", "", ""), ncol=3, nrow=1, rel_widths = c(.8, .8, 1), label_size = 20, label_x = 0.1)

ggsave(filename="Figures/PI_Figure.pdf", plot=pi_figure, dpi=300, width=22, height=5, units="in")
```

### Analysis of Am   

Build a mixed model for univariate analysis and examine data distribution. 

`am_model<-lmer(Am~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
am_model<-lmer(Am~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(am_model))
hist(residuals(am_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`am_model<-lmer(log(Am)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
am_model<-lmer(log(Am)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(am_model))
hist(residuals(am_model))
```

Generate a Type II Anova of model.    

```{r}
anova(am_model, type="II")
```

Generate model effect plots.  

```{r}
plot(allEffects(am_model))
```

### Analysis of AQY   

Build a mixed model for univariate analysis and examine data distribution. 

`aqy_model<-lmer(AQY~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
aqy_model<-lmer(AQY~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(aqy_model))
hist(residuals(aqy_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`aqy_model<-lmer(log(AQY)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
aqy_model<-lmer(log(AQY)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(aqy_model))
hist(residuals(aqy_model))
```

Generate a Type II Anova of model.    

```{r}
anova(aqy_model, type="II")
```

Generate model effect plots.  

```{r}
plot(allEffects(aqy_model))
```

We have a time point issue here - TP 4 values are much higher than other time points.  

### Analysis of Rd   

Build a mixed model for univariate analysis and examine data distribution. 

`rd_model<-lmer(Rd~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
rd_model<-lmer(Rd~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(rd_model))
hist(residuals(rd_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`rd_model<-lmer(log(Rd)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
rd_model<-lmer(log(Rd)~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(rd_model))
hist(residuals(rd_model))
```

Generate a Type II Anova of model.    

```{r}
anova(rd_model, type="II")
```

Generate model effect plots.  

```{r}
plot(allEffects(rd_model))
```

## Generating univariate response panels  

First, specify symbiont and holobiont responses for plotting in separate panels.  
```{r}
symbiont_responses<-c("cells.mgAFDW", "Sym_AFDW.mg.cm2", "Total_Chl", "Total_Chl_cell", "Am", "AQY") 
holobiont_responses<-c("cre.umol.mgafdw", "Host_AFDW.mg.cm2", "Ratio_AFDW.mg.cm2", "prot_mg.mgafdw", "Rd")
```

Generate a panel of responses for symbiont metrics.  

```{r}
chlplot_total_cell<-chlplot_total_cell+theme(legend.position="bottom")

symbiont_univ<-plot_grid(symbplot_afdw, sAFDWplot, am_plot, aqy_plot, chlplot_total, chlplot_total_cell, ncol=1, nrow=6, rel_widths = c(1,1), align="vh")

ggsave(filename="Figures/Symbiont_Univariate_Panel.pdf", plot=symbiont_univ, dpi=150, width=11, height=30, units="in")
```

Generate a panel of responses for host/holobiont metrics.  

```{r}
rd_plot<-rd_plot+theme(legend.position="bottom")

#holobiont_univ1<-plot_grid(tacplot_afdw, hAFDWplot, ratioAFDWplot, ncol=3, nrow=1, rel_widths = c(1))
#holobiont_univ2<-plot_grid(protplot_afdw, rd_plot, NULL, ncol=3, nrow=1, rel_widths = c(1.2, 1.5, 0.8))
holobiont_univ<-plot_grid(tacplot_afdw, hAFDWplot, ratioAFDWplot, protplot_afdw, rd_plot, ncol=1, nrow=5, rel_widths = c(1, 1), align="vh")

ggsave(filename="Figures/Holobiont_Univariate_Panel.pdf", plot=holobiont_univ, dpi=150, width=10, height=30, units="in")
```

# Correlations  

Generate a correlation matrix to examine relationships between responses of interest. Use normalizations by afdw for all responses.     
 
Generating network plot with corrr package.  
```{r}
master%>%
  select(cre.umol.mgafdw, prot_mg.mgafdw, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chlc2.ug.mgAFDW, chla.ug.mgAFDW, cells.mgAFDW, chla.ug.cell, chlc2.ug.cell, Am, AQY, Rd)%>%
  corrr::correlate(., method="spearman", diagonal=1)%>% #generate correlation matrix
  rearrange(.)%>%
  #shave(.)%>% #remove upper triangle
  network_plot(min_cor=.2)
```

Generating matrix with ggcorrplot for all colonies of all species.    

```{r}
p<-master%>%
  select(species, cre.umol.mgafdw, prot_mg.mgafdw, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chlc2.ug.mgAFDW, chla.ug.mgAFDW, cells.mgAFDW, chla.ug.cell, chlc2.ug.cell, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(prot_mg.mgafdw<1.5)%>%
  ggpairs(., columns=2:14, ggplot2::aes(colour=species)) #try to bold significant stats

#change colors
for(i in 1:p$nrow) {
  for(j in 1:p$ncol){
    p[i,j] <- p[i,j] + 
        scale_fill_manual(values=c("orange", "gray", "purple")) +
        scale_color_manual(values=c("orange", "gray", "purple")) +
        theme_classic()+
        theme(text=element_text(size=14, face="bold"))+
        theme(strip.text.x=element_text(face="bold", size=14))
  }
}

p

ggsave(plot=p, "Figures/Correlation_Matrix.pdf", width=20, height=12, unit="in", dpi=300)
```

Acropora: 
```{r}
p<-master%>%
  filter(species=="Acropora")%>%
  select(site_code, cre.umol.mgafdw, prot_mg.mgafdw, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chlc2.ug.mgAFDW, chla.ug.mgAFDW, cells.mgAFDW, chla.ug.cell, chlc2.ug.cell, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  ggpairs(., columns=2:14, ggplot2::aes(colour=site_code)) 

#change colors
for(i in 1:p$nrow) {
  for(j in 1:p$ncol){
    p[i,j] <- p[i,j] + 
        scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
        scale_color_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
        theme_classic()+
        theme(text=element_text(size=14, face="bold"))+
        theme(strip.text.x=element_text(face="bold", size=14))
  }
}

p

ggsave(plot=p, "Figures/Correlation_Matrix_Acropora.pdf", width=20, height=12, unit="in", dpi=300)
```

Pocillopora
```{r}
p<-master%>%
  filter(species=="Pocillopora")%>%
  select(site_code, cre.umol.mgafdw, prot_mg.mgafdw, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chlc2.ug.mgAFDW, chla.ug.mgAFDW, cells.mgAFDW, chla.ug.cell, chlc2.ug.cell, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  ggpairs(., columns=2:14, ggplot2::aes(colour=site_code)) 

#change colors
for(i in 1:p$nrow) {
  for(j in 1:p$ncol){
    p[i,j] <- p[i,j] + 
        scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
        scale_color_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
        theme_classic()+
        theme(text=element_text(size=14, face="bold"))+
        theme(strip.text.x=element_text(face="bold", size=14))
  }
}

p

ggsave(plot=p, "Figures/Correlation_Matrix_Pocillopora.pdf", width=20, height=12, unit="in", dpi=300)
```

Porites 
```{r}
p<-master%>%
  filter(species=="Porites")%>%
  select(site_code, cre.umol.mgafdw, prot_mg.mgafdw, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chlc2.ug.mgAFDW, chla.ug.mgAFDW, cells.mgAFDW, chla.ug.cell, chlc2.ug.cell, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(prot_mg.mgafdw<1.5)%>%
  ggpairs(., columns=2:14, ggplot2::aes(colour=site_code)) 

#change colors
for(i in 1:p$nrow) {
  for(j in 1:p$ncol){
    p[i,j] <- p[i,j] + 
        scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
        scale_color_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
        theme_classic()+
        theme(text=element_text(size=14, face="bold"))+
        theme(strip.text.x=element_text(face="bold", size=14))
  }
}

p

ggsave(plot=p, "Figures/Correlation_Matrix_Porites.pdf", width=20, height=12, unit="in", dpi=300)
```

# Multivariate analyses  

## All Responses  
### Standard PCA's
#### PCAs: Surface Area normalizers  

#### Combined PCA's   
 
Plot PCA using prcomp to center and scale.     
 
```{r}
pca_data_cm2<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.cm2, chlc2.ug.cm2, prot_mg.cm2, cells.cm2, cre.umol.cm2, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)

pca_data_cm2<-pca_data_cm2[complete.cases(pca_data_cm2), ]

scaled_data_cm2<-prcomp(pca_data_cm2[c(5:15)], scale=TRUE, center=TRUE) 
```

Groupings by species:  
```{r}
pcaSpecies_cm2<-ggplot2::autoplot(scaled_data_cm2, data=pca_data_cm2, frame.colour="species", loadings=FALSE,  colour="species", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("orange", "darkgray", "purple")) +
  scale_fill_manual(values=c("orange", "darkgray", "purple")) + 
  theme_classic()+
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaSpecies_cm2

```

PERMANOVA of the effect of species  
```{r}
# scale data
vegan_cm2 <- scale(pca_data_cm2[ ,5:15])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_cm2 ~ species, data = pca_data_cm2, method='eu')
```


Groupings by timepoint:  
```{r}
pcaTimepoint_cm2<-ggplot2::autoplot(scaled_data_cm2, data=pca_data_cm2, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaTimepoint_cm2
```

PERMANOVA of the effect of timepoint  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_cm2 ~ timepoint, data = pca_data_cm2, method='eu')
```

Groupings by site:  
```{r}
pcaSite_cm2<-ggplot2::autoplot(scaled_data_cm2, data=pca_data_cm2, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaSite_cm2

```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_cm2 ~ site_code, data = pca_data_cm2, method='eu')
```

Generate a plot of all PCA's for surface area normalization.  

```{r}
pcaplots_cm2<-plot_grid(pcaSpecies_cm2, pcaSite_cm2, pcaTimepoint_cm2, labels = c("Species: Surface Area", "Site: Surface Area", "Timepoint: Surface Area"), ncol=3, nrow=1, rel_widths = c(1, 1, 1), label_size = 20, label_x = 0.01)

#ggsave(filename="Figures/All_PCAs_cm2.pdf", plot=pcaplots_cm2, dpi=300, width=24, height=5, units="in")
```  

#### Species-specific PCA's   

Next generate PCA for site and timepoint for each species separately.  

Separate by species.  
```{r}
#porites
por_data_cm2<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.cm2, chlc2.ug.cm2, prot_mg.cm2, cells.cm2, cre.umol.cm2, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Porites")

por_data_cm2<-por_data_cm2[complete.cases(por_data_cm2), ]

scaled_por_cm2<-prcomp(por_data_cm2[c(5:15)], scale=TRUE, center=TRUE) 

#acropora
acr_data_cm2<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.cm2, chlc2.ug.cm2, prot_mg.cm2, cells.cm2, cre.umol.cm2, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Acropora")

acr_data_cm2<-acr_data_cm2[complete.cases(acr_data_cm2), ]

scaled_acr_cm2<-prcomp(acr_data_cm2[c(5:15)], scale=TRUE, center=TRUE) 

#pocillopora
poc_data_cm2<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.cm2, chlc2.ug.cm2, prot_mg.cm2, cells.cm2, cre.umol.cm2, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Pocillopora")

poc_data_cm2<-poc_data_cm2[complete.cases(poc_data_cm2), ]

scaled_poc_cm2<-prcomp(poc_data_cm2[c(5:15)], scale=TRUE, center=TRUE) 
```

#### Porites PCA's   

Groupings by timepoint:  
```{r}
porTimepoint_cm2<-ggplot2::autoplot(scaled_por_cm2, data=por_data_cm2, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.7,0.5)+
  #ylim(-0.7, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));porTimepoint_cm2
```

PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_cm2 <- scale(por_data_cm2[ ,5:15])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_cm2 ~ timepoint, data = por_data_cm2, method='eu')
```

Groupings by site:  
```{r}
porSite_cm2<-ggplot2::autoplot(scaled_por_cm2, data=por_data_cm2, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.7,0.5)+
  #ylim(-0.7, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));porSite_cm2
```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_cm2 ~ site_code, data = por_data_cm2, method='eu')
```

#### Acropora PCA's  
 
Groupings by timepoint:  
```{r}
acrTimepoint_cm2<-ggplot2::autoplot(scaled_acr_cm2, data=acr_data_cm2, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.5,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));acrTimepoint_cm2
```

PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_cm2 <- scale(acr_data_cm2[ ,5:15])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_cm2 ~ timepoint, data = acr_data_cm2, method='eu')
```

Groupings by site:  
```{r}
acrSite_cm2<-ggplot2::autoplot(scaled_acr_cm2, data=acr_data_cm2, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.5,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));acrSite_cm2
```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_cm2 ~ site_code, data = acr_data_cm2, method='eu')
```

#### Pocillopora PCA's  

Groupings by timepoint:   
```{r}
pocTimepoint_cm2<-ggplot2::autoplot(scaled_poc_cm2, data=poc_data_cm2, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.6,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pocTimepoint_cm2
```
 
PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_cm2 <- scale(poc_data_cm2[ ,5:15])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_cm2 ~ timepoint, data = poc_data_cm2, method='eu')
```

Groupings by site:  
```{r}
pocSite_cm2<-ggplot2::autoplot(scaled_poc_cm2, data=poc_data_cm2, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.5,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pocSite_cm2
```

PERMANOVA of the effect of site  
```{r}

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_cm2 ~ site_code, data = poc_data_cm2, method='eu')
```

Generate a plot of all PCA's for all Species    

```{r}
species_plots_cm2<-plot_grid(porSite_cm2, porTimepoint_cm2, acrSite_cm2, acrTimepoint_cm2, pocSite_cm2, pocTimepoint_cm2, labels = c("Porites: Surface Area", "Porites: Surface Area", "Acropora: Surface Area", "Acropora: Surface Area", "Pocillopora: Surface Area", "Pocillopora: Surface Area"), ncol=2, nrow=3, rel_widths = c(1, 1, 1, 1, 1, 1), label_size = 20, label_x = 0.01, label_y=1.0)

#ggsave(filename="Figures/Species_PCAs_cm2.pdf", plot=species_plots_cm2, dpi=300, width=18, height=15, units="in")
``` 




#### PCAs: Protein normalizers  

#### Combined PCA's  

Plot PCA using prcomp to center and scale.    
 
```{r}
pca_data_prot<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgprot, chlc2.ug.mgprot, prot_mg.cm2, cells.mgprot, cre.umol.mgprot, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)

pca_data_prot<-pca_data_prot[complete.cases(pca_data_prot), ]

scaled_data_prot<-prcomp(pca_data_prot[c(5:15)], scale=TRUE, center=TRUE) 
```

Groupings by species:  
```{r}
pcaSpecies_prot<-ggplot2::autoplot(scaled_data_prot, data=pca_data_prot, frame.colour="species", loadings=FALSE,  colour="species", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("orange", "darkgray", "purple")) +
  scale_fill_manual(values=c("orange", "darkgray", "purple")) + 
  theme_classic()+
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaSpecies_prot

```

PERMANOVA of the effect of species  
```{r}
# scale data
vegan_prot <- scale(pca_data_prot[ ,5:15])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_prot ~ species, data = pca_data_prot, method='eu')
```


Groupings by timepoint:  
```{r}
pcaTimepoint_prot<-ggplot2::autoplot(scaled_data_prot, data=pca_data_prot, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaTimepoint_prot
```

PERMANOVA of the effect of timepoint  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_prot ~ timepoint, data = pca_data_prot, method='eu')
```

Groupings by site:  
```{r}
pcaSite_prot<-ggplot2::autoplot(scaled_data_prot, data=pca_data_prot, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaSite_prot

```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_prot ~ site_code, data = pca_data_prot, method='eu')
```

Generate a plot of all PCA's for protein normalization.  

```{r}
pcaplots_prot<-plot_grid(pcaSpecies_prot, pcaSite_prot, pcaTimepoint_prot, labels = c("Species: Protein", "Site: Protein", "Timepoint: Protein"), ncol=3, nrow=1, rel_widths = c(1, 1, 1), label_size = 20, label_x = 0.02)

#ggsave(filename="Figures/All_PCAs_prot.pdf", plot=pcaplots_prot, dpi=300, width=24, height=5, units="in")
```  

#### Species-specific PCA's   

Next generate PCA for site and timepoint for each species separately.  

Separate by species.  
```{r}
#porites
por_data_prot<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgprot, chlc2.ug.mgprot, prot_mg.cm2, cells.mgprot, cre.umol.mgprot, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Porites")

por_data_prot<-por_data_prot[complete.cases(por_data_prot), ]

scaled_por_prot<-prcomp(por_data_prot[c(5:15)], scale=TRUE, center=TRUE) 

#acropora
acr_data_prot<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgprot, chlc2.ug.mgprot, prot_mg.cm2, cells.mgprot, cre.umol.mgprot, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Acropora")

acr_data_prot<-acr_data_prot[complete.cases(acr_data_prot), ]

scaled_acr_prot<-prcomp(acr_data_prot[c(5:15)], scale=TRUE, center=TRUE) 

#pocillopora
poc_data_prot<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgprot, chlc2.ug.mgprot, prot_mg.cm2, cells.mgprot, cre.umol.mgprot, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Pocillopora")

poc_data_prot<-poc_data_prot[complete.cases(poc_data_prot), ]

scaled_poc_prot<-prcomp(poc_data_prot[c(5:15)], scale=TRUE, center=TRUE) 
```

#### Porites PCA's   

Groupings by timepoint:  
```{r}
porTimepoint_prot<-ggplot2::autoplot(scaled_por_prot, data=por_data_prot, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.7,0.5)+
  #ylim(-0.7, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));porTimepoint_prot
```

PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_prot <- scale(por_data_prot[ ,5:15])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_prot ~ timepoint, data = por_data_prot, method='eu')
```

Groupings by site:  
```{r}
porSite_prot<-ggplot2::autoplot(scaled_por_prot, data=por_data_prot, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.7,0.5)+
  #ylim(-0.7, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));porSite_prot
```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_prot ~ site_code, data = por_data_prot, method='eu')
```

#### Acropora PCA's  
 
Groupings by timepoint:  
```{r}
acrTimepoint_prot<-ggplot2::autoplot(scaled_acr_prot, data=acr_data_prot, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.5,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));acrTimepoint_prot
```

PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_prot <- scale(acr_data_prot[ ,5:15])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_prot ~ timepoint, data = acr_data_prot, method='eu')
```

Groupings by site:  
```{r}
acrSite_prot<-ggplot2::autoplot(scaled_acr_prot, data=acr_data_prot, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.5,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));acrSite_prot
```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_prot ~ site_code, data = acr_data_prot, method='eu')
```

#### Pocillopora PCA's  
 
Groupings by timepoint:   
```{r}
pocTimepoint_prot<-ggplot2::autoplot(scaled_poc_prot, data=poc_data_prot, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.6,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pocTimepoint_prot
```
 
PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_prot <- scale(poc_data_prot[ ,5:15])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_prot ~ timepoint, data = poc_data_prot, method='eu')
```

Groupings by site:  
```{r}
pocSite_prot<-ggplot2::autoplot(scaled_poc_prot, data=poc_data_prot, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.5,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pocSite_prot
```

PERMANOVA of the effect of site  
```{r}

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_prot ~ site_code, data = poc_data_prot, method='eu')
```

Generate a plot of all PCA's for all Species    

```{r}
species_plots_prot<-plot_grid(porSite_prot, porTimepoint_prot, acrSite_prot, acrTimepoint_prot, pocSite_prot, pocTimepoint_prot, labels = c("Porites: Protein", "Porites: Protein", "Acropora: Protein", "Acropora: Protein", "Pocillopora: Protein", "Pocillopora: Protein"), ncol=2, nrow=3, rel_widths = c(1, 1, 1, 1, 1, 1), label_size = 20, label_x = 0.01, label_y=1.0)

#ggsave(filename="Figures/Species_PCAs_prot.pdf", plot=species_plots_prot, dpi=300, width=18, height=15, units="in")
``` 





#### PCAs: Biomass normalizers  

#### Combined PCA's  

Plot PCA using prcomp to center and scale.    
  
```{r}
pca_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(prot_mg.mgafdw<1.5) #remove outliers


pca_data_afdw<-pca_data_afdw[complete.cases(pca_data_afdw), ]

scaled_data_afdw<-prcomp(pca_data_afdw[c(5:15)], scale=TRUE, center=TRUE) 
```

```{r}
# scale data
vegan <- scale(pca_data_afdw[ ,5:15])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis(vegan ~ species, data = pca_data_afdw, method='eu')
z_species<-permanova$aov.tab
z_species
``` 
 
Groupings by species:  
```{r}
pcaSpecies_afdw<-ggplot2::autoplot(scaled_data_afdw, data=pca_data_afdw, frame.colour="species", loadings=FALSE,  colour="species", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm', alpha=0.5) + 
  scale_colour_manual(values=c("darkgray", "orange", "purple")) +
  scale_fill_manual(values=c("darkgray", "orange", "purple")) + 
  theme_classic()+
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
  #geom_text(x=0.3, y=-0.15, label=paste("p(Species)=", z_species$`Pr(>F)`[1]), size=6, color="black") + 
  xlab("PC1")+
  ylab("PC2")+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_blank(), 
        axis.text = element_text(size=18, color="black"), 
        axis.title = element_text(size=18, color="black"));pcaSpecies_afdw

ggsave(filename="Figures/Species_Overall_PCA.pdf", plot=pcaSpecies_afdw, dpi=300, width=7, height=5, units="in")
```

PERMANOVA of the effect of species  
```{r}
# scale data
vegan_afdw <- scale(pca_data_afdw[ ,5:15])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_afdw ~ species, data = pca_data_afdw, method='eu')
```
 

Groupings by timepoint:  
```{r}
pcaTimepoint_afdw<-ggplot2::autoplot(scaled_data_afdw, data=pca_data_afdw, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaTimepoint_afdw
```

PERMANOVA of the effect of timepoint  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_afdw ~ timepoint, data = pca_data_afdw, method='eu')
```

Groupings by site:  
```{r}
pcaSite_afdw<-ggplot2::autoplot(scaled_data_afdw, data=pca_data_afdw, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.3,0.5)+
  #ylim(-0.3, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaSite_afdw

```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_afdw ~ site_code, data = pca_data_afdw, method='eu')
```

Generate a plot of all PCA's for afdw normalization.  

```{r}
pcaplots_afdw<-plot_grid(pcaSpecies_afdw, pcaSite_afdw, pcaTimepoint_afdw, labels = c("Species: Biomass", "Site: Biomass", "Timepoint: Biomass"), ncol=3, nrow=1, rel_widths = c(1, 1, 1), label_size = 20, label_x = 0.02)

#ggsave(filename="Figures/All_PCAs_afdw.pdf", plot=pcaplots_afdw, dpi=300, width=24, height=5, units="in")
```  

#### Species-specific PCA's   

Next generate PCA for site and timepoint for each species separately.  
 
Separate by species.  
```{r}
#porites
por_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Porites")

por_data_afdw<-por_data_afdw[complete.cases(por_data_afdw), ]

scaled_por_afdw<-prcomp(por_data_afdw[c(5:15)], scale=TRUE, center=TRUE) 

#acropora
acr_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Acropora")

acr_data_afdw<-acr_data_afdw[complete.cases(acr_data_afdw), ]

scaled_acr_afdw<-prcomp(acr_data_afdw[c(5:15)], scale=TRUE, center=TRUE) 

#pocillopora
poc_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Pocillopora")

poc_data_afdw<-poc_data_afdw[complete.cases(poc_data_afdw), ]

scaled_poc_afdw<-prcomp(poc_data_afdw[c(5:15)], scale=TRUE, center=TRUE) 
```

#### Porites PCA's   

Groupings by timepoint:  
```{r}
porTimepoint_afdw<-ggplot2::autoplot(scaled_por_afdw, data=por_data_afdw, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.7,0.5)+
  #ylim(-0.7, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));porTimepoint_afdw
```

PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_afdw <- scale(por_data_afdw[ ,5:15])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_afdw ~ timepoint, data = por_data_afdw, method='eu')
```

Groupings by site:  
```{r}
porSite_afdw<-ggplot2::autoplot(scaled_por_afdw, data=por_data_afdw, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
 # xlim(-0.7,0.5)+
 # ylim(-0.7, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));porSite_afdw
```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_afdw ~ site_code, data = por_data_afdw, method='eu')
```

#### Acropora PCA's  
 
Groupings by timepoint:  
```{r}
acrTimepoint_afdw<-ggplot2::autoplot(scaled_acr_afdw, data=acr_data_afdw, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
  #xlim(-0.5,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));acrTimepoint_afdw
```

PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_afdw <- scale(acr_data_afdw[ ,5:15])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_afdw ~ timepoint, data = acr_data_afdw, method='eu')
```

Groupings by site:  
```{r}
acrSite_afdw<-ggplot2::autoplot(scaled_acr_afdw, data=acr_data_afdw, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.5,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));acrSite_afdw
```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_afdw ~ site_code, data = acr_data_afdw, method='eu')
```

#### Pocillopora PCA's  

Groupings by timepoint:   
```{r}
pocTimepoint_afdw<-ggplot2::autoplot(scaled_poc_afdw, data=poc_data_afdw, frame.colour="timepoint", loadings=FALSE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred", "black"), labels=c("Jan2020", "March2020", "Sept2020", "Nov2020")) + 
  theme_classic()+
 # xlim(-0.6,0.5)+
  #ylim(-0.5, 0.8)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pocTimepoint_afdw
```
 
PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan_afdw <- scale(poc_data_afdw[ ,5:15])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_afdw ~ timepoint, data = poc_data_afdw, method='eu')
```

Groupings by site:  
```{r}
pocSite_afdw<-ggplot2::autoplot(scaled_poc_afdw, data=poc_data_afdw, frame.colour="site_code", loadings=FALSE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=FALSE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5, frame.type = 'norm') + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  #xlim(-0.5,0.5)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pocSite_afdw
```

PERMANOVA of the effect of site  
```{r}

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan_afdw ~ site_code, data = poc_data_afdw, method='eu')
```

Generate a plot of all PCA's for all Species    

```{r}
species_plots_afdw<-plot_grid(porSite_afdw, porTimepoint_afdw, acrSite_afdw, acrTimepoint_afdw, pocSite_afdw, pocTimepoint_afdw, labels = c("Porites: Biomass", "Porites: Biomass", "Acropora: Biomass", "Acropora: Biomass", "Pocillopora: Biomass", "Pocillopora: Biomass"), ncol=2, nrow=3, rel_widths = c(1, 1, 1, 1, 1, 1), label_size = 20, label_x = 0.01, label_y=1.0)

#ggsave(filename="Figures/Species_PCAs_afdw.pdf", plot=species_plots_afdw, dpi=300, width=18, height=15, units="in")
``` 



#### Assemble all PCA plots  

Generate plot of all combined PCA's

```{r}
All_PCAs<-plot_grid(pcaSpecies_prot, pcaSite_prot, pcaTimepoint_prot, pcaSpecies_afdw, pcaSite_afdw, pcaTimepoint_afdw, pcaSpecies_cm2, pcaSite_cm2, pcaTimepoint_cm2, labels = c("Protein", "Protein", "Protein", "Biomass", "Biomass", "Biomass","Surface Area", "Surface Area", "Surface Area"), ncol=3, nrow=3, rel_widths = c(1, 1, 1, 1, 1, 1, 1, 1, 1), label_size = 20, label_x = 0.06, label_y=1.0)

ggsave(filename="Figures/All_PCAs.pdf", plot=All_PCAs, dpi=300, width=24, height=15, units="in")
``` 

Generate plot of all species specific PCA's

```{r}
All_PCAs_species<-plot_grid(porSite_prot, porTimepoint_prot, porSite_afdw, porTimepoint_afdw, porSite_cm2, porTimepoint_cm2, 
                    acrSite_prot, acrTimepoint_prot, acrSite_afdw, acrTimepoint_afdw, acrSite_cm2, acrTimepoint_cm2,
                    pocSite_prot, pocTimepoint_prot, pocSite_afdw, pocTimepoint_afdw, pocSite_cm2, pocTimepoint_cm2,
                    labels = c("Porites: Protein", "Porites: Protein", "Porites: Biomass", "Porites: Biomass", "Porites: SA", "Porites: SA",
                               "Acropora: Protein", "Acropora: Protein", "Acropora: Biomass", "Acropora: Biomass", "Acropora: SA", "Acropora: SA",
                               "Pocillopora: Protein", "Pocillopora: Protein", "Pocillopora: Biomass", "Pocillopora: Biomass", "Pocillopora: SA", "Pocillopora: SA"), ncol=6, nrow=3, rel_widths = c(1), label_size = 20, label_x = 0.06, label_y=1.0)

ggsave(filename="Figures/All_Species_PCAs.pdf", plot=All_PCAs_species, dpi=300, width=48, height=15, units="in")
``` 


### PCA's for centroid and trajectories  

#### Acropora  

Generate PCA using scaled (scaled_acr_afdw) from dataframe (acr_data_afdw).   
 
```{r}
acr_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Acropora")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Chl_a=chla.ug.mgAFDW, Chl_c2=chlc2.ug.mgAFDW, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw)

acr_data_afdw<-acr_data_afdw[complete.cases(acr_data_afdw), ]

scaled_acr_afdw<-prcomp(acr_data_afdw[c(5:15)], scale=TRUE, center=TRUE) 

acr_info<-acr_data_afdw[c(2,4)]

acr_data<-scaled_acr_afdw%>%
  augment(acr_info)%>%
  group_by(timepoint, site_code)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

acr.centroids<-acr_data %>% 
  select(timepoint, site_code, PC1.mean, PC2.mean)%>%
  group_by(timepoint, site_code)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
```

Examine PERMANOVA results.  
 
```{r}
# scale data
vegan <- scale(acr_data_afdw[ ,5:12])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis(vegan ~ timepoint*site_code, data = acr_data_afdw, method='eu')
z_acr<-permanova$aov.tab
z_acr
``` 
 
Assemble plot with background points 
```{r}
#1. make plot with dots
acrPCA<-ggplot(acr_data, aes(.fittedPC1, .fittedPC2, color=site_code)) + 
  geom_point(size = 4, alpha=0.2, show.legend=FALSE)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  ylim(-6,10)+
  xlim(-5,10)+
  ylab("PC2")+
  xlab("PC1")+
  ggtitle(expression(italic("Acropora")))+
  geom_text(x=7, y=-2.5, label=paste("p(Timepoint)=", z_acr$`Pr(>F)`[1]), size=4, color=ifelse(z_acr$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  geom_text(x=7, y=-3.25, label=paste("p(Site)=", z_acr$`Pr(>F)`[2]), size=4, color=ifelse(z_acr$`Pr(>F)`[2] < 0.05, "black", "darkgray")) + 
  geom_text(x=7, y=-4, label=paste("p(Timepoint x Site)=", z_acr$`Pr(>F)`[3]), size=4, color=ifelse(z_acr$`Pr(>F)`[3] < 0.05, "black", "darkgray")) + 
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         title = element_text(size=25, face="bold"), 
         axis.title = element_text(size=18));acrPCA

```

Add centroids  

```{r}
#2. add centroids 
acrPCAcen<-acrPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site_code), data=acr.centroids, size=3, show.legend=FALSE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="none"); acrPCAcen

```

Add segments

```{r}
#3. add segments
segpoints<-acr.centroids%>%
  gather(variable, value, -(timepoint:site_code)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
acrPCAfull<-acrPCAcen + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = site_code), data = segpoints, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); acrPCAfull
```

Add bi plot with loadings  
```{r}
#1. make plot with dots
acrArrows<-ggplot2::autoplot(scaled_acr_afdw, data=acr_data_afdw, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=3.5, loadings.label.vjust=0.5, loadings.label.hjust=-0.1, loadings.label.repel=FALSE, size=4, alpha=0.0) + 
  #scale_colour_manual(values=c("blue4", "darkgray", "springgreen4")) +
  #scale_fill_manual(values=c("blue4", "darkgray", "springgreen4")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_blank(),
         axis.text.y=element_blank(),
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         title = element_text(size=25, face="bold"),
         axis.title = element_blank());acrArrows
```


Asemble final figure with inset biplot.  
```{r}
#acrFullPCA<-ggdraw(acrPCAfull) + #theme_half_open(12)) +
  #draw_plot(acrArrows, .5, .5, .5, .5); acrFullPCA #x, y, w, h

#ggsave(filename="Figures/FullPCA_Acropora.pdf", plot=acrFullPCA, dpi=300, width=12, height=8, units="in")
```

##### Calculate plasticity using centroid travel calculations.  

1 - calculate sd of mean distance between all points and the centroid of all points (spread)

```{r}

#calculate mean centroid location
mean.centroid.acr <- acr.centroids%>%
  select(PC1.mean, PC2.mean)%>%
  summarise(x.mean = mean(PC1.mean), 
         y.mean = mean(PC2.mean))%>%
  summarise(x.mean = mean(x.mean), 
         y.mean = mean(y.mean))

#calculate average standard deviation of mean distance between mean centroid and location of each point using formula for distance between two points
spread.acr<-acr_data%>%
  mutate(distance=sqrt((PC1.mean-mean.centroid.acr[1])^2+(PC2.mean-mean.centroid.acr[2])^2))%>%
  summarise(distance=mean(distance$x.mean))%>% #summarize across groups
  summarise(distance=sd(distance))%>% #calculate the sd of distances
  summarise(distance=mean(distance)) #summarize across groups

#spread<-acr_data[c(12,13)]
#spread<-as.matrix(dist(spread, mean.centroid, method="euclidean"))
#spread<-mean(spread)
spread.acr$distance
```


2 - calculate distance between each time point centroids for each site (distance) 

```{r}
distance.acr<-acr.centroids%>%
  arrange(site_code)%>%
  gather(variable, value, -(timepoint:site_code)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)%>%
  group_by(site_code)%>%
  mutate(tp1.2=sqrt((timepoint1_PC1.mean-timepoint2_PC1.mean)^2+(timepoint1_PC2.mean-timepoint2_PC2.mean)^2), #calculate distance between tp1 and tp2 centroids, do for each pair of time points
         tp2.3=sqrt((timepoint2_PC1.mean-timepoint3_PC1.mean)^2+(timepoint2_PC2.mean-timepoint3_PC2.mean)^2),
         tp3.4=sqrt((timepoint3_PC1.mean-timepoint4_PC1.mean)^2+(timepoint3_PC2.mean-timepoint4_PC2.mean)^2))
```

3 - divide distance by spread, generating a plasticity ratio for each site, higher ratio = more plasticity

```{r}
plasticity.acr<-distance.acr%>%
  select(site_code, tp1.2, tp2.3, tp3.4)%>% #keep desired columns
  gather(key="comparison", value="distance_time", -site_code)%>% #gather and generate new rows to designate time comparisons
  mutate(ratio=distance_time/spread.acr$distance)
plasticity.acr
```

4 - average these ratios across sites to generate a mean plasticity ratio for time, site, and species

Display mean plasticity scores by site:  
```{r}
acr.plasticity.site<-plasticity.acr%>%
  group_by(site_code)%>%
  summarise(mean_site=mean(ratio))%>%
  mutate(species="Acropora")
acr.plasticity.site
```

Display mean plasticity scores by timepoint comparison: 
```{r}
plasticity.acr.time<-plasticity.acr%>%
  group_by(comparison)%>%
  summarise(mean_timepoint=mean(ratio))%>%
  mutate(species="Acropora")
plasticity.acr.time
```

Display mean plasticity score for the species:  
```{r}
plasticity.acr.species<-plasticity.acr%>%
  summarise(mean_species=mean(ratio))%>%
  summarise(mean_species=mean(mean_species))%>%
  mutate(species="Acropora")
plasticity.acr.species
```


#### Porites

Generate PCA using scaled (scaled_por_afdw) from dataframe (por_data_afdw).   
 
Calculate centroid locations for each site and timepoint and pull PC1 and PC2 locations.     
 
```{r}
por_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Porites")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Chl_a=chla.ug.mgAFDW, Chl_c2=chlc2.ug.mgAFDW, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw)

por_data_afdw<-por_data_afdw[complete.cases(por_data_afdw), ]

scaled_por_afdw<-prcomp(por_data_afdw[c(5:15)], scale=TRUE, center=TRUE) 

por_info<-por_data_afdw[c(2,4)]

por_data<-scaled_por_afdw%>%
  augment(por_info)%>%
  group_by(timepoint, site_code)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

por.centroids<-por_data %>% 
  select(timepoint, site_code, PC1.mean, PC2.mean)%>%
  group_by(timepoint, site_code)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
```

```{r}
# scale data
vegan <- scale(por_data_afdw[ ,5:12])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis(vegan ~ timepoint*site_code, data = por_data_afdw, method='eu')
z_por<-permanova$aov.tab
z_por
```

Assemble plot with background points
```{r}
#1. make plot with dots
porPCA<-ggplot(por_data, aes(.fittedPC1, .fittedPC2, color=site_code)) + 
  geom_point(size = 4, alpha=0.2, show.legend=FALSE)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  ylab("PC2")+
  xlab("PC1")+
  ylim(-6,10)+
  xlim(-5,10)+
  ggtitle(expression(italic("Porites")))+
  geom_text(x=7, y=-2.5, label=paste("p(Timepoint)=", z_por$`Pr(>F)`[1]), size=4, color=ifelse(z_por$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  geom_text(x=7, y=-3.25, label=paste("p(Site)=", z_por$`Pr(>F)`[2]), size=4, color=ifelse(z_por$`Pr(>F)`[2] < 0.05, "black", "darkgray")) + 
  geom_text(x=7, y=-4, label=paste("p(Timepoint x Site)=", z_por$`Pr(>F)`[3]), size=4, color=ifelse(z_por$`Pr(>F)`[3] < 0.05, "black", "darkgray")) + 
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         legend.title = element_blank(), 
         axis.text = element_text(size=18), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         title = element_text(size=25, face="bold"),
         axis.title = element_text(size=18,  face="bold"));porPCA
```

Add centroids  

```{r}
#2. add centroids 
porPCAcen<-porPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site_code), data=por.centroids, size=3, show.legend=FALSE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position=c(1,0.3)); porPCAcen

#build a plot for the legend
legend_plot<-porPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site_code), data=por.centroids, size=3, show.legend=TRUE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="bottom")

# extract the legend from one of the plots
legend <- get_legend(
  # create some space to the left of the legend
  legend_plot + theme(legend.box.margin = margin(1,1,1,1))
)

```

Add segments

```{r}
#3. add segments
segpoints<-por.centroids%>%
  gather(variable, value, -(timepoint:site_code)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
porPCAfull<-porPCAcen + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = site_code), data = segpoints, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); porPCAfull
```

Add bi plot with loadings  
```{r}
#1. make plot with dots
porArrows<-ggplot2::autoplot(scaled_por_afdw, data=por_data_afdw, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=3.5, loadings.label.vjust=-0.1, loadings.label.hjust=0.1, loadings.label.repel=FALSE, size=4, alpha=0.0) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-0.5,0.1)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_blank(),
         axis.text.y=element_blank(),
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_blank());porArrows
```
 

Assemble final figure with inset biplot.  
```{r}
#porFullPCA<-ggdraw(porPCAfull)+ #+ theme_half_open(12)) +
  #draw_plot(porArrows, .5, .5, .5, .5); porFullPCA #x, y, w, h

#ggsave(filename="Figures/FullPCA_Porites.pdf", plot=porFullPCA, dpi=300, width=12, height=8, units="in")
```
 
##### Calculate plasticity using centroid travel calculations.  

1 - calculate mean distance between all points and the centroid of all points (spread)   

```{r}
#calculate mean centroid location
mean.centroid.por <- por.centroids%>%
  select(PC1.mean, PC2.mean)%>%
  summarise(x.mean = mean(PC1.mean), 
         y.mean = mean(PC2.mean))%>%
  summarise(x.mean = mean(x.mean), 
         y.mean = mean(y.mean))

#calculate average standard deviation of mean distance between mean centroid and location of each point using formula for distance between two points
spread.por<-por_data%>%
  mutate(distance=sqrt((PC1.mean-mean.centroid.por[1])^2+(PC2.mean-mean.centroid.por[2])^2))%>%
  summarise(distance=mean(distance$x.mean))%>% #summarize across groups
  summarise(distance=sd(distance))%>% #summarize across groups
  summarise(distance=mean(distance)) #summarize across groups

#spread<-acr_data[c(12,13)]
#spread<-as.matrix(dist(spread, mean.centroid, method="euclidean"))
#spread<-mean(spread)
spread.por
```


2 - calculate distance between each time point centroids for each site (distance) 

```{r}
distance.por<-por.centroids%>%
  arrange(site_code)%>%
  gather(variable, value, -(timepoint:site_code)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)%>%
  group_by(site_code)%>%
  mutate(tp1.2=sqrt((timepoint1_PC1.mean-timepoint2_PC1.mean)^2+(timepoint1_PC2.mean-timepoint2_PC2.mean)^2), #calculate distance between tp1 and tp2 centroids, do for each pair of time points
         tp2.3=sqrt((timepoint2_PC1.mean-timepoint3_PC1.mean)^2+(timepoint2_PC2.mean-timepoint3_PC2.mean)^2),
         tp3.4=sqrt((timepoint3_PC1.mean-timepoint4_PC1.mean)^2+(timepoint3_PC2.mean-timepoint4_PC2.mean)^2))
```

3 - divide distance by spread, generating a plasticity ratio for each site, higher ratio = more plasticity

```{r}
plasticity.por<-distance.por%>%
  select(site_code, tp1.2, tp2.3, tp3.4)%>% #keep desired columns
  gather(key="comparison", value="distance_time", -site_code)%>% #gather and generate new rows to designate time comparisons
  mutate(ratio=distance_time/spread.por$distance)
plasticity.por
```

4 - average these ratios across sites to generate a mean plasticity ratio for time, site, and species

Display mean plasticity scores by site:  
```{r}
por.plasticity.site<-plasticity.por%>%
  group_by(site_code)%>%
  summarise(mean_site=mean(ratio))%>%
  mutate(species="Porites")
por.plasticity.site
```

Display mean plasticity scores by timepoint comparison: 
```{r}
plasticity.por.time<-plasticity.por%>%
  group_by(comparison)%>%
  summarise(mean_timepoint=mean(ratio))%>%
  mutate(species="Porites")
plasticity.por.time
```

Display mean plasticity score for the species:  
```{r}
plasticity.por.species<-plasticity.por%>%
  summarise(mean_species=mean(ratio))%>%
  summarise(mean_species=mean(mean_species))%>%
  mutate(species="Porites")
plasticity.por.species
```


#### Pocillopora   

Generate PCA using scaled (scaled_poc_afdw) from dataframe (poc_data_afdw). 
 
```{r}
poc_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Pocillopora")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Chl_a=chla.ug.mgAFDW, Chl_c2=chlc2.ug.mgAFDW, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw)

poc_data_afdw<-poc_data_afdw[complete.cases(poc_data_afdw), ]
 
scaled_poc_afdw<-prcomp(poc_data_afdw[c(5:15)], scale=TRUE, center=TRUE) 

poc_info<-poc_data_afdw[c(2,4)]

poc_data<-scaled_poc_afdw%>%
  augment(poc_info)%>%
  group_by(timepoint, site_code)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

poc.centroids<-poc_data %>% 
  select(timepoint, site_code, PC1.mean, PC2.mean)%>%
  group_by(timepoint, site_code)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
``` 
  
```{r}
# scale data
vegan <- scale(poc_data_afdw[ ,5:12])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis(vegan ~ timepoint*site_code, data = poc_data_afdw, method='eu')
z_poc<-permanova$aov.tab
z_poc
```

Assemble plot with background points
```{r}
#1. make plot with dots
pocPCA<-ggplot(poc_data, aes(.fittedPC1, .fittedPC2, color=site_code)) + 
  geom_point(size = 4, alpha=0.2, show.legend=FALSE)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  ylim(-6,10)+
  xlim(-5,10)+
  ylab("PC2")+
  xlab("PC1")+
  ggtitle(expression(italic("Pocillopora")))+
  geom_text(x=7, y=-2.5, label=paste("p(Timepoint)=", z_poc$`Pr(>F)`[1]), size=4, color=ifelse(z_poc$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  geom_text(x=7, y=-3.25, label=paste("p(Site)=", z_poc$`Pr(>F)`[2]), size=4, color=ifelse(z_poc$`Pr(>F)`[2] < 0.05, "black", "darkgray")) + 
  geom_text(x=7, y=-4, label=paste("p(Timepoint x Site)=", z_poc$`Pr(>F)`[3]), size=4, color=ifelse(z_poc$`Pr(>F)`[3] < 0.05, "black", "darkgray")) + 
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         plot.margin = margin(1, 1, 1, 1, "cm"),
         legend.title = element_blank(), 
         title = element_text(size=25, face="bold"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18,  face="bold"));pocPCA

```

Add centroids  

```{r}
#2. add centroids 
pocPCAcen<-pocPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site_code), data=poc.centroids, size=3, show.legend=FALSE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="none"); pocPCAcen

```

Add segments

```{r}
#3. add segments
segpoints<-poc.centroids%>%
  gather(variable, value, -(timepoint:site_code)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
pocPCAfull<-pocPCAcen + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = site_code), data = segpoints, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); pocPCAfull
```

Add bi plot with loadings  
```{r}

pocArrows<-ggplot2::autoplot(scaled_poc_afdw, data=poc_data_afdw, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=3.5, loadings.label.vjust=0, loadings.label.hjust=-0.1, laodings.label.repel=FALSE, size=4, alpha=0.0) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_blank(),
         axis.text.y=element_blank(),
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_blank());pocArrows
```

 
Assemble final figure with inset biplot.  
```{r}
#pocFullPCA<-ggdraw(pocPCAfull) + #theme_half_open(12)) +
  #draw_plot(pocArrows, .5, .5, .5, .5); pocFullPCA #x, y, w, h

#ggsave(filename="Figures/FullPCA_Pocillopora.pdf", plot=pocFullPCA, dpi=300, width=12, height=8, units="in")
```
 
Assemble all plots.  

```{r}
PCA_full_panel<-plot_grid(acrPCAfull, pocPCAfull, porPCAfull, labels = c("", "", ""), ncol=3, nrow=1, rel_heights= c(1,1,1), rel_widths = c(1,1,1), label_size = 20, label_y=1, align="vh")

# add the legend to the row we made earlier. Give it one-third of 
# the width of one plot (via rel_widths).
PCA_full_panel_legend<-plot_grid(PCA_full_panel, legend, rel_heights = c(4, .2), ncol=1, nrow=2)

ggsave(filename="Figures/Full_Panel_PCAs.png", plot=PCA_full_panel_legend, dpi=500, width=20, height=6, units="in")
```  

##### Calculate plasticity using centroid travel calculations.  

1 - calculate mean distance between all points and the centroid of all points (spread)

```{r}
#calculate mean centroid location
mean.centroid.poc <- poc.centroids%>%
  select(PC1.mean, PC2.mean)%>%
  summarise(x.mean = mean(PC1.mean), 
         y.mean = mean(PC2.mean))%>%
  summarise(x.mean = mean(x.mean), 
         y.mean = mean(y.mean))

#calculate average distance between mean centroid and location of each point using formula for distance between two points
spread.poc<-poc_data%>%
  mutate(distance=sqrt((PC1.mean-mean.centroid.poc[1])^2+(PC2.mean-mean.centroid.poc[2])^2))%>%
  summarise(distance=mean(distance$x.mean))%>% #summarize across groups
  summarise(distance=sd(distance))%>% #summarize across groups
  summarise(distance=mean(distance)) #summarize across groups

#spread<-acr_data[c(12,13)]
#spread<-as.matrix(dist(spread, mean.centroid, method="euclidean"))
#spread<-mean(spread)
spread.poc
```

 
2 - calculate distance between each time point centroids for each site (distance) 

```{r}
distance.poc<-poc.centroids%>%
  arrange(site_code)%>%
  gather(variable, value, -(timepoint:site_code)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)%>%
  group_by(site_code)%>%
  mutate(tp1.2=sqrt((timepoint1_PC1.mean-timepoint2_PC1.mean)^2+(timepoint1_PC2.mean-timepoint2_PC2.mean)^2), #calculate distance between tp1 and tp2 centroids, do for each pair of time points
         tp2.3=sqrt((timepoint2_PC1.mean-timepoint3_PC1.mean)^2+(timepoint2_PC2.mean-timepoint3_PC2.mean)^2),
         tp3.4=sqrt((timepoint3_PC1.mean-timepoint4_PC1.mean)^2+(timepoint3_PC2.mean-timepoint4_PC2.mean)^2))
```

3 - divide distance by spread, generating a plasticity ratio for each site, higher ratio = more plasticity

```{r}
plasticity.poc<-distance.poc%>%
  select(site_code, tp1.2, tp2.3, tp3.4)%>% #keep desired columns
  gather(key="comparison", value="distance_time", -site_code)%>% #gather and generate new rows to designate time comparisons
  mutate(ratio=distance_time/spread.poc$distance)
plasticity.poc
```

4 - average these ratios across sites to generate a mean plasticity ratio for time, site, and species

Display mean plasticity scores by site:  
```{r}
poc.plasticity.site<-plasticity.poc%>%
  group_by(site_code)%>%
  summarise(mean_site=mean(ratio))%>%
  mutate(species="Pocillopora")
poc.plasticity.site
```

Display mean plasticity scores by timepoint comparison: 
```{r}
plasticity.poc.time<-plasticity.poc%>%
  group_by(comparison)%>%
  summarise(mean_timepoint=mean(ratio))%>%
  mutate(species="Pocillopora")
plasticity.poc.time
```

Display mean plasticity score for the species:  
```{r}
plasticity.poc.species<-plasticity.poc%>%
  summarise(mean_species=mean(ratio))%>%
  summarise(mean_species=mean(mean_species))%>%
  mutate(species="Pocillopora")
plasticity.poc.species
```

### Examine plasticity scores generated from PCA's
   
Generate plasticity dataframe from calculations for each species.   
```{r}
plasticity.site<-bind_rows(acr.plasticity.site, poc.plasticity.site, por.plasticity.site);plasticity.site

plasticity.time<-bind_rows(plasticity.acr.time, plasticity.poc.time, plasticity.por.time);plasticity.time
  
plasticity.species<-bind_rows(plasticity.acr.species, plasticity.poc.species, plasticity.por.species);plasticity.species
```

Plot plasticity scores for site values.    

```{r}
plasticity_site<-plasticity.site%>%
                group_by(site_code)%>%
                summarise(mean=mean(mean_site))%>%

  ggplot(., aes(x = site_code, y = mean, fill = site_code, group=interaction(site_code))) +
    geom_point(pch = 21, size=5, position = position_jitterdodge(0)) + 
    scale_fill_manual(values = c("#374d7c", "#00cccc", "#ff6633"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    #facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold("Plasticity (Distance / Spread)")))+
    theme_classic() + 
    ylim(0,5)+
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=12),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); plasticity_site
```

Plot plasticity scores for timepoint values.    
```{r}
plasticity_time<-plasticity.time%>%
                group_by(comparison)%>%
                summarise(mean=mean(mean_timepoint))%>%
  
  ggplot(., aes(x = comparison, y = mean, group=interaction(comparison))) +
    geom_point(pch = 21, size=5, fill="gray") + 
    #scale_fill_manual(values = c("#374d7c", "#00cccc", "#ff6633"))+
    scale_x_discrete(labels=c("tp1.2" = "Jan-March", "tp2.3" = "March-Sept", "tp3.4" = "Sept-Nov"))+
    #facet_wrap(~species) +
    xlab("Timepoint") + 
    ylab(expression(bold("Plasticity (Distance / Spread)")))+
    theme_classic() + 
    ylim(0,5)+
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=12),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); plasticity_time
```

Plot plasticity scores for species values.    

```{r}
plasticity_species<-ggplot(plasticity.species, aes(x = species, y = mean_species, fill=species, group=interaction(species))) +
    geom_point(pch = 21, size=5, position = position_jitterdodge(0)) + 
    scale_fill_manual(values = c("darkgray", "orange", "purple"))+
    #scale_x_discrete(labels=c("tp1.2" = "Jan-March", "tp2.3" = "March-Sept", "tp3.4" = "Sept-Nov"))+
    #facet_wrap(~species) +
    xlab("Species") + 
    ylab(expression(bold("Plasticity (Distance / Spread)")))+
    theme_classic() + 
    ylim(0,5)+
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=12),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); plasticity_species
```

Assemble full plasticity figure.  

```{r}
plasticity_full_panel<-plot_grid(plasticity_species, plasticity_site, plasticity_time, labels = c("", "", ""), ncol=3, nrow=1, rel_heights= c(1,1,1), rel_widths = c(1,1,1), label_size = 20, label_y=1, align="vh")

ggsave(filename="Figures/Plasticity_Panel.png", plot=plasticity_full_panel, dpi=500, width=10, height=4, units="in")
```  

Generate plots for within species.  

Plot plasticity scores for site values.     

```{r}
plasticity_site2<-ggplot(plasticity.site, aes(x = site_code, y = mean_site, fill = site_code, group=interaction(site_code))) +
    geom_point(pch = 21, size=5, position = position_jitterdodge(0)) + 
    scale_fill_manual(values = c("#374d7c", "#00cccc", "#ff6633"))+
    scale_x_discrete(labels=c("Mahana Low" = "Mahana \nLow", "Hilton Medium" = "Hilton \nMedium",
                              "Manava High" = "Manava \nHigh"))+
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold("Plasticity (Distance / Spread)")))+
    theme_classic() + 
    ylim(0,5)+
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=12),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); plasticity_site2
```

Plot plasticity scores for timepoint values.    
```{r}
plasticity_time2<-ggplot(plasticity.time, aes(x = comparison, y = mean_timepoint, group=interaction(comparison))) +
    geom_point(pch = 21, size=5, fill="gray") + 
    #scale_fill_manual(values = c("#374d7c", "#00cccc", "#ff6633"))+
    scale_x_discrete(labels=c("tp1.2" = "Jan-March", "tp2.3" = "March-Sept", "tp3.4" = "Sept-Nov"))+
    facet_wrap(~species) +
    xlab("Timepoint") + 
    ylab(expression(bold("Plasticity (Distance / Spread)")))+
    theme_classic() + 
    ylim(0,5)+
    theme(
      legend.position="none",
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=12),
      axis.text=element_text(size=10, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); plasticity_time2
```


Assemble full plasticity figure.  

```{r}
plasticity_full_panel2<-plot_grid(plasticity_species, plasticity_site2, plasticity_time2, labels = c("", "", ""), ncol=3, nrow=1, rel_heights= c(0.5,1,1), rel_widths = c(0.5,1,1), label_size = 20, label_y=1, align="vh")

ggsave(filename="Figures/Plasticity_Panel_species_detail.png", plot=plasticity_full_panel2, dpi=500, width=20, height=4, units="in")
```  

### Matrix of PCA's by species and time  

Generate biplot showing groupings by site for each species and time point.  

#### Pocillopora  

```{r}
poc_tp1_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Pocillopora")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Chl_a=chla.ug.mgAFDW, Chl_c2=chlc2.ug.mgAFDW, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint1")

poc_tp1_data<-poc_tp1_data[complete.cases(poc_tp1_data), ]
 
poc_tp1_scaled<-prcomp(poc_tp1_data[c(5:15)], scale=TRUE, center=TRUE) 

pocTP1<-ggplot2::autoplot(poc_tp1_scaled, data=poc_tp1_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0, loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("January 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  annotate("text", x=-16, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 2, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP1
```

```{r}
poc_tp2_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(chla.ug.mgAFDW<2.2)%>%
  filter(species=="Pocillopora")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Chl_a=chla.ug.mgAFDW, Chl_c2=chlc2.ug.mgAFDW, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint2")
 
poc_tp2_data<-poc_tp2_data[complete.cases(poc_tp2_data), ]
 
poc_tp2_scaled<-prcomp(poc_tp2_data[c(5:15)], scale=TRUE, center=TRUE) 

pocTP2<-ggplot2::autoplot(poc_tp2_scaled, data=poc_tp2_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("March 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP2
```

```{r}
poc_tp3_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(chla.ug.mgAFDW<2.2)%>%
  filter(species=="Pocillopora")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Chl_a=chla.ug.mgAFDW, Chl_c2=chlc2.ug.mgAFDW, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint3")
 
poc_tp3_data<-poc_tp3_data[complete.cases(poc_tp3_data), ]
 
poc_tp3_scaled<-prcomp(poc_tp3_data[c(5:15)], scale=TRUE, center=TRUE) 

pocTP3<-ggplot2::autoplot(poc_tp3_scaled, data=poc_tp3_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("September 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP3
```

```{r}
poc_tp4_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(chla.ug.mgAFDW<2.2)%>%
  filter(species=="Pocillopora")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Chl_a=chla.ug.mgAFDW, Chl_c2=chlc2.ug.mgAFDW, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint4")
 
poc_tp4_data<-poc_tp4_data[complete.cases(poc_tp4_data), ]
 
poc_tp4_scaled<-prcomp(poc_tp4_data[c(5:15)], scale=TRUE, center=TRUE) 

pocTP4<-ggplot2::autoplot(poc_tp4_scaled, data=poc_tp4_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("November 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP4
```








#### Acropora  

```{r}
acr_tp1_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Acropora")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Chl_a=chla.ug.mgAFDW, Chl_c2=chlc2.ug.mgAFDW, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint1")

acr_tp1_data<-acr_tp1_data[complete.cases(acr_tp1_data), ]
 
acr_tp1_scaled<-prcomp(acr_tp1_data[c(5:15)], scale=TRUE, center=TRUE) 

acrTP1<-ggplot2::autoplot(acr_tp1_scaled, data=acr_tp1_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0, loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("January 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  annotate("text", x=-16, y=0, label="italic(Acropora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 2, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP1
```

```{r}
acr_tp2_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(chla.ug.mgAFDW<2.2)%>%
  filter(species=="Acropora")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Chl_a=chla.ug.mgAFDW, Chl_c2=chlc2.ug.mgAFDW, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint2")
 
acr_tp2_data<-acr_tp2_data[complete.cases(acr_tp2_data), ]
 
acr_tp2_scaled<-prcomp(acr_tp2_data[c(5:15)], scale=TRUE, center=TRUE) 

acrTP2<-ggplot2::autoplot(acr_tp2_scaled, data=acr_tp2_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("March 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP2
```

```{r}
acr_tp3_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(chla.ug.mgAFDW<2.2)%>%
  filter(species=="Acropora")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Chl_a=chla.ug.mgAFDW, Chl_c2=chlc2.ug.mgAFDW, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint3")
 
acr_tp3_data<-acr_tp3_data[complete.cases(acr_tp3_data), ]
 
acr_tp3_scaled<-prcomp(acr_tp3_data[c(5:15)], scale=TRUE, center=TRUE) 

acrTP3<-ggplot2::autoplot(acr_tp3_scaled, data=acr_tp3_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("September 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP3
```

```{r}
acr_tp4_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(chla.ug.mgAFDW<2.2)%>%
  filter(species=="Acropora")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Chl_a=chla.ug.mgAFDW, Chl_c2=chlc2.ug.mgAFDW, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint4")
 
acr_tp4_data<-acr_tp4_data[complete.cases(acr_tp4_data), ]
 
acr_tp4_scaled<-prcomp(acr_tp4_data[c(5:15)], scale=TRUE, center=TRUE) 

acrTP4<-ggplot2::autoplot(acr_tp4_scaled, data=acr_tp4_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("November 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP4
```








#### Porites  

```{r}
por_tp1_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Porites")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Chl_a=chla.ug.mgAFDW, Chl_c2=chlc2.ug.mgAFDW, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint1")

por_tp1_data<-por_tp1_data[complete.cases(por_tp1_data), ]
 
por_tp1_scaled<-prcomp(por_tp1_data[c(5:15)], scale=TRUE, center=TRUE) 

porTP1<-ggplot2::autoplot(por_tp1_scaled, data=por_tp1_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0, loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("January 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  annotate("text", x=-16, y=0, label="italic(Porites)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 2, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP1
```

```{r}
por_tp2_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(chla.ug.mgAFDW<2.2)%>%
  filter(species=="Porites")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Chl_a=chla.ug.mgAFDW, Chl_c2=chlc2.ug.mgAFDW, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint2")
 
por_tp2_data<-por_tp2_data[complete.cases(por_tp2_data), ]
 
por_tp2_scaled<-prcomp(por_tp2_data[c(5:15)], scale=TRUE, center=TRUE) 

porTP2<-ggplot2::autoplot(por_tp2_scaled, data=por_tp2_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("March 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP2
```

```{r}
por_tp3_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(chla.ug.mgAFDW<2.2)%>%
  filter(species=="Porites")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Chl_a=chla.ug.mgAFDW, Chl_c2=chlc2.ug.mgAFDW, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint3")
 
por_tp3_data<-por_tp3_data[complete.cases(por_tp3_data), ]
 
por_tp3_scaled<-prcomp(por_tp3_data[c(5:15)], scale=TRUE, center=TRUE) 

porTP3<-ggplot2::autoplot(por_tp3_scaled, data=por_tp3_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("September 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP3
```

```{r}
por_tp4_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, chla.ug.mgAFDW, chlc2.ug.mgAFDW, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(chla.ug.mgAFDW<2.2)%>%
  filter(species=="Porites")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Chl_a=chla.ug.mgAFDW, Chl_c2=chlc2.ug.mgAFDW, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint4")
 
por_tp4_data<-por_tp4_data[complete.cases(por_tp4_data), ]
 
por_tp4_scaled<-prcomp(por_tp4_data[c(5:15)], scale=TRUE, center=TRUE) 

porTP4<-ggplot2::autoplot(por_tp4_scaled, data=por_tp4_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
 # ggtitle("November 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP4
```

#### Assemble grid plot of all metrics by species and time  

```{r}
all_grid<-plot_grid(acrTP1, acrTP2, acrTP3, acrTP4, pocTP1, pocTP2, pocTP3, pocTP4, porTP1, porTP2, porTP3, porTP4, ncol=4, nrow=3)
all_grid2<-plot_grid(all_grid, legend, rel_heights = c(4, .2), ncol=1, nrow=2)

ggsave(filename="Figures/Matrix_AllResponses.pdf", plot=all_grid2, dpi=500, width=20, height=20, units="in")

```







## Holobiont Responses  

### PCA's for centroid and trajectories  

#### Acropora  

Generate PCA using scaled (scaled_acr_afdw) from dataframe (acr_data_afdw).   
 
```{r}
acr_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Acropora")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw)

acr_data_afdw<-acr_data_afdw[complete.cases(acr_data_afdw), ]

scaled_acr_afdw<-prcomp(acr_data_afdw[c(5:9)], scale=TRUE, center=TRUE) 

acr_info<-acr_data_afdw[c(2,4)]

acr_data<-scaled_acr_afdw%>%
  augment(acr_info)%>%
  group_by(timepoint, site_code)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

acr.centroids<-acr_data %>% 
  select(timepoint, site_code, PC1.mean, PC2.mean)%>%
  group_by(timepoint, site_code)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
```

Examine PERMANOVA results.  
 
```{r}
# scale data
vegan <- scale(acr_data_afdw[ ,5:9])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis(vegan ~ timepoint*site_code, data = acr_data_afdw, method='eu')
z_acr<-permanova$aov.tab
z_acr
``` 
 
Assemble plot with background points
```{r}
#1. make plot with dots
acrPCA<-ggplot(acr_data, aes(.fittedPC1, .fittedPC2, color=site_code)) + 
  geom_point(size = 4, alpha=0.2, show.legend=FALSE)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  ylim(-6,10)+
  xlim(-5,10)+
  ylab("PC2")+
  xlab("PC1")+
  ggtitle(expression(italic("Acropora")))+
  geom_text(x=7, y=-2.5, label=paste("p(Timepoint)=", z_acr$`Pr(>F)`[1]), size=4, color=ifelse(z_acr$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  geom_text(x=7, y=-3.25, label=paste("p(Site)=", z_acr$`Pr(>F)`[2]), size=4, color=ifelse(z_acr$`Pr(>F)`[2] < 0.05, "black", "darkgray")) + 
  geom_text(x=7, y=-4, label=paste("p(Timepoint x Site)=", z_acr$`Pr(>F)`[3]), size=4, color=ifelse(z_acr$`Pr(>F)`[3] < 0.05, "black", "darkgray")) + 
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         title = element_text(size=25, face="bold"), 
         axis.title = element_text(size=18));acrPCA

```

Add centroids  

```{r}
#2. add centroids 
acrPCAcen<-acrPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site_code), data=acr.centroids, size=3, show.legend=FALSE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="none"); acrPCAcen

```

Add segments

```{r}
#3. add segments
segpoints<-acr.centroids%>%
  gather(variable, value, -(timepoint:site_code)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
acrPCAfull<-acrPCAcen + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = site_code), data = segpoints, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); acrPCAfull
```

Add bi plot with loadings  
```{r}
#1. make plot with dots
acrArrows<-ggplot2::autoplot(scaled_acr_afdw, data=acr_data_afdw, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=3.5, loadings.label.vjust=0.5, loadings.label.hjust=-0.1, loadings.label.repel=TRUE, size=4, alpha=0.0) + 
  #scale_colour_manual(values=c("blue4", "darkgray", "springgreen4")) +
  #scale_fill_manual(values=c("blue4", "darkgray", "springgreen4")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_blank(),
         axis.text.y=element_blank(),
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         title = element_text(size=25, face="bold"),
         axis.title = element_blank());acrArrows
```


Asemble final figure with inset biplot.  
```{r}
#acrFullPCA<-ggdraw(acrPCAfull) + #theme_half_open(12)) +
  #draw_plot(acrArrows, .5, .5, .5, .5); acrFullPCA #x, y, w, h

#ggsave(filename="Figures/FullPCA_Acropora.pdf", plot=acrFullPCA, dpi=300, width=12, height=8, units="in")
```

#### Porites

Generate PCA using scaled (scaled_por_afdw) from dataframe (por_data_afdw).   
 
Calculate centroid locations for each site and timepoint and pull PC1 and PC2 locations.      
 
```{r}
por_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Porites")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw)

por_data_afdw<-por_data_afdw[complete.cases(por_data_afdw), ]

scaled_por_afdw<-prcomp(por_data_afdw[c(5:9)], scale=TRUE, center=TRUE) 

por_info<-por_data_afdw[c(2,4)]

por_data<-scaled_por_afdw%>%
  augment(por_info)%>%
  group_by(timepoint, site_code)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

por.centroids<-por_data %>% 
  select(timepoint, site_code, PC1.mean, PC2.mean)%>%
  group_by(timepoint, site_code)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
```

```{r}
# scale data
vegan <- scale(por_data_afdw[ ,5:9])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis(vegan ~ timepoint*site_code, data = por_data_afdw, method='eu')
z_por<-permanova$aov.tab
z_por
```

Assemble plot with background points
```{r}
#1. make plot with dots
porPCA<-ggplot(por_data, aes(.fittedPC1, .fittedPC2, color=site_code)) + 
  geom_point(size = 4, alpha=0.2, show.legend=FALSE)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  ylab("PC2")+
  xlab("PC1")+
  ylim(-6,10)+
  xlim(-5,10)+
  ggtitle(expression(italic("Porites")))+
  geom_text(x=7, y=-2.5, label=paste("p(Timepoint)=", z_por$`Pr(>F)`[1]), size=4, color=ifelse(z_por$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  geom_text(x=7, y=-3.25, label=paste("p(Site)=", z_por$`Pr(>F)`[2]), size=4, color=ifelse(z_por$`Pr(>F)`[2] < 0.05, "black", "darkgray")) + 
  geom_text(x=7, y=-4, label=paste("p(Timepoint x Site)=", z_por$`Pr(>F)`[3]), size=4, color=ifelse(z_por$`Pr(>F)`[3] < 0.05, "black", "darkgray")) + 
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         legend.title = element_blank(), 
         axis.text = element_text(size=18), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         title = element_text(size=25, face="bold"),
         axis.title = element_text(size=18,  face="bold"));porPCA
```

Add centroids  

```{r}
#2. add centroids 
porPCAcen<-porPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site_code), data=por.centroids, size=3, show.legend=FALSE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position=c(1,0.3)); porPCAcen

#build a plot for the legend
legend_plot<-porPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site_code), data=por.centroids, size=3, show.legend=TRUE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="bottom")

# extract the legend from one of the plots
legend <- get_legend(
  # create some space to the left of the legend
  legend_plot + theme(legend.box.margin = margin(1,1,1,1))
)

```

Add segments

```{r}
#3. add segments
segpoints<-por.centroids%>%
  gather(variable, value, -(timepoint:site_code)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
porPCAfull<-porPCAcen + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = site_code), data = segpoints, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); porPCAfull
```

Add bi plot with loadings  
```{r}
#1. make plot with dots
porArrows<-ggplot2::autoplot(scaled_por_afdw, data=por_data_afdw, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=3.5, loadings.label.vjust=-0.1, loadings.label.hjust=0.1, loadings.label.repel=FALSE, size=4, alpha=0.0) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-0.5,0.1)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_blank(),
         axis.text.y=element_blank(),
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_blank());porArrows
```
 

Assemble final figure with inset biplot.  
```{r}
#porFullPCA<-ggdraw(porPCAfull)+ #+ theme_half_open(12)) +
  #draw_plot(porArrows, .5, .5, .5, .5); porFullPCA #x, y, w, h

#ggsave(filename="Figures/FullPCA_Porites.pdf", plot=porFullPCA, dpi=300, width=12, height=8, units="in")
```
 
#### Pocillopora   

Generate PCA using scaled (scaled_poc_afdw) from dataframe (poc_data_afdw). 
 
```{r}
poc_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Pocillopora")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw)

poc_data_afdw<-poc_data_afdw[complete.cases(poc_data_afdw), ]
 
scaled_poc_afdw<-prcomp(poc_data_afdw[c(5:9)], scale=TRUE, center=TRUE) 

poc_info<-poc_data_afdw[c(2,4)]

poc_data<-scaled_poc_afdw%>%
  augment(poc_info)%>%
  group_by(timepoint, site_code)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

poc.centroids<-poc_data %>% 
  select(timepoint, site_code, PC1.mean, PC2.mean)%>%
  group_by(timepoint, site_code)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
``` 
  
```{r}
# scale data
vegan <- scale(poc_data_afdw[ ,5:9])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis(vegan ~ timepoint*site_code, data = poc_data_afdw, method='eu')
z_poc<-permanova$aov.tab
z_poc
```

Assemble plot with background points
```{r}
#1. make plot with dots
pocPCA<-ggplot(poc_data, aes(.fittedPC1, .fittedPC2, color=site_code)) + 
  geom_point(size = 4, alpha=0.2, show.legend=FALSE)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  ylim(-6,10)+
  xlim(-5,10)+
  ylab("PC2")+
  xlab("PC1")+
  ggtitle(expression(italic("Pocillopora")))+
  geom_text(x=7, y=-2.5, label=paste("p(Timepoint)=", z_poc$`Pr(>F)`[1]), size=4, color=ifelse(z_poc$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  geom_text(x=7, y=-3.25, label=paste("p(Site)=", z_poc$`Pr(>F)`[2]), size=4, color=ifelse(z_poc$`Pr(>F)`[2] < 0.05, "black", "darkgray")) + 
  geom_text(x=7, y=-4, label=paste("p(Timepoint x Site)=", z_poc$`Pr(>F)`[3]), size=4, color=ifelse(z_poc$`Pr(>F)`[3] < 0.05, "black", "darkgray")) + 
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         plot.margin = margin(1, 1, 1, 1, "cm"),
         legend.title = element_blank(), 
         title = element_text(size=25, face="bold"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18,  face="bold"));pocPCA

```

Add centroids  

```{r}
#2. add centroids 
pocPCAcen<-pocPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site_code), data=poc.centroids, size=3, show.legend=FALSE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="none"); pocPCAcen

```

Add segments

```{r}
#3. add segments
segpoints<-poc.centroids%>%
  gather(variable, value, -(timepoint:site_code)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
pocPCAfull<-pocPCAcen + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = site_code), data = segpoints, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); pocPCAfull
```

Add bi plot with loadings  
```{r}

pocArrows<-ggplot2::autoplot(scaled_poc_afdw, data=poc_data_afdw, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=3.5, loadings.label.vjust=0, loadings.label.hjust=-0.1, laodings.label.repel=FALSE, size=4, alpha=0.0) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_blank(),
         axis.text.y=element_blank(),
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_blank());pocArrows
```

 
Assemble final figure with inset biplot.  
```{r}
#pocFullPCA<-ggdraw(pocPCAfull) + #theme_half_open(12)) +
  #draw_plot(pocArrows, .5, .5, .5, .5); pocFullPCA #x, y, w, h

#ggsave(filename="Figures/FullPCA_Pocillopora.pdf", plot=pocFullPCA, dpi=300, width=12, height=8, units="in")
```
 
Assemble all plots.  

```{r}
PCA_full_panel<-plot_grid(acrPCAfull, pocPCAfull, porPCAfull, labels = c("", "", ""), ncol=3, nrow=1, rel_heights= c(1,1,1), rel_widths = c(1,1,1), label_size = 20, label_y=1, align="vh")

# add the legend to the row we made earlier. Give it one-third of 
# the width of one plot (via rel_widths).
PCA_full_panel_legend<-plot_grid(PCA_full_panel, legend, rel_heights = c(4, .2), ncol=1, nrow=2)

ggsave(filename="Figures/Full_Panel_PCAs_Holobiont.png", plot=PCA_full_panel_legend, dpi=500, width=20, height=6, units="in")
```  




  
  
### Matrix of PCA's by species and time  

Generate biplot showing groupings by site for each species and time point.  

#### Pocillopora  

```{r}
poc_tp1_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Pocillopora")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint1")

poc_tp1_data<-poc_tp1_data[complete.cases(poc_tp1_data), ]
 
poc_tp1_scaled<-prcomp(poc_tp1_data[c(5:9)], scale=TRUE, center=TRUE) 

pocTP1<-ggplot2::autoplot(poc_tp1_scaled, data=poc_tp1_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0, loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("January 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  annotate("text", x=-16, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 2, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP1
```

```{r}
poc_tp2_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Pocillopora")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint2")
 
poc_tp2_data<-poc_tp2_data[complete.cases(poc_tp2_data), ]
 
poc_tp2_scaled<-prcomp(poc_tp2_data[c(5:9)], scale=TRUE, center=TRUE) 

pocTP2<-ggplot2::autoplot(poc_tp2_scaled, data=poc_tp2_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("March 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP2
```

```{r}
poc_tp3_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Pocillopora")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint3")
 
poc_tp3_data<-poc_tp3_data[complete.cases(poc_tp3_data), ]
 
poc_tp3_scaled<-prcomp(poc_tp3_data[c(5:9)], scale=TRUE, center=TRUE) 

pocTP3<-ggplot2::autoplot(poc_tp3_scaled, data=poc_tp3_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("September 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP3
```

```{r}
poc_tp4_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Pocillopora")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint4")
 
poc_tp4_data<-poc_tp4_data[complete.cases(poc_tp4_data), ]
 
poc_tp4_scaled<-prcomp(poc_tp4_data[c(5:9)], scale=TRUE, center=TRUE) 

pocTP4<-ggplot2::autoplot(poc_tp4_scaled, data=poc_tp4_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("November 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP4
```


#### Acropora  

```{r}
acr_tp1_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Acropora")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint1")

acr_tp1_data<-acr_tp1_data[complete.cases(acr_tp1_data), ]
 
acr_tp1_scaled<-prcomp(acr_tp1_data[c(5:9)], scale=TRUE, center=TRUE) 

acrTP1<-ggplot2::autoplot(acr_tp1_scaled, data=acr_tp1_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0, loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("January 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  annotate("text", x=-16, y=0, label="italic(Acropora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 2, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP1
```

```{r}
acr_tp2_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Acropora")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint2")
 
acr_tp2_data<-acr_tp2_data[complete.cases(acr_tp2_data), ]
 
acr_tp2_scaled<-prcomp(acr_tp2_data[c(5:9)], scale=TRUE, center=TRUE) 

acrTP2<-ggplot2::autoplot(acr_tp2_scaled, data=acr_tp2_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("March 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP2
```

```{r}
acr_tp3_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Acropora")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint3")
 
acr_tp3_data<-acr_tp3_data[complete.cases(acr_tp3_data), ]
 
acr_tp3_scaled<-prcomp(acr_tp3_data[c(5:9)], scale=TRUE, center=TRUE) 

acrTP3<-ggplot2::autoplot(acr_tp3_scaled, data=acr_tp3_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("September 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP3
```

```{r}
acr_tp4_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Acropora")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint4")
 
acr_tp4_data<-acr_tp4_data[complete.cases(acr_tp4_data), ]
 
acr_tp4_scaled<-prcomp(acr_tp4_data[c(5:9)], scale=TRUE, center=TRUE) 

acrTP4<-ggplot2::autoplot(acr_tp4_scaled, data=acr_tp4_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("November 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP4
```



#### Porites  

```{r}
por_tp1_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Porites")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint1")

por_tp1_data<-por_tp1_data[complete.cases(por_tp1_data), ]
 
por_tp1_scaled<-prcomp(por_tp1_data[c(5:9)], scale=TRUE, center=TRUE) 

porTP1<-ggplot2::autoplot(por_tp1_scaled, data=por_tp1_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0, loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("January 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  annotate("text", x=-16, y=0, label="italic(Porites)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 2, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP1
```

```{r}
por_tp2_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Porites")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint2")
 
por_tp2_data<-por_tp2_data[complete.cases(por_tp2_data), ]
 
por_tp2_scaled<-prcomp(por_tp2_data[c(5:9)], scale=TRUE, center=TRUE) 

porTP2<-ggplot2::autoplot(por_tp2_scaled, data=por_tp2_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("March 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP2
```

```{r}
por_tp3_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Porites")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint3")
 
por_tp3_data<-por_tp3_data[complete.cases(por_tp3_data), ]
 
por_tp3_scaled<-prcomp(por_tp3_data[c(5:9)], scale=TRUE, center=TRUE) 

porTP3<-ggplot2::autoplot(por_tp3_scaled, data=por_tp3_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("September 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP3
```

```{r}
por_tp4_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(holobiont_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Porites")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw)%>%
  filter(timepoint=="timepoint4")
 
por_tp4_data<-por_tp4_data[complete.cases(por_tp4_data), ]
 
por_tp4_scaled<-prcomp(por_tp4_data[c(5:9)], scale=TRUE, center=TRUE) 

porTP4<-ggplot2::autoplot(por_tp4_scaled, data=por_tp4_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
 # ggtitle("November 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP4
```

#### Assemble grid plot of all metrics by species and time  

```{r}
all_grid<-plot_grid(acrTP1, acrTP2, acrTP3, acrTP4, pocTP1, pocTP2, pocTP3, pocTP4, porTP1, porTP2, porTP3, porTP4, ncol=4, nrow=3)
all_grid2<-plot_grid(all_grid, legend, rel_heights = c(4, .2), ncol=1, nrow=2)

ggsave(filename="Figures/Matrix_Holobiont_Responses.pdf", plot=all_grid2, dpi=500, width=20, height=20, units="in")

```


## Symbiont Responses  

### PCA's for centroid and trajectories  

#### Acropora  

Generate PCA using scaled (scaled_acr_afdw) from dataframe (acr_data_afdw).   
 
```{r}
acr_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Total_Chl<13)%>%
  filter(species=="Acropora")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)

acr_data_afdw<-acr_data_afdw[complete.cases(acr_data_afdw), ]

scaled_acr_afdw<-prcomp(acr_data_afdw[c(5:10)], scale=TRUE, center=TRUE) 

acr_info<-acr_data_afdw[c(2,4)]

acr_data<-scaled_acr_afdw%>%
  augment(acr_info)%>%
  group_by(timepoint, site_code)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

acr.centroids<-acr_data %>% 
  select(timepoint, site_code, PC1.mean, PC2.mean)%>%
  group_by(timepoint, site_code)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
```

Examine PERMANOVA results.  
 
```{r}
# scale data
vegan <- scale(acr_data_afdw[ ,5:10])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis(vegan ~ timepoint*site_code, data = acr_data_afdw, method='eu')
z_acr<-permanova$aov.tab
z_acr
``` 
 
Assemble plot with background points
```{r}
#1. make plot with dots
acrPCA<-ggplot(acr_data, aes(.fittedPC1, .fittedPC2, color=site_code)) + 
  geom_point(size = 4, alpha=0.2, show.legend=FALSE)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  ylim(-6,10)+
  xlim(-7,10)+
  ylab("PC2")+
  xlab("PC1")+
  ggtitle(expression(italic("Acropora")))+
  geom_text(x=7, y=-2.5, label=paste("p(Timepoint)=", z_acr$`Pr(>F)`[1]), size=4, color=ifelse(z_acr$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  geom_text(x=7, y=-3.25, label=paste("p(Site)=", z_acr$`Pr(>F)`[2]), size=4, color=ifelse(z_acr$`Pr(>F)`[2] < 0.05, "black", "darkgray")) + 
  geom_text(x=7, y=-4, label=paste("p(Timepoint x Site)=", z_acr$`Pr(>F)`[3]), size=4, color=ifelse(z_acr$`Pr(>F)`[3] < 0.05, "black", "darkgray")) + 
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         title = element_text(size=25, face="bold"), 
         axis.title = element_text(size=18));acrPCA

```

Add centroids  

```{r}
#2. add centroids 
acrPCAcen<-acrPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site_code), data=acr.centroids, size=3, show.legend=FALSE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="none"); acrPCAcen

```

Add segments

```{r}
#3. add segments
segpoints<-acr.centroids%>%
  gather(variable, value, -(timepoint:site_code)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
acrPCAfull<-acrPCAcen + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = site_code), data = segpoints, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); acrPCAfull
```

Add bi plot with loadings  
```{r}
#1. make plot with dots
acrArrows<-ggplot2::autoplot(scaled_acr_afdw, data=acr_data_afdw, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=3.5, loadings.label.vjust=0.5, loadings.label.hjust=-0.1, loadings.label.repel=TRUE, size=4, alpha=0.0) + 
  #scale_colour_manual(values=c("blue4", "darkgray", "springgreen4")) +
  #scale_fill_manual(values=c("blue4", "darkgray", "springgreen4")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_blank(),
         axis.text.y=element_blank(),
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         title = element_text(size=25, face="bold"),
         axis.title = element_blank());acrArrows
```


Asemble final figure with inset biplot.  
```{r}
#acrFullPCA<-ggdraw(acrPCAfull) + #theme_half_open(12)) +
  #draw_plot(acrArrows, .5, .5, .5, .5); acrFullPCA #x, y, w, h

#ggsave(filename="Figures/FullPCA_Acropora.pdf", plot=acrFullPCA, dpi=300, width=12, height=8, units="in")
```

#### Porites

Generate PCA using scaled (scaled_por_afdw) from dataframe (por_data_afdw).   
 
Calculate centroid locations for each site and timepoint and pull PC1 and PC2 locations.      
 
```{r}
por_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Total_Chl<13)%>%
  filter(species=="Porites")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)

por_data_afdw<-por_data_afdw[complete.cases(por_data_afdw), ]

scaled_por_afdw<-prcomp(por_data_afdw[c(5:10)], scale=TRUE, center=TRUE) 

por_info<-por_data_afdw[c(2,4)]

por_data<-scaled_por_afdw%>%
  augment(por_info)%>%
  group_by(timepoint, site_code)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

por.centroids<-por_data %>% 
  select(timepoint, site_code, PC1.mean, PC2.mean)%>%
  group_by(timepoint, site_code)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
```

```{r}
# scale data
vegan <- scale(por_data_afdw[ ,5:10])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis(vegan ~ timepoint*site_code, data = por_data_afdw, method='eu')
z_por<-permanova$aov.tab
z_por
```

Assemble plot with background points
```{r}
#1. make plot with dots
porPCA<-ggplot(por_data, aes(.fittedPC1, .fittedPC2, color=site_code)) + 
  geom_point(size = 4, alpha=0.2, show.legend=FALSE)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  ylab("PC2")+
  xlab("PC1")+
  ylim(-6,10)+
  xlim(-7,10)+
  ggtitle(expression(italic("Porites")))+
  geom_text(x=7, y=-2.5, label=paste("p(Timepoint)=", z_por$`Pr(>F)`[1]), size=4, color=ifelse(z_por$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  geom_text(x=7, y=-3.25, label=paste("p(Site)=", z_por$`Pr(>F)`[2]), size=4, color=ifelse(z_por$`Pr(>F)`[2] < 0.05, "black", "darkgray")) + 
  geom_text(x=7, y=-4, label=paste("p(Timepoint x Site)=", z_por$`Pr(>F)`[3]), size=4, color=ifelse(z_por$`Pr(>F)`[3] < 0.05, "black", "darkgray")) + 
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         legend.title = element_blank(), 
         axis.text = element_text(size=18), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         title = element_text(size=25, face="bold"),
         axis.title = element_text(size=18,  face="bold"));porPCA
```

Add centroids  

```{r}
#2. add centroids 
porPCAcen<-porPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site_code), data=por.centroids, size=3, show.legend=FALSE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position=c(1,0.3)); porPCAcen

#build a plot for the legend
legend_plot<-porPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site_code), data=por.centroids, size=3, show.legend=TRUE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="bottom")

# extract the legend from one of the plots
legend <- get_legend(
  # create some space to the left of the legend
  legend_plot + theme(legend.box.margin = margin(1,1,1,1))
)

```

Add segments

```{r}
#3. add segments
segpoints<-por.centroids%>%
  gather(variable, value, -(timepoint:site_code)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
porPCAfull<-porPCAcen + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = site_code), data = segpoints, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); porPCAfull
```

Add bi plot with loadings  
```{r}
#1. make plot with dots
porArrows<-ggplot2::autoplot(scaled_por_afdw, data=por_data_afdw, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=3.5, loadings.label.vjust=-0.1, loadings.label.hjust=0.1, loadings.label.repel=FALSE, size=4, alpha=0.0) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-0.5,0.1)+
  #ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_blank(),
         axis.text.y=element_blank(),
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_blank());porArrows
```
 

Assemble final figure with inset biplot.  
```{r}
#porFullPCA<-ggdraw(porPCAfull)+ #+ theme_half_open(12)) +
 # draw_plot(porArrows, .5, .5, .5, .5); porFullPCA #x, y, w, h

#ggsave(filename="Figures/FullPCA_Porites.pdf", plot=porFullPCA, dpi=300, width=12, height=8, units="in")
```
 
#### Pocillopora   

Generate PCA using scaled (scaled_poc_afdw) from dataframe (poc_data_afdw). 
 
```{r}
poc_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Total_Chl<13)%>%
  filter(species=="Pocillopora")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)

poc_data_afdw<-poc_data_afdw[complete.cases(poc_data_afdw), ]
 
scaled_poc_afdw<-prcomp(poc_data_afdw[c(5:10)], scale=TRUE, center=TRUE) 

poc_info<-poc_data_afdw[c(2,4)]

poc_data<-scaled_poc_afdw%>%
  augment(poc_info)%>%
  group_by(timepoint, site_code)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

poc.centroids<-poc_data %>% 
  select(timepoint, site_code, PC1.mean, PC2.mean)%>%
  group_by(timepoint, site_code)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
``` 
  
```{r}
# scale data
vegan <- scale(poc_data_afdw[ ,5:10])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis(vegan ~ timepoint*site_code, data = poc_data_afdw, method='eu')
z_poc<-permanova$aov.tab
z_poc
```

Assemble plot with background points
```{r}
#1. make plot with dots
pocPCA<-ggplot(poc_data, aes(.fittedPC1, .fittedPC2, color=site_code)) + 
  geom_point(size = 4, alpha=0.2, show.legend=FALSE)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  ylim(-6,10)+
  xlim(-5,10)+
  ylab("PC2")+
  xlab("PC1")+
  ggtitle(expression(italic("Pocillopora")))+
  geom_text(x=7, y=-2.5, label=paste("p(Timepoint)=", z_poc$`Pr(>F)`[1]), size=4, color=ifelse(z_poc$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  geom_text(x=7, y=-3.25, label=paste("p(Site)=", z_poc$`Pr(>F)`[2]), size=4, color=ifelse(z_poc$`Pr(>F)`[2] < 0.05, "black", "darkgray")) + 
  geom_text(x=7, y=-4, label=paste("p(Timepoint x Site)=", z_poc$`Pr(>F)`[3]), size=4, color=ifelse(z_poc$`Pr(>F)`[3] < 0.05, "black", "darkgray")) + 
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         plot.margin = margin(1, 1, 1, 1, "cm"),
         legend.title = element_blank(), 
         title = element_text(size=25, face="bold"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18,  face="bold"));pocPCA

```

Add centroids  

```{r}
#2. add centroids 
pocPCAcen<-pocPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site_code), data=poc.centroids, size=3, show.legend=FALSE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="none"); pocPCAcen

```

Add segments

```{r}
#3. add segments
segpoints<-poc.centroids%>%
  gather(variable, value, -(timepoint:site_code)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
pocPCAfull<-pocPCAcen + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = site_code), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = site_code), data = segpoints, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); pocPCAfull
```

Add bi plot with loadings  
```{r}

pocArrows<-ggplot2::autoplot(scaled_poc_afdw, data=poc_data_afdw, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=3.5, loadings.label.vjust=0, loadings.label.hjust=-0.1, laodings.label.repel=FALSE, size=4, alpha=0.0) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_blank(),
         axis.text.y=element_blank(),
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_blank());pocArrows
```

 
Assemble final figure with inset biplot.  
```{r}
#pocFullPCA<-ggdraw(pocPCAfull) + #theme_half_open(12)) +
  #draw_plot(pocArrows, .5, .5, .5, .5); pocFullPCA #x, y, w, h

#ggsave(filename="Figures/FullPCA_Pocillopora.pdf", plot=pocFullPCA, dpi=300, width=12, height=8, units="in")
```
 
Assemble all plots.  

```{r}
PCA_full_panel<-plot_grid(acrPCAfull, pocPCAfull, porPCAfull, labels = c("", "", ""), ncol=3, nrow=1, rel_heights= c(1,1,1), rel_widths = c(1,1,1), label_size = 20, label_y=1, align="vh")

# add the legend to the row we made earlier. Give it one-third of 
# the width of one plot (via rel_widths).
PCA_full_panel_legend<-plot_grid(PCA_full_panel, legend, rel_heights = c(4, .2), ncol=1, nrow=2)

ggsave(filename="Figures/Full_Panel_PCAs_Symbiont.png", plot=PCA_full_panel_legend, dpi=500, width=20, height=6, units="in")
```  

### Matrix of PCA's by species and time  

Generate biplot showing groupings by site for each species and time point.  

#### Pocillopora  

```{r}
poc_tp1_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Total_Chl<13)%>%
  filter(species=="Pocillopora")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint1")

poc_tp1_data<-poc_tp1_data[complete.cases(poc_tp1_data), ]
 
poc_tp1_scaled<-prcomp(poc_tp1_data[c(5:10)], scale=TRUE, center=TRUE) 

pocTP1<-ggplot2::autoplot(poc_tp1_scaled, data=poc_tp1_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0, loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("January 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  annotate("text", x=-16, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 2, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP1
```

```{r}
poc_tp2_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Total_Chl<13)%>%
  filter(species=="Pocillopora")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint2")
 
poc_tp2_data<-poc_tp2_data[complete.cases(poc_tp2_data), ]
 
poc_tp2_scaled<-prcomp(poc_tp2_data[c(5:10)], scale=TRUE, center=TRUE) 

pocTP2<-ggplot2::autoplot(poc_tp2_scaled, data=poc_tp2_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("March 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP2
```

```{r}
poc_tp3_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Total_Chl<13)%>%
  filter(species=="Pocillopora")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint3")
 
poc_tp3_data<-poc_tp3_data[complete.cases(poc_tp3_data), ]
 
poc_tp3_scaled<-prcomp(poc_tp3_data[c(5:10)], scale=TRUE, center=TRUE) 

pocTP3<-ggplot2::autoplot(poc_tp3_scaled, data=poc_tp3_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("September 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP3
```

```{r}
poc_tp4_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Total_Chl<13)%>%
  filter(species=="Pocillopora")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint4")
 
poc_tp4_data<-poc_tp4_data[complete.cases(poc_tp4_data), ]
 
poc_tp4_scaled<-prcomp(poc_tp4_data[c(5:10)], scale=TRUE, center=TRUE) 

pocTP4<-ggplot2::autoplot(poc_tp4_scaled, data=poc_tp4_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("November 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP4
```


#### Acropora  

```{r}
acr_tp1_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Total_Chl<13)%>%
  filter(species=="Acropora")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint1")

acr_tp1_data<-acr_tp1_data[complete.cases(acr_tp1_data), ]
 
acr_tp1_scaled<-prcomp(acr_tp1_data[c(5:10)], scale=TRUE, center=TRUE) 

acrTP1<-ggplot2::autoplot(acr_tp1_scaled, data=acr_tp1_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0, loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("January 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  annotate("text", x=-16, y=0, label="italic(Acropora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 2, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP1
```

```{r}
acr_tp2_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Total_Chl<13)%>%
  filter(species=="Acropora")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint2")
 
acr_tp2_data<-acr_tp2_data[complete.cases(acr_tp2_data), ]
 
acr_tp2_scaled<-prcomp(acr_tp2_data[c(5:10)], scale=TRUE, center=TRUE) 

acrTP2<-ggplot2::autoplot(acr_tp2_scaled, data=acr_tp2_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("March 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP2
```

```{r}
acr_tp3_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Total_Chl<13)%>%
  filter(species=="Acropora")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint3")
 
acr_tp3_data<-acr_tp3_data[complete.cases(acr_tp3_data), ]
 
acr_tp3_scaled<-prcomp(acr_tp3_data[c(5:10)], scale=TRUE, center=TRUE) 

acrTP3<-ggplot2::autoplot(acr_tp3_scaled, data=acr_tp3_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("September 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP3
```

```{r}
acr_tp4_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Total_Chl<13)%>%
  filter(species=="Acropora")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint4")
 
acr_tp4_data<-acr_tp4_data[complete.cases(acr_tp4_data), ]
 
acr_tp4_scaled<-prcomp(acr_tp4_data[c(5:10)], scale=TRUE, center=TRUE) 

acrTP4<-ggplot2::autoplot(acr_tp4_scaled, data=acr_tp4_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("November 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP4
```



#### Porites  

```{r}
por_tp1_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Total_Chl<13)%>%
  filter(species=="Porites")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint1")

por_tp1_data<-por_tp1_data[complete.cases(por_tp1_data), ]
 
por_tp1_scaled<-prcomp(por_tp1_data[c(5:10)], scale=TRUE, center=TRUE) 

porTP1<-ggplot2::autoplot(por_tp1_scaled, data=por_tp1_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0, loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("January 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  annotate("text", x=-16, y=0, label="italic(Porites)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 2, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP1
```

```{r}
por_tp2_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Total_Chl<13)%>%
  filter(species=="Porites")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint2")
 
por_tp2_data<-por_tp2_data[complete.cases(por_tp2_data), ]
 
por_tp2_scaled<-prcomp(por_tp2_data[c(5:10)], scale=TRUE, center=TRUE) 

porTP2<-ggplot2::autoplot(por_tp2_scaled, data=por_tp2_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("March 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP2
```

```{r}
por_tp3_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Total_Chl<13)%>%
  filter(species=="Porites")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint3")
 
por_tp3_data<-por_tp3_data[complete.cases(por_tp3_data), ]
 
por_tp3_scaled<-prcomp(por_tp3_data[c(5:10)], scale=TRUE, center=TRUE) 

porTP3<-ggplot2::autoplot(por_tp3_scaled, data=por_tp3_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("September 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP3
```

```{r}
por_tp4_data<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Total_Chl<13)%>%
  filter(species=="Porites")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint4")
 
por_tp4_data<-por_tp4_data[complete.cases(por_tp4_data), ]
 
por_tp4_scaled<-prcomp(por_tp4_data[c(5:10)], scale=TRUE, center=TRUE) 

porTP4<-ggplot2::autoplot(por_tp4_scaled, data=por_tp4_data, loadings=TRUE,  colour="site_code", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, laodings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site_code), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
 # ggtitle("November 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP4
```

#### Assemble grid plot of all metrics by species and time  

```{r}
all_grid<-plot_grid(acrTP1, acrTP2, acrTP3, acrTP4, pocTP1, pocTP2, pocTP3, pocTP4, porTP1, porTP2, porTP3, porTP4, ncol=4, nrow=3)
all_grid2<-plot_grid(all_grid, legend, rel_heights = c(4, .2), ncol=1, nrow=2)

ggsave(filename="Figures/Matrix_Symbiont_Responses.pdf", plot=all_grid2, dpi=500, width=20, height=20, units="in")

```

