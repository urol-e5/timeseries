---
title: "Integrating E5 time series biological data"
author: "Ariana S Huffmyer"
date: "1/18/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

```{r}
## install packages if you dont already have them
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("ggplot2")) install.packages("ggplot2")

# load packages
library(tidyverse)
library(ggplot2)
```

## Loading data files 

Load all .csv files from output of all timepoints for each biological response

```{r}
biomass_files<-list.files("../", pattern = "biomass.csv", recursive=T, full.names=T)
antioxidant_files<-list.files("../", pattern = "antioxidant_capacity.csv", recursive=T, full.names=T)
pi_curve_rate_files<-list.files("../", pattern = "pi_curve_rates.csv", recursive=T, full.names=T)
surface_area_files<-list.files("../", pattern = "surface_area.csv", recursive=T, full.names=T)
pi_curve_pars_files<-list.files("../", pattern = "pi_curve_pars.csv", recursive=T, full.names=T)
protein_files<-list.files("../", pattern = "protein.csv", recursive=T, full.names=T)
symb_densities_files<-list.files("../", pattern = "symb_densities.csv", recursive=T, full.names=T)
chlorophyll_files<-list.files("../", pattern = "chlorophyll.csv", recursive=T, full.names=T)

#need to add calcification
```


## Read data files 

Load all data frames.  

```{r}
#biomass WORKS
biomass_dataset <- data.frame()

for (i in 1:length(biomass_files)){
  biomass_df <- read.csv(biomass_files[i]) #each file will be read in
  biomass_dataset <- rbind(biomass_dataset, biomass_df) #for each iteration, bind the new data to the building dataset
}

```

```{r}
#antioxidant capacity WORKS
antioxidant_dataset <- data.frame()

for (i in 1:length(antioxidant_files)){
  antioxidant_df <- read.csv(antioxidant_files[i]) #each file will be read in
  antioxidant_dataset <- rbind(antioxidant_dataset, antioxidant_df) #for each iteration, bind the new data to the building dataset
}

```

```{r}
#PI curve rates- NOT READY
#pi_curve_rate_dataset <- data.frame()

#for (i in 1:length(pi_curve_rate_files)){
  #pi_curve_rate_df <- read.csv(pi_curve_rate_files[i]) #each file will be read in
  #pi_curve_rate_dataset <- rbind(pi_curve_rate_dataset, pi_curve_rate_df) #for each iteration, bind the new data to the building dataset
#}
```

```{r}
#surface area WORKS
surface_area_dataset <- data.frame()

for (i in 1:length(surface_area_files)){
  surface_area_df <- read.csv(surface_area_files[i]) #each file will be read in
  surface_area_dataset <- rbind(surface_area_dataset, surface_area_df) #for each iteration, bind the new data to the building dataset
}
```

```{r}
#PI Curve parameters - NOT READY
#pi_curve_pars_dataset <- data.frame()

#for (i in 1:length(pi_curve_pars_files)){
  #pi_curve_pars_df <- read.csv(pi_curve_pars_files[i]) #each file will be read in
  #pi_curve_pars_dataset <- rbind(pi_curve_pars_dataset, pi_curve_pars_df) #for each iteration, bind the new data to the building dataset
#}
```

```{r}
#protein WORKS
protein_dataset <- data.frame()

for (i in 1:length(protein_files)){
  protein_df <- read.csv(protein_files[i]) #each file will be read in
  protein_dataset <- rbind(protein_dataset, protein_df) #for each iteration, bind the new data to the building dataset
}
```

```{r}
#symb densities WORKS, NEEDS TP4
symb_densities_dataset <- data.frame()

for (i in 1:length(symb_densities_files)){
  symb_densities_df <- read.csv(symb_densities_files[i]) #each file will be read in
  symb_densities_dataset <- rbind(symb_densities_dataset, symb_densities_df) #for each iteration, bind the new data to the building dataset
}
```

```{r}
#chlorophyll files WORKS
chlorophyll_dataset <- data.frame()

for (i in 1:length(chlorophyll_files)){
  chlorophyll_df <- read.csv(chlorophyll_files[i]) #each file will be read in
  chlorophyll_dataset <- rbind(chlorophyll_dataset, chlorophyll_df) #for each iteration, bind the new data to the building dataset
}

```

```{r}
#remove files that are not needed from loops
rm(list = ls(pattern = "*_df"))
```


## Generate master data frame    

Read in metadata frame. 
```{r}
#Load tag metadata sheet 
tags<-read.csv("../metadata/coral_id_metadata.csv")
```

Prepare datasets for merging by renaming columns and spreading dataframes. Each file needs to have one line per colony per response variable in order to merge and should be without site/species columns as these will be added from metadata sheet.   
```{r}
#antioxidant data 
antioxidant_dataset<-antioxidant_dataset%>%
  select(colony_id, cre.umol.mgprot, timepoint)

#biomass data 
biomass_dataset<- biomass_dataset %>%
  filter(!colony_id=="1xPBS")%>%
  nest(AFDW.mg.cm2, DW.mg.cm2, .key = 'value_col') %>%
  spread(key = partner, value = value_col) %>%
  unnest(Host, Sym, .sep = '_')%>%
  select(colony_id, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Host_DW.mg.cm2, Sym_DW.mg.cm2, timepoint)

#protein data
protein_dataset<-protein_dataset%>%
  select(colony_id, prot_ug.cm2, timepoint)
  
#symbiont densitites
symb_densities_dataset<-symb_densities_dataset%>%
  select(colony_id, cells.cm2, timepoint)
```

```{r}
#need to find a more elegant solution for this
master <- full_join(full_join(full_join(full_join(full_join(
  antioxidant_dataset,
  biomass_dataset, by=c("colony_id", "timepoint")),
  chlorophyll_dataset, by=c("colony_id", "timepoint")),
  protein_dataset, by=c("colony_id", "timepoint")),
  surface_area_dataset, by=c("colony_id", "timepoint")), 
  symb_densities_dataset, by=c("colony_id", "timepoint"))

head(master)
```

Control for colony id, site name, and timepoint names. 
```{r}
## Correct and control for colony id that changed between time points due to relabeling \
## Rename sites by name rather than 1, 2, 3

#match site name by site number from tag sheet 


## Merge in species, site information



```








## Antioxidant capacity  

View by site and timepoint for each species.  
```{r}
tacplot<-antioxidant_dataset %>%
  filter(!is.na(species)) %>%
  ggplot(., aes(x = site, y = cre.umol.mgprot, fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, position = position_jitterdodge()) + 
    scale_fill_brewer(palette = "YlGnBu")+
    facet_wrap(~species)+
    theme_classic(); tacplot
```

## Symbiont Densities  

View by site and timepoint for each species.  
```{r}
symbplot<-symb_densities_dataset %>%
  filter(!is.na(species)) %>%
  ggplot(., aes(x = site, y = cells.cm2, fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, position = position_jitterdodge()) + 
    scale_fill_brewer(palette = "YlGnBu")+
    facet_wrap(~species)+
    theme_classic(); symbplot
```


## Biomass

View by site and timepoint for each species in the host. *Need to address negative values in dataset by removing outliers.  
```{r}
biomassHplot<-biomass_dataset %>%
  filter(!is.na(species)) %>%
  filter(partner=="Host") %>%
  ggplot(., aes(x = site, y = AFDW.mg.cm2, fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, position = position_jitterdodge()) + 
    ylim(0,15)+
    scale_fill_brewer(palette = "YlGnBu")+
    facet_wrap(~species)+
    ggtitle("Host Biomass") +
    theme_classic(); biomassHplot
```

View by site and timepoint for each species in the symbiont *Need to address negative values in dataset by removing outliers.  
```{r}
biomassSplot<-biomass_dataset %>%
  filter(!is.na(species)) %>%
  filter(partner=="Sym") %>%
  ggplot(., aes(x = site, y = AFDW.mg.cm2, fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, position = position_jitterdodge()) + 
    ylim(0,15)+
    scale_fill_brewer(palette = "YlGnBu")+
    facet_wrap(~species)+
    ggtitle("Symbiont Biomass") +
    theme_classic(); biomassSplot
```