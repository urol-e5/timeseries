---
title: "Integrating E5 time series biological data"
author: "Ariana S Huffmyer"
date: "1/18/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

```{r}
## install packages if you dont already have them
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("RColorBrewer")) install.packages("RColorBrewer")
if (!require("lme4")) install.packages("lme4")
if (!require("lmerTest")) install.packages("lmerTest")
if (!require("car")) install.packages("car")
if (!require("effects")) install.packages("effects")
if (!require("ggfortify")) install.packages("ggfortify")
if (!require("cowplot")) install.packages("cowplot")
if (!require("vegan")) install.packages("vegan")

# load packages
library(tidyverse)
library(ggplot2)
library(RColorBrewer)
library(lme4)
library(lmerTest)
library(car)
library(effects)
library(ggfortify)
library(cowplot)
library(vegan)
```
 
# Load and manipulate data  

## Loading data files   

Load all .csv files from output of all timepoints for each biological response  

```{r}
biomass_files<-list.files("../", pattern = "biomass.csv", recursive=T, full.names=T)
antioxidant_files<-list.files("../", pattern = "antioxidant_capacity.csv", recursive=T, full.names=T)
pi_curve_rate_files<-list.files("../", pattern = "pi_curve_rates.csv", recursive=T, full.names=T)
surface_area_files<-list.files("../", pattern = "surface_area.csv", recursive=T, full.names=T)
pi_curve_pars_files<-list.files("../", pattern = "pi_curve_pars.csv", recursive=T, full.names=T)
protein_files<-list.files("../", pattern = "protein.csv", recursive=T, full.names=T)
symb_densities_files<-list.files("../", pattern = "symb_densities.csv", recursive=T, full.names=T)
chlorophyll_files<-list.files("../", pattern = "chlorophyll.csv", recursive=T, full.names=T)

#need to add calcification
```


## Read data files 

Load all data frames.  

```{r}
#biomass WORKS
biomass_dataset <- data.frame()

for (i in 1:length(biomass_files)){
  biomass_df <- read.csv(biomass_files[i]) #each file will be read in
  biomass_dataset <- rbind(biomass_dataset, biomass_df) #for each iteration, bind the new data to the building dataset
}

```

```{r}
#antioxidant capacity WORKS
antioxidant_dataset <- data.frame()

for (i in 1:length(antioxidant_files)){
  antioxidant_df <- read.csv(antioxidant_files[i]) #each file will be read in
  antioxidant_dataset <- rbind(antioxidant_dataset, antioxidant_df) #for each iteration, bind the new data to the building dataset
}

```

```{r}
#PI curve rates- NOT READY
#pi_curve_rate_dataset <- data.frame()

#for (i in 1:length(pi_curve_rate_files)){
  #pi_curve_rate_df <- read.csv(pi_curve_rate_files[i]) #each file will be read in
  #pi_curve_rate_dataset <- rbind(pi_curve_rate_dataset, pi_curve_rate_df) #for each iteration, bind the new data to the building dataset
#}
```

```{r}
#surface area WORKS
surface_area_dataset <- data.frame()

for (i in 1:length(surface_area_files)){
  surface_area_df <- read.csv(surface_area_files[i]) #each file will be read in
  surface_area_dataset <- rbind(surface_area_dataset, surface_area_df) #for each iteration, bind the new data to the building dataset
}
```

```{r}
#PI Curve parameters - NOT READY
#pi_curve_pars_dataset <- data.frame()

#for (i in 1:length(pi_curve_pars_files)){
  #pi_curve_pars_df <- read.csv(pi_curve_pars_files[i]) #each file will be read in
  #pi_curve_pars_dataset <- rbind(pi_curve_pars_dataset, pi_curve_pars_df) #for each iteration, bind the new data to the building dataset
#}
```

```{r}
#protein WORKS
protein_dataset <- data.frame()

for (i in 1:length(protein_files)){
  protein_df <- read.csv(protein_files[i]) #each file will be read in
  protein_dataset <- rbind(protein_dataset, protein_df) #for each iteration, bind the new data to the building dataset
}
```

```{r}
#symb densities WORKS, NEEDS TP4
symb_densities_dataset <- data.frame()

for (i in 1:length(symb_densities_files)){
  symb_densities_df <- read.csv(symb_densities_files[i]) #each file will be read in
  symb_densities_dataset <- rbind(symb_densities_dataset, symb_densities_df) #for each iteration, bind the new data to the building dataset
}
```

```{r}
#chlorophyll files WORKS
chlorophyll_dataset <- data.frame()

for (i in 1:length(chlorophyll_files)){
  chlorophyll_df <- read.csv(chlorophyll_files[i]) #each file will be read in
  chlorophyll_dataset <- rbind(chlorophyll_dataset, chlorophyll_df) #for each iteration, bind the new data to the building dataset
}

```

```{r}
#remove files that are not needed from loops
rm(list = ls(pattern = "*_df"))
```


## Generate master data frame    

Read in metadata frame. 
```{r}
#Load tag metadata sheet 
tags<-read.csv("../metadata/coral_id_metadata.csv")
```

Prepare datasets for merging by renaming columns and spreading dataframes. Each file needs to have one line per colony per response variable in order to merge and should be without site/species columns as these will be added from metadata sheet.   
```{r}
#antioxidant data 
antioxidant_dataset<-antioxidant_dataset%>%
  select(colony_id, cre.umol.mgprot, timepoint)

#biomass data 
biomass_dataset<- biomass_dataset %>%
  filter(!colony_id=="1xPBS")%>%
  nest(value_col = c(AFDW.mg.cm2, DW.mg.cm2)) %>%
  spread(key = partner, value = value_col) %>%
  unnest(Host, Sym, .sep = '_')%>%
  select(colony_id, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Host_DW.mg.cm2, Sym_DW.mg.cm2, timepoint)

#protein data
protein_dataset<-protein_dataset%>%
  select(colony_id, prot_ug.cm2, timepoint)
  
#symbiont densitites
symb_densities_dataset<-symb_densities_dataset%>%
  select(colony_id, cells.cm2, timepoint)
```

```{r}
#need to find a more elegant solution for this
master <- full_join(full_join(full_join(full_join(full_join(
  antioxidant_dataset,
  biomass_dataset, by=c("colony_id", "timepoint")),
  chlorophyll_dataset, by=c("colony_id", "timepoint")),
  protein_dataset, by=c("colony_id", "timepoint")),
  surface_area_dataset, by=c("colony_id", "timepoint")), 
  symb_densities_dataset, by=c("colony_id", "timepoint"))

head(master)
```

Control for colony id, site name, and timepoint names. 
```{r}
#Add column for month of year for each timepoint
master$month[master$timepoint == "timepoint1"] <- "January 2020"
master$month[master$timepoint == "timepoint2"] <- "March 2020"
master$month[master$timepoint == "timepoint3"] <- "September 2020"
master$month[master$timepoint == "timepoint4"] <- "November 2020"

#replace colony id with the original tag number if the tag was changed during the timeseries, as shown by a new tag id at the end of the time series
master$colony_id_corr<-tags$Original_Tag[match(master$colony_id, tags$Tag_ID_Nov)] 

#if there is an na (because the colony tag id did not change over the timesereis), populate with the colonyid number from colony_id column
master$colony_id_corr[is.na(master$colony_id_corr)] <- master$colony_id[is.na(master$colony_id_corr)]

#match site name by site number and species from tag sheet 
master$site<-tags$Site[match(master$colony_id_corr, tags$Original_Tag)]
master$species<-tags$Coral_Species[match(master$colony_id_corr, tags$Original_Tag)]
```

Write master file to csv.  
```{r}
write_csv(master, "Output/master_timeseries.csv")
```

# Examine Responses  

## Antioxidant capacity  

### Plot 

View by site and timepoint for each species.   
```{r}
tacplot<-master %>%
  filter(!is.na(cre.umol.mgprot)) %>%
  select(colony_id_corr, species, site, timepoint, cre.umol.mgprot)%>%
  
  ggplot(., aes(x = site, y = cre.umol.mgprot, fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Copper Reducing Elements (", mu, "mol mg protein"^-1,")"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=12, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); tacplot

ggsave("Figures/Antioxidant_capacity.pdf", plot=tacplot, height=6, width=10, units = c("in"), dpi=300) #output figure
```

### Analysis  

Build a mixed model for univariate analysis and examine data distribution.

`antiox_model<-lmer(cre.umol.mgprot~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
antiox_model<-lmer(cre.umol.mgprot~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(antiox_model))
hist(residuals(antiox_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`antiox_model<-lmer(log(cre.umol.mgprot)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
antiox_model<-lmer(log(cre.umol.mgprot)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(antiox_model))
hist(residuals(antiox_model))
```

Residuals are improved, but we need to revisit this model to improve fit.  

Generate a Type II Anova of model.    

```{r}
anova(antiox_model, type="II")
```

Generate model effect plots.  

```{r}
plot(allEffects(antiox_model))
```

## Symbiont Densities  

### Plot   

View by site and timepoint for each species.   
```{r}
symbplot<-master %>%
  filter(!is.na(cells.cm2)) %>%
  select(colony_id_corr, species, site, timepoint, cells.cm2)%>%
  
  ggplot(., aes(x = site, y = cells.cm2, fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Symbiont Cells cm"^-2))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=12, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); symbplot

ggsave("Figures/Symbiont_densities.pdf", plot=symbplot, height=6, width=10, units = c("in"), dpi=300) #output figure
```
### Analysis  

Build a mixed model for univariate analysis and examine data distribution.

`density_model<-lmer(cells.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
density_model<-lmer(cells.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(density_model))
hist(residuals(density_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`density_model<-lmer(log(cells.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
density_model<-lmer(log(cells.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(density_model))
hist(residuals(density_model))
```

Residuals are improved, but we need to revisit this model to improve fit.  

Generate a Type II Anova of model.    

```{r}
anova(density_model, type="II")
```

Generate model effect plots.  

```{r}
plot(allEffects(density_model)) #currently not working, need TP4 data 
```


## Biomass
  
View by site and timepoint for each species in the host. *Need to address negative values in dataset by removing outliers.     
```{r} 
hAFDWplot<-master %>%
  filter(!is.na(Host_AFDW.mg.cm2)) %>%
  filter(!is.na(species))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  select(colony_id_corr, species, site, timepoint, Host_AFDW.mg.cm2)%>%
  
  ggplot(., aes(x = site, y = Host_AFDW.mg.cm2, fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Host Biomass (AFDW mg cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=12, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); hAFDWplot

ggsave("Figures/Host_AFDW.pdf", plot=hAFDWplot, height=6, width=10, units = c("in"), dpi=300) #output figure
```

View by site and timepoint for each species in the host. *Need to address negative values in dataset by removing outliers.    
```{r} 
sAFDWplot<-master %>%
  filter(!is.na(Sym_AFDW.mg.cm2)) %>%
  filter(!is.na(species))%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  select(colony_id_corr, species, site, timepoint, Sym_AFDW.mg.cm2)%>%
  
  ggplot(., aes(x = site, y = Sym_AFDW.mg.cm2, fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Symbiont Biomass (AFDW mg cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=12, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); sAFDWplot

ggsave("Figures/Symbiont_AFDW.pdf", plot=sAFDWplot, height=6, width=10, units = c("in"), dpi=300) #output figure
```

Calculate biomass as a ratio of host to symbiont and plot.  

```{r} 
master <- master %>% 
  mutate(Ratio_AFDW.mg.cm2=Sym_AFDW.mg.cm2/Host_AFDW.mg.cm2)

ratioAFDWplot<-master %>%
  filter(!is.na(Host_AFDW.mg.cm2)) %>%
  filter(!is.na(species))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  select(colony_id_corr, species, site, timepoint, Ratio_AFDW.mg.cm2)%>%
  
  ggplot(., aes(x = site, y = Ratio_AFDW.mg.cm2, fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Symbiont : Host Biomass"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=12, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); ratioAFDWplot

ggsave("Figures/S_H_Ratio_AFDW.pdf", plot=ratioAFDWplot, height=6, width=10, units = c("in"), dpi=300) #output figure
```

### Analysis  

Build a mixed model for univariate analysis and examine data distribution.

Host Biomass:  

`hAFDW_model<-lmer(Host_AFDW.mg.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0))` 

```{r}
hAFDW_model<-lmer(Host_AFDW.mg.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0))
qqPlot(residuals(hAFDW_model))
hist(residuals(hAFDW_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`hAFDW_model<-lmer(log(Host_AFDW.mg.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0))` 

```{r}
hAFDW_model<-lmer(log(Host_AFDW.mg.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Host_AFDW.mg.cm2>0))
qqPlot(residuals(hAFDW_model))
hist(residuals(hAFDW_model))
```

Residuals are improved, but we need to revisit this model to improve fit.  

Generate a Type II Anova of model.    

```{r}
anova(hAFDW_model, type="II")
```

Generate model effect plots.  

```{r}
plot(allEffects(hAFDW_model))
```

Symbiont Biomass:  

`sAFDW_model<-lmer(Sym_AFDW.mg.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0))` 

```{r}
sAFDW_model<-lmer(Sym_AFDW.mg.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0))
qqPlot(residuals(sAFDW_model))
hist(residuals(sAFDW_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`sAFDW_model<-lmer(log(Sym_AFDW.mg.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0))` 

```{r}
sAFDW_model<-lmer(log(Sym_AFDW.mg.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Sym_AFDW.mg.cm2>0))
qqPlot(residuals(sAFDW_model))
hist(residuals(sAFDW_model))
```

Residuals are improved, but we need to revisit this model to improve fit.  

Generate a Type II Anova of model.    

```{r}
anova(sAFDW_model, type="II")
```

Generate model effect plots.  

```{r}
plot(allEffects(sAFDW_model))
```


S:H Biomass: 

`shAFDW_model<-lmer(Ratio_AFDW.mg.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0))` 

```{r}
shAFDW_model<-lmer(Ratio_AFDW.mg.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0))
qqPlot(residuals(shAFDW_model))
hist(residuals(shAFDW_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`shAFDW_model<-lmer(log(Ratio_AFDW.mg.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0))` 

```{r}
shAFDW_model<-lmer(log(Ratio_AFDW.mg.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master, subset=c(Ratio_AFDW.mg.cm2>0))
qqPlot(residuals(shAFDW_model))
hist(residuals(shAFDW_model))
```

Residuals are improved, but we need to revisit this model to improve fit.  

Generate a Type II Anova of model.    

```{r}
anova(shAFDW_model, type="II")
```

Generate model effect plots.  

```{r}
plot(allEffects(shAFDW_model))
```

## Chlorophyll 

### Plot  

View by site and timepoint for each species in Chl a.    
```{r}
chlaplot<-master %>%
  filter(!is.na(chla.ug.cm2)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site, timepoint, chla.ug.cm2)%>%
  
  ggplot(., aes(x = site, y = chla.ug.cm2, fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Chlorophyll a (", mu, "g cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=12, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); chlaplot

ggsave("Figures/Chl_a.pdf", plot=chlaplot, height=6, width=10, units = c("in"), dpi=300) #output figure
```

View by site and timepoint for each species in Chl c2.   
```{r}
chlcplot<-master %>%
  filter(!is.na(chlc2.ug.cm2)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site, timepoint, chlc2.ug.cm2)%>%
  
  ggplot(., aes(x = site, y = chlc2.ug.cm2, fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Chlorophyll c2 (", mu, "g cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=12, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); chlcplot

ggsave("Figures/Chl_c2.pdf", plot=chlcplot, height=6, width=10, units = c("in"), dpi=300) #output figure
```

### Analysis  

Build a mixed model for univariate analysis and examine data distribution.

Chlorophyll a: 

`chla_model<-lmer(chla.ug.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
chla_model<-lmer(chla.ug.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(chla_model))
hist(residuals(chla_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`chla_model<-lmer(log(chla.ug.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
chla_model<-lmer(log(chla.ug.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(chla_model))
hist(residuals(chla_model))
```

Generate a Type II Anova of model.    

```{r}
anova(chla_model, type="II")
```

Generate model effect plots.  

```{r}
plot(allEffects(chla_model))
```


Chlorophyll c2: 

Build a mixed model for univariate analysis and examine data distribution.

`chlc2_model<-lmer(chlc2.ug.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
chlc2_model<-lmer(chlc2.ug.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(chlc2_model))
hist(residuals(chlc2_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`chlc2_model<-lmer(log(chlc2.ug.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
chlc2_model<-lmer(log(chlc2.ug.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(chlc2_model))
hist(residuals(chlc2_model))
```

Return to check outliers in this model.  

Generate a Type II Anova of model.    

```{r}
anova(chlc2_model, type="II")
```

Generate model effect plots.  

```{r}
plot(allEffects(chlc2_model))
```


## Protein 

### Plot  

View by site and timepoint for each species.    
```{r}
protplot<-master %>%
  filter(!is.na(prot_ug.cm2)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site, timepoint, prot_ug.cm2)%>%
  
  ggplot(., aes(x = site, y = prot_ug.cm2, fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Protein (", mu, "g cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=12, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); protplot

ggsave("Figures/Protein.pdf", plot=protplot, height=6, width=10, units = c("in"), dpi=300) #output figure
```

### Analysis  

Build a mixed model for univariate analysis and examine data distribution.

`prot_model<-lmer(prot_ug.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
prot_model<-lmer(prot_ug.cm2~timepoint*species*site+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(prot_model))
hist(residuals(prot_model))
```

Residuals are not normally distributed. Attempt with log transformation.      

`prot_model<-lmer(log(prot_ug.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)` 

```{r}
prot_model<-lmer(log(prot_ug.cm2)~timepoint*site*species+(1|colony_id_corr), na.action=na.omit, data=master)
qqPlot(residuals(prot_model))
hist(residuals(prot_model))
```

Return to check outliers in this model.  

Generate a Type II Anova of model.    

```{r}
anova(prot_model, type="II")
```

Generate model effect plots.  

```{r}
plot(allEffects(prot_model))
```

# Multivariate analyses  

## PCA  

### All species PCA's  

Plot PCA using prcomp to center and scale.    

```{r}
pca_data<-master%>%
  select(colony_id_corr, timepoint, species, site, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2,chla.ug.cm2, chlc2.ug.cm2, prot_ug.cm2, cells.cm2)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)

pca_data<-pca_data[complete.cases(pca_data), ]

scaled_data<-prcomp(pca_data[c(5:11)], scale=TRUE, center=TRUE) 
```

Groupings by species:  
```{r}
pcaSpecies<-ggplot2::autoplot(scaled_data, data=pca_data, frame.colour="species", loadings=TRUE,  colour="species", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  scale_colour_manual(values=c("orange", "darkgray", "purple")) +
  scale_fill_manual(values=c("orange", "darkgray", "purple")) + 
  theme_classic()+
  xlim(-0.2,0.5)+
  ylim(-0.2, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaSpecies

#ggsave("Figures/PCA_species.pdf", plot=pcaSpecies, height=8, width=10, units = c("in"), dpi=300) #output figure
```

PERMANOVA of the effect of species  
```{r}
# scale data
vegan <- scale(pca_data[ ,5:11])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan ~ species, data = pca_data, method='eu')
```


Groupings by timepoint:  
```{r}
pcaTimepoint<-ggplot2::autoplot(scaled_data, data=pca_data, frame.colour="timepoint", loadings=TRUE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) + 
  theme_classic()+
  xlim(-0.2,0.5)+
  ylim(-0.2, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaTimepoint

#ggsave("Figures/PCA_timepoint.pdf", plot=pcaTimepoint, height=8, width=10, units = c("in"), dpi=300) #output figure
```

PERMANOVA of the effect of timepoint  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan ~ timepoint, data = pca_data, method='eu')
```

Groupings by site:  
```{r}
pcaSite<-ggplot2::autoplot(scaled_data, data=pca_data, frame.colour="site", loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  xlim(-0.2,0.5)+
  ylim(-0.2, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pcaSite

#ggsave("Figures/PCA_site.pdf", plot=pcaTimepoint, height=8, width=10, units = c("in"), dpi=300) #output figure
```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan ~ site, data = pca_data, method='eu')
```

Generate a plot of all PCA's for full dataset.  

```{r}
pcaplots<-plot_grid(pcaSpecies, pcaSite, pcaTimepoint, labels = c("Species", "Site", "Timepoint"), ncol=3, nrow=1, rel_widths = c(1, 1, 1), label_size = 20, label_x = 0.1)

ggsave(filename="Figures/All_PCAs.pdf", plot=pcaplots, dpi=300, width=24, height=5, units="in")
```  

Next generate PCA for site and timepoint for each species separately.  

Separate by species.  
```{r}
#porites
por_data<-master%>%
  select(colony_id_corr, timepoint, species, site, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2,chla.ug.cm2, chlc2.ug.cm2, prot_ug.cm2, cells.cm2)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Porites")

por_data<-por_data[complete.cases(por_data), ]

scaled_por<-prcomp(por_data[c(5:11)], scale=TRUE, center=TRUE) 

#acropora
acr_data<-master%>%
  select(colony_id_corr, timepoint, species, site, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2,chla.ug.cm2, chlc2.ug.cm2, prot_ug.cm2, cells.cm2)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Acropora")

acr_data<-acr_data[complete.cases(acr_data), ]

scaled_acr<-prcomp(acr_data[c(5:11)], scale=TRUE, center=TRUE) 

#pocillopora
poc_data<-master%>%
  select(colony_id_corr, timepoint, species, site, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2,chla.ug.cm2, chlc2.ug.cm2, prot_ug.cm2, cells.cm2)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Pocillopora")

poc_data<-poc_data[complete.cases(poc_data), ]

scaled_poc<-prcomp(poc_data[c(5:11)], scale=TRUE, center=TRUE) 
```

### Porites PCA's   

Groupings by timepoint:  
```{r}
porTimepoint<-ggplot2::autoplot(scaled_por, data=por_data, frame.colour="timepoint", loadings=TRUE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) + 
  theme_classic()+
  xlim(-0.7,0.5)+
  ylim(-0.7, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));porTimepoint
```

PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan <- scale(por_data[ ,5:11])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan ~ timepoint, data = por_data, method='eu')
```

Groupings by site:  
```{r}
porSite<-ggplot2::autoplot(scaled_por, data=por_data, frame.colour="site", loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  xlim(-0.7,0.5)+
  ylim(-0.7, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));porSite
```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan ~ site, data = por_data, method='eu')
```

Generate a plot of all PCA's for Porites.    

```{r}
por_plots<-plot_grid(porSite, porTimepoint, labels = c("Porites", ""), ncol=2, nrow=1, rel_widths = c(1, 1), label_size = 20, label_x = 0.1, label_y=1.0)

ggsave(filename="Figures/POR_PCAs.pdf", plot=por_plots, dpi=300, width=18, height=5, units="in")
```  

### Acropora PCA's  
 
Groupings by timepoint:  
```{r}
acrTimepoint<-ggplot2::autoplot(scaled_acr, data=acr_data, frame.colour="timepoint", loadings=TRUE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) + 
  theme_classic()+
  xlim(-0.5,0.5)+
  ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));acrTimepoint
```

PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan <- scale(acr_data[ ,5:11])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan ~ timepoint, data = acr_data, method='eu')
```

Groupings by site:  
```{r}
acrSite<-ggplot2::autoplot(scaled_acr, data=acr_data, frame.colour="site", loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  xlim(-0.5,0.5)+
  ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));acrSite
```

PERMANOVA of the effect of site  
```{r}
# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan ~ site, data = acr_data, method='eu')
```

Generate a plot of all PCA's for Acropora.      

```{r}
acr_plots<-plot_grid(acrSite, acrTimepoint, labels = c("Acropora", ""), ncol=2, nrow=1, rel_widths = c(1, 1), label_size = 20, label_x = 0.1, label_y=1.0)

ggsave(filename="Figures/ACR_PCAs.pdf", plot=acr_plots, dpi=300, width=18, height=5, units="in")
``` 

### Pocillopora PCA's  

Groupings by timepoint:   
```{r}
pocTimepoint<-ggplot2::autoplot(scaled_poc, data=poc_data, frame.colour="timepoint", loadings=TRUE,  colour="timepoint", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  scale_colour_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) +
  scale_fill_manual(values=c("darkturquoise", "darkgray", "mediumvioletred"), labels=c("Jan2020", "March2020", "Sept2020")) + 
  theme_classic()+
  xlim(-0.5,0.5)+
  ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pocTimepoint
```
 
PERMANOVA of the effect of timepoint  
```{r}
# scale data
vegan <- scale(poc_data[ ,5:11])

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan ~ timepoint, data = poc_data, method='eu')
```

Groupings by site:  
```{r}
pocSite<-ggplot2::autoplot(scaled_poc, data=poc_data, frame.colour="site", loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=TRUE, loadings.label.size=5, loadings.label.vjust=-1, size=5) + 
  scale_colour_manual(values=c("blue4", "darkgray", "springgreen3")) +
  scale_fill_manual(values=c("blue4", "darkgray", "springgreen3")) + 
  theme_classic()+
  xlim(-0.5,0.5)+
  ylim(-0.5, 0.5)+
   theme(legend.text = element_text(size=18), 
         legend.position="right",
        plot.background = element_blank(),
        legend.title = element_text(size=18, face="bold"), 
        axis.text = element_text(size=18), 
        axis.title = element_text(size=18,  face="bold"));pocSite
```

PERMANOVA of the effect of site  
```{r}

# PerMANOVA - partitioning the euclidean distance matrix by species
adonis(vegan ~ site, data = poc_data, method='eu')
```

Generate a plot of all PCA's for Pocillopora    

```{r}
poc_plots<-plot_grid(pocSite, pocTimepoint, labels = c("Pocillopora", ""), ncol=2, nrow=1, rel_widths = c(1, 1), label_size = 20, label_x = 0.1, label_y=1.0)

ggsave(filename="Figures/POC_PCAs.pdf", plot=poc_plots, dpi=300, width=18, height=5, units="in")
``` 

