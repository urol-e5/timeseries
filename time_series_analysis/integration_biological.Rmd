---
title: "Integrating E5 time series biological data"
author: "Ariana S Huffmyer"
date: "1/18/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

```{r}
## install packages if you dont already have them
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("RColorBrewer")) install.packages("RColorBrewer")

# load packages
library(tidyverse)
library(ggplot2)
library(RColorBrewer)
```
 
# Load and manipulate data  

## Loading data files   

Load all .csv files from output of all timepoints for each biological response  

```{r}
biomass_files<-list.files("../", pattern = "biomass.csv", recursive=T, full.names=T)
antioxidant_files<-list.files("../", pattern = "antioxidant_capacity.csv", recursive=T, full.names=T)
pi_curve_rate_files<-list.files("../", pattern = "pi_curve_rates.csv", recursive=T, full.names=T)
surface_area_files<-list.files("../", pattern = "surface_area.csv", recursive=T, full.names=T)
pi_curve_pars_files<-list.files("../", pattern = "pi_curve_pars.csv", recursive=T, full.names=T)
protein_files<-list.files("../", pattern = "protein.csv", recursive=T, full.names=T)
symb_densities_files<-list.files("../", pattern = "symb_densities.csv", recursive=T, full.names=T)
chlorophyll_files<-list.files("../", pattern = "chlorophyll.csv", recursive=T, full.names=T)

#need to add calcification
```


## Read data files 

Load all data frames.  

```{r}
#biomass WORKS
biomass_dataset <- data.frame()

for (i in 1:length(biomass_files)){
  biomass_df <- read.csv(biomass_files[i]) #each file will be read in
  biomass_dataset <- rbind(biomass_dataset, biomass_df) #for each iteration, bind the new data to the building dataset
}

```

```{r}
#antioxidant capacity WORKS
antioxidant_dataset <- data.frame()

for (i in 1:length(antioxidant_files)){
  antioxidant_df <- read.csv(antioxidant_files[i]) #each file will be read in
  antioxidant_dataset <- rbind(antioxidant_dataset, antioxidant_df) #for each iteration, bind the new data to the building dataset
}

```

```{r}
#PI curve rates- NOT READY
#pi_curve_rate_dataset <- data.frame()

#for (i in 1:length(pi_curve_rate_files)){
  #pi_curve_rate_df <- read.csv(pi_curve_rate_files[i]) #each file will be read in
  #pi_curve_rate_dataset <- rbind(pi_curve_rate_dataset, pi_curve_rate_df) #for each iteration, bind the new data to the building dataset
#}
```

```{r}
#surface area WORKS
surface_area_dataset <- data.frame()

for (i in 1:length(surface_area_files)){
  surface_area_df <- read.csv(surface_area_files[i]) #each file will be read in
  surface_area_dataset <- rbind(surface_area_dataset, surface_area_df) #for each iteration, bind the new data to the building dataset
}
```

```{r}
#PI Curve parameters - NOT READY
#pi_curve_pars_dataset <- data.frame()

#for (i in 1:length(pi_curve_pars_files)){
  #pi_curve_pars_df <- read.csv(pi_curve_pars_files[i]) #each file will be read in
  #pi_curve_pars_dataset <- rbind(pi_curve_pars_dataset, pi_curve_pars_df) #for each iteration, bind the new data to the building dataset
#}
```

```{r}
#protein WORKS
protein_dataset <- data.frame()

for (i in 1:length(protein_files)){
  protein_df <- read.csv(protein_files[i]) #each file will be read in
  protein_dataset <- rbind(protein_dataset, protein_df) #for each iteration, bind the new data to the building dataset
}
```

```{r}
#symb densities WORKS, NEEDS TP4
symb_densities_dataset <- data.frame()

for (i in 1:length(symb_densities_files)){
  symb_densities_df <- read.csv(symb_densities_files[i]) #each file will be read in
  symb_densities_dataset <- rbind(symb_densities_dataset, symb_densities_df) #for each iteration, bind the new data to the building dataset
}
```

```{r}
#chlorophyll files WORKS
chlorophyll_dataset <- data.frame()

for (i in 1:length(chlorophyll_files)){
  chlorophyll_df <- read.csv(chlorophyll_files[i]) #each file will be read in
  chlorophyll_dataset <- rbind(chlorophyll_dataset, chlorophyll_df) #for each iteration, bind the new data to the building dataset
}

```

```{r}
#remove files that are not needed from loops
rm(list = ls(pattern = "*_df"))
```


## Generate master data frame    

Read in metadata frame. 
```{r}
#Load tag metadata sheet 
tags<-read.csv("../metadata/coral_id_metadata.csv")
```

Prepare datasets for merging by renaming columns and spreading dataframes. Each file needs to have one line per colony per response variable in order to merge and should be without site/species columns as these will be added from metadata sheet.   
```{r}
#antioxidant data 
antioxidant_dataset<-antioxidant_dataset%>%
  select(colony_id, cre.umol.mgprot, timepoint)

#biomass data 
biomass_dataset<- biomass_dataset %>%
  filter(!colony_id=="1xPBS")%>%
  nest(AFDW.mg.cm2, DW.mg.cm2, .key = 'value_col') %>%
  spread(key = partner, value = value_col) %>%
  unnest(Host, Sym, .sep = '_')%>%
  select(colony_id, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Host_DW.mg.cm2, Sym_DW.mg.cm2, timepoint)

#protein data
protein_dataset<-protein_dataset%>%
  select(colony_id, prot_ug.cm2, timepoint)
  
#symbiont densitites
symb_densities_dataset<-symb_densities_dataset%>%
  select(colony_id, cells.cm2, timepoint)
```

```{r}
#need to find a more elegant solution for this
master <- full_join(full_join(full_join(full_join(full_join(
  antioxidant_dataset,
  biomass_dataset, by=c("colony_id", "timepoint")),
  chlorophyll_dataset, by=c("colony_id", "timepoint")),
  protein_dataset, by=c("colony_id", "timepoint")),
  surface_area_dataset, by=c("colony_id", "timepoint")), 
  symb_densities_dataset, by=c("colony_id", "timepoint"))

head(master)
```

Control for colony id, site name, and timepoint names. 
```{r}
#Add column for month of year for each timepoint
master$month[master$timepoint == "timepoint1"] <- "January 2020"
master$month[master$timepoint == "timepoint2"] <- "March 2020"
master$month[master$timepoint == "timepoint3"] <- "September 2020"
master$month[master$timepoint == "timepoint4"] <- "November 2020"

#replace colony id with the original tag number if the tag was changed during the timeseries, as shown by a new tag id at the end of the time series
master$colony_id_corr<-tags$Original_Tag[match(master$colony_id, tags$Tag_ID_Nov)] 

#if there is an na (because the colony tag id did not change over the timesereis), populate with the colonyid number from colony_id column
master$colony_id_corr[is.na(master$colony_id_corr)] <- master$colony_id[is.na(master$colony_id_corr)]

#match site name by site number and species from tag sheet 
master$site<-tags$Site[match(master$colony_id_corr, tags$Original_Tag)]
master$species<-tags$Coral_Species[match(master$colony_id_corr, tags$Original_Tag)]
```
 
# Examine Responses  

## Antioxidant capacity  

View by site and timepoint for each species.   
```{r}
tacplot<-master %>%
  filter(!is.na(cre.umol.mgprot)) %>%
  select(colony_id_corr, species, site, timepoint, cre.umol.mgprot)%>%
  
  ggplot(., aes(x = site, y = cre.umol.mgprot, fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Copper Reducing Elements (", mu, "mol mg protein"^-1,")"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=12, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); tacplot

ggsave("Figures/Antioxidant_capacity.pdf", plot=tacplot, height=6, width=10, units = c("in"), dpi=300) #output figure
```



## Symbiont Densities  

View by site and timepoint for each species.   
```{r}
symbplot<-master %>%
  filter(!is.na(cells.cm2)) %>%
  select(colony_id_corr, species, site, timepoint, cells.cm2)%>%
  
  ggplot(., aes(x = site, y = cells.cm2, fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Symbiont Cells cm"^-2))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=12, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); symbplot

ggsave("Figures/Symbiont_densities.pdf", plot=symbplot, height=6, width=10, units = c("in"), dpi=300) #output figure
```


## Biomass
 
View by site and timepoint for each species in the host. *Need to address negative values in dataset by removing outliers.    
```{r} 
hAFDWplot<-master %>%
  filter(!is.na(Host_AFDW.mg.cm2)) %>%
  filter(!is.na(species))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  select(colony_id_corr, species, site, timepoint, Host_AFDW.mg.cm2)%>%
  
  ggplot(., aes(x = site, y = Host_AFDW.mg.cm2, fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Host Biomass (AFDW mg cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=12, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); hAFDWplot

ggsave("Figures/Host_AFDW.pdf", plot=hAFDWplot, height=6, width=10, units = c("in"), dpi=300) #output figure
```

View by site and timepoint for each species in the host. *Need to address negative values in dataset by removing outliers.    
```{r} 
sAFDWplot<-master %>%
  filter(!is.na(Sym_AFDW.mg.cm2)) %>%
  filter(!is.na(species))%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  select(colony_id_corr, species, site, timepoint, Sym_AFDW.mg.cm2)%>%
  
  ggplot(., aes(x = site, y = Sym_AFDW.mg.cm2, fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Symbiont Biomass (AFDW mg cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=12, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); sAFDWplot

ggsave("Figures/Symbiont_AFDW.pdf", plot=sAFDWplot, height=6, width=10, units = c("in"), dpi=300) #output figure
```

Calculate biomass as a ratio of host to symbiont and plot.  

```{r} 
ratioAFDWplot<-master %>%
  filter(!is.na(Host_AFDW.mg.cm2)) %>%
  filter(!is.na(species))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  mutate(Ratio_AFDW.mg.cm2=Host_AFDW.mg.cm2/Sym_AFDW.mg.cm2)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  select(colony_id_corr, species, site, timepoint, Ratio_AFDW.mg.cm2)%>%
  
  ggplot(., aes(x = site, y = Ratio_AFDW.mg.cm2, fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Host : Symbiont Biomass"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=12, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); ratioAFDWplot

ggsave("Figures/H_S_Ratio_AFDW.pdf", plot=ratioAFDWplot, height=6, width=10, units = c("in"), dpi=300) #output figure
```

## Chlorophyll 

View by site and timepoint for each species in Chl a.   
```{r}
chlaplot<-master %>%
  filter(!is.na(chla.ug.cm2)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site, timepoint, chla.ug.cm2)%>%
  
  ggplot(., aes(x = site, y = chla.ug.cm2, fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Chlorophyll a (", mu, "g cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=12, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); chlaplot

ggsave("Figures/Chl_a.pdf", plot=chlaplot, height=6, width=10, units = c("in"), dpi=300) #output figure
```

View by site and timepoint for each species in Chl c2.   
```{r}
chlcplot<-master %>%
  filter(!is.na(chlc2.ug.cm2)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site, timepoint, chlc2.ug.cm2)%>%
  
  ggplot(., aes(x = site, y = chlc2.ug.cm2, fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Chlorophyll c2 (", mu, "g cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=12, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); chlcplot

ggsave("Figures/Chl_c2.pdf", plot=chlcplot, height=6, width=10, units = c("in"), dpi=300) #output figure
```
## Protein 

View by site and timepoint for each species.   
```{r}
protplot<-master %>%
  filter(!is.na(prot_ug.cm2)) %>%
  filter(!is.na(species)) %>%
  select(colony_id_corr, species, site, timepoint, prot_ug.cm2)%>%
  
  ggplot(., aes(x = site, y = prot_ug.cm2, fill = timepoint, group=interaction(site,timepoint))) +
    geom_boxplot(outlier.size = 0) +
    geom_point(pch = 21, size=2, position = position_jitterdodge(0.2)) + 
    scale_fill_manual(values = brewer.pal(4,"YlGnBu"), limits=c("timepoint1", "timepoint2", "timepoint3", "timepoint4"), labels=c("January 2020", "March 2020", "September 2020", "November 2020"))+
    labs(fill = "Month") +
    facet_wrap(~species) +
    xlab("Site") + 
    ylab(expression(bold(paste("Protein (", mu, "g cm"^-2, ")"))))+
    theme_classic() + 
    theme(
      legend.title=element_text(face="bold", size=14),
      legend.text=element_text(size=14),
      axis.title=element_text(face="bold", size=14),
      axis.text=element_text(size=12, color="black"), 
      strip.text.x=element_text(face="italic", size=14)
      ); protplot

ggsave("Figures/Protein.pdf", plot=protplot, height=6, width=10, units = c("in"), dpi=300) #output figure
```
