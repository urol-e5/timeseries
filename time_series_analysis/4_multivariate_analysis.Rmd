---
title: "Multivariate analysis of E5 time series biological data"
author: "Ariana S Huffmyer, E5 RoL Team"
date: "08/1/2023"
output: 
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
editor_options: 
  chunk_output_type: console
---

Definitions: 

- Genus (Pocillopora, Acropora, and Porites) are coded as "species"
- Haplotype are coded as "haplotype". In the manuscript document, haplotype is referred to as "holobiont" because the host genetic haplotype and the associated symbiont communities are exclusive. 
- Biological levels are categorized in the code as all host and symbiont metrics together "holobiont" (i.e., "combined responses" in the manuscript to avoid confusion with above mentioned definition of holobiont), host metrics as "host", and symbiont metrics as "symbiont". 
- Time point is coded for seasonal sampling (January, March, September, and November) as "timepoint"
- Site is coded as "site"  

# Set Up    
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

```{r}
## install packages if you dont already have them
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("RColorBrewer")) install.packages("RColorBrewer")
if (!require("lme4")) install.packages("lme4")
if (!require("lmerTest")) install.packages("lmerTest")
if (!require("car")) install.packages("car")
if (!require("effects")) install.packages("effects")
if (!require("ggfortify")) install.packages("ggfortify")
if (!require("cowplot")) install.packages("cowplot")
if (!require("vegan")) install.packages("vegan")
if (!require("corrr")) install.packages("corrr")
if (!require("ggcorrplot")) install.packages("ggcorrplot")
if (!require("GGally")) install.packages("GGally")
if (!require("broom")) install.packages("broom")
if (!require("cowplot")) install.packages("cowplot")
if (!require("pairwiseAdonis")) install.packages("pairwiseAdonis")
if (!require("MicEco")) remotes::install_github("Russel88/MicEco")

# load packages
library(tidyverse)
library(ggplot2)
library(RColorBrewer)
library(lme4)
library(lmerTest)
library(car)
library(effects)
library(ggfortify)
library(cowplot)
library(vegan)
library(corrr)
library(ggcorrplot)
library(GGally)
library(broom)
library(cowplot)
library(pairwiseAdonis)
library(MicEco)
```

# Load dataframe

Load in master dataframe generated from 1_assemble_data.Rmd.  
```{r}
master<-read.csv("Output/master_timeseries.csv")

#reorder site levels 
master$site_code<-as.factor(master$site_code)
master$site_code<-fct_relevel(master$site_code, "Mahana Low", "Hilton Medium", "Manava High")

master$site<-fct_relevel(master$site, "Mahana", "Hilton", "Manava")

master<-master%>%
  mutate(site=if_else(site=="Mahana", "Orovau",
                      if_else(site=="Hilton", "Vaipahu", 
                              if_else(site=="Manava", "Matotia", NA))))

master<-master%>%
  select(!code)
```

Set seed for permutation tests (randomly picked). 
```{r}
set.seed(2534)
```

# Build trajectory PCA plots  

## Holobiont Responses 

### PCA's for centroid and trajectories  

#### Acropora  

Generate PCA using scaled (scaled_acr_afdw) from dataframe (acr_data_afdw).   
 
```{r}
acr_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, Total_Chl, Total_Chl_cell, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd, Ik, Ic, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Acropora")%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)

acr_data_afdw<-acr_data_afdw[complete.cases(acr_data_afdw), ]

acr_data_afdw[,-c(1:4)]<-log(acr_data_afdw[,-c(1:4)]+1)

scaled_acr_afdw<-prcomp(acr_data_afdw[c(5:18)], scale=TRUE, center=TRUE) 

acr_info<-acr_data_afdw[c(2,4)]

acr_data<-scaled_acr_afdw%>%
  augment(acr_info)%>%
  group_by(timepoint, site)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

acr.centroids<-acr_data %>% 
  select(timepoint, site, PC1.mean, PC2.mean)%>%
  group_by(timepoint, site)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
```

Examine PERMANOVA results.  
 
```{r}
# scale data
vegan <- scale(acr_data_afdw[ ,5:18])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis2(vegan ~ timepoint*site, data = acr_data_afdw, method='eu')
z_acr<-permanova
z_acr
``` 

adonis2(formula = vegan ~ timepoint * site, data = acr_data_afdw, method = "eu")
                Df SumOfSqs      R2       F Pr(>F)    
timepoint        3   423.98 0.29984 15.6680  0.001 ***
site             2    95.01 0.06719  5.2666  0.001 ***
timepoint:site   6    83.20 0.05884  1.5374  0.025 *  
Residual        90   811.81 0.57412                   
Total          101  1414.00 1.00000  

Calculate Omega effect sizes for site and time point. 
```{r}
adonis_OmegaSq(z_acr, partial = TRUE)
```

adonis2(formula = vegan ~ timepoint * site, data = acr_data_afdw, method = "eu")
                Df SumOfSqs       F parOmegaSq Pr(>F)    
timepoint        3   423.98 15.6680    0.30139  0.001 ***
site             2    95.01  5.2666    0.07720  0.001 ***
timepoint:site   6    83.20  1.5374    0.03064  0.038 *  
Residual        90   811.81                              
Total          101  1414.00 

Examine dispersion for this model by site 
```{r}
#conduct pairwise adonis to look at pairwise permanova comparisons
pairwise.adonis(x=acr_data_afdw[ ,5:18],factors=acr_data_afdw$site, sim.function="vegdist",  sim.method='euclidean', p.adjust.m='bonferroni')

#evaluate dispersion
beta_site<-betadisper(vegdist(acr_data_afdw[ ,5:18], "euclidian"), acr_data_afdw$site)
anova(beta_site)

#conduct posthoc analysis of betadispersion
TukeyHSD(beta_site)
```
There is a difference in dispersion by site, so therefore differences are likely due to both dispersion and centroid location. 

Examine dispersion for this model by season 
```{r}
#conduct pairwise adonis to look at pairwise permanova comparisons
pairwise.adonis(x=acr_data_afdw[ ,5:18],factors=acr_data_afdw$timepoint, sim.function="vegdist",  sim.method='euclidean', p.adjust.m='bonferroni')

#evaluate dispersion
beta_time<-betadisper(vegdist(acr_data_afdw[ ,5:18], "euclidian"), acr_data_afdw$timepoint)
anova(beta_time)

#conduct posthoc analysis of betadispersion
TukeyHSD(beta_time)
```
There is no difference in dispersion between time points, therefore differences are due to centroid location. 

Assemble plot with background points 
```{r}
#1. make plot with dots
acrPCA<-ggplot(acr_data, aes(.fittedPC1, .fittedPC2, color=site)) + 
  geom_point(size = 4, alpha=0.2, show.legend=FALSE)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  ylim(-8,8)+
  xlim(-8,8)+
  ylab("PC2")+
  xlab("PC1")+
  ggtitle(expression(italic("Acropora")))+
  #geom_text(x=3, y=5.5, label=paste("T=",z_acr$`Pr(>F)`[1]), size=6, color=ifelse(z_acr$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  #geom_text(x=3, y=4.75, label=paste("S=",z_acr$`Pr(>F)`[2]), size=6, color=ifelse(z_acr$`Pr(>F)`[2] < 0.05, "black", "darkgray")) + 
  #geom_text(x=3, y=4, label=paste("TxS=",z_acr$`Pr(>F)`[3]), size=6, color=ifelse(z_acr$`Pr(>F)`[3] < 0.05, "black", "darkgray")) + 
  #geom_text(x=3, y=5.5, label="T=0.001", size=6, color="black") + 
  #geom_text(x=3, y=4.75, label="S=0.001", size=6, color="black") + 
  #geom_text(x=3, y=4, label="TxS=0.025", size=6, color="black") + 
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         title = element_text(size=25, face="bold"), 
         axis.title = element_text(size=18));acrPCA

```

Add centroids  

```{r}
#2. add centroids 
acrPCAcen<-acrPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site), data=acr.centroids, size=3, show.legend=FALSE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="none"); acrPCAcen

```

Add segments

```{r}
#3. add segments
segpoints<-acr.centroids%>%
  gather(variable, value, -(timepoint:site)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
acrPCAfull<-acrPCAcen + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = site), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = site), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = site), data = segpoints, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); acrPCAfull
```

Make bi plot with loadings  
```{r}
#1. make plot with dots
acrArrows<-ggplot2::autoplot(scaled_acr_afdw, data=acr_data_afdw, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=3.5, loadings.label.vjust=0.5, loadings.label.hjust=-0.1, loadings.label.repel=FALSE, size=4, alpha=0.0) + 
  #geom_point(aes(fill=site, colour=site), alpha=0.2)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle(expression(italic("Acropora")))+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         #axis.text.x=element_blank(),
         #axis.text.y=element_blank(),
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         title = element_text(size=25, face="bold"),
         axis.title = element_text(size=20));acrArrows
```

#### Porites

Generate PCA using scaled (scaled_por_afdw) from dataframe (por_data_afdw).   
 
Calculate centroid locations for each site and timepoint and pull PC1 and PC2 locations.     
```{r}
por_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site, haplotype, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, Total_Chl, Total_Chl_cell, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd, Ik, Ic, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Porites")%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  filter(Ic<1000)%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)

por_data_afdw<-por_data_afdw[complete.cases(por_data_afdw), ]

por_data_afdw[,-c(1:5)]<-log(por_data_afdw[,-c(1:5)]+1)

scaled_por_afdw<-prcomp(por_data_afdw[c(6:19)], scale=TRUE, center=TRUE) 

por_info<-por_data_afdw[c(2,4)]

por_data<-scaled_por_afdw%>%
  augment(por_info)%>%
  group_by(timepoint, site)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

por.centroids<-por_data %>% 
  select(timepoint, site, PC1.mean, PC2.mean)%>%
  group_by(timepoint, site)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
```

```{r}
# scale data
vegan <- scale(por_data_afdw[ ,6:19])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis2(vegan ~ haplotype + timepoint*site, data = por_data_afdw, method='eu')
z_por<-permanova
z_por
```

adonis2(formula = vegan ~ haplotype + timepoint * site, data = por_data_afdw, method = "eu")
                Df SumOfSqs      R2       F Pr(>F)    
haplotype        1   258.36 0.13373 28.0498  0.001 ***
timepoint        3   329.09 0.17034 11.9098  0.001 ***
site             2    75.05 0.03885  4.0742  0.001 ***
timepoint:site   6   108.94 0.05639  1.9713  0.001 ***
Residual       126  1160.55 0.60070                   
Total          138  1932.00 1.00000  

Calculate Omega effect sizes for site and time point. 
```{r}
adonis_OmegaSq(z_por, partial = TRUE)
```

Examine dispersion for this model by site 
```{r}
#conduct pairwise adonis to look at pairwise permanova comparisons
pairwise.adonis(x=por_data_afdw[ ,6:19],factors=por_data_afdw$site, sim.function="vegdist",  sim.method='euclidean', p.adjust.m='bonferroni')

#evaluate dispersion
beta_site<-betadisper(vegdist(por_data_afdw[ ,6:19], "euclidian"), por_data_afdw$site)
anova(beta_site)

#conduct posthoc analysis of betadispersion
TukeyHSD(beta_site)
```
There is a difference in dispersion by site, so therefore differences are likely due to both dispersion and centroid location. 

Examine dispersion for this model by season 
```{r}
#conduct pairwise adonis to look at pairwise permanova comparisons
pairwise.adonis(x=por_data_afdw[ ,6:19],factors=por_data_afdw$timepoint, sim.function="vegdist",  sim.method='euclidean', p.adjust.m='bonferroni')

#evaluate dispersion
beta_time<-betadisper(vegdist(por_data_afdw[ ,6:19], "euclidian"), por_data_afdw$timepoint)
anova(beta_time)

#conduct posthoc analysis of betadispersion
TukeyHSD(beta_time)
```
There is no difference in dispersion between time points, therefore differences are due to centroid location. 

Examine dispersion for this model by haplotype 
```{r}
#conduct pairwise adonis to look at pairwise permanova comparisons
pairwise.adonis(x=por_data_afdw[ ,6:19],factors=por_data_afdw$haplotype, sim.function="vegdist",  sim.method='euclidean', p.adjust.m='bonferroni')

#evaluate dispersion
beta_haplo<-betadisper(vegdist(por_data_afdw[ ,6:19], "euclidian"), por_data_afdw$haplotype)
anova(beta_haplo)

#conduct posthoc analysis of betadispersion
TukeyHSD(beta_haplo)
```
There is no difference in dispersion between haplotypes, therefore differences are due to centroid location.

Assemble plot with background points
```{r}
#1. make plot with dots
porPCA<-ggplot(por_data, aes(.fittedPC1, .fittedPC2, color=site)) + 
  geom_point(size = 4, alpha=0.2, show.legend=FALSE)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  ylab("PC2")+
  xlab("PC1")+
 ylim(-8,8)+
  xlim(-8,8)+
  ggtitle(expression(italic("Porites")))+
  #geom_text(x=3, y=5.5, label=paste("T=",z_por$`Pr(>F)`[1]), size=6, color=ifelse(z_por$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  #geom_text(x=3, y=4.75, label=paste("S=",z_por$`Pr(>F)`[2]), size=6, color=ifelse(z_por$`Pr(>F)`[2] < 0.05, "black", "darkgray")) + 
  #geom_text(x=3, y=4, label=paste("TxS=",z_por$`Pr(>F)`[3]), size=6, color=ifelse(z_por$`Pr(>F)`[3] < 0.05, "black", "darkgray")) + 
  #geom_text(x=3, y=5.5, label="T=0.001", size=6, color="black") + 
  #geom_text(x=3, y=4.75, label="S=0.001", size=6, color="black") + 
  #geom_text(x=3, y=4, label="TxS=0.001", size=6, color="black") + 
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         legend.title = element_blank(), 
         axis.text = element_text(size=18), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         title = element_text(size=25, face="bold"),
         axis.title = element_text(size=18,  face="bold"));porPCA
```

Add centroids  

```{r}
#2. add centroids 
porPCAcen<-porPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site), data=por.centroids, size=3, show.legend=FALSE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position=c(1,0.3)); porPCAcen

#build a plot for the legend
legend_plot<-porPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site), data=por.centroids, size=3, show.legend=TRUE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="bottom")+theme(legend.text=element_text(size=18))

# extract the legend from one of the plots
legend <- get_legend(
  # create some space to the left of the legend
  legend_plot + theme(legend.box.margin = margin(1,1,1,1))
)

```

Add segments

```{r}
#3. add segments
segpoints<-por.centroids%>%
  gather(variable, value, -(timepoint:site)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
porPCAfull<-porPCAcen + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = site), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = site), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = site), data = segpoints, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); porPCAfull
```

Add bi plot with loadings  
```{r}
#1. make plot with dots
porArrows<-ggplot2::autoplot(scaled_por_afdw, data=por_data_afdw, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=3.5, loadings.label.vjust=-0.1, loadings.label.hjust=0.1, loadings.label.repel=FALSE, size=4, alpha=0.0) + 
  #geom_point(aes(fill=site, colour=site), alpha=0.0)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-0.5,0.1)+
  #ylim(-0.5, 0.5)+
  ggtitle(expression(italic("Porites")))+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         #axis.text.x=element_blank(),
         #axis.text.y=element_blank(),
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         title = element_text(size=25, face="bold"),
         axis.title = element_text(size=20));porArrows
```

##### Generate POR panel by haplotype 

Calculate centroid locations for each site and timepoint and pull PC1 and PC2 locations.     
```{r}
por_data_afdw_haplotype<-master%>%
  select(colony_id_corr, timepoint, species, haplotype, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, Total_Chl, Total_Chl_cell, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd, Ik, Ic, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Porites")%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  filter(Ic<1000)%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)

por_data_afdw_haplotype<-por_data_afdw_haplotype[complete.cases(por_data_afdw_haplotype), ]

por_data_afdw_haplotype[,-c(1:4)]<-log(por_data_afdw_haplotype[,-c(1:4)]+1)

scaled_por_afdw_haplotype<-prcomp(por_data_afdw_haplotype[c(5:18)], scale=TRUE, center=TRUE) 

por_info_haplotype<-por_data_afdw_haplotype[c(2,4)]

por_data_haplotype<-scaled_por_afdw_haplotype%>%
  augment(por_info_haplotype)%>%
  group_by(timepoint, haplotype)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

por.centroids_haplotype<-por_data_haplotype %>% 
  select(timepoint, haplotype, PC1.mean, PC2.mean)%>%
  group_by(timepoint, haplotype)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
```

Assemble plot with background points
```{r}
#1. make plot with dots
porPCA_haplotype<-ggplot(por_data_haplotype, aes(.fittedPC1, .fittedPC2, color=haplotype)) + 
  geom_point(size = 4, alpha=0.1, show.legend=FALSE)+
  scale_colour_manual(values=c("black", "darkgray")) +
  scale_fill_manual(values=c("black", "darkgray")) + 
  theme_classic()+
  ylab("PC2")+
  xlab("PC1")+
  ylim(-8,8)+
  xlim(-8,8)+
  ggtitle("Combined")+
  #geom_text(x=3, y=4, label="H=0.001", size=6, color="black") +
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         legend.title = element_blank(), 
         axis.text = element_text(size=18), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         title = element_text(size=18, face="bold"),
         axis.title = element_text(size=18,  face="bold"));porPCA_haplotype
```

Add centroids  

```{r}
#2. add centroids 
porPCAcen_haplotype<-porPCA_haplotype + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=haplotype), data=por.centroids_haplotype, size=3, show.legend=FALSE) + 
  #scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="right"); porPCAcen_haplotype

#build a plot for the legend
legend_plot_haplotype<-porPCA_haplotype + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=haplotype), data=por.centroids_haplotype, size=3, show.legend=FALSE) + 
  #scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="right")+theme(legend.text=element_text(size=18))

# extract the legend from one of the plots
legend <- get_legend(
  # create some space to the left of the legend
  legend_plot + theme(legend.box.margin = margin(1,1,1,1))
)

```

Add segments

```{r}
#3. add segments
segpoints_haplotype<-por.centroids_haplotype%>%
  gather(variable, value, -(timepoint:haplotype)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
porPCAfull_haplotype<-porPCAcen_haplotype + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = haplotype), data = segpoints_haplotype, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = haplotype), data = segpoints_haplotype, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = haplotype), data = segpoints_haplotype, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); porPCAfull_haplotype
```

#### Pocillopora   

Generate PCA using scaled (scaled_poc_afdw) from dataframe (poc_data_afdw). 
 
```{r}
poc_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site, haplotype, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, Total_Chl, Total_Chl_cell, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd, Ik, Ic, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Pocillopora")%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)

poc_data_afdw<-poc_data_afdw[complete.cases(poc_data_afdw), ]
 
poc_data_afdw[,-c(1:5)]<-log(poc_data_afdw[,-c(1:5)]+1)

scaled_poc_afdw<-prcomp(poc_data_afdw[c(6:19)], scale=TRUE, center=TRUE) 

poc_info<-poc_data_afdw[c(2,4)]

poc_data<-scaled_poc_afdw%>%
  augment(poc_info)%>%
  group_by(timepoint, site)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

poc.centroids<-poc_data %>% 
  select(timepoint, site, PC1.mean, PC2.mean)%>%
  group_by(timepoint, site)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
``` 
  
```{r}
# scale data
vegan <- scale(poc_data_afdw[ ,6:19])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis2(vegan ~ haplotype+timepoint*site, data = poc_data_afdw, method='eu')
z_poc<-permanova
z_poc
```

adonis2(formula = vegan ~ timepoint * site + haplotype, data = poc_data_afdw, method = "eu")
                Df SumOfSqs      R2       F Pr(>F)    
haplotype        1    67.75 0.03666  7.1932  0.001 ***
timepoint        3   442.85 0.23964 15.6727  0.001 ***
site             2    69.74 0.03774  3.7023  0.001 ***
timepoint:site   6   137.41 0.07435  2.4315  0.001 ***
Residual       120  1130.25 0.61161                   
Total          132  1848.00 1.00000   

Calculate Omega effect sizes for site and time point. 
```{r}
adonis_OmegaSq(z_poc, partial = TRUE)
```

Examine dispersion for this model by site 
```{r}
#conduct pairwise adonis to look at pairwise permanova comparisons
pairwise.adonis(x=poc_data_afdw[ ,6:19],factors=poc_data_afdw$site, sim.function="vegdist",  sim.method='euclidean', p.adjust.m='bonferroni')

#evaluate dispersion
beta_site<-betadisper(vegdist(poc_data_afdw[ ,6:19], "euclidian"), poc_data_afdw$site)
anova(beta_site)

#conduct posthoc analysis of betadispersion
TukeyHSD(beta_site)
```
There is no difference in dispersion by site, so therefore differences are due to centroid location. 

Examine dispersion for this model by season 
```{r}
#conduct pairwise adonis to look at pairwise permanova comparisons
pairwise.adonis(x=poc_data_afdw[ ,6:19],factors=poc_data_afdw$timepoint, sim.function="vegdist",  sim.method='euclidean', p.adjust.m='bonferroni')

#evaluate dispersion
beta_time<-betadisper(vegdist(poc_data_afdw[ ,6:19], "euclidian"), poc_data_afdw$timepoint)
anova(beta_time)

#conduct posthoc analysis of betadispersion
TukeyHSD(beta_time)
```
There is a significant difference in dispersion by timepoint, so differences are likely due to both dispersion and centroid location.

Examine dispersion for this model by haplotype 
```{r}
#conduct pairwise adonis to look at pairwise permanova comparisons
pairwise.adonis(x=poc_data_afdw[ ,6:19],factors=poc_data_afdw$haplotype, sim.function="vegdist",  sim.method='euclidean', p.adjust.m='bonferroni')

#evaluate dispersion
beta_haplo<-betadisper(vegdist(poc_data_afdw[ ,6:19], "euclidian"), poc_data_afdw$haplotype)
anova(beta_haplo)

#conduct posthoc analysis of betadispersion
TukeyHSD(beta_haplo)
```
There is a significant difference in dispersion by timepoint, so differences are likely due to both dispersion and centroid location.

Assemble plot with background points
```{r}
#1. make plot with dots
pocPCA<-ggplot(poc_data, aes(.fittedPC1, .fittedPC2, color=site)) + 
  geom_point(size = 4, alpha=0.2, show.legend=FALSE)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
 ylim(-8,8)+
  xlim(-8,8)+
  ylab("PC2")+
  xlab("PC1")+
  ggtitle(expression(italic("Pocillopora")))+
  #geom_text(x=3, y=5.5, label=paste("T=", z_poc$`Pr(>F)`[1]), size=6, color=ifelse(z_poc$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  #geom_text(x=3, y=4.75, label=paste("S=", z_poc$`Pr(>F)`[2]), size=6, color=ifelse(z_poc$`Pr(>F)`[2] < 0.05, "black", "darkgray")) + 
  #geom_text(x=3, y=4, label=paste("TxS=", z_poc$`Pr(>F)`[3]), size=6, color=ifelse(z_poc$`Pr(>F)`[3] < 0.05, "black", "darkgray")) + 
  #geom_text(x=3, y=5.5, label="T=0.001", size=6, color="black") + 
  #geom_text(x=3, y=4.75, label="S=0.001", size=6, color="black") + 
  #geom_text(x=3, y=4, label="TxS=0.001", size=6, color="black") + 
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         plot.margin = margin(1, 1, 1, 1, "cm"),
         legend.title = element_blank(), 
         title = element_text(size=25, face="bold"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18,  face="bold"));pocPCA

```

Add centroids  

```{r}
#2. add centroids 
pocPCAcen<-pocPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site), data=poc.centroids, size=3, show.legend=FALSE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="none"); pocPCAcen

```

Add segments

```{r}
#3. add segments
segpoints<-poc.centroids%>%
  gather(variable, value, -(timepoint:site)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
pocPCAfull<-pocPCAcen + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = site), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = site), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = site), data = segpoints, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); pocPCAfull
```

Add bi plot with loadings  
```{r}

pocArrows<-ggplot2::autoplot(scaled_poc_afdw, data=poc_data_afdw, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=3.5, loadings.label.vjust=0, loadings.label.hjust=-0.1, loadings.label.repel=TRUE, size=4, alpha=0.0) + 
  #geom_point(aes(fill=site, colour=site), alpha=0.2)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle(expression(italic("Pocillopora")))+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         #axis.text.x=element_blank(),
         #axis.text.y=element_blank(),
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         title = element_text(size=25, face="bold"),
         axis.title = element_text(size=20));pocArrows
```

##### Generate POC panel by haplotype 

Calculate centroid locations for each site and timepoint and pull PC1 and PC2 locations.     
```{r}
poc_data_afdw_haplotype<-master%>%
  select(colony_id_corr, timepoint, species, haplotype, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, Total_Chl, Total_Chl_cell, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd, Ik, Ic, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Pocillopora")%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)

poc_data_afdw_haplotype<-poc_data_afdw_haplotype[complete.cases(poc_data_afdw_haplotype), ]

poc_data_afdw_haplotype[,-c(1:4)]<-log(poc_data_afdw_haplotype[,-c(1:4)]+1)

scaled_poc_afdw_haplotype<-prcomp(poc_data_afdw_haplotype[c(5:18)], scale=TRUE, center=TRUE) 

poc_info_haplotype<-poc_data_afdw_haplotype[c(2,4)]

poc_data_haplotype<-scaled_poc_afdw_haplotype%>%
  augment(poc_info_haplotype)%>%
  group_by(timepoint, haplotype)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

poc.centroids_haplotype<-poc_data_haplotype %>% 
  select(timepoint, haplotype, PC1.mean, PC2.mean)%>%
  group_by(timepoint, haplotype)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
```

Assemble plot with background points
```{r}
#1. make plot with dots
pocPCA_haplotype<-ggplot(poc_data_haplotype, aes(.fittedPC1, .fittedPC2, color=haplotype)) + 
  geom_point(size = 4, alpha=0.1, show.legend=FALSE)+
  scale_colour_manual(values=c("black", "darkgray")) +
  scale_fill_manual(values=c("black", "darkgray")) + 
  theme_classic()+
  ylab("PC2")+
  xlab("PC1")+
  ylim(-8,8)+
  xlim(-8,8)+
  ggtitle("Combined")+
  #geom_text(x=3, y=4, label="H=0.001", size=6, color="black") +
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         legend.title = element_blank(), 
         axis.text = element_text(size=18), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         title = element_text(size=18, face="bold"),
         axis.title = element_text(size=18,  face="bold"));pocPCA_haplotype
```

Add centroids  

```{r}
#2. add centroids 
pocPCAcen_haplotype<-pocPCA_haplotype + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=haplotype), data=poc.centroids_haplotype, size=3, show.legend=FALSE) + 
  #scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="right"); pocPCAcen_haplotype

#build a plot for the legend
legend_plot_haplotype<-pocPCA_haplotype + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=haplotype), data=poc.centroids_haplotype, size=3, show.legend=FALSE) + 
  #scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="right")+theme(legend.text=element_text(size=18))

# extract the legend from one of the plots
legend <- get_legend(
  # create some space to the left of the legend
  legend_plot + theme(legend.box.margin = margin(1,1,1,1))
)

```

Add segments

```{r}
#3. add segments
segpoints_haplotype<-poc.centroids_haplotype%>%
  gather(variable, value, -(timepoint:haplotype)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
pocPCAfull_haplotype<-pocPCAcen_haplotype + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = haplotype), data = segpoints_haplotype, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = haplotype), data = segpoints_haplotype, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = haplotype), data = segpoints_haplotype, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); pocPCAfull_haplotype
```

#### Assemble all plots    

Assemble trajectory PCAs
```{r}
PCA_full_panel<-plot_grid(acrPCAfull, pocPCAfull, porPCAfull, labels = c("A", "B", "C"), ncol=3, nrow=1, rel_heights= c(1,1,1), rel_widths = c(1,1,1), label_size = 20, label_y=0.85, align="vh")

# add the legend to the row we made earlier. Give it one-third of 
# the width of one plot (via rel_widths).
PCA_full_panel_legend<-plot_grid(PCA_full_panel, legend, rel_heights = c(4, .2), ncol=1, nrow=2)

ggsave(filename="Figures/Multivariate/Full_Panel_PCAs_Holobiont.png", plot=PCA_full_panel_legend, dpi=500, width=20, height=6, units="in")
ggsave(filename="Figures/Multivariate/Full_Panel_PCAs_Holobiont.jpg", plot=PCA_full_panel_legend, dpi=500, width=20, height=6, units="in")
ggsave(filename="Figures/Multivariate/Full_Panel_PCAs_Holobiont.pdf", plot=PCA_full_panel_legend, dpi=500, width=20, height=6, units="in")
```  

Assemble biplots  
```{r}
biplot_full_panel<-plot_grid(acrArrows, pocArrows, porArrows, labels = c("A", "B", "C"), ncol=3, nrow=1, rel_heights= c(1,1,1), rel_widths = c(1,1,1), label_size = 20, label_y=0.85, align="vh")

# add the legend to the row we made earlier. Give it one-third of 
# the width of one plot (via rel_widths).
biplot_full_panel_legend<-plot_grid(biplot_full_panel, legend, rel_heights = c(4, .2), ncol=1, nrow=2)

ggsave(filename="Figures/Multivariate/Full_Biplots_Holobiont.png", plot=biplot_full_panel_legend, dpi=500, width=20, height=6, units="in")
ggsave(filename="Figures/Multivariate/Full_Biplots_Holobiont.jpg", plot=biplot_full_panel_legend, dpi=500, width=20, height=6, units="in")
ggsave(filename="Figures/Multivariate/Full_Biplots_Holobiont.pdf", plot=biplot_full_panel_legend, dpi=500, width=20, height=6, units="in")
```  

### Matrix of PCA's by species and time  

Generate biplot showing groupings by site for each species and time point.  

#### Pocillopora  

```{r}
poc_tp1_data<-master%>%
  select(colony_id_corr, timepoint, species, site, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, Total_Chl, Total_Chl_cell, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd, Ik, Ic, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Ic<1000)%>%
  filter(species=="Pocillopora")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)%>%
  filter(timepoint=="timepoint1")

poc_tp1_data<-poc_tp1_data[complete.cases(poc_tp1_data), ]

poc_tp1_data[,-c(1:4)]<-log(poc_tp1_data[,-c(1:4)]+1)
 
poc_tp1_scaled<-prcomp(poc_tp1_data[c(5:18)], scale=TRUE, center=TRUE) 

pocTP1<-ggplot2::autoplot(poc_tp1_scaled, data=poc_tp1_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0, loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("January 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  annotate("text", x=-16, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 2, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP1
```

```{r}
poc_tp2_data<-master%>%
  select(colony_id_corr, timepoint, species, site, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, Total_Chl, Total_Chl_cell, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd, Ik, Ic, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(chla.ug.mgAFDW<2.2)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  filter(species=="Pocillopora")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)%>%
  filter(timepoint=="timepoint2")
 
poc_tp2_data<-poc_tp2_data[complete.cases(poc_tp2_data), ]

poc_tp2_data[,-c(1:4)]<-log(poc_tp2_data[,-c(1:4)]+1)
 
poc_tp2_scaled<-prcomp(poc_tp2_data[c(5:18)], scale=TRUE, center=TRUE) 

pocTP2<-ggplot2::autoplot(poc_tp2_scaled, data=poc_tp2_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("March 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP2
```

```{r}
poc_tp3_data<-master%>%
  select(colony_id_corr, timepoint, species, site, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, Total_Chl, Total_Chl_cell, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd, Ik, Ic, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  #filter(chla.ug.mgAFDW<2.2)%>%
  filter(Ic<1000)%>%
  filter(species=="Pocillopora")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)%>%
  filter(timepoint=="timepoint3")
 
poc_tp3_data<-poc_tp3_data[complete.cases(poc_tp3_data), ]

poc_tp3_data[,-c(1:4)]<-log(poc_tp3_data[,-c(1:4)]+1)
 
poc_tp3_scaled<-prcomp(poc_tp3_data[c(5:18)], scale=TRUE, center=TRUE) 

pocTP3<-ggplot2::autoplot(poc_tp3_scaled, data=poc_tp3_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("September 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP3
```

```{r}
poc_tp4_data<-master%>%
  select(colony_id_corr, timepoint, species, site, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, Total_Chl, Total_Chl_cell, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd, Ik, Ic, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  #filter(chla.ug.mgAFDW<2.2)%>%
  filter(species=="Pocillopora")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)%>%
  filter(timepoint=="timepoint4")
 
poc_tp4_data<-poc_tp4_data[complete.cases(poc_tp4_data), ]

poc_tp4_data[,-c(1:4)]<-log(poc_tp4_data[,-c(1:4)]+1)
 
poc_tp4_scaled<-prcomp(poc_tp4_data[c(5:18)], scale=TRUE, center=TRUE) 

pocTP4<-ggplot2::autoplot(poc_tp4_scaled, data=poc_tp4_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("November 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP4
```

#### Acropora  

```{r}
acr_tp1_data<-master%>%
  select(colony_id_corr, timepoint, species, site, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, Total_Chl, Total_Chl_cell, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd, Ik, Ic, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Acropora")%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)%>%
  filter(timepoint=="timepoint1")

acr_tp1_data<-acr_tp1_data[complete.cases(acr_tp1_data), ]

acr_tp1_data[,-c(1:4)]<-log(acr_tp1_data[,-c(1:4)]+1)
 
acr_tp1_scaled<-prcomp(acr_tp1_data[c(5:18)], scale=TRUE, center=TRUE) 

acrTP1<-ggplot2::autoplot(acr_tp1_scaled, data=acr_tp1_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0, loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("January 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  annotate("text", x=-16, y=0, label="italic(Acropora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 2, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP1
```

```{r}
acr_tp2_data<-master%>%
  select(colony_id_corr, timepoint, species, site, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, Total_Chl, Total_Chl_cell, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd, Ik, Ic, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  #filter(chla.ug.mgAFDW<2.2)%>%
  filter(species=="Acropora")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)%>%
  filter(timepoint=="timepoint2")
 
acr_tp2_data<-acr_tp2_data[complete.cases(acr_tp2_data), ]

acr_tp2_data[,-c(1:4)]<-log(acr_tp2_data[,-c(1:4)]+1)
 
acr_tp2_scaled<-prcomp(acr_tp2_data[c(5:18)], scale=TRUE, center=TRUE) 

acrTP2<-ggplot2::autoplot(acr_tp2_scaled, data=acr_tp2_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("March 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP2
```

```{r}
acr_tp3_data<-master%>%
  select(colony_id_corr, timepoint, species, site, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, Total_Chl, Total_Chl_cell, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd, Ik, Ic, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  #filter(chla.ug.mgAFDW<2.2)%>%
  filter(species=="Acropora")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)%>%
  filter(timepoint=="timepoint3")
 
acr_tp3_data<-acr_tp3_data[complete.cases(acr_tp3_data), ]

acr_tp3_data[,-c(1:4)]<-log(acr_tp3_data[,-c(1:4)]+1)
 
acr_tp3_scaled<-prcomp(acr_tp3_data[c(5:18)], scale=TRUE, center=TRUE) 

acrTP3<-ggplot2::autoplot(acr_tp3_scaled, data=acr_tp3_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("September 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP3
```

```{r}
acr_tp4_data<-master%>%
  select(colony_id_corr, timepoint, species, site, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, Total_Chl, Total_Chl_cell, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd, Ik, Ic, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Ic<1000)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  #filter(chla.ug.mgAFDW<2.2)%>%
  filter(species=="Acropora")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)%>%
  filter(timepoint=="timepoint4")
 
acr_tp4_data<-acr_tp4_data[complete.cases(acr_tp4_data), ]

acr_tp4_data[,-c(1:4)]<-log(acr_tp4_data[,-c(1:4)]+1)
 
acr_tp4_scaled<-prcomp(acr_tp4_data[c(5:18)], scale=TRUE, center=TRUE) 

acrTP4<-ggplot2::autoplot(acr_tp4_scaled, data=acr_tp4_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("November 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-7, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP4
```


#### Porites  

```{r}
por_tp1_data<-master%>%
  select(colony_id_corr, timepoint, species, site, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, Total_Chl, Total_Chl_cell, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd, Ik, Ic, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Porites")%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)%>%
  filter(timepoint=="timepoint1")

por_tp1_data<-por_tp1_data[complete.cases(por_tp1_data), ]

por_tp1_data[,-c(1:4)]<-log(por_tp1_data[,-c(1:4)]+1)
 
por_tp1_scaled<-prcomp(por_tp1_data[c(5:18)], scale=TRUE, center=TRUE) 

porTP1<-ggplot2::autoplot(por_tp1_scaled, data=por_tp1_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0, loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("January 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  annotate("text", x=-16, y=0, label="italic(Porites)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 2, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP1
```

```{r}
por_tp2_data<-master%>%
  select(colony_id_corr, timepoint, species, site, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, Total_Chl, Total_Chl_cell, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd, Ik, Ic, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  #filter(chla.ug.mgAFDW<2.2)%>%
  filter(species=="Porites")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)%>%
  filter(timepoint=="timepoint2")
 
por_tp2_data<-por_tp2_data[complete.cases(por_tp2_data), ]

por_tp2_data[,-c(1:4)]<-log(por_tp2_data[,-c(1:4)]+1)
 
por_tp2_scaled<-prcomp(por_tp2_data[c(5:18)], scale=TRUE, center=TRUE) 

porTP2<-ggplot2::autoplot(por_tp2_scaled, data=por_tp2_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("March 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP2
```

```{r}
por_tp3_data<-master%>%
  select(colony_id_corr, timepoint, species, site, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, Total_Chl, Total_Chl_cell, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd, Ik, Ic, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Ic<1000)%>%
  #filter(chla.ug.mgAFDW<2.2)%>%
  filter(species=="Porites")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)%>%
  filter(timepoint=="timepoint3")
 
por_tp3_data<-por_tp3_data[complete.cases(por_tp3_data), ]

por_tp3_data[,-c(1:4)]<-log(por_tp3_data[,-c(1:4)]+1)
 
por_tp3_scaled<-prcomp(por_tp3_data[c(5:18)], scale=TRUE, center=TRUE) 

porTP3<-ggplot2::autoplot(por_tp3_scaled, data=por_tp3_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("September 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP3
```

```{r}
por_tp4_data<-master%>%
  select(colony_id_corr, timepoint, species, site, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, Total_Chl, Total_Chl_cell, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd, Ik, Ic, calc.umol.cm2.hr)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  #filter(chla.ug.mgAFDW<2.2)%>%
  filter(species=="Porites")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)%>%
  filter(timepoint=="timepoint4")
 
por_tp4_data<-por_tp4_data[complete.cases(por_tp4_data), ]

por_tp4_data[,-c(1:4)]<-log(por_tp4_data[,-c(1:4)]+1)
 
por_tp4_scaled<-prcomp(por_tp4_data[c(5:18)], scale=TRUE, center=TRUE) 

porTP4<-ggplot2::autoplot(por_tp4_scaled, data=por_tp4_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
 # ggtitle("November 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP4
```

#### Assemble grid plot of all metrics by species and time  

```{r}
all_grid<-plot_grid(acrTP1, acrTP2, acrTP3, acrTP4, pocTP1, pocTP2, pocTP3, pocTP4, porTP1, porTP2, porTP3, porTP4, ncol=4, nrow=3)
all_grid2<-plot_grid(all_grid, legend, rel_heights = c(4, .2), ncol=1, nrow=2)

ggsave(filename="Figures/Multivariate/Matrix_HolobiontResponses.png", plot=all_grid2, dpi=500, width=20, height=20, units="in")

```


## Host Responses  

Generate a list of symbiont and host responses.  
```{r}
symbiont_responses<-c("cells.mgAFDW", "Sym_AFDW.mg.cm2", "Total_Chl", "Total_Chl_cell", "Am", "AQY", "Ik", "Ic", "Ratio_AFDW.mg.cm2") 
host_responses<-c("cre.umol.mgafdw", "Host_AFDW.mg.cm2", "prot_mg.mgafdw", "Rd", "calc.umol.cm2.hr")
```

### PCA's for centroid and trajectories  
 
#### Acropora  

Generate PCA using scaled (scaled_acr_afdw) from dataframe (acr_data_afdw).   
 
```{r}
acr_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site, all_of(host_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Acropora")%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(prot_mg.mgafdw<1.5) %>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw, Respiration=Rd, Calc=calc.umol.cm2.hr)

acr_data_afdw<-acr_data_afdw[complete.cases(acr_data_afdw), ]

acr_data_afdw[,-c(1:4)]<-log(acr_data_afdw[,-c(1:4)]+1)

scaled_acr_afdw<-prcomp(acr_data_afdw[c(5:9)], scale=TRUE, center=TRUE) 

acr_info<-acr_data_afdw[c(2,4)]

acr_data<-scaled_acr_afdw%>%
  augment(acr_info)%>%
  group_by(timepoint, site)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

acr.centroids<-acr_data %>% 
  select(timepoint, site, PC1.mean, PC2.mean)%>%
  group_by(timepoint, site)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
```

Examine PERMANOVA results.  
 
```{r}
# scale data
vegan <- scale(acr_data_afdw[ ,5:9])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis2(vegan ~ timepoint*site, data = acr_data_afdw, method='eu')
z_acr<-permanova
z_acr
``` 
 
adonis2(formula = vegan ~ timepoint * site, data = acr_data_afdw, method = "eu")
                Df SumOfSqs      R2       F Pr(>F)    
timepoint        3   196.82 0.38217 23.6506  0.001 ***
site             2    35.68 0.06928  6.4312  0.001 ***
timepoint:site   6    27.30 0.05300  1.6400  0.033 *  
Residual        92   255.21 0.49554                   
Total          103   515.00 1.00000  

Calculate Omega effect sizes for site and time point. 
```{r}
adonis_OmegaSq(z_acr, partial = TRUE)
```

Examine dispersion for this model by site 
```{r}
#conduct pairwise adonis to look at pairwise permanova comparisons
pairwise.adonis(x=acr_data_afdw[ ,5:9],factors=acr_data_afdw$site, sim.function="vegdist",  sim.method='euclidean', p.adjust.m='bonferroni')

#evaluate dispersion
beta_site<-betadisper(vegdist(acr_data_afdw[ ,5:9], "euclidian"), acr_data_afdw$site)
anova(beta_site)

#conduct posthoc analysis of betadispersion
TukeyHSD(beta_site)
```
There is a difference in dispersion by site, so therefore differences are likely due to both dispersion and centroid location. 

Examine dispersion for this model by season 
```{r}
#conduct pairwise adonis to look at pairwise permanova comparisons
pairwise.adonis(x=acr_data_afdw[ ,5:9],factors=acr_data_afdw$timepoint, sim.function="vegdist",  sim.method='euclidean', p.adjust.m='bonferroni')

#evaluate dispersion
beta_time<-betadisper(vegdist(acr_data_afdw[ ,5:9], "euclidian"), acr_data_afdw$timepoint)
anova(beta_time)

#conduct posthoc analysis of betadispersion
TukeyHSD(beta_time)
```
There is no significant difference in dispersion by timepoint, so differences are likely due to only centroid location.

Assemble plot with background points
```{r}
#1. make plot with dots
acrPCA<-ggplot(acr_data, aes(.fittedPC1, .fittedPC2, color=site)) + 
  geom_point(size = 4, alpha=0.2, show.legend=FALSE)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  ylim(-6,6)+
  xlim(-6,6)+
  ylab("PC2")+
  xlab("PC1")+
  ggtitle(expression(italic("Acropora")))+
  #geom_text(x=3, y=5.5, label=paste("T=",z_acr$`Pr(>F)`[1]), size=6, color=ifelse(z_acr$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  #geom_text(x=3, y=4.75, label=paste("S=",z_acr$`Pr(>F)`[2]), size=6, color=ifelse(z_acr$`Pr(>F)`[2] < 0.05, "black", "darkgray")) + 
  #geom_text(x=3, y=4, label=paste("TxS=",z_acr$`Pr(>F)`[3]), size=6, color=ifelse(z_acr$`Pr(>F)`[3] < 0.05, "black", "darkgray")) +
  #geom_text(x=3, y=5.5, label="T=0.001", size=6, color="black") + 
  #geom_text(x=3, y=4.75, label="S=0.001", size=6, color="black") + 
  #geom_text(x=3, y=4, label="TxS=0.035", size=6, color="black") + 
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         title = element_text(size=25, face="bold"), 
         axis.title = element_text(size=18));acrPCA

```

Add centroids  

```{r}
#2. add centroids 
acrPCAcen<-acrPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site), data=acr.centroids, size=3, show.legend=FALSE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="none"); acrPCAcen

```

Add segments

```{r}
#3. add segments
segpoints<-acr.centroids%>%
  gather(variable, value, -(timepoint:site)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
acrPCAfull<-acrPCAcen + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = site), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = site), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = site), data = segpoints, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); acrPCAfull
```

Add bi plot with loadings  
```{r}
#1. make plot with dots
acrArrows<-ggplot2::autoplot(scaled_acr_afdw, data=acr_data_afdw, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=3.5, loadings.label.vjust=0.5, loadings.label.hjust=-0.1, loadings.label.repel=TRUE, size=4, alpha=0.0) + 
  #geom_point(aes(fill=site, colour=site), alpha=0.2)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
    ggtitle(expression(italic("Acropora")))+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         #axis.text.x=element_blank(),
         #axis.text.y=element_blank(),
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         title = element_text(size=25, face="bold"),
         axis.title = element_text(size=20));acrArrows
```

Assemble final figure with inset biplot.  
```{r}
#acrFullPCA<-ggdraw(acrPCAfull) + #theme_half_open(12)) +
  #draw_plot(acrArrows, .5, .5, .5, .5); acrFullPCA #x, y, w, h

#ggsave(filename="Figures/FullPCA_Acropora.pdf", plot=acrFullPCA, dpi=300, width=12, height=8, units="in")
```

#### Porites

Generate PCA using scaled (scaled_por_afdw) from dataframe (por_data_afdw).   
 
Calculate centroid locations for each site and timepoint and pull PC1 and PC2 locations.      
```{r}
por_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site, haplotype, all_of(host_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Porites")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Respiration=Rd, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)

por_data_afdw<-por_data_afdw[complete.cases(por_data_afdw), ]

por_data_afdw[,-c(1:5)]<-log(por_data_afdw[,-c(1:5)]+1)

scaled_por_afdw<-prcomp(por_data_afdw[c(6:10)], scale=TRUE, center=TRUE) 

por_info<-por_data_afdw[c(2,4)]

por_data<-scaled_por_afdw%>%
  augment(por_info)%>%
  group_by(timepoint, site)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

por.centroids<-por_data %>% 
  select(timepoint, site, PC1.mean, PC2.mean)%>%
  group_by(timepoint, site)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
```

```{r}
# scale data
vegan <- scale(por_data_afdw[ ,6:10])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis2(vegan ~ haplotype+timepoint*site, data = por_data_afdw, method='eu')
z_por<-permanova
z_por
```

adonis2(formula = vegan ~ timepoint * site, data = por_data_afdw, method = "eu")
                Df SumOfSqs      R2       F Pr(>F)    
haplotype        1    92.46 0.13208 29.5475  0.001 ***
timepoint        3   150.69 0.21528 16.0527  0.001 ***
site             2    22.42 0.03203  3.5826  0.002 ** 
timepoint:site   6    33.90 0.04843  1.8055  0.012 *  
Residual       128   400.53 0.57219                   
Total          140   700.00 1.00000  

Calculate Omega effect sizes for site and time point. 
```{r}
adonis_OmegaSq(z_por, partial = TRUE)
```

Examine dispersion for this model by site 
```{r}
#conduct pairwise adonis to look at pairwise permanova comparisons
pairwise.adonis(x=por_data_afdw[ ,6:10],factors=por_data_afdw$site, sim.function="vegdist",  sim.method='euclidean', p.adjust.m='bonferroni')

#evaluate dispersion
beta_site<-betadisper(vegdist(por_data_afdw[ ,6:10], "euclidian"), por_data_afdw$site)
anova(beta_site)

#conduct posthoc analysis of betadispersion
TukeyHSD(beta_site)
```
There is no difference in dispersion by site, so therefore differences are likely due to  centroid location. 

Examine dispersion for this model by season 
```{r}
#conduct pairwise adonis to look at pairwise permanova comparisons
pairwise.adonis(x=por_data_afdw[ ,6:10],factors=por_data_afdw$timepoint, sim.function="vegdist",  sim.method='euclidean', p.adjust.m='bonferroni')

#evaluate dispersion
beta_time<-betadisper(vegdist(por_data_afdw[ ,6:10], "euclidian"), por_data_afdw$timepoint)
anova(beta_time)

#conduct posthoc analysis of betadispersion
TukeyHSD(beta_time)
```
There is no significant difference in dispersion by timepoint (rounds to p=0.05), so differences are likely due to only centroid location.

Examine dispersion for this model by haplotype 
```{r}
#conduct pairwise adonis to look at pairwise permanova comparisons
pairwise.adonis(x=por_data_afdw[ ,6:10],factors=por_data_afdw$haplotype, sim.function="vegdist",  sim.method='euclidean', p.adjust.m='bonferroni')

#evaluate dispersion
beta_haplo<-betadisper(vegdist(por_data_afdw[ ,6:10], "euclidian"), por_data_afdw$haplotype)
anova(beta_haplo)

#conduct posthoc analysis of betadispersion
TukeyHSD(beta_haplo)
```
There is no significant difference in dispersion by timepoint (rounds to p=0.05), so differences are likely due to only centroid location.

Assemble plot with background points
```{r}
#1. make plot with dots
porPCA<-ggplot(por_data, aes(.fittedPC1, .fittedPC2, color=site)) + 
  geom_point(size = 4, alpha=0.2, show.legend=FALSE)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  ylab("PC2")+
  xlab("PC1")+
  ylim(-6,6)+
  xlim(-6,6)+
  ggtitle(expression(italic("Porites")))+
  #geom_text(x=3, y=5.5, label=paste("T=",z_por$`Pr(>F)`[1]), size=6, color=ifelse(z_por$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  #geom_text(x=3, y=4.75, label=paste("S=",z_por$`Pr(>F)`[2]), size=6, color=ifelse(z_por$`Pr(>F)`[2] < 0.05, "black", "darkgray")) + 
  #geom_text(x=3, y=4, label=paste("TxS=",z_por$`Pr(>F)`[3]), size=6, color=ifelse(z_por$`Pr(>F)`[3] < 0.05, "black", "darkgray")) + 
  #geom_text(x=3, y=5.5, label="T=0.001", size=6, color="black") + 
  #geom_text(x=3, y=4.75, label="S=0.001", size=6, color="black") + 
  #geom_text(x=3, y=4, label="TxS=0.027", size=6, color="black") + 
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         legend.title = element_blank(), 
         axis.text = element_text(size=18), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         title = element_text(size=25, face="bold"),
         axis.title = element_text(size=18,  face="bold"));porPCA
```

Add centroids  

```{r}
#2. add centroids 
porPCAcen<-porPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site), data=por.centroids, size=3, show.legend=FALSE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position=c(1,0.3)); porPCAcen

#build a plot for the legend
legend_plot<-porPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site), data=por.centroids, size=3, show.legend=TRUE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="bottom")+theme(legend.text=element_text(size=18))

# extract the legend from one of the plots
legend <- get_legend(
  # create some space to the left of the legend
  legend_plot + theme(legend.box.margin = margin(1,1,1,1))
)

```

Add segments

```{r}
#3. add segments
segpoints<-por.centroids%>%
  gather(variable, value, -(timepoint:site)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
porPCAfull<-porPCAcen + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = site), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = site), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = site), data = segpoints, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); porPCAfull
```

Add bi plot with loadings  
```{r}
#1. make plot with dots
porArrows<-ggplot2::autoplot(scaled_por_afdw, data=por_data_afdw, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=3.5, loadings.label.vjust=-0.1, loadings.label.hjust=0.1, loadings.label.repel=TRUE, size=4, alpha=0.0) + 
  #geom_point(aes(fill=site, colour=site), alpha=0.2)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-0.5,0.1)+
  #ylim(-0.5, 0.5)+
    ggtitle(expression(italic("Porites")))+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         #axis.text.x=element_blank(),
         #axis.text.y=element_blank(),
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         title = element_text(size=25, face="bold"),
         axis.title = element_text(size=20));porArrows
```

##### Generate plot for POR haplotypes 

Calculate centroid locations for each haplotype and timepoint and pull PC1 and PC2 locations.      
```{r}
por_data_afdw_haplotype<-master%>%
  select(colony_id_corr, timepoint, species, haplotype, all_of(host_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Porites")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Respiration=Rd, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)

por_data_afdw_haplotype<-por_data_afdw_haplotype[complete.cases(por_data_afdw_haplotype), ]

por_data_afdw_haplotype[,-c(1:4)]<-log(por_data_afdw_haplotype[,-c(1:4)]+1)

scaled_por_afdw_haplotype<-prcomp(por_data_afdw_haplotype[c(5:9)], scale=TRUE, center=TRUE) 

por_info_haplotype<-por_data_afdw_haplotype[c(2,4)]

por_data_haplotype<-scaled_por_afdw_haplotype%>%
  augment(por_info_haplotype)%>%
  group_by(timepoint, haplotype)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

por.centroids_haplotype<-por_data_haplotype %>% 
  select(timepoint, haplotype, PC1.mean, PC2.mean)%>%
  group_by(timepoint, haplotype)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
```

Assemble plot with background points
```{r}
#1. make plot with dots
porPCA_haplotype<-ggplot(por_data_haplotype, aes(.fittedPC1, .fittedPC2, color=haplotype)) + 
  geom_point(size = 4, alpha=0.1, show.legend=FALSE)+
  scale_colour_manual(values=c("black", "darkgray")) +
  scale_fill_manual(values=c("black", "darkgray")) + 
  theme_classic()+
  ylab("PC2")+
  xlab("PC1")+
  #ylim(-6,6)+
  #xlim(-6,6)+
  ggtitle("Host")+
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         legend.title = element_blank(), 
         axis.text = element_text(size=18), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         title = element_text(size=18, face="bold"),
         axis.title = element_text(size=18,  face="bold"));porPCA_haplotype
```

Add centroids  

```{r}
#2. add centroids 
porPCAcen_haplotype<-porPCA_haplotype + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=haplotype), data=por.centroids_haplotype, size=3, show.legend=FALSE) + 
  #scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position=c(1,0.3)); porPCAcen_haplotype

#build a plot for the legend
legend_plot_haplotype<-porPCA_haplotype + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=haplotype), data=por.centroids_haplotype, size=3, show.legend=TRUE) + 
  #scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="bottom")+theme(legend.text=element_text(size=18))

# extract the legend from one of the plots
legend_haplotype <- get_legend(
  # create some space to the left of the legend
  legend_plot_haplotype + theme(legend.box.margin = margin(1,1,1,1))
)

```

Add segments

```{r}
#3. add segments
segpoints_haplotype<-por.centroids_haplotype%>%
  gather(variable, value, -(timepoint:haplotype)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
porPCAhost_haplotype<-porPCAcen_haplotype + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = haplotype), data = segpoints_haplotype, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = haplotype), data = segpoints_haplotype, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = haplotype), data = segpoints_haplotype, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); porPCAhost_haplotype
```

#### Pocillopora   

Generate PCA using scaled (scaled_poc_afdw) from dataframe (poc_data_afdw). 
 
```{r}
poc_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site, haplotype, all_of(host_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Pocillopora")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Respiration=Rd, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)

poc_data_afdw<-poc_data_afdw[complete.cases(poc_data_afdw), ]

poc_data_afdw[,-c(1:5)]<-log(poc_data_afdw[,-c(1:5)]+1)
 
scaled_poc_afdw<-prcomp(poc_data_afdw[c(6:10)], scale=TRUE, center=TRUE) 

poc_info<-poc_data_afdw[c(2,4)]

poc_data<-scaled_poc_afdw%>%
  augment(poc_info)%>%
  group_by(timepoint, site)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

poc.centroids<-poc_data %>% 
  select(timepoint, site, PC1.mean, PC2.mean)%>%
  group_by(timepoint, site)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
``` 
  
```{r}
# scale data
vegan <- scale(poc_data_afdw[ ,6:10])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis2(vegan ~ haplotype+timepoint*site, data = poc_data_afdw, method='eu')
z_poc<-permanova
z_poc
```
adonis2(formula = vegan ~ haplotype + timepoint * site, data = poc_data_afdw, method = "eu")
                Df SumOfSqs      R2       F Pr(>F)    
haplotype        1    12.43 0.01715  3.6310  0.005 ** 
timepoint        3   173.34 0.23908 16.8769  0.001 ***
site             2    22.18 0.03059  3.2391  0.002 ** 
timepoint:site   6    61.73 0.08514  3.0050  0.001 ***
Residual       133   455.33 0.62804                   
Total          145   725.00 1.00000   

Calculate Omega effect sizes for site and time point. 
```{r}
adonis_OmegaSq(z_poc, partial = TRUE)
```

Examine dispersion for this model by site 
```{r}
#conduct pairwise adonis to look at pairwise permanova comparisons
pairwise.adonis(x=poc_data_afdw[ ,6:10],factors=poc_data_afdw$site, sim.function="vegdist",  sim.method='euclidean', p.adjust.m='bonferroni')

#evaluate dispersion
beta_site<-betadisper(vegdist(poc_data_afdw[ ,6:10], "euclidian"), poc_data_afdw$site)
anova(beta_site)

#conduct posthoc analysis of betadispersion
TukeyHSD(beta_site)
```
There is no difference in dispersion by site, so therefore differences are likely due to  centroid location. 

Examine dispersion for this model by season 
```{r}
#conduct pairwise adonis to look at pairwise permanova comparisons
pairwise.adonis(x=poc_data_afdw[ ,6:10],factors=poc_data_afdw$timepoint, sim.function="vegdist",  sim.method='euclidean', p.adjust.m='bonferroni')

#evaluate dispersion
beta_time<-betadisper(vegdist(poc_data_afdw[ ,6:10], "euclidian"), poc_data_afdw$timepoint)
anova(beta_time)

#conduct posthoc analysis of betadispersion
TukeyHSD(beta_time)
```
There is a significant difference in dispersion by timepoint, so differences are likely due to dispersion and centroid location.

Examine dispersion for this model by haplotype 
```{r}
#conduct pairwise adonis to look at pairwise permanova comparisons
pairwise.adonis(x=poc_data_afdw[ ,6:10],factors=poc_data_afdw$haplotype, sim.function="vegdist",  sim.method='euclidean', p.adjust.m='bonferroni')

#evaluate dispersion
beta_haplo<-betadisper(vegdist(poc_data_afdw[ ,6:10], "euclidian"), poc_data_afdw$haplotype)
anova(beta_haplo)

#conduct posthoc analysis of betadispersion
TukeyHSD(beta_haplo)
```
There is a significant difference in dispersion by timepoint, so differences are likely due to dispersion and centroid location.

Assemble plot with background points
```{r}
#1. make plot with dots
pocPCA<-ggplot(poc_data, aes(.fittedPC1, .fittedPC2, color=site)) + 
  geom_point(size = 4, alpha=0.2, show.legend=FALSE)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  ylim(-6,6)+
  xlim(-6,6)+
  ylab("PC2")+
  xlab("PC1")+
  ggtitle(expression(italic("Pocillopora")))+
  #geom_text(x=3, y=5.5, label=paste("T=",z_poc$`Pr(>F)`[1]), size=6, color=ifelse(z_poc$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  #geom_text(x=3, y=4.75, label=paste("S=",z_poc$`Pr(>F)`[2]), size=6, color=ifelse(z_poc$`Pr(>F)`[2] < 0.05, "black", "darkgray")) + 
  #geom_text(x=3, y=4, label=paste("TxS=",z_poc$`Pr(>F)`[3]), size=6, color=ifelse(z_poc$`Pr(>F)`[3] < 0.05, "black", "darkgray")) + 
  #geom_text(x=3, y=5.5, label="T=0.001", size=6, color="black") + 
  #geom_text(x=3, y=4.75, label="S=0.001", size=6, color="black") + 
  #geom_text(x=3, y=4, label="TxS=0.001", size=6, color="black") + 
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         plot.margin = margin(1, 1, 1, 1, "cm"),
         legend.title = element_blank(), 
         title = element_text(size=25, face="bold"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18,  face="bold"));pocPCA

```

Add centroids  

```{r}
#2. add centroids 
pocPCAcen<-pocPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site), data=poc.centroids, size=3, show.legend=FALSE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="none"); pocPCAcen

```

Add segments

```{r}
#3. add segments
segpoints<-poc.centroids%>%
  gather(variable, value, -(timepoint:site)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
pocPCAfull<-pocPCAcen + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = site), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = site), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = site), data = segpoints, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); pocPCAfull
```

Add bi plot with loadings  
```{r}
pocArrows<-ggplot2::autoplot(scaled_poc_afdw, data=poc_data_afdw, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=3.5, loadings.label.vjust=0, loadings.label.hjust=-0.1, loadings.label.repel=TRUE, size=4, alpha=0.0) + 
  #geom_point(aes(fill=site, colour=site), alpha=0.2)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
    ggtitle(expression(italic("Pocillopora")))+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         #axis.text.x=element_blank(),
         #axis.text.y=element_blank(),
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         title = element_text(size=25, face="bold"),
         axis.title = element_text(size=20));pocArrows
```

##### Generate plot for POR haplotypes 

Calculate centroid locations for each haplotype and timepoint and pull PC1 and PC2 locations.      
```{r}
poc_data_afdw_haplotype<-master%>%
  select(colony_id_corr, timepoint, species, haplotype, all_of(host_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Pocillopora")%>%
  rename(Host_Biomass=Host_AFDW.mg.cm2, Respiration=Rd, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)

poc_data_afdw_haplotype<-poc_data_afdw_haplotype[complete.cases(poc_data_afdw_haplotype), ]

poc_data_afdw_haplotype[,-c(1:4)]<-log(poc_data_afdw_haplotype[,-c(1:4)]+1)

scaled_poc_afdw_haplotype<-prcomp(poc_data_afdw_haplotype[c(5:9)], scale=TRUE, center=TRUE) 

poc_info_haplotype<-poc_data_afdw_haplotype[c(2,4)]

poc_data_haplotype<-scaled_poc_afdw_haplotype%>%
  augment(poc_info_haplotype)%>%
  group_by(timepoint, haplotype)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

poc.centroids_haplotype<-poc_data_haplotype %>% 
  select(timepoint, haplotype, PC1.mean, PC2.mean)%>%
  group_by(timepoint, haplotype)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
```

Assemble plot with background points
```{r}
#1. make plot with dots
pocPCA_haplotype<-ggplot(poc_data_haplotype, aes(.fittedPC1, .fittedPC2, color=haplotype)) + 
  geom_point(size = 4, alpha=0.1, show.legend=FALSE)+
  scale_colour_manual(values=c("black", "darkgray")) +
  scale_fill_manual(values=c("black", "darkgray")) + 
  theme_classic()+
  ylab("PC2")+
  xlab("PC1")+
  #ylim(-6,6)+
  #xlim(-6,6)+
  ggtitle("Host")+
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         legend.title = element_blank(), 
         axis.text = element_text(size=18), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         title = element_text(size=18, face="bold"),
         axis.title = element_text(size=18,  face="bold"));pocPCA_haplotype
```

Add centroids  

```{r}
#2. add centroids 
pocPCAcen_haplotype<-pocPCA_haplotype + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=haplotype), data=poc.centroids_haplotype, size=3, show.legend=FALSE) + 
  #scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position=c(1,0.3)); pocPCAcen_haplotype

#build a plot for the legend
legend_plot_haplotype<-pocPCA_haplotype + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=haplotype), data=poc.centroids_haplotype, size=3, show.legend=TRUE) + 
  #scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="bottom")+theme(legend.text=element_text(size=18))

# extract the legend from one of the plots
legend_haplotype <- get_legend(
  # create some space to the left of the legend
  legend_plot_haplotype + theme(legend.box.margin = margin(1,1,1,1))
)

```

Add segments

```{r}
#3. add segments
segpoints_haplotype<-poc.centroids_haplotype%>%
  gather(variable, value, -(timepoint:haplotype)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
pocPCAhost_haplotype<-pocPCAcen_haplotype + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = haplotype), data = segpoints_haplotype, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = haplotype), data = segpoints_haplotype, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = haplotype), data = segpoints_haplotype, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); pocPCAhost_haplotype
```

#### Assemble all plots    

```{r}
PCA_full_panel<-plot_grid(acrPCAfull, pocPCAfull, porPCAfull, labels = c("D", "E", "F"), ncol=3, nrow=1, rel_heights= c(1,1,1), rel_widths = c(1,1,1), label_size = 20, label_y=0.85, align="vh")

# add the legend to the row we made earlier. Give it one-third of 
# the width of one plot (via rel_widths).
PCA_full_panel_legend<-plot_grid(PCA_full_panel, legend, rel_heights = c(4, .2), ncol=1, nrow=2)

ggsave(filename="Figures/Multivariate/Full_Panel_PCAs_Host.png", plot=PCA_full_panel_legend, dpi=500, width=20, height=6, units="in")
ggsave(filename="Figures/Multivariate/Full_Panel_PCAs_Host.jpg", plot=PCA_full_panel_legend, dpi=500, width=20, height=6, units="in")
ggsave(filename="Figures/Multivariate/Full_Panel_PCAs_Host.pdf", plot=PCA_full_panel_legend, dpi=500, width=20, height=6, units="in")
```  

Assemble biplots  
```{r}
biplot_full_panel<-plot_grid(acrArrows, pocArrows, porArrows, labels = c("D", "E", "F"), ncol=3, nrow=1, rel_heights= c(1,1,1), rel_widths = c(1,1,1), label_size = 20, label_y=0.85, align="vh")

# add the legend to the row we made earlier. Give it one-third of 
# the width of one plot (via rel_widths).
biplot_full_panel_legend<-plot_grid(biplot_full_panel, legend, rel_heights = c(4, .2), ncol=1, nrow=2)

ggsave(filename="Figures/Multivariate/Full_Biplots_Host.png", plot=biplot_full_panel_legend, dpi=500, width=20, height=6, units="in")
ggsave(filename="Figures/Multivariate/Full_Biplots_Host.pdf", plot=biplot_full_panel_legend, dpi=500, width=20, height=6, units="in")
ggsave(filename="Figures/Multivariate/Full_Biplots_Host.jpg", plot=biplot_full_panel_legend, dpi=500, width=20, height=6, units="in")
``` 


### Matrix of PCA's by species and time  

Generate biplot showing groupings by site for each species and time point.  

#### Pocillopora  

```{r}
poc_tp1_data<-master%>%
  select(colony_id_corr, timepoint, species, site, all_of(host_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Pocillopora")%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)%>%
  filter(timepoint=="timepoint1")

poc_tp1_data<-poc_tp1_data[complete.cases(poc_tp1_data), ]

poc_tp1_data[,-c(1:4)]<-log(poc_tp1_data[,-c(1:4)]+1)
 
poc_tp1_scaled<-prcomp(poc_tp1_data[c(5:9)], scale=TRUE, center=TRUE) 

pocTP1<-ggplot2::autoplot(poc_tp1_scaled, data=poc_tp1_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0, loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("January 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  annotate("text", x=-16, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 2, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP1
```

```{r}
poc_tp2_data<-master%>%
  select(colony_id_corr, timepoint, species, site, all_of(host_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Pocillopora")%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)%>%
  filter(timepoint=="timepoint2")
 
poc_tp2_data<-poc_tp2_data[complete.cases(poc_tp2_data), ]

poc_tp2_data[,-c(1:4)]<-log(poc_tp2_data[,-c(1:4)]+1)
 
poc_tp2_scaled<-prcomp(poc_tp2_data[c(5:9)], scale=TRUE, center=TRUE) 

pocTP2<-ggplot2::autoplot(poc_tp2_scaled, data=poc_tp2_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("March 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP2
```

```{r}
poc_tp3_data<-master%>%
  select(colony_id_corr, timepoint, species, site, all_of(host_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Pocillopora")%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)%>%
  filter(timepoint=="timepoint3")
 
poc_tp3_data<-poc_tp3_data[complete.cases(poc_tp3_data), ]

poc_tp3_data[,-c(1:4)]<-log(poc_tp3_data[,-c(1:4)]+1)
 
poc_tp3_scaled<-prcomp(poc_tp3_data[c(5:9)], scale=TRUE, center=TRUE) 

pocTP3<-ggplot2::autoplot(poc_tp3_scaled, data=poc_tp3_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("September 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP3
```

```{r}
poc_tp4_data<-master%>%
  select(colony_id_corr, timepoint, species, site, all_of(host_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Pocillopora")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)%>%
  filter(timepoint=="timepoint4")
 
poc_tp4_data<-poc_tp4_data[complete.cases(poc_tp4_data), ]

poc_tp4_data[,-c(1:4)]<-log(poc_tp4_data[,-c(1:4)]+1)
 
poc_tp4_scaled<-prcomp(poc_tp4_data[c(5:9)], scale=TRUE, center=TRUE) 

pocTP4<-ggplot2::autoplot(poc_tp4_scaled, data=poc_tp4_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("November 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP4
```


#### Acropora  

```{r}
acr_tp1_data<-master%>%
  select(colony_id_corr, timepoint, species, site, all_of(host_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Acropora")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)%>%
  filter(timepoint=="timepoint1")

acr_tp1_data<-acr_tp1_data[complete.cases(acr_tp1_data), ]

acr_tp1_data[,-c(1:4)]<-log(acr_tp1_data[,-c(1:4)]+1)
 
acr_tp1_scaled<-prcomp(acr_tp1_data[c(5:9)], scale=TRUE, center=TRUE) 

acrTP1<-ggplot2::autoplot(acr_tp1_scaled, data=acr_tp1_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0, loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("January 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  annotate("text", x=-16, y=0, label="italic(Acropora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 2, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP1
```

```{r}
acr_tp2_data<-master%>%
  select(colony_id_corr, timepoint, species, site, all_of(host_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Acropora")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)%>%
  filter(timepoint=="timepoint2")
 
acr_tp2_data<-acr_tp2_data[complete.cases(acr_tp2_data), ]

acr_tp2_data[,-c(1:4)]<-log(acr_tp2_data[,-c(1:4)]+1)
 
acr_tp2_scaled<-prcomp(acr_tp2_data[c(5:9)], scale=TRUE, center=TRUE) 

acrTP2<-ggplot2::autoplot(acr_tp2_scaled, data=acr_tp2_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("March 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP2
```

```{r}
acr_tp3_data<-master%>%
  select(colony_id_corr, timepoint, species, site, all_of(host_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Acropora")%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)%>%
  filter(timepoint=="timepoint3")
 
acr_tp3_data<-acr_tp3_data[complete.cases(acr_tp3_data), ]

acr_tp3_data[,-c(1:4)]<-log(acr_tp3_data[,-c(1:4)]+1)
 
acr_tp3_scaled<-prcomp(acr_tp3_data[c(5:9)], scale=TRUE, center=TRUE) 

acrTP3<-ggplot2::autoplot(acr_tp3_scaled, data=acr_tp3_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("September 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP3
```

```{r}
acr_tp4_data<-master%>%
  select(colony_id_corr, timepoint, species, site, all_of(host_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Acropora")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)%>%
  filter(timepoint=="timepoint4")
 
acr_tp4_data<-acr_tp4_data[complete.cases(acr_tp4_data), ]

acr_tp4_data[,-c(1:4)]<-log(acr_tp4_data[,-c(1:4)]+1)
 
acr_tp4_scaled<-prcomp(acr_tp4_data[c(5:9)], scale=TRUE, center=TRUE) 

acrTP4<-ggplot2::autoplot(acr_tp4_scaled, data=acr_tp4_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("November 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP4
```



#### Porites  

```{r}
por_tp1_data<-master%>%
  select(colony_id_corr, timepoint, species, site, all_of(host_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Porites")%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)%>%
  filter(timepoint=="timepoint1")

por_tp1_data<-por_tp1_data[complete.cases(por_tp1_data), ]

por_tp1_data[,-c(1:4)]<-log(por_tp1_data[,-c(1:4)]+1)
 
por_tp1_scaled<-prcomp(por_tp1_data[c(5:9)], scale=TRUE, center=TRUE) 

porTP1<-ggplot2::autoplot(por_tp1_scaled, data=por_tp1_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0, loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("January 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  annotate("text", x=-16, y=0, label="italic(Porites)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 2, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP1
```

```{r}
por_tp2_data<-master%>%
  select(colony_id_corr, timepoint, species, site, all_of(host_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Porites")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)%>%
  filter(timepoint=="timepoint2")
 
por_tp2_data<-por_tp2_data[complete.cases(por_tp2_data), ]

por_tp2_data[,-c(1:4)]<-log(por_tp2_data[,-c(1:4)]+1)
 
por_tp2_scaled<-prcomp(por_tp2_data[c(5:9)], scale=TRUE, center=TRUE) 

porTP2<-ggplot2::autoplot(por_tp2_scaled, data=por_tp2_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("March 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP2
```

```{r}
por_tp3_data<-master%>%
  select(colony_id_corr, timepoint, species, site, all_of(host_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Porites")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)%>%
  filter(timepoint=="timepoint3")
 
por_tp3_data<-por_tp3_data[complete.cases(por_tp3_data), ]

por_tp3_data[,-c(1:4)]<-log(por_tp3_data[,-c(1:4)]+1)
 
por_tp3_scaled<-prcomp(por_tp3_data[c(5:9)], scale=TRUE, center=TRUE) 

porTP3<-ggplot2::autoplot(por_tp3_scaled, data=por_tp3_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("September 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP3
```

```{r}
por_tp4_data<-master%>%
  select(colony_id_corr, timepoint, species, site, all_of(host_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(species=="Porites")%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)%>%
  filter(timepoint=="timepoint4")
 
por_tp4_data<-por_tp4_data[complete.cases(por_tp4_data), ]

por_tp4_data[,-c(1:4)]<-log(por_tp4_data[,-c(1:4)]+1)
 
por_tp4_scaled<-prcomp(por_tp4_data[c(5:9)], scale=TRUE, center=TRUE) 

porTP4<-ggplot2::autoplot(por_tp4_scaled, data=por_tp4_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
 # ggtitle("November 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP4
```

#### Assemble grid plot of all metrics by species and time  
 
```{r}
all_grid<-plot_grid(acrTP1, acrTP2, acrTP3, acrTP4, pocTP1, pocTP2, pocTP3, pocTP4, porTP1, porTP2, porTP3, porTP4, ncol=4, nrow=3)
all_grid2<-plot_grid(all_grid, legend, rel_heights = c(4, .2), ncol=1, nrow=2)

ggsave(filename="Figures/Multivariate/Matrix_Host_Responses.png", plot=all_grid2, dpi=500, width=20, height=20, units="in")

```

## Symbiont Responses  

### PCA's for centroid and trajectories  

#### Acropora  

Generate PCA using scaled (scaled_acr_afdw) from dataframe (acr_data_afdw).   
  
```{r}
acr_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Total_Chl<13)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  filter(species=="Acropora")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell, SH_Ratio=Ratio_AFDW.mg.cm2)

acr_data_afdw<-acr_data_afdw[complete.cases(acr_data_afdw), ]

acr_data_afdw[,-c(1:4)]<-log(acr_data_afdw[,-c(1:4)]+1)

scaled_acr_afdw<-prcomp(acr_data_afdw[c(5:13)], scale=TRUE, center=TRUE) 

acr_info<-acr_data_afdw[c(2,4)]

acr_data<-scaled_acr_afdw%>%
  augment(acr_info)%>%
  group_by(timepoint, site)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

acr.centroids<-acr_data %>% 
  select(timepoint, site, PC1.mean, PC2.mean)%>%
  group_by(timepoint, site)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
```

Examine PERMANOVA results.  
 
```{r}
# scale data
vegan <- scale(acr_data_afdw[ ,5:13])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis2(vegan ~ timepoint*site, data = acr_data_afdw, method='eu')
z_acr<-permanova
z_acr
``` 
 
adonis2(formula = vegan ~ timepoint * site, data = acr_data_afdw, method = "eu")
                Df SumOfSqs      R2       F Pr(>F)    
timepoint        3   255.03 0.25529 13.6811  0.001 ***
site             2    60.94 0.06100  4.9037  0.001 ***
timepoint:site   6    61.66 0.06172  1.6539  0.022 *  
Residual       100   621.37 0.62199                   
Total          111   999.00 1.00000 

Calculate Omega effect sizes for site and time point. 
```{r}
adonis_OmegaSq(z_acr, partial = TRUE)
```

Examine dispersion for this model by site 
```{r}
#conduct pairwise adonis to look at pairwise permanova comparisons
pairwise.adonis(x=acr_data_afdw[ ,5:13],factors=acr_data_afdw$site, sim.function="vegdist",  sim.method='euclidean', p.adjust.m='bonferroni')

#evaluate dispersion
beta_site<-betadisper(vegdist(acr_data_afdw[ ,5:13], "euclidian"), acr_data_afdw$site)
anova(beta_site)

#conduct posthoc analysis of betadispersion
TukeyHSD(beta_site)
```
There is a difference in dispersion by site, so therefore differences are likely due to  both dispersion and centroid location. 

Examine dispersion for this model by season 
```{r}
#conduct pairwise adonis to look at pairwise permanova comparisons
pairwise.adonis(x=acr_data_afdw[ ,5:13],factors=acr_data_afdw$timepoint, sim.function="vegdist",  sim.method='euclidean', p.adjust.m='bonferroni')

#evaluate dispersion
beta_time<-betadisper(vegdist(acr_data_afdw[ ,5:13], "euclidian"), acr_data_afdw$timepoint)
anova(beta_time)

#conduct posthoc analysis of betadispersion
TukeyHSD(beta_time)
```
There is a significant difference in dispersion by timepoint, so differences are likely due to dispersion and centroid location.

Assemble plot with background points
```{r}
#1. make plot with dots
acrPCA<-ggplot(acr_data, aes(.fittedPC1, .fittedPC2, color=site)) + 
  geom_point(size = 4, alpha=0.2, show.legend=FALSE)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  ylim(-6,6)+
  xlim(-6,6)+
  ylab("PC2")+
  xlab("PC1")+
  ggtitle(expression(italic("Acropora")))+
  #geom_text(x=3, y=5.5, label=paste("T=",z_acr$`Pr(>F)`[1]), size=6, color=ifelse(z_acr$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  #geom_text(x=3, y=4.75, label=paste("S=",z_acr$`Pr(>F)`[2]), size=6, color=ifelse(z_acr$`Pr(>F)`[2] < 0.05, "black", "darkgray")) + 
  #geom_text(x=3, y=4, label=paste("TxS=",z_acr$`Pr(>F)`[3]), size=6, color=ifelse(z_acr$`Pr(>F)`[3] < 0.05, "black", "darkgray")) + 
  #geom_text(x=3, y=5.5, label="T=0.001", size=6, color="black") + 
  #geom_text(x=3, y=4.75, label="S=0.001", size=6, color="black") + 
  #geom_text(x=3, y=4, label="TxS=0.021", size=6, color="black") + 
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         title = element_text(size=25, face="bold"), 
         axis.title = element_text(size=18));acrPCA

```

Add centroids  

```{r}
#2. add centroids 
acrPCAcen<-acrPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site), data=acr.centroids, size=3, show.legend=FALSE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="none"); acrPCAcen

```

Add segments

```{r}
#3. add segments
segpoints<-acr.centroids%>%
  gather(variable, value, -(timepoint:site)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
acrPCAfull<-acrPCAcen + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = site), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = site), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = site), data = segpoints, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); acrPCAfull
```

Add bi plot with loadings  
```{r}
#1. make plot with dots
acrArrows<-ggplot2::autoplot(scaled_acr_afdw, data=acr_data_afdw, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=3.5, loadings.label.vjust=0.5, loadings.label.hjust=-0.1, loadings.label.repel=TRUE, size=4, alpha=0.0) + 
  #geom_point(aes(fill=site, colour=site), alpha=0.2)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
    ggtitle(expression(italic("Acropora")))+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         #axis.text.x=element_blank(),
         #axis.text.y=element_blank(),
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         title = element_text(size=25, face="bold"),
         axis.title = element_text(size=20));acrArrows
```

#### Porites

Generate PCA using scaled (scaled_por_afdw) from dataframe (por_data_afdw).   
 
Calculate centroid locations for each site and timepoint and pull PC1 and PC2 locations.
 
```{r}
por_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site, haplotype, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Total_Chl<13)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  filter(species=="Porites")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell, SH_Ratio=Ratio_AFDW.mg.cm2)

por_data_afdw<-por_data_afdw[complete.cases(por_data_afdw), ]

por_data_afdw[,-c(1:5)]<-log(por_data_afdw[,-c(1:5)]+1)

scaled_por_afdw<-prcomp(por_data_afdw[c(6:14)], scale=TRUE, center=TRUE) 

por_info<-por_data_afdw[c(2,4)]

por_data<-scaled_por_afdw%>%
  augment(por_info)%>%
  group_by(timepoint, site)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

por.centroids<-por_data %>% 
  select(timepoint, site, PC1.mean, PC2.mean)%>%
  group_by(timepoint, site)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
```

```{r}
# scale data
vegan <- scale(por_data_afdw[ ,6:14])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis2(vegan ~ haplotype+timepoint*site, data = por_data_afdw, method='eu')
z_por<-permanova
z_por
```

adonis2(formula = vegan ~ haplotype + timepoint * site, data = por_data_afdw, method = "eu")
                Df SumOfSqs      R2       F Pr(>F)    
haplotype        1   186.77 0.13303 30.7757  0.001 ***
timepoint        3   202.11 0.14396 11.1014  0.001 ***
site             2    64.47 0.04592  5.3117  0.001 ***
timepoint:site   6    76.75 0.05467  2.1078  0.001 ***
Residual       144   873.90 0.62243                   
Total          156  1404.00 1.00000     

Calculate Omega effect sizes for site and time point. 
```{r}
adonis_OmegaSq(z_por, partial = TRUE)
```

Examine dispersion for this model by site 
```{r}
#conduct pairwise adonis to look at pairwise permanova comparisons
pairwise.adonis(x=por_data_afdw[ ,6:14],factors=por_data_afdw$site, sim.function="vegdist",  sim.method='euclidean', p.adjust.m='bonferroni')

#evaluate dispersion
beta_site<-betadisper(vegdist(por_data_afdw[ ,6:14], "euclidian"), por_data_afdw$site)
anova(beta_site)

#conduct posthoc analysis of betadispersion
TukeyHSD(beta_site)
```
There is a difference in dispersion by site, so therefore differences are likely due to  both dispersion and centroid location. 

Examine dispersion for this model by season 
```{r}
#conduct pairwise adonis to look at pairwise permanova comparisons
pairwise.adonis(x=por_data_afdw[ ,6:14],factors=por_data_afdw$timepoint, sim.function="vegdist",  sim.method='euclidean', p.adjust.m='bonferroni')

#evaluate dispersion
beta_time<-betadisper(vegdist(por_data_afdw[ ,6:14], "euclidian"), por_data_afdw$timepoint)
anova(beta_time)

#conduct posthoc analysis of betadispersion
TukeyHSD(beta_time)
```
There is no significant difference in dispersion by timepoint, so differences are likely due to only centroid location.

Examine dispersion for this model by haplotype 
```{r}
#conduct pairwise adonis to look at pairwise permanova comparisons
pairwise.adonis(x=por_data_afdw[ ,6:14],factors=por_data_afdw$haplotype, sim.function="vegdist",  sim.method='euclidean', p.adjust.m='bonferroni')

#evaluate dispersion
beta_haplo<-betadisper(vegdist(por_data_afdw[ ,6:14], "euclidian"), por_data_afdw$haplotype)
anova(beta_haplo)

#conduct posthoc analysis of betadispersion
TukeyHSD(beta_haplo)
```

Assemble plot with background points
```{r}
#1. make plot with dots
porPCA<-ggplot(por_data, aes(.fittedPC1, .fittedPC2, color=site)) + 
  geom_point(size = 4, alpha=0.2, show.legend=FALSE)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  ylab("PC2")+
  xlab("PC1")+
  ylim(-6,6)+
  xlim(-6,6)+
  ggtitle(expression(italic("Porites")))+
  #geom_text(x=3, y=5.5, label=paste("T=",z_por$`Pr(>F)`[1]), size=6, color=ifelse(z_por$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  #geom_text(x=3, y=4.75, label=paste("S=",z_por$`Pr(>F)`[2]), size=6, color=ifelse(z_por$`Pr(>F)`[2] < 0.05, "black", "darkgray")) + 
  #geom_text(x=3, y=4, label=paste("TxS=",z_por$`Pr(>F)`[3]), size=6, color=ifelse(z_por$`Pr(>F)`[3] < 0.05, "black", "darkgray")) + 
  #geom_text(x=3, y=5.5, label="T=0.001", size=6, color="black") + 
  #geom_text(x=3, y=4.75, label="S=0.001", size=6, color="black") + 
  #geom_text(x=3, y=4, label="TxS=0.001", size=6, color="black") + 
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         legend.title = element_blank(), 
         axis.text = element_text(size=18), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         title = element_text(size=25, face="bold"),
         axis.title = element_text(size=18,  face="bold"));porPCA
```

Add centroids  

```{r}
#2. add centroids 
porPCAcen<-porPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site), data=por.centroids, size=3, show.legend=FALSE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position=c(1,0.3)); porPCAcen

#build a plot for the legend
legend_plot<-porPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site), data=por.centroids, size=3, show.legend=TRUE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="bottom")+theme(legend.text=element_text(size=18))

# extract the legend from one of the plots
legend <- get_legend(
  # create some space to the left of the legend
  legend_plot + theme(legend.box.margin = margin(1,1,1,1))
)

```

Add segments

```{r}
#3. add segments
segpoints<-por.centroids%>%
  gather(variable, value, -(timepoint:site)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
porPCAfull<-porPCAcen + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = site), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = site), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = site), data = segpoints, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); porPCAfull
```

Add bi plot with loadings  
```{r}
#1. make plot with dots
porArrows<-ggplot2::autoplot(scaled_por_afdw, data=por_data_afdw, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=3.5, loadings.label.vjust=-0.1, loadings.label.hjust=0.1, loadings.label.repel=TRUE, size=4, alpha=0.0) + 
  #geom_point(aes(fill=site, colour=site), alpha=0.2)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-0.5,0.1)+
  #ylim(-0.5, 0.5)+
    ggtitle(expression(italic("Porites")))+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         #axis.text.x=element_blank(),
         #axis.text.y=element_blank(),
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         title = element_text(size=25, face="bold"),
         axis.title = element_text(size=20));porArrows
```

Assemble final figure with inset biplot.  
```{r}
#porFullPCA<-ggdraw(porPCAfull)+ #+ theme_half_open(12)) +
 # draw_plot(porArrows, .5, .5, .5, .5); porFullPCA #x, y, w, h

#ggsave(filename="Figures/FullPCA_Porites.pdf", plot=porFullPCA, dpi=300, width=12, height=8, units="in")
```

##### Plot POR haplotypes 

```{r}
por_data_afdw_haplotype<-master%>%
  select(colony_id_corr, timepoint, species, haplotype, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Total_Chl<13)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  filter(species=="Porites")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell, SH_Ratio=Ratio_AFDW.mg.cm2)

por_data_afdw_haplotype<-por_data_afdw_haplotype[complete.cases(por_data_afdw_haplotype), ]

por_data_afdw_haplotype[,-c(1:4)]<-log(por_data_afdw_haplotype[,-c(1:4)]+1)

scaled_por_afdw_haplotype<-prcomp(por_data_afdw_haplotype[c(5:13)], scale=TRUE, center=TRUE) 

por_info_haplotype<-por_data_afdw_haplotype[c(2,4)]

por_data_haplotype<-scaled_por_afdw_haplotype%>%
  augment(por_info_haplotype)%>%
  group_by(timepoint, haplotype)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

por.centroids_haplotype<-por_data_haplotype %>% 
  select(timepoint, haplotype, PC1.mean, PC2.mean)%>%
  group_by(timepoint, haplotype)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
```

Assemble plot with background points
```{r}
#1. make plot with dots
porPCA_haplotype<-ggplot(por_data_haplotype, aes(.fittedPC1, .fittedPC2, color=haplotype)) + 
  geom_point(size = 4, alpha=0.1, show.legend=TRUE)+
  scale_colour_manual(values=c("black", "darkgray")) +
  scale_fill_manual(values=c("black", "darkgray")) + 
  theme_classic()+
  ylab("PC2")+
  xlab("PC1")+
  #ylim(-6,6)+
  #xlim(-6,6)+
  ggtitle("Symbiont")+
  theme(legend.text = element_text(size=18), 
         legend.position="right",
         plot.background = element_blank(),
         legend.title = element_blank(), 
         axis.text = element_text(size=18), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         title = element_text(size=18, face="bold"),
         axis.title = element_text(size=18,  face="bold"));porPCA_haplotype
```

Add centroids  

```{r}
#2. add centroids 
porPCAcen_haplotype<-porPCA_haplotype + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=haplotype), data=por.centroids_haplotype, size=3, show.legend=TRUE); porPCAcen_haplotype

#build a plot for the legend
legend_plot_haplotype<-porPCA_haplotype + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=haplotype), data=por.centroids_haplotype, size=3, show.legend=TRUE) + 
  scale_colour_manual(values=c("black", "darkgray"))+
  theme(legend.position="bottom")+theme(legend.text=element_text(size=18))

# extract the legend from one of the plots
legend_haplotype <- get_legend(
  # create some space to the left of the legend
  legend_plot_haplotype + theme(legend.box.margin = margin(1,1,1,1))
)

```

Add segments

```{r}
#3. add segments
segpoints_haplotype<-por.centroids_haplotype%>%
  gather(variable, value, -(timepoint:haplotype)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
porPCAsym_haplotype<-porPCAcen_haplotype + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = haplotype), data = segpoints_haplotype, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = haplotype), data = segpoints_haplotype, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = haplotype), data = segpoints_haplotype, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); porPCAsym_haplotype
```

#### Pocillopora   

Generate PCA using scaled (scaled_poc_afdw) from dataframe (poc_data_afdw). 
 
```{r}
poc_data_afdw<-master%>%
  select(colony_id_corr, timepoint, species, site, haplotype, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Total_Chl<13)%>%
  filter(species=="Pocillopora")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell, SH_Ratio=Ratio_AFDW.mg.cm2)

poc_data_afdw<-poc_data_afdw[complete.cases(poc_data_afdw), ]

poc_data_afdw[,-c(1:5)]<-log(poc_data_afdw[,-c(1:5)]+1)

poc_data_afdw<-poc_data_afdw[complete.cases(poc_data_afdw), ]
 
scaled_poc_afdw<-prcomp(poc_data_afdw[c(6:14)], scale=TRUE, center=TRUE) 

poc_info<-poc_data_afdw[c(2,4)]

poc_data<-scaled_poc_afdw%>%
  augment(poc_info)%>%
  group_by(timepoint, site)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

poc.centroids<-poc_data %>% 
  select(timepoint, site, PC1.mean, PC2.mean)%>%
  group_by(timepoint, site)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
``` 
  
```{r}
# scale data
vegan <- scale(poc_data_afdw[ ,6:14])

# PerMANOVA - partitioning the euclidean distance matrix by species
permanova<-adonis2(vegan ~ haplotype+timepoint*site, data = poc_data_afdw, method='eu')
z_poc<-permanova
z_poc
```
adonis2(formula = vegan ~ haplotype + timepoint * site, data = poc_data_afdw, method = "eu")
                Df SumOfSqs      R2       F Pr(>F)    
haplotype        1    45.11 0.03456  7.1534  0.001 ***
timepoint        3   282.66 0.21659 14.9425  0.001 ***
site             2    39.87 0.03055  3.1614  0.003 ** 
timepoint:site   6    98.76 0.07568  2.6104  0.001 ***
Residual       133   838.62 0.64262                   
Total          145  1305.00 1.00000 

Calculate Omega effect sizes for site and time point. 
```{r}
adonis_OmegaSq(z_poc, partial = TRUE)
```

Examine dispersion for this model by site 
```{r}
#conduct pairwise adonis to look at pairwise permanova comparisons
pairwise.adonis(x=poc_data_afdw[ ,6:14],factors=poc_data_afdw$site, sim.function="vegdist",  sim.method='euclidean', p.adjust.m='bonferroni')

#evaluate dispersion
beta_site<-betadisper(vegdist(poc_data_afdw[ ,6:14], "euclidian"), poc_data_afdw$site)
anova(beta_site)

#conduct posthoc analysis of betadispersion
TukeyHSD(beta_site)
```
There is a difference in dispersion by site, so therefore differences are likely due to  both dispersion and centroid location. 

Examine dispersion for this model by season 
```{r}
#conduct pairwise adonis to look at pairwise permanova comparisons
pairwise.adonis(x=poc_data_afdw[ ,6:14],factors=poc_data_afdw$timepoint, sim.function="vegdist",  sim.method='euclidean', p.adjust.m='bonferroni')

#evaluate dispersion
beta_time<-betadisper(vegdist(poc_data_afdw[ ,6:14], "euclidian"), poc_data_afdw$timepoint)
anova(beta_time)

#conduct posthoc analysis of betadispersion
TukeyHSD(beta_time)
```
There is a significant difference in dispersion by timepoint, so differences are likely due to dispersion and centroid location.

Examine dispersion for this model by haplotype 
```{r}
#conduct pairwise adonis to look at pairwise permanova comparisons
pairwise.adonis(x=poc_data_afdw[ ,6:14],factors=poc_data_afdw$haplotype, sim.function="vegdist",  sim.method='euclidean', p.adjust.m='bonferroni')

#evaluate dispersion
beta_haplo<-betadisper(vegdist(poc_data_afdw[ ,6:14], "euclidian"), poc_data_afdw$haplotype)
anova(beta_haplo)

#conduct posthoc analysis of betadispersion
TukeyHSD(beta_haplo)
```

Assemble plot with background points
```{r}
#1. make plot with dots
pocPCA<-ggplot(poc_data, aes(.fittedPC1, .fittedPC2, color=site)) + 
  geom_point(size = 4, alpha=0.2, show.legend=FALSE)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  ylim(-6,6)+
  xlim(-6,6)+
  ylab("PC2")+
  xlab("PC1")+
  ggtitle(expression(italic("Pocillopora")))+
  #geom_text(x=3, y=5.5, label=paste("T=",z_poc$`Pr(>F)`[1]), size=6, color=ifelse(z_poc$`Pr(>F)`[1] < 0.05, "black", "darkgray")) + 
  #geom_text(x=3, y=4.75, label=paste("S=",z_poc$`Pr(>F)`[2]), size=6, color=ifelse(z_poc$`Pr(>F)`[2] < 0.05, "black", "darkgray")) + 
  #geom_text(x=3, y=4, label=paste("TxS=",z_poc$`Pr(>F)`[3]), size=6, color=ifelse(z_poc$`Pr(>F)`[3] < 0.05, "black", "darkgray")) + 
  #geom_text(x=3, y=5.5, label="T=0.001", size=6, color="black") + 
  #geom_text(x=3, y=4.75, label="S=0.001", size=6, color="black") + 
  #geom_text(x=3, y=4, label="TxS=0.001", size=6, color="black") + 
  theme(legend.text = element_text(size=18), 
         legend.position="none",
         plot.background = element_blank(),
         plot.margin = margin(1, 1, 1, 1, "cm"),
         legend.title = element_blank(), 
         title = element_text(size=25, face="bold"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18,  face="bold"));pocPCA

```

Add centroids  

```{r}
#2. add centroids 
pocPCAcen<-pocPCA + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=site), data=poc.centroids, size=3, show.legend=FALSE) + 
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633"))+
  theme(legend.position="none"); pocPCAcen

```

Add segments

```{r}
#3. add segments
segpoints<-poc.centroids%>%
  gather(variable, value, -(timepoint:site)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
pocPCAfull<-pocPCAcen + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = site), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = site), data = segpoints, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = site), data = segpoints, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); pocPCAfull
```

Add bi plot with loadings  
```{r}

pocArrows<-ggplot2::autoplot(scaled_poc_afdw, data=poc_data_afdw, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, loadings.label.size=3.5, loadings.label.vjust=0, loadings.label.hjust=-0.1, loadings.label.repel=TRUE, size=4, alpha=0.0) + 
  #geom_point(aes(fill=site, colour=site), alpha=0.2)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
    ggtitle(expression(italic("Pocillopora")))+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         #axis.text.x=element_blank(),
         #axis.text.y=element_blank(),
         plot.background = element_blank(),
         legend.title = element_blank(), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         axis.text = element_text(size=18), 
         title = element_text(size=25, face="bold"),
         axis.title = element_text(size=20));pocArrows
```


##### Plot POC haplotypes 

```{r}
poc_data_afdw_haplotype<-master%>%
  select(colony_id_corr, timepoint, species, haplotype, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Total_Chl>0)%>%
  filter(species=="Pocillopora")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell, SH_Ratio=Ratio_AFDW.mg.cm2)

poc_data_afdw_haplotype<-poc_data_afdw_haplotype[complete.cases(poc_data_afdw_haplotype), ]

poc_data_afdw_haplotype[,-c(1:4)]<-log(poc_data_afdw_haplotype[,-c(1:4)]+1)

scaled_poc_afdw_haplotype<-prcomp(poc_data_afdw_haplotype[c(5:13)], scale=TRUE, center=TRUE) 

poc_info_haplotype<-poc_data_afdw_haplotype[c(2,4)]

poc_data_haplotype<-scaled_poc_afdw_haplotype%>%
  augment(poc_info_haplotype)%>%
  group_by(timepoint, haplotype)%>%
  mutate(PC1.mean = mean(.fittedPC1),
         PC2.mean = mean(.fittedPC2))

poc.centroids_haplotype<-poc_data_haplotype %>% 
  select(timepoint, haplotype, PC1.mean, PC2.mean)%>%
  group_by(timepoint, haplotype)%>%
  summarise(PC1.mean = mean(PC1.mean),
         PC2.mean = mean(PC2.mean))
```

Assemble plot with background points
```{r}
#1. make plot with dots
pocPCA_haplotype<-ggplot(poc_data_haplotype, aes(.fittedPC1, .fittedPC2, color=haplotype)) + 
  geom_point(size = 4, alpha=0.1, show.legend=TRUE)+
  scale_colour_manual(values=c("black", "darkgray")) +
  scale_fill_manual(values=c("black", "darkgray")) + 
  theme_classic()+
  ylab("PC2")+
  xlab("PC1")+
  #ylim(-6,6)+
  #xlim(-6,6)+
  ggtitle("Symbiont")+
  theme(legend.text = element_text(size=18), 
         legend.position="right",
         plot.background = element_blank(),
         legend.title = element_blank(), 
         axis.text = element_text(size=18), 
         plot.margin = margin(1, 1, 1, 1, "cm"),
         title = element_text(size=18, face="bold"),
         axis.title = element_text(size=18,  face="bold"));pocPCA_haplotype
```

Add centroids  

```{r}
#2. add centroids 
pocPCAcen_haplotype<-pocPCA_haplotype + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=haplotype), data=poc.centroids_haplotype, size=3, show.legend=TRUE); pocPCAcen_haplotype

#build a plot for the legend
legend_plot_haplotype<-pocPCA_haplotype + geom_point(aes(x=PC1.mean, y=PC2.mean, colour=haplotype), data=poc.centroids_haplotype, size=3, show.legend=TRUE) + 
  scale_colour_manual(values=c("black", "darkgray"))+
  theme(legend.position="bottom")+theme(legend.text=element_text(size=18))

# extract the legend from one of the plots
legend_haplotype <- get_legend(
  # create some space to the left of the legend
  legend_plot_haplotype + theme(legend.box.margin = margin(1,1,1,1))
)

```

Add segments

```{r}
#3. add segments
segpoints_haplotype<-poc.centroids_haplotype%>%
  gather(variable, value, -(timepoint:haplotype)) %>%
  unite(temp, timepoint, variable) %>%
  spread(temp, value)
  
pocPCAsym_haplotype<-pocPCAcen_haplotype + 
  geom_segment(aes(x = timepoint1_PC1.mean, y = timepoint1_PC2.mean, xend = timepoint2_PC1.mean, yend = timepoint2_PC2.mean, colour = haplotype), data = segpoints_haplotype, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint2_PC1.mean, y = timepoint2_PC2.mean, xend = timepoint3_PC1.mean, yend = timepoint3_PC2.mean, colour = haplotype), data = segpoints_haplotype, size=2, show.legend=FALSE) +
  geom_segment(aes(x = timepoint3_PC1.mean, y = timepoint3_PC2.mean, xend = timepoint4_PC1.mean, yend = timepoint4_PC2.mean, colour = haplotype), data = segpoints_haplotype, size=2, arrow = arrow(length=unit(0.5,"cm")), show.legend=FALSE); pocPCAsym_haplotype
```


#### Assemble all plots    

```{r}
PCA_full_panel<-plot_grid(acrPCAfull, pocPCAfull, porPCAfull, labels = c("G", "H", "I"), ncol=3, nrow=1, rel_heights= c(1,1,1), rel_widths = c(1,1,1), label_size = 20, label_y=0.85, align="vh")

# add the legend to the row we made earlier. Give it one-third of 
# the width of one plot (via rel_widths).
PCA_full_panel_legend<-plot_grid(PCA_full_panel, legend, rel_heights = c(4, .2), ncol=1, nrow=2)

ggsave(filename="Figures/Multivariate/Full_Panel_PCAs_Symbiont.png", plot=PCA_full_panel_legend, dpi=500, width=20, height=6, units="in")
ggsave(filename="Figures/Multivariate/Full_Panel_PCAs_Symbiont.pdf", plot=PCA_full_panel_legend, dpi=500, width=20, height=6, units="in")
ggsave(filename="Figures/Multivariate/Full_Panel_PCAs_Symbiont.jpg", plot=PCA_full_panel_legend, dpi=500, width=20, height=6, units="in")
```  

Assemble biplots  
```{r}
biplot_full_panel<-plot_grid(acrArrows, pocArrows, porArrows, labels = c("G", "H", "I"), ncol=3, nrow=1, rel_heights= c(1,1,1), rel_widths = c(1,1,1), label_size = 20, label_y=0.85, align="vh")

# add the legend to the row we made earlier. Give it one-third of 
# the width of one plot (via rel_widths).
biplot_full_panel_legend<-plot_grid(biplot_full_panel, legend, rel_heights = c(4, .2), ncol=1, nrow=2)

ggsave(filename="Figures/Multivariate/Full_Biplots_Symbiont.png", plot=biplot_full_panel_legend, dpi=500, width=20, height=6, units="in")
ggsave(filename="Figures/Multivariate/Full_Biplots_Symbiont.pdf", plot=biplot_full_panel_legend, dpi=500, width=20, height=6, units="in")
ggsave(filename="Figures/Multivariate/Full_Biplots_Symbiont.jpg", plot=biplot_full_panel_legend, dpi=500, width=20, height=6, units="in")
``` 

### Matrix of PCA's by species and time  

Generate biplot showing groupings by site for each species and time point.  

#### Pocillopora  

```{r}
poc_tp1_data<-master%>%
  select(colony_id_corr, timepoint, species, site, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Ic<1000)%>%
  #filter(Total_Chl<13)%>%
  filter(species=="Pocillopora")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2)%>%
  filter(timepoint=="timepoint1")

poc_tp1_data<-poc_tp1_data[complete.cases(poc_tp1_data), ]

poc_tp1_data[,-c(1:4)]<-log(poc_tp1_data[,-c(1:4)]+1)
 
poc_tp1_scaled<-prcomp(poc_tp1_data[c(5:13)], scale=TRUE, center=TRUE) 

pocTP1<-ggplot2::autoplot(poc_tp1_scaled, data=poc_tp1_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0, loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("January 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  annotate("text", x=-16, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 2, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP1
```

```{r}
poc_tp2_data<-master%>%
  select(colony_id_corr, timepoint, species, site, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Total_Chl<13)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  filter(species=="Pocillopora")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint2")
 
poc_tp2_data<-poc_tp2_data[complete.cases(poc_tp2_data), ]

poc_tp2_data[,-c(1:4)]<-log(poc_tp2_data[,-c(1:4)]+1)
 
poc_tp2_scaled<-prcomp(poc_tp2_data[c(5:13)], scale=TRUE, center=TRUE) 

pocTP2<-ggplot2::autoplot(poc_tp2_scaled, data=poc_tp2_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("March 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP2
```

```{r}
poc_tp3_data<-master%>%
  select(colony_id_corr, timepoint, species, site, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Ic<1000)%>%
  #filter(Total_Chl<13)%>%
  filter(species=="Pocillopora")%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint3")
 
poc_tp3_data<-poc_tp3_data[complete.cases(poc_tp3_data), ]

poc_tp3_data[,-c(1:4)]<-log(poc_tp3_data[,-c(1:4)]+1)
 
poc_tp3_scaled<-prcomp(poc_tp3_data[c(5:13)], scale=TRUE, center=TRUE) 

pocTP3<-ggplot2::autoplot(poc_tp3_scaled, data=poc_tp3_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("September 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP3
```

```{r}
poc_tp4_data<-master%>%
  select(colony_id_corr, timepoint, species, site, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Ic<1000)%>%
  #filter(Total_Chl<13)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(species=="Pocillopora")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint4")
 
poc_tp4_data<-poc_tp4_data[complete.cases(poc_tp4_data), ]

poc_tp4_data[,-c(1:4)]<-log(poc_tp4_data[,-c(1:4)]+1)
 
poc_tp4_scaled<-prcomp(poc_tp4_data[c(5:13)], scale=TRUE, center=TRUE) 

pocTP4<-ggplot2::autoplot(poc_tp4_scaled, data=poc_tp4_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("November 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));pocTP4
```


#### Acropora  

```{r}
acr_tp1_data<-master%>%
  select(colony_id_corr, timepoint, species, site, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Total_Chl<13)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  filter(species=="Acropora")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint1")

acr_tp1_data<-acr_tp1_data[complete.cases(acr_tp1_data), ]

acr_tp1_data[,-c(1:4)]<-log(acr_tp1_data[,-c(1:4)]+1)
 
acr_tp1_scaled<-prcomp(acr_tp1_data[c(5:13)], scale=TRUE, center=TRUE) 

acrTP1<-ggplot2::autoplot(acr_tp1_scaled, data=acr_tp1_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0, loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("January 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  annotate("text", x=-16, y=0, label="italic(Acropora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 2, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP1
```

```{r}
acr_tp2_data<-master%>%
  select(colony_id_corr, timepoint, species, site, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Total_Chl<13)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  filter(species=="Acropora")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint2")
 
acr_tp2_data<-acr_tp2_data[complete.cases(acr_tp2_data), ]

acr_tp2_data[,-c(1:4)]<-log(acr_tp2_data[,-c(1:4)]+1)
 
acr_tp2_scaled<-prcomp(acr_tp2_data[c(5:13)], scale=TRUE, center=TRUE) 

acrTP2<-ggplot2::autoplot(acr_tp2_scaled, data=acr_tp2_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("March 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP2
```

```{r}
acr_tp3_data<-master%>%
  select(colony_id_corr, timepoint, species, site, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Total_Chl<13)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  filter(species=="Acropora")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint3")
 
acr_tp3_data<-acr_tp3_data[complete.cases(acr_tp3_data), ]

acr_tp3_data[,-c(1:4)]<-log(acr_tp3_data[,-c(1:4)]+1)
 
acr_tp3_scaled<-prcomp(acr_tp3_data[c(5:13)], scale=TRUE, center=TRUE) 

acrTP3<-ggplot2::autoplot(acr_tp3_scaled, data=acr_tp3_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("September 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP3
```

```{r}
acr_tp4_data<-master%>%
  select(colony_id_corr, timepoint, species, site, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Ic<1000)%>%
  #filter(Total_Chl<13)%>%
  filter(species=="Acropora")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint4")
 
acr_tp4_data<-acr_tp4_data[complete.cases(acr_tp4_data), ]

acr_tp4_data[,-c(1:4)]<-log(acr_tp4_data[,-c(1:4)]+1)
 
acr_tp4_scaled<-prcomp(acr_tp4_data[c(5:13)], scale=TRUE, center=TRUE) 

acrTP4<-ggplot2::autoplot(acr_tp4_scaled, data=acr_tp4_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  ggtitle("November 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));acrTP4
```



#### Porites  

```{r}
por_tp1_data<-master%>%
  select(colony_id_corr, timepoint, species, site, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Ic<1000)%>%
  #filter(Total_Chl<13)%>%
  filter(species=="Porites")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint1")

por_tp1_data<-por_tp1_data[complete.cases(por_tp1_data), ]

por_tp1_data[,-c(1:4)]<-log(por_tp1_data[,-c(1:4)]+1)
 
por_tp1_scaled<-prcomp(por_tp1_data[c(5:13)], scale=TRUE, center=TRUE) 

porTP1<-ggplot2::autoplot(por_tp1_scaled, data=por_tp1_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0, loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("January 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  annotate("text", x=-16, y=0, label="italic(Porites)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 2, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP1
```

```{r}
por_tp2_data<-master%>%
  select(colony_id_corr, timepoint, species, site, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Ic<1000)%>%
  #filter(Total_Chl<13)%>%
  filter(species=="Porites")%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint2")
 
por_tp2_data<-por_tp2_data[complete.cases(por_tp2_data), ]
 
por_tp2_data[,-c(1:4)]<-log(por_tp2_data[,-c(1:4)]+1)

por_tp2_scaled<-prcomp(por_tp2_data[c(5:13)], scale=TRUE, center=TRUE) 

porTP2<-ggplot2::autoplot(por_tp2_scaled, data=por_tp2_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("March 2020")+
  coord_cartesian(xlim=c(-8, 8), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP2
```

```{r}
por_tp3_data<-master%>%
  select(colony_id_corr, timepoint, species, site, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ic<1000)%>%
  #filter(Total_Chl<13)%>%
  filter(species=="Porites")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint3")
 
por_tp3_data<-por_tp3_data[complete.cases(por_tp3_data), ]

por_tp3_data[,-c(1:4)]<-log(por_tp3_data[,-c(1:4)]+1)
 
por_tp3_scaled<-prcomp(por_tp3_data[c(5:13)], scale=TRUE, center=TRUE) 

porTP3<-ggplot2::autoplot(por_tp3_scaled, data=por_tp3_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
  #ggtitle("September 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP3
```

```{r}
por_tp4_data<-master%>%
  select(colony_id_corr, timepoint, species, site, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Ic<1000)%>%
  #filter(Total_Chl<13)%>%
  filter(species=="Porites")%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW, Total_Chl=Total_Chl, Total_Chl_Cell=Total_Chl_cell)%>%
  filter(timepoint=="timepoint4")
 
por_tp4_data<-por_tp4_data[complete.cases(por_tp4_data), ]

por_tp4_data[,-c(1:4)]<-log(por_tp4_data[,-c(1:4)]+1)
 
por_tp4_scaled<-prcomp(por_tp4_data[c(5:13)], scale=TRUE, center=TRUE) 

porTP4<-ggplot2::autoplot(por_tp4_scaled, data=por_tp4_data, loadings=TRUE,  colour="site", loadings.label.colour="black", loadings.colour="black", loadings.label=TRUE, frame=FALSE, frame.type="convex", frame.level=0.95, loadings.label.size=5, loadings.label.repel=TRUE, size=4, alpha=1.0,   loadings.arrow = grid::arrow(length = grid::unit(10, "points")), scale=0) + 
  #geom_point(aes(colour=site), size=3)+
  scale_colour_manual(values=c("#374d7c", "#00cccc", "#ff6633")) +
  scale_fill_manual(values=c("#374d7c", "#00cccc", "#ff6633")) + 
  theme_classic()+
  #xlim(-.3,.6)+
  #ylim(-.3, .3)+
 # ggtitle("November 2020")+
  coord_cartesian(xlim=c(-8, 9), ylim=c(-5, 5), clip = "off")+
  #annotate("text", x=-8, y=0, label="italic(Pocillopora)", fontface="bold", parse = TRUE, angle=90, size=10)+
   theme(legend.text = element_text(size=18), 
         legend.position="none",
         axis.text.x=element_text(colour="black"),
         axis.text.y=element_text(colour="black"),
         plot.background = element_blank(),
         plot.title = element_text(size=22, face="bold", hjust = 0.5), 
         plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
         axis.text = element_text(size=18), 
         axis.title = element_text(size=18));porTP4
```

#### Assemble grid plot of all metrics by species and time  

```{r}
all_grid<-plot_grid(acrTP1, acrTP2, acrTP3, acrTP4, pocTP1, pocTP2, pocTP3, pocTP4, porTP1, porTP2, porTP3, porTP4, ncol=4, nrow=3)
all_grid2<-plot_grid(all_grid, legend, rel_heights = c(4, .2), ncol=1, nrow=2)

ggsave(filename="Figures/Multivariate/Matrix_Symbiont_Responses.png", plot=all_grid2, dpi=500, width=20, height=20, units="in")

```




## Build panel for haplotype plots 

porPCAfull_haplotype = holobiont
porPCAhost_haplotype = host 

```{r}
porPCAsym_haplotype 
porPCAfull_haplotype
porPCAhost_haplotype

haplotype_grid<-plot_grid(porPCAfull_haplotype, porPCAhost_haplotype, porPCAsym_haplotype, ncol=3, rel_widths=c(0.7, 0.7, 1.1))

ggsave(filename="Figures/Multivariate/Haplotype_POR_Panel.pdf", haplotype_grid, width=18, height=5)
``` 


```{r}
pocPCAsym_haplotype 
pocPCAfull_haplotype
pocPCAhost_haplotype

haplotype_grid_poc<-plot_grid(pocPCAfull_haplotype, pocPCAhost_haplotype, pocPCAsym_haplotype, ncol=3, rel_widths=c(0.7, 0.7, 1.1))

ggsave(filename="Figures/Multivariate/Haplotype_POC_Panel.pdf", haplotype_grid_poc, width=18, height=5)
```
