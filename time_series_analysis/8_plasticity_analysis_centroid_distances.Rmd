---
title: "Plasticity analysis centroid distances"
author: "Ariana S Huffmyer, Serena Hackerott, E5 RoL Team"
date: "06/12/2023"
output: 
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
editor_options: 
  chunk_output_type: console
--- 

# Set Up    
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

```{r}
## install packages if you dont already have them
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("vegan")) install.packages("vegan")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("ggpubr")) install.packages("ggpubr")

# load packages
library(tidyverse)
library(vegan)
library(ggplot2)
library(ggpubr)

```


#Site colors

```{r}
site.cols<-c("#374d7c", "#00cccc", "#ff6633")
#"Mahana Low", "Hilton Medium", "Manava High")
```

# Load dataframe

Load in master dataframe generated from 1_assemble_data.Rmd.  
```{r}
master<-read.csv("Output/master_timeseries.csv")

#reorder site levels 
master$site_code<-as.factor(master$site_code)
master$site_code<-fct_relevel(master$site_code, "Mahana Low", "Hilton Medium", "Manava High")
```


# Holobiont responses   
```{r}
data_all<-master%>%
  select(colony_id_corr, timepoint, species, site_code, Host_AFDW.mg.cm2, Sym_AFDW.mg.cm2, Ratio_AFDW.mg.cm2, prot_mg.mgafdw, cells.mgAFDW, cre.umol.mgafdw, Am, AQY, Rd, calc.umol.cm2.hr, Total_Chl, Total_Chl_cell)%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Symbiont_Density=cells.mgAFDW, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)
```

##Log+1 transform all responses
```{r}
data_all_log <-data_all
data_all_log[,-c(1:4)]<-log(data_all_log[,-c(1:4)]+1)

#change timepoint to a factor 
data_all_log$timepoint<-as.factor(data_all_log$timepoint)

#change species to a factor 
data_all_log$species<-as.factor(data_all_log$species)
```

##Update site naming
```{r}
data_all_log.comp<-data_all_log[complete.cases(data_all_log), ]

data_all_log.comp<-separate(data_all_log.comp, "site_code", into=c("site", "nutrient"), remove=FALSE)
data_all_log.comp$siteID<-paste(data_all_log.comp$site, data_all_log.comp$nutrient, sep="")
```

##Differences in dispersion between species
```{r}
species.disp<-betadisper(vegdist(data_all_log.comp[,7:18], "euclidean"), data_all_log.comp$species)
anova(species.disp)
#            Df  Sum Sq Mean Sq F value   Pr(>F)   
# Groups      2  1.0697 0.53483  6.4532 0.001757 **
# Residuals 374 30.9965 0.08288    
#Significant difference in dispersion between Species (cannot attribute significant effect from PERMANOVA to difference in centroids alone) 
#Difference in "plasticity" between species 

##Pairwise comparisons of dispersion between Species
TukeyHSD(species.disp)
#                             diff         lwr        upr     p adj
# Pocillopora-Acropora -0.05669480 -0.14517953 0.03178992 0.2884423
# Porites-Acropora      0.06810476 -0.02010320 0.15631272 0.1654624
# Porites-Pocillopora   0.12479956  0.04294862 0.20665051 0.0010981
```


##Centroid distances
```{r}
##Obtain centroid coordinates of each Sample Set (Same Species, Site, Season) with betadisper type="centroid"
data_all_log.comp$Set<-paste(data_all_log.comp$species, data_all_log.comp$siteID, data_all_log.comp$timepoint, sep=".")

all.disp.grp<-betadisper(vegdist(data_all_log.comp[,7:18], "euclidean"), data_all_log.comp$Set, type="centroid")

##Calculate the variance of Physiology explained by the first two PCoA axes
all.disp.grp$eig[1]/sum(all.disp.grp$eig[which(all.disp.grp$eig>0)])*100
all.disp.grp$eig[2]/sum(all.disp.grp$eig[which(all.disp.grp$eig>0)])*100
sum(all.disp.grp$eig[1:2])/sum(all.disp.grp$eig[which(all.disp.grp$eig>0)])*100
#86.76% explained by first two axes 

##Calculate the Euclidean distance between centroids using coordinates of the first 2 PCoA axes
centdist.all<-as.matrix(dist(all.disp.grp$centroids[,c(1:2)], method = "euclidean"))

##Create a dataframe of distances between centroids of Sample Sets
cents.all<-data.frame(SetA=colnames(centdist.all)[col(centdist.all)], SetB=rownames(centdist.all)[row(centdist.all)], Cent.Dist=c(centdist.all))

##Remove rows comparing self-pairs of Sample Sets 
cents.all<-cents.all[-c(which(cents.all$SetA==cents.all$SetB)),]

##Remove repeats (Ex: Set 1 vs Set 2 and Set 2 vs Set 1)
cents.all<-cents.all[!duplicated(cents.all$Cent.Dist),]

##Split Sets column to add variables of interest
cents.all<-separate(cents.all, "SetA", into=c("species.A", "site.A", "timepoint.A"), remove=FALSE)
cents.all<-separate(cents.all, "SetB", into=c("species.B", "site.B", "timepoint.B"), remove=FALSE)

##Filter to only keep rows comparing the same Species
cents.all<-cents.all[c(which(cents.all$species.A==cents.all$species.B)),]

##Species as factor
cents.all$species<-factor(cents.all$species.A, levels=c("Acropora", "Pocillopora", "Porites"))

##Dataframe with distances between Seasons by only keeping rows comparing the same Site
cents.all.seas<-cents.all[c(which(cents.all$site.A==cents.all$site.B)),]

##Dataframe with distances between Sites by only keeping rows comparing the same Season
cents.all.site<-cents.all[c(which(cents.all$timepoint.A==cents.all$timepoint.B)),]

##Comparisons of interest
spp_comparisons <- list( c("Acropora", "Pocillopora"),  c( "Pocillopora", "Porites"), c("Acropora", "Porites") )

```

##Run ANOVA on plasticity values 

Run anova on seasonal plasticity between species.
```{r}
summary(aov(Cent.Dist~species*site.A, data=cents.all.seas))
#                  Df Sum Sq Mean Sq F value Pr(>F)
# species.A         2  0.640  0.3199   2.348  0.107
# site.A            2  0.373  0.1867   1.370  0.265
# species.A:site.A  4  0.556  0.1390   1.020  0.407
# Residuals        45  6.133  0.1363  
#No significant difference in seasonal plasticity between species
#The effect of season does not differ between sites

compare_means(Cent.Dist~species, data=cents.all.seas, method = "anova")
#   .y.           p p.adj p.format p.signif method
#   <chr>     <dbl> <dbl> <chr>    <chr>    <chr> 
# 1 Cent.Dist 0.110  0.11 0.11     ns       Anova 
```

Run anova on spatial plasticity between species.
```{r}
summary(aov(Cent.Dist~species*timepoint.A, data=cents.all.site))
#                       Df Sum Sq Mean Sq F value   Pr(>F)    
# species.A              2 0.7165  0.3582  10.841 0.000442 ***
# timepoint.A            3 0.2339  0.0780   2.359 0.096731 .  
# species.A:timepoint.A  6 0.2003  0.0334   1.010 0.441827    
# Residuals             24 0.7931  0.0330    
#Significant difference in spatial plasticity between species
#The effect of site does not differ between seasons 

compare_means(Cent.Dist~species, data=cents.all.site, method = "anova")
#   .y.              p   p.adj p.format p.signif method
#   <chr>        <dbl>   <dbl> <chr>    <chr>    <chr> 
# 1 Cent.Dist 0.000507 0.00051 0.00051  ***      Anova 

```

##Generate figures- Seasonal and Spatial Plasticity
```{r}

season.plasticity.plot<-ggplot(cents.all.seas, aes(x=species.A, y=Cent.Dist, fill=species.A)) + 
  geom_boxplot(alpha=0.8, outlier.shape = NA)+
  geom_jitter(shape=16, position=position_jitter(0.2), alpha=0.5, size=3)+
  scale_fill_manual(name="Species", values = c("darkgray", "orange", "purple"))+
  stat_compare_means(method = "anova", label.x=1.75, size=6)+
  theme_classic()+
  theme(axis.title.x = element_text(size = 18), axis.title.y = element_text(size = 18), axis.text.x = element_text(size=14, face="italic"), axis.text.y = element_text(size=14), legend.text=element_text(size=12), legend.title=element_text(size=15), legend.position="none")+
  ylim(0,1.55)+
  ylab("Holobiont Seasonal Plasticity")+
  xlab("Species");season.plasticity.plot

ggsave("Figures/Plasticity/dispersion_plasticity_season.png", season.plasticity.plot, width=4, height=4, dpi=300)


spatial.plasticity.plot<-ggplot(cents.all.site, aes(x=species.A, y=Cent.Dist, fill=species.A)) + 
  geom_boxplot(alpha=0.8, outlier.shape = NA)+
  geom_jitter(shape=16, position=position_jitter(0.2), alpha=0.5, size=3)+
  scale_fill_manual(name="Species", values = c("darkgray", "orange", "purple"))+
    stat_compare_means(method = "anova", label.x=1.75, size=6)+
  stat_compare_means(comparisons = spp_comparisons, size=5)+
  theme_classic()+
  theme(axis.title.x = element_text(size = 18), axis.title.y = element_text(size = 18), axis.text.x = element_text(size=14, face="italic"), axis.text.y = element_text(size=14), legend.text=element_text(size=12), legend.title=element_text(size=15), legend.position="none")+
  ylim(0,1.55)+
  ylab("Holobiont Spatial Plasticity")+
  xlab("Species");spatial.plasticity.plot

ggsave("Figures/Plasticity/dispersion_plasticity_spatial.png", spatial.plasticity.plot, width=4, height=4, dpi=300)
```


# Generate a list of symbiont and host responses.  Holobiont = all responses
```{r}
symbiont_responses<-c("cells.mgAFDW", "Sym_AFDW.mg.cm2", "Total_Chl", "Total_Chl_cell", "Am", "AQY", "Ratio_AFDW.mg.cm2") 
host_responses<-c("cre.umol.mgafdw", "Host_AFDW.mg.cm2", "prot_mg.mgafdw", "Rd", "calc.umol.cm2.hr")
```

# Host responses
```{r}
data_host<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(host_responses))%>%
  filter(Host_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2>0)%>%
  #filter(Ratio_AFDW.mg.cm2>0)%>%
  #filter(Sym_AFDW.mg.cm2<20)%>%
  filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Host_Biomass=Host_AFDW.mg.cm2, Host_Protein=prot_mg.mgafdw, Antiox_Capacity=cre.umol.mgafdw, Calc=calc.umol.cm2.hr)

data_host<-data_host[complete.cases(data_host), ]
```


##Log+1 transform all responses
```{r}
data_host_log <-data_host
data_host_log[,-c(1:4)]<-log(data_host_log[,-c(1:4)]+1)

#change timepoint to a factor 
data_host_log$timepoint<-as.factor(data_host_log$timepoint)

#change species to a factor 
data_host_log$species<-as.factor(data_host_log$species)
```

##Update site naming
```{r}
data_all_host.comp<-data_host_log

data_all_host.comp<-separate(data_all_host.comp, "site_code", into=c("site", "nutrient"), remove=FALSE)
data_all_host.comp$siteID<-paste(data_all_host.comp$site, data_all_host.comp$nutrient, sep="")
```


##Differences in dispersion between species
```{r}
species.disp_host<-betadisper(vegdist(data_all_host.comp[,7:11], "euclidean"), data_all_host.comp$species)
anova(species.disp_host)
#            Df  Sum Sq Mean Sq F value   Pr(>F)   
# Groups      2 3.4459 1.72296   72.59 < 2.2e-16 ***
# Residuals 387 9.1857 0.02374    
#Significant difference in dispersion of host physiology between Species (cannot attribute significant effect from PERMANOVA to difference in centroids alone) 
#Difference in "plasticity" of host between species 

##Pairwise comparisons of dispersion of host physiology between Species
TukeyHSD(species.disp_host)
#                             diff         lwr         upr     p adj
# Pocillopora-Acropora -0.04478369 -0.09129476 0.001727373 0.0619821
# Porites-Acropora      0.16630457  0.11938073 0.213228422 0.0000000
# Porites-Pocillopora   0.21108827  0.16821151 0.253965028 0.0000000
```


##Centroid distances
```{r}
##Obtain centroid coordinates of each Sample Set (Same Species, Site, Season) with betadisper type="centroid"
data_all_host.comp$Set<-paste(data_all_host.comp$species, data_all_host.comp$siteID, data_all_host.comp$timepoint, sep=".")

host.disp.grp<-betadisper(vegdist(data_all_host.comp[,7:11], "euclidean"), data_all_host.comp$Set, type="centroid")

##Calculate the variance of Physiology explained by the first two PCoA axes
host.disp.grp$eig[1]/sum(host.disp.grp$eig[which(host.disp.grp$eig>0)])*100
host.disp.grp$eig[2]/sum(host.disp.grp$eig[which(host.disp.grp$eig>0)])*100
sum(host.disp.grp$eig[1:2])/sum(host.disp.grp$eig[which(host.disp.grp$eig>0)])*100
#92.95% explained by first two axes 

##Calculate the Euclidean distance between centroids using coordinates of the first 2 PCoA axes
centdist.host<-as.matrix(dist(host.disp.grp$centroids[,c(1:2)], method = "euclidean"))

##Create a dataframe of distances between centroids of Sample Sets
cents.host<-data.frame(SetA=colnames(centdist.host)[col(centdist.host)], SetB=rownames(centdist.host)[row(centdist.host)], Cent.Dist.Host=c(centdist.host))

##Remove rows comparing self-pairs of Sample Sets 
cents.host<-cents.host[-c(which(cents.host$SetA==cents.host$SetB)),]

##Remove repeats (Ex: Set 1 vs Set 2 and Set 2 vs Set 1)
cents.host<-cents.host[!duplicated(cents.host$Cent.Dist),]

##Split Sets column to add variables of interest
cents.host<-separate(cents.host, "SetA", into=c("species.A", "site.A", "timepoint.A"), remove=FALSE)
cents.host<-separate(cents.host, "SetB", into=c("species.B", "site.B", "timepoint.B"), remove=FALSE)

##Filter to only keep rows comparing the same Species
cents.host<-cents.host[c(which(cents.host$species.A==cents.host$species.B)),]

##Add variable of Pair for merging
cents.host$Pair<-paste(cents.host$SetA, cents.host$SetB, sep="_")

##Species as factor
cents.host$species<-factor(cents.host$species.A, levels=c("Acropora", "Pocillopora", "Porites"))

##Dataframe with distances between Seasons by only keeping rows comparing the same Site
cents.host.seas<-cents.host[c(which(cents.host$site.A==cents.host$site.B)),]

##Dataframe with distances between Sites by only keeping rows comparing the same Season
cents.host.site<-cents.host[c(which(cents.host$timepoint.A==cents.host$timepoint.B)),]

```

##Run ANOVA on plasticity values 

Run anova on seasonal plasticity between species.
```{r}
summary(aov(Cent.Dist.Host~species*site.A, data=cents.host.seas))
#                  Df Sum Sq Mean Sq F value   Pr(>F)    
# species.A         2 0.4400 0.22000  10.243 0.000216 ***
# site.A            2 0.0212 0.01058   0.493 0.614306    
# species.A:site.A  4 0.1151 0.02877   1.339 0.270127    
# Residuals        45 0.9665 0.02148   
#Significant difference in seasonal plasticity of host between species
#The effect of season does not differ between sites

compare_means(Cent.Dist.Host~species, data=cents.host.seas, method = "anova")
#   .y.                   p   p.adj p.format p.signif method
#   <chr>             <dbl>   <dbl> <chr>    <chr>    <chr> 
# 1 Cent.Dist.Host 0.000191 0.00019 0.00019  ***      Anova 
  
```

Run anova on spatial plasticity between species.
```{r}
summary(aov(Cent.Dist.Host~species*timepoint.A, data=cents.host.site))
#                      Df  Sum Sq  Mean Sq F value Pr(>F)  
# species.A              2 0.06120 0.030598   3.830  0.036 *
# timepoint.A            3 0.00051 0.000170   0.021  0.996  
# species.A:timepoint.A  6 0.06930 0.011550   1.446  0.239  
# Residuals             24 0.19171 0.007988     
#Significant difference in spatial plasticity of host between species
#The effect of site does not differ between seasons 

compare_means(Cent.Dist.Host~species, data=cents.host.site, method = "anova")
#   .y.                 p p.adj p.format p.signif method
#   <chr>           <dbl> <dbl> <chr>    <chr>    <chr> 
# 1 Cent.Dist.Host 0.0311 0.031 0.031    *        Anova 
```


##Generate figures- Seasonal and Spatial Plasticity
```{r}

host.season.plasticity.plot<-ggplot(cents.host.seas, aes(x=species.A, y=Cent.Dist.Host, fill=species.A)) + 
  geom_boxplot(alpha=0.8, outlier.shape = NA)+
  geom_jitter(shape=16, position=position_jitter(0.2), alpha=0.5, size=3)+
  scale_fill_manual(name="Species", values = c("darkgray", "orange", "purple"))+
  stat_compare_means(method = "anova", label.x=1.75, size=6)+
  stat_compare_means(comparisons = spp_comparisons, size=5)+
  theme_classic()+
  theme(axis.title.x = element_text(size = 18), axis.title.y = element_text(size = 18), axis.text.x = element_text(size=14, face="italic"), axis.text.y = element_text(size=14), legend.text=element_text(size=12), legend.title=element_text(size=15), legend.position="none")+
  ylim(0,.85)+
  ylab("Host Seasonal Plasticity")+
  xlab("Species");host.season.plasticity.plot

ggsave("Figures/Plasticity/dispersion_plasticity_season_host.png", host.season.plasticity.plot, width=4, height=4, dpi=300)


host.spatial.plasticity.plot<-ggplot(cents.host.site, aes(x=species.A, y=Cent.Dist.Host, fill=species.A)) + 
  geom_boxplot(alpha=0.8, outlier.shape = NA)+
  geom_jitter(shape=16, position=position_jitter(0.2), alpha=0.5, size=3)+
  scale_fill_manual(name="Species", values = c("darkgray", "orange", "purple"))+
  stat_compare_means(method = "anova", label.x=1.75, size=6)+
  stat_compare_means(comparisons = spp_comparisons, size=5)+
  theme_classic()+
  theme(axis.title.x = element_text(size = 18), axis.title.y = element_text(size = 18), axis.text.x = element_text(size=14, face="italic"), axis.text.y = element_text(size=14), legend.text=element_text(size=12), legend.title=element_text(size=15), legend.position="none")+
  ylim(0,.85)+
  ylab("Host Spatial Plasticity")+
  xlab("Species");host.spatial.plasticity.plot

ggsave("Figures/Plasticity/dispersion_plasticity_spatial_host.png", host.spatial.plasticity.plot, width=4, height=4, dpi=300)
```




# Symbiont responses
```{r}
data_sym<-master%>%
  select(colony_id_corr, timepoint, species, site_code, all_of(symbiont_responses))%>%
  #filter(Host_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2>0)%>%
  filter(Ratio_AFDW.mg.cm2>0)%>%
  filter(Sym_AFDW.mg.cm2<20)%>%
  #filter(prot_mg.mgafdw<1.5)%>% #remove outliers
  rename(Symbiont_Biomass=Sym_AFDW.mg.cm2, S_H_Biomass_Ratio=Ratio_AFDW.mg.cm2, Symbiont_Density=cells.mgAFDW)

data_sym<-data_sym[complete.cases(data_sym), ]
```


##Log+1 transform all responses
```{r}
data_sym_log <-data_sym
data_sym_log[,-c(1:4)]<-log(data_sym_log[,-c(1:4)]+1)

#change timepoint to a factor 
data_sym_log$timepoint<-as.factor(data_sym_log$timepoint)

#change species to a factor 
data_sym_log$species<-as.factor(data_sym_log$species)
```

##Update site naming
```{r}
data_all_sym.comp<-data_sym_log

data_all_sym.comp<-separate(data_all_sym.comp, "site_code", into=c("site", "nutrient"), remove=FALSE)
data_all_sym.comp$siteID<-paste(data_all_sym.comp$site, data_all_sym.comp$nutrient, sep="")
```


##Differences in dispersion between species
```{r}
species.disp_sym<-betadisper(vegdist(data_all_sym.comp[,7:13], "euclidean"), data_all_sym.comp$species)
anova(species.disp_sym)
#            Df  Sum Sq Mean Sq F value   Pr(>F)   
# Groups      2  0.303 0.15127  1.4295 0.2406
# Residuals 416 44.022 0.10582   
#No significant difference in dispersion of symbiont physiology between Species 
```


##Centroid distances
```{r}
##Obtain centroid coordinates of each Sample Set (Same Species, Site, Season) with betadisper type="centroid"
data_all_sym.comp$Set<-paste(data_all_sym.comp$species, data_all_sym.comp$siteID, data_all_sym.comp$timepoint, sep=".")

sym.disp.grp<-betadisper(vegdist(data_all_sym.comp[,7:13], "euclidean"), data_all_sym.comp$Set, type="centroid")

##Calculate the variance of Physiology explained by the first two PCoA axes
sym.disp.grp$eig[1]/sum(sym.disp.grp$eig[which(sym.disp.grp$eig>0)])*100
sym.disp.grp$eig[2]/sum(sym.disp.grp$eig[which(sym.disp.grp$eig>0)])*100
sum(sym.disp.grp$eig[1:2])/sum(sym.disp.grp$eig[which(sym.disp.grp$eig>0)])*100
#88.75% explained by first two axes 

##Calculate the Euclidean distance between centroids using coordinates of the first 2 PCoA axes
centdist.sym<-as.matrix(dist(sym.disp.grp$centroids[,c(1:2)], method = "euclidean"))

##Create a dataframe of distances between centroids of Sample Sets
cents.sym<-data.frame(SetA=colnames(centdist.sym)[col(centdist.sym)], SetB=rownames(centdist.sym)[row(centdist.sym)], Cent.Dist.Sym=c(centdist.sym))

##Remove rows comparing self-pairs of Sample Sets 
cents.sym<-cents.sym[-c(which(cents.sym$SetA==cents.sym$SetB)),]

##Remove repeats (Ex: Set 1 vs Set 2 and Set 2 vs Set 1)
cents.sym<-cents.sym[!duplicated(cents.sym$Cent.Dist),]

##Split Sets column to add variables of interest
cents.sym<-separate(cents.sym, "SetA", into=c("species.A", "site.A", "timepoint.A"), remove=FALSE)
cents.sym<-separate(cents.sym, "SetB", into=c("species.B", "site.B", "timepoint.B"), remove=FALSE)

##Filter to only keep rows comparing the same Species
cents.sym<-cents.sym[c(which(cents.sym$species.A==cents.sym$species.B)),]

##Add variable of Pair for merging
cents.sym$Pair<-paste(cents.sym$SetA, cents.sym$SetB, sep="_")

##Species as factor
cents.sym$species<-factor(cents.sym$species.A, levels=c("Acropora", "Pocillopora", "Porites"))

##Dataframe with distances between Seasons by only keeping rows comparing the same Site
cents.sym.seas<-cents.sym[c(which(cents.sym$site.A==cents.sym$site.B)),]

##Dataframe with distances between Sites by only keeping rows comparing the same Season
cents.sym.site<-cents.sym[c(which(cents.sym$timepoint.A==cents.sym$timepoint.B)),]

```

##Run ANOVA on plasticity values 

Run anova on seasonal plasticity between species.
```{r}
summary(aov(Cent.Dist.Sym~species*site.A, data=cents.sym.seas))
#                  Df Sum Sq Mean Sq F value Pr(>F)  
# species.A         2  0.892  0.4461   2.876 0.0668 .
# site.A            2  0.271  0.1355   0.873 0.4245  
# species.A:site.A  4  0.520  0.1301   0.839 0.5079  
# Residuals        45  6.980  0.1551    
#No significant difference in seasonal plasticity of symbiont between species
#The effect of season does not differ between sites

compare_means(Cent.Dist.Sym~species, data=cents.sym.seas, method = "anova")
#   .y.                p p.adj p.format p.signif method
#   <chr>          <dbl> <dbl> <chr>    <chr>    <chr> 
# 1 Cent.Dist.Sym 0.0626 0.063 0.063    ns       Anova 
```

Run anova on spatial plasticity between species.
```{r}
summary(aov(Cent.Dist.Sym~species*timepoint.A, data=cents.sym.site))
#                       Df Sum Sq Mean Sq F value  Pr(>F)   
# species.A              2 0.5477 0.27383   7.353 0.00323 **
# timepoint.A            3 0.3553 0.11845   3.181 0.04217 * 
# species.A:timepoint.A  6 0.2324 0.03874   1.040 0.42440   
# Residuals             24 0.8938 0.03724  
#Significant difference in spatial plasticity of symbiont between species
#Significant difference in spatial plasticity of symbiont between seasons

compare_means(Cent.Dist.Sym~species, data=cents.sym.site, method = "anova")
#   .y.                 p  p.adj p.format p.signif method
#   <chr>           <dbl>  <dbl> <chr>    <chr>    <chr> 
# 1 Cent.Dist.Sym 0.00557 0.0056 0.0056   **       Anova 
```


##Generate figures- Seasonal and Spatial Plasticity
```{r}

sym.season.plasticity.plot<-ggplot(cents.sym.seas, aes(x=species.A, y=Cent.Dist.Sym, fill=species.A)) + 
  geom_boxplot(alpha=0.8, outlier.shape = NA)+
  geom_jitter(shape=16, position=position_jitter(0.2), alpha=0.5, size=3)+
  scale_fill_manual(name="Species", values = c("darkgray", "orange", "purple"))+
  stat_compare_means(method = "anova", label.x=1.75, size=6)+
  theme_classic()+
  theme(axis.title.x = element_text(size = 18), axis.title.y = element_text(size = 18), axis.text.x = element_text(size=14, face="italic"), axis.text.y = element_text(size=14), legend.text=element_text(size=12), legend.title=element_text(size=15), legend.position="none")+
  ylim(0,1.7)+
  ylab("Symbiont Seasonal Plasticity")+
  xlab("Species");sym.season.plasticity.plot

ggsave("Figures/Plasticity/dispersion_plasticity_season_sym.png", sym.season.plasticity.plot, width=4, height=4, dpi=300)


sym.spatial.plasticity.plot<-ggplot(cents.sym.site, aes(x=species.A, y=Cent.Dist.Sym, fill=species.A)) + 
  geom_boxplot(alpha=0.8, outlier.shape = NA)+
  geom_jitter(shape=16, position=position_jitter(0.2), alpha=0.5, size=3)+
  scale_fill_manual(name="Species", values = c("darkgray", "orange", "purple"))+
  stat_compare_means(method = "anova", label.x=1.75, size=6)+
  stat_compare_means(comparisons = spp_comparisons, size=5)+
  theme_classic()+
  theme(axis.title.x = element_text(size = 18), axis.title.y = element_text(size = 18), axis.text.x = element_text(size=14, face="italic"), axis.text.y = element_text(size=14), legend.text=element_text(size=12), legend.title=element_text(size=15), legend.position="none")+
  ylim(0,1.7)+
  ylab("Symbiont Spatial Plasticity")+
  xlab("Species");sym.spatial.plasticity.plot

ggsave("Figures/Plasticity/dispersion_plasticity_spatial_sym.png", sym.spatial.plasticity.plot, width=4, height=4, dpi=300)
```


#Correlation between Host and Symbiont Seasonal Plasticity 
```{r}

##Merge Host and Symbiont Seasonal plasticity dataframes
cent.dists.all.seas<-merge(cents.host.seas, cents.sym.seas)

##Correlation between Plasticity of Host and Symbiont across Seasons
cor.test(cent.dists.all.seas$Cent.Dist.Host, cent.dists.all.seas$Cent.Dist.Sym, method="spearman")
# S = 30718, p-value = 0.216
# alternative hypothesis: true rho is not equal to 0
# sample estimates:
#        rho 
# -0.1708786 


####Acropora
cent.dists.acr.seas<-cent.dists.all.seas%>%
  filter(species.A=="Acropora")

##Correlation between Plasticity of Host and Symbiont across Seasons
cor.test(cent.dists.acr.seas$Cent.Dist.Host, cent.dists.acr.seas$Cent.Dist.Sym, method="spearman")
# S = 1114, p-value = 0.5522
# alternative hypothesis: true rho is not equal to 0
# sample estimates:
#        rho 
# -0.1496388 


####Porites
cent.dists.por.seas<-cent.dists.all.seas%>%
  filter(species.A=="Porites")

##Correlation between Plasticity of Host and Symbiont across Seasons
cor.test(cent.dists.por.seas$Cent.Dist.Host, cent.dists.por.seas$Cent.Dist.Sym, method="spearman")
# S = 1002, p-value = 0.8953
# alternative hypothesis: true rho is not equal to 0
# sample estimates:
#         rho 
# -0.03405573 

####Pocillopora
cent.dists.poc.seas<-cent.dists.all.seas%>%
  filter(species.A=="Pocillopora")

##Correlation between Plasticity of Host and Symbiont across Seasons
cor.test(cent.dists.poc.seas$Cent.Dist.Host, cent.dists.poc.seas$Cent.Dist.Sym, method="spearman")
# S = 822, p-value = 0.5467
# alternative hypothesis: true rho is not equal to 0
# sample estimates:
#       rho 
# 0.1517028 
```


#Correlation between Host and Symbiont Spatial Plasticity 
```{r}

##Merge Host and Symbiont Spatial plasticity dataframes
cent.dists.all.site<-merge(cents.host.site, cents.sym.site)

##Correlation between Plasticity of Host and Symbiont across Seasons
cor.test(cent.dists.all.site$Cent.Dist.Host, cent.dists.all.site$Cent.Dist.Sym, method="spearman")
# S = 8074, p-value = 0.8204
# alternative hypothesis: true rho is not equal to 0
# sample estimates:
#         rho 
# -0.03912484 


####Acropora
cent.dists.acr.site<-cent.dists.all.site%>%
  filter(species.A=="Acropora")

##Correlation between Plasticity of Host and Symbiont across Seasons
cor.test(cent.dists.acr.site$Cent.Dist.Host, cent.dists.acr.site$Cent.Dist.Sym, method="spearman")
# S = 292, p-value = 0.9562
# alternative hypothesis: true rho is not equal to 0
# sample estimates:
#         rho 
# -0.02097902 


####Porites
cent.dists.por.site<-cent.dists.all.site%>%
  filter(species.A=="Porites")

##Correlation between Plasticity of Host and Symbiont across Seasons
cor.test(cent.dists.por.site$Cent.Dist.Host, cent.dists.por.site$Cent.Dist.Sym, method="spearman")
# S = 400, p-value = 0.201
# alternative hypothesis: true rho is not equal to 0
# sample estimates:
#        rho 
# -0.3986014 

####Pocillopora
cent.dists.poc.site<-cent.dists.all.site%>%
  filter(species.A=="Pocillopora")

##Correlation between Plasticity of Host and Symbiont across Seasons
cor.test(cent.dists.poc.site$Cent.Dist.Host, cent.dists.poc.site$Cent.Dist.Sym, method="spearman")
# S = 438, p-value = 0.0793
# alternative hypothesis: true rho is not equal to 0
# sample estimates:
#        rho 
# -0.5314685 
```
