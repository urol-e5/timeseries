---
title: "Calcification-test.Rmd"
author: "Emma Strand"
date: "3/10/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, message = FALSE, warning = FALSE)
```

# Calcification test 

We want to avoid manual entry when possible. So this script tests loading in:  
- `raw_files` folder with raw data file (example = `TA_Output_20220303_PutnamTitrations_PutnamLab`)
- `3_DeltaTA_metadata`  
- `3_DeltaTA_metadata`  

To produce with any manual entry:  
- `3_TA_data`

### Load all packages needed

```{r load_packages}
## install packages if you dont already have them in your library
if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages('tidyverse') 
if ("broom" %in% rownames(installed.packages()) == 'FALSE') install.packages('broom') 
if ("purrr" %in% rownames(installed.packages()) == 'FALSE') install.packages('purrr') 
if ("lubridate" %in% rownames(installed.packages()) == 'FALSE') install.packages('lubridate') 
if ("nlstools" %in% rownames(installed.packages()) == 'FALSE') install.packages('nlstools')
if ("stringr" %in% rownames(installed.packages()) == 'FALSE') install.packages('stringr') 

#Read in required libraries

library(broom)
library(plyr)
library(dplyr)
library(purrr)
library(lubridate)
library(tidyverse)
library(nlstools)
library(stringr)
```


### Import raw data 

For other time points, we will need better code for including the Initial1 and Initial2 verbiage. This only works well because it's 4 lines.

```{r import_data}
#bring in calcification data file with TA and chamber pH, temp, salinity measurements
raw.data <- list.files(path = 'data/3_calcification/raw_files', pattern = ".csv", full.names = TRUE) %>% 
  set_names(.) %>% 
  map_dfr(read.table, .id = "titration.run", header=TRUE, sep=",") %>%
  rename(Salinity.lab = Salinity) %>%
  filter(!SampleID == "JUNK 1")

deltaTA <- read.csv("data/3_calcification/3_DeltaTA_metadata.csv", header = TRUE, sep = ",")
initial.raw <- read.csv("data/3_calcification/3_initial_TA_samples.csv", header = TRUE, sep = ",")
initial.raw$colony_id <- c("Initial1", "Initial2", "Initial1", "Initial2")

deltaTA <- full_join(deltaTA, initial.raw) %>%
  rename(Salinity.chamber = Salinity) %>% # only changing salinity because delta TA and raw.data have this; temperature and pH are only in deltaTA
  unite(SampleID, colony_id, Date, Run.Number, sep = "_", remove = FALSE)

data <- full_join(deltaTA, raw.data, by = "SampleID") %>%
  mutate(sample.type = case_when(
    startsWith(SampleID, "Initial") ~ "Initial",
    startsWith(SampleID, "BK") ~ "Blank",
    startsWith(SampleID, "P") ~ "Sample", #this covers POC, POR
    startsWith(SampleID, "A") ~ "Sample")) # this covers ACR
```

## Normalize TA values to salinity and separate blanks from samples.  

```{r}
#add salinity normalization for TA values for blanks - add new column for TA initial normalized and TA normalized, then include TA.norm values below
data <- data %>% 
  mutate(Ta.norm_initial = ifelse(sample.type == "Initial", (TA * Salinity.lab/36), "NA"),
         Ta.norm = ifelse(!sample.type == "Initial", (TA * Salinity.lab/36), "NA")) # Both blanks and samples get a Ta.normal value

#blanks need TA.norm - initial for that run  
      
         delta.TA.blank = ifelse(sample.type == "Blank", (Ta.norm_initial - Ta.norm), "NA"))
  
 
initial <- data %>%
  dplyr::filter(sample.type=="Initial")%>% #create a data frame of the initial values
  select(SampleID, Salinity.chamber, Salinity.lab, TA, pH.mV, Ta.norm) %>%
  separate(SampleID, c("colony_id", "Date", "Run.Number"),sep = "_", remove=FALSE) %>% # this will include initials that we have TA but not in-field measurements
  rename_all(~ paste0(.x, "_initial")) %>% # add "_initial" to all columns 
  rename(Date=Date_initial, Run.Number=Run.Number_initial)
initial$Date <- as.character(initial$Date)

blanks <- data %>%
  dplyr::filter(sample.type=="Blank") #create a data frame of the blanks 
blanks$Date <- as.character(blanks$Date)
blanks$Run.Number <- as.character(blanks$Run.Number)

calc.data <- data %>%
  dplyr::filter(sample.type=="Sample")

#join blanks and carb chem data frame
calc.data <- left_join(calc.data, initial) #joining the initials to the data frame for carb chem

blanks <- left_join(blanks,initial)
```

## Calculate delta TA and mean blank values. 

```{r}
#figure out delta TA, initial-final
blanks<-blanks%>%
  mutate(delta.TA.blank = Ta.norm_initial - Ta.norm)

#getting the averages of blanks for each temperature and each date
mean.blanks <- blanks %>% 
  group_by(date) %>%
  summarise(mean.blanks=mean(delta.TA.blank))

calc.data <- left_join(calc.data, mean.blanks) #bring in mean blanks to calc.data

#need to join in SA, time data by colony ID, before calculating NEC
```





