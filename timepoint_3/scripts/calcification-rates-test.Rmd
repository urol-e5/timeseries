---
title: "Calcification-test.Rmd"
author: "Emma Strand"
date: "3/10/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, message = FALSE, warning = FALSE)
```

# Calcification test 

We want to avoid manual entry when possible. So this script tests loading in:  
- `raw_files` folder with raw data file (example = `TA_Output_20220303_PutnamTitrations_PutnamLab`)
- `3_DeltaTA_metadata`  
- `3_DeltaTA_metadata`  

To produce with any manual entry:  
- `3_TA_data`

### Load all packages needed

```{r load_packages}
## install packages if you dont already have them in your library
if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages('tidyverse') 
if ("broom" %in% rownames(installed.packages()) == 'FALSE') install.packages('broom') 
if ("purrr" %in% rownames(installed.packages()) == 'FALSE') install.packages('purrr') 
if ("lubridate" %in% rownames(installed.packages()) == 'FALSE') install.packages('lubridate') 
if ("nlstools" %in% rownames(installed.packages()) == 'FALSE') install.packages('nlstools')
if ("stringr" %in% rownames(installed.packages()) == 'FALSE') install.packages('stringr') 

#Read in required libraries

library(broom)
library(plyr)
library(dplyr)
library(purrr)
library(lubridate)
library(tidyverse)
library(nlstools)
library(stringr)
```


### Import raw data 

Putnam_Sample_TA file (output from CSUN titrations) is only used for salinity. We are pulling TA values straight from raw output files in 'data/3_calcification/raw_files' folder.  
I'm taking out initial 1 run 3 from CSUN for now (done at both CSUN and URI) -- circle back to which one to keep for analysis. 

```{r import_data}
#bring in calcification data file with TA and chamber pH, temp, salinity measurements
raw.data <- list.files(path = 'data/3_calcification/raw_files', pattern = ".csv", full.names = TRUE) %>% 
  set_names(.) %>% 
  map_dfr(read.table, .id = "titration.run", header=TRUE, sep=",") %>%
  filter(!SampleID == "JUNK 1") %>% filter(!SampleID == "JUNK 2") %>% filter(!SampleID == "CRM") %>% 
  select(-Sample.Index, -TA_evap) %>%
  rename(Salinity.lab = Salinity) 

Putnam_Sample_TA <- read.csv("data/3_calcification/Putnam_Sample_TA.csv") %>% select(SampleID, Salinity) %>% filter(!SampleID == "Initial1_20200912_3")  

raw.data <- full_join(raw.data, Putnam_Sample_TA, by = "SampleID") %>% 
  gather("salinity.origin", "Salinity.lab", 5:6) %>% # this will combine both salinity columns into one
  filter(!is.na(Salinity.lab)) %>% select(-salinity.origin) %>%
  separate(SampleID, c("colony_id", "Date", "Run.Number"), sep = "_", convert = FALSE) # keeps new column as old string (character)

deltaTA <- read.csv("data/3_calcification/3_DeltaTA_metadata.csv", header = TRUE, sep = ",",
                    colClasses=c(rep('character', 11), rep('numeric', 5), rep('character', 3))) %>%
           rename(Salinity.chamber = Salinity) 

data <- full_join(deltaTA, raw.data, by = c("colony_id", "Date", "Run.Number")) %>%
  mutate(sample.type = case_when(
    startsWith(colony_id, "Initial") ~ "Initial",
    startsWith(colony_id, "BK") ~ "Blank",
    startsWith(colony_id, "P") ~ "Sample", #this covers POC, POR
    startsWith(colony_id, "A") ~ "Sample")) # this covers ACR
```


```{r}
### use this later?
# initial.raw <- read.csv("data/3_calcification/3_initial_TA_samples.csv", header = TRUE, sep = ",") %>%
#   mutate(colony_id = "Initial") #%>% unite(colony_id, colony_id, Run.Number, sep = "_", remove = FALSE)
# 
# deltaTA <- full_join(deltaTA, initial.raw) 
```

## Normalize TA values to salinity and separate blanks from samples.  

```{r}
#add salinity normalization for TA values for blanks - add new column for TA initial normalized and TA normalized, then include TA.norm values below
Calc.data2 <- data %>%
  mutate(Ta.norm = TA*Salinity.lab/36) %>%
  dplyr::group_by(Run.Number, sample.type) %>%
  mutate(Ta.norm_initial_avg = mean(Ta.norm))
  
Calc.data <- data %>%
  mutate(Ta.norm_initial = ifelse(sample.type == "Initial", (TA * Salinity.lab/36), NA), # for only initials, calculate Ta.norm.initial
         Ta.norm = ifelse(!sample.type == "Initial", (TA * Salinity.lab/36), NA)) %>% # for all rows that are not Initials, calculate Ta.norm
  dplyr::group_by(Run.Number, sample.type) %>% # grouping by run number and sample type to do the following calculation
  mutate(Ta.norm_initial_avg = mean(Ta.norm_initial)) %>% ungroup(sample.type) %>% # averaging the 2 initial values for each run
  mutate(delta.TA.blank = ifelse(sample.type == "Blank", (Ta.norm_initial_avg - Ta.norm), NA))
  
    
### left off at trying to subset to initial values and group those by run.number to calculate average
# average initial TA values (n=6)

#blanks need TA.norm - initial for that run  
      
         delta.TA.blank = ifelse(sample.type == "Blank", (Ta.norm_initial - Ta.norm), NA))
  
 
initial <- data %>%
  dplyr::filter(sample.type=="Initial")%>% #create a data frame of the initial values
  select(SampleID, Salinity.chamber, Salinity.lab, TA, pH.mV, Ta.norm) %>%
  separate(SampleID, c("colony_id", "Date", "Run.Number"),sep = "_", remove=FALSE) %>% # this will include initials that we have TA but not in-field measurements
  rename_all(~ paste0(.x, "_initial")) %>% # add "_initial" to all columns 
  rename(Date=Date_initial, Run.Number=Run.Number_initial)
initial$Date <- as.character(initial$Date)

blanks <- data %>%
  dplyr::filter(sample.type=="Blank") #create a data frame of the blanks 
blanks$Date <- as.character(blanks$Date)
blanks$Run.Number <- as.character(blanks$Run.Number)

calc.data <- data %>%
  dplyr::filter(sample.type=="Sample")

#join blanks and carb chem data frame
calc.data <- left_join(calc.data, initial) #joining the initials to the data frame for carb chem

blanks <- left_join(blanks,initial)
```

## Calculate delta TA and mean blank values. 

```{r}
#figure out delta TA, initial-final
blanks<-blanks%>%
  mutate(delta.TA.blank = Ta.norm_initial - Ta.norm)

#getting the averages of blanks for each temperature and each date
mean.blanks <- blanks %>% 
  group_by(date) %>%
  summarise(mean.blanks=mean(delta.TA.blank))

calc.data <- left_join(calc.data, mean.blanks) #bring in mean blanks to calc.data

#need to join in SA, time data by colony ID, before calculating NEC
```





